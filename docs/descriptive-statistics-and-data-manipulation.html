<!DOCTYPE html>
<html >

<head>

  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Chapter 4 Descriptive statistics and data manipulation | Modern R with the tidyverse</title>
  <meta name="description" content="This book will teach you how to use R to solve you statistical, data science and machine learning problems. Importing data, computing descriptive statistics, running regressions (or more complex machine learning models) and generating reports are some of the topics covered. No previous experience with R is needed.">
  <meta name="generator" content="bookdown  and GitBook 2.6.7">

  <meta property="og:title" content="Chapter 4 Descriptive statistics and data manipulation | Modern R with the tidyverse" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="This book will teach you how to use R to solve you statistical, data science and machine learning problems. Importing data, computing descriptive statistics, running regressions (or more complex machine learning models) and generating reports are some of the topics covered. No previous experience with R is needed." />
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 4 Descriptive statistics and data manipulation | Modern R with the tidyverse" />
  
  <meta name="twitter:description" content="This book will teach you how to use R to solve you statistical, data science and machine learning problems. Importing data, computing descriptive statistics, running regressions (or more complex machine learning models) and generating reports are some of the topics covered. No previous experience with R is needed." />
  

<meta name="author" content="Bruno Rodrigues">


<meta name="date" content="2019-05-09">

  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  
  
<link rel="prev" href="reading-and-writing-data.html">
<link rel="next" href="graphs.html">
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />









<style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(title);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Modern R with the tidyverse</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Preface</a><ul>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#note-to-the-reader"><i class="fa fa-check"></i>Note to the reader</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#what-is-r"><i class="fa fa-check"></i>What is R?</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#who-is-this-book-for"><i class="fa fa-check"></i>Who is this book for?</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#why-this-book"><i class="fa fa-check"></i>Why this book?</a></li>
<li><a href="index.html#why-modern-r">Why <em>modern</em> R?</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#what-is-rstudio"><i class="fa fa-check"></i>What is RStudio?</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#what-to-expect-from-this-book"><i class="fa fa-check"></i>What to expect from this book?</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#prerequisites"><i class="fa fa-check"></i>Prerequisites</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#what-are-packages"><i class="fa fa-check"></i>What are packages?</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#the-author"><i class="fa fa-check"></i>The author</a></li>
</ul></li>
<li class="chapter" data-level="1" data-path="getting-to-know-rstudio.html"><a href="getting-to-know-rstudio.html"><i class="fa fa-check"></i><b>1</b> Getting to know RStudio</a><ul>
<li class="chapter" data-level="1.1" data-path="getting-to-know-rstudio.html"><a href="getting-to-know-rstudio.html#panes"><i class="fa fa-check"></i><b>1.1</b> Panes</a></li>
<li class="chapter" data-level="1.2" data-path="getting-to-know-rstudio.html"><a href="getting-to-know-rstudio.html#console"><i class="fa fa-check"></i><b>1.2</b> Console</a></li>
<li class="chapter" data-level="1.3" data-path="getting-to-know-rstudio.html"><a href="getting-to-know-rstudio.html#scripts"><i class="fa fa-check"></i><b>1.3</b> Scripts</a><ul>
<li class="chapter" data-level="1.3.1" data-path="getting-to-know-rstudio.html"><a href="getting-to-know-rstudio.html#the-help-pane"><i class="fa fa-check"></i><b>1.3.1</b> The help pane</a></li>
<li class="chapter" data-level="1.3.2" data-path="getting-to-know-rstudio.html"><a href="getting-to-know-rstudio.html#the-environment-pane"><i class="fa fa-check"></i><b>1.3.2</b> The Environment pane</a></li>
</ul></li>
<li class="chapter" data-level="1.4" data-path="getting-to-know-rstudio.html"><a href="getting-to-know-rstudio.html#options"><i class="fa fa-check"></i><b>1.4</b> Options</a></li>
<li class="chapter" data-level="1.5" data-path="getting-to-know-rstudio.html"><a href="getting-to-know-rstudio.html#keyboard-shortcuts"><i class="fa fa-check"></i><b>1.5</b> Keyboard shortcuts</a></li>
<li class="chapter" data-level="1.6" data-path="getting-to-know-rstudio.html"><a href="getting-to-know-rstudio.html#projects"><i class="fa fa-check"></i><b>1.6</b> Projects</a></li>
<li class="chapter" data-level="1.7" data-path="getting-to-know-rstudio.html"><a href="getting-to-know-rstudio.html#history"><i class="fa fa-check"></i><b>1.7</b> History</a></li>
<li class="chapter" data-level="1.8" data-path="getting-to-know-rstudio.html"><a href="getting-to-know-rstudio.html#plots"><i class="fa fa-check"></i><b>1.8</b> Plots</a></li>
<li class="chapter" data-level="1.9" data-path="getting-to-know-rstudio.html"><a href="getting-to-know-rstudio.html#addins"><i class="fa fa-check"></i><b>1.9</b> Addins</a></li>
<li class="chapter" data-level="1.10" data-path="getting-to-know-rstudio.html"><a href="getting-to-know-rstudio.html#packages"><i class="fa fa-check"></i><b>1.10</b> Packages</a></li>
<li class="chapter" data-level="1.11" data-path="getting-to-know-rstudio.html"><a href="getting-to-know-rstudio.html#exercises"><i class="fa fa-check"></i><b>1.11</b> Exercises</a><ul>
<li class="chapter" data-level="" data-path="getting-to-know-rstudio.html"><a href="getting-to-know-rstudio.html#exercise-1"><i class="fa fa-check"></i>Exercise 1</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="2" data-path="objects-types-and-useful-r-functions-to-get-started.html"><a href="objects-types-and-useful-r-functions-to-get-started.html"><i class="fa fa-check"></i><b>2</b> Objects, types and useful R functions to get started</a><ul>
<li class="chapter" data-level="2.1" data-path="objects-types-and-useful-r-functions-to-get-started.html"><a href="objects-types-and-useful-r-functions-to-get-started.html#the-numeric-class"><i class="fa fa-check"></i><b>2.1</b> The <code>numeric</code> class</a></li>
<li class="chapter" data-level="2.2" data-path="objects-types-and-useful-r-functions-to-get-started.html"><a href="objects-types-and-useful-r-functions-to-get-started.html#the-character-class"><i class="fa fa-check"></i><b>2.2</b> The <code>character</code> class</a></li>
<li class="chapter" data-level="2.3" data-path="objects-types-and-useful-r-functions-to-get-started.html"><a href="objects-types-and-useful-r-functions-to-get-started.html#the-factor-class"><i class="fa fa-check"></i><b>2.3</b> The <code>factor</code> class</a></li>
<li class="chapter" data-level="2.4" data-path="objects-types-and-useful-r-functions-to-get-started.html"><a href="objects-types-and-useful-r-functions-to-get-started.html#the-date-class"><i class="fa fa-check"></i><b>2.4</b> The <code>Date</code> class</a></li>
<li class="chapter" data-level="2.5" data-path="objects-types-and-useful-r-functions-to-get-started.html"><a href="objects-types-and-useful-r-functions-to-get-started.html#the-logical-class"><i class="fa fa-check"></i><b>2.5</b> The <code>logical</code> class</a></li>
<li class="chapter" data-level="2.6" data-path="objects-types-and-useful-r-functions-to-get-started.html"><a href="objects-types-and-useful-r-functions-to-get-started.html#vectors-and-matrices"><i class="fa fa-check"></i><b>2.6</b> Vectors and matrices</a><ul>
<li class="chapter" data-level="2.6.1" data-path="objects-types-and-useful-r-functions-to-get-started.html"><a href="objects-types-and-useful-r-functions-to-get-started.html#the-c-function"><i class="fa fa-check"></i><b>2.6.1</b> The <code>c()</code> function</a></li>
<li class="chapter" data-level="2.6.2" data-path="objects-types-and-useful-r-functions-to-get-started.html"><a href="objects-types-and-useful-r-functions-to-get-started.html#cbind-and-rbind"><i class="fa fa-check"></i><b>2.6.2</b> <code>cbind()</code> and <code>rbind()</code></a></li>
<li class="chapter" data-level="2.6.3" data-path="objects-types-and-useful-r-functions-to-get-started.html"><a href="objects-types-and-useful-r-functions-to-get-started.html#the-matrix-class"><i class="fa fa-check"></i><b>2.6.3</b> The <code>matrix</code> class</a></li>
</ul></li>
<li class="chapter" data-level="2.7" data-path="objects-types-and-useful-r-functions-to-get-started.html"><a href="objects-types-and-useful-r-functions-to-get-started.html#the-list-class"><i class="fa fa-check"></i><b>2.7</b> The <code>list</code> class</a></li>
<li class="chapter" data-level="2.8" data-path="objects-types-and-useful-r-functions-to-get-started.html"><a href="objects-types-and-useful-r-functions-to-get-started.html#the-data.frame-and-tibble-classes"><i class="fa fa-check"></i><b>2.8</b> The <code>data.frame</code> and <code>tibble</code> classes</a></li>
<li class="chapter" data-level="2.9" data-path="objects-types-and-useful-r-functions-to-get-started.html"><a href="objects-types-and-useful-r-functions-to-get-started.html#formulas"><i class="fa fa-check"></i><b>2.9</b> Formulas</a></li>
<li class="chapter" data-level="2.10" data-path="objects-types-and-useful-r-functions-to-get-started.html"><a href="objects-types-and-useful-r-functions-to-get-started.html#models"><i class="fa fa-check"></i><b>2.10</b> Models</a></li>
<li class="chapter" data-level="2.11" data-path="objects-types-and-useful-r-functions-to-get-started.html"><a href="objects-types-and-useful-r-functions-to-get-started.html#null-na-and-nan"><i class="fa fa-check"></i><b>2.11</b> NULL, NA and NaN</a></li>
<li class="chapter" data-level="2.12" data-path="objects-types-and-useful-r-functions-to-get-started.html"><a href="objects-types-and-useful-r-functions-to-get-started.html#useful-functions-to-get-you-started"><i class="fa fa-check"></i><b>2.12</b> Useful functions to get you started</a><ul>
<li class="chapter" data-level="2.12.1" data-path="objects-types-and-useful-r-functions-to-get-started.html"><a href="objects-types-and-useful-r-functions-to-get-started.html#sequences"><i class="fa fa-check"></i><b>2.12.1</b> Sequences</a></li>
<li class="chapter" data-level="2.12.2" data-path="objects-types-and-useful-r-functions-to-get-started.html"><a href="objects-types-and-useful-r-functions-to-get-started.html#basic-string-manipulation"><i class="fa fa-check"></i><b>2.12.2</b> Basic string manipulation</a></li>
</ul></li>
<li class="chapter" data-level="2.13" data-path="objects-types-and-useful-r-functions-to-get-started.html"><a href="objects-types-and-useful-r-functions-to-get-started.html#exercises-1"><i class="fa fa-check"></i><b>2.13</b> Exercises</a><ul>
<li class="chapter" data-level="" data-path="objects-types-and-useful-r-functions-to-get-started.html"><a href="objects-types-and-useful-r-functions-to-get-started.html#exercise-1-1"><i class="fa fa-check"></i>Exercise 1</a></li>
<li class="chapter" data-level="" data-path="objects-types-and-useful-r-functions-to-get-started.html"><a href="objects-types-and-useful-r-functions-to-get-started.html#exercise-2"><i class="fa fa-check"></i>Exercise 2</a></li>
<li class="chapter" data-level="" data-path="objects-types-and-useful-r-functions-to-get-started.html"><a href="objects-types-and-useful-r-functions-to-get-started.html#exercise-3"><i class="fa fa-check"></i>Exercise 3</a></li>
<li class="chapter" data-level="" data-path="objects-types-and-useful-r-functions-to-get-started.html"><a href="objects-types-and-useful-r-functions-to-get-started.html#exercise-4"><i class="fa fa-check"></i>Exercise 4</a></li>
<li class="chapter" data-level="" data-path="objects-types-and-useful-r-functions-to-get-started.html"><a href="objects-types-and-useful-r-functions-to-get-started.html#exercise-5"><i class="fa fa-check"></i>Exercise 5</a></li>
<li class="chapter" data-level="" data-path="objects-types-and-useful-r-functions-to-get-started.html"><a href="objects-types-and-useful-r-functions-to-get-started.html#exercise-6"><i class="fa fa-check"></i>Exercise 6</a></li>
<li class="chapter" data-level="" data-path="objects-types-and-useful-r-functions-to-get-started.html"><a href="objects-types-and-useful-r-functions-to-get-started.html#exercise-7"><i class="fa fa-check"></i>Exercise 7</a></li>
<li class="chapter" data-level="" data-path="objects-types-and-useful-r-functions-to-get-started.html"><a href="objects-types-and-useful-r-functions-to-get-started.html#exercise-8"><i class="fa fa-check"></i>Exercise 8</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="3" data-path="reading-and-writing-data.html"><a href="reading-and-writing-data.html"><i class="fa fa-check"></i><b>3</b> Reading and writing data</a><ul>
<li class="chapter" data-level="3.1" data-path="reading-and-writing-data.html"><a href="reading-and-writing-data.html#the-swiss-army-knife-of-data-import-and-export-rio"><i class="fa fa-check"></i><b>3.1</b> The swiss army knife of data import and export: <code>{rio}</code></a></li>
<li class="chapter" data-level="3.2" data-path="reading-and-writing-data.html"><a href="reading-and-writing-data.html#writing-any-object-to-disk"><i class="fa fa-check"></i><b>3.2</b> Writing any object to disk</a></li>
<li class="chapter" data-level="3.3" data-path="reading-and-writing-data.html"><a href="reading-and-writing-data.html#using-rstudio-projects-to-manage-paths"><i class="fa fa-check"></i><b>3.3</b> Using RStudio projects to manage paths</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="descriptive-statistics-and-data-manipulation.html"><a href="descriptive-statistics-and-data-manipulation.html"><i class="fa fa-check"></i><b>4</b> Descriptive statistics and data manipulation</a><ul>
<li class="chapter" data-level="4.1" data-path="descriptive-statistics-and-data-manipulation.html"><a href="descriptive-statistics-and-data-manipulation.html#a-data-exploration-exercice-using-base-r"><i class="fa fa-check"></i><b>4.1</b> A data exploration exercice using <em>base</em> R</a></li>
<li class="chapter" data-level="4.2" data-path="descriptive-statistics-and-data-manipulation.html"><a href="descriptive-statistics-and-data-manipulation.html#smoking-is-bad-for-you-but-pipes-are-your-friend"><i class="fa fa-check"></i><b>4.2</b> Smoking is bad for you, but pipes are your friend</a></li>
<li class="chapter" data-level="4.3" data-path="descriptive-statistics-and-data-manipulation.html"><a href="descriptive-statistics-and-data-manipulation.html#the-tidyverses-enfant-prodige-dplyr"><i class="fa fa-check"></i><b>4.3</b> The <code>{tidyverse}</code>‚Äôs <em>enfant prodige</em>: <code>{dplyr}</code></a><ul>
<li class="chapter" data-level="4.3.1" data-path="descriptive-statistics-and-data-manipulation.html"><a href="descriptive-statistics-and-data-manipulation.html#a-first-taste-of-data-manipulation-with-dplyr"><i class="fa fa-check"></i><b>4.3.1</b> A first taste of data manipulation with <code>{dplyr}</code></a></li>
<li class="chapter" data-level="4.3.2" data-path="descriptive-statistics-and-data-manipulation.html"><a href="descriptive-statistics-and-data-manipulation.html#filter-the-rows-of-a-dataset-with-filter"><i class="fa fa-check"></i><b>4.3.2</b> Filter the rows of a dataset with <code>filter()</code></a></li>
<li class="chapter" data-level="4.3.3" data-path="descriptive-statistics-and-data-manipulation.html"><a href="descriptive-statistics-and-data-manipulation.html#select-columns-with-select"><i class="fa fa-check"></i><b>4.3.3</b> Select columns with <code>select()</code></a></li>
<li class="chapter" data-level="4.3.4" data-path="descriptive-statistics-and-data-manipulation.html"><a href="descriptive-statistics-and-data-manipulation.html#group-the-observations-of-your-dataset-with-group_by"><i class="fa fa-check"></i><b>4.3.4</b> Group the observations of your dataset with <code>group_by()</code></a></li>
<li class="chapter" data-level="4.3.5" data-path="descriptive-statistics-and-data-manipulation.html"><a href="descriptive-statistics-and-data-manipulation.html#get-summary-statistics-with-summarise"><i class="fa fa-check"></i><b>4.3.5</b> Get summary statistics with <code>summarise()</code></a></li>
<li class="chapter" data-level="4.3.6" data-path="descriptive-statistics-and-data-manipulation.html"><a href="descriptive-statistics-and-data-manipulation.html#adding-columns-with-mutate-and-transmute"><i class="fa fa-check"></i><b>4.3.6</b> Adding columns with <code>mutate()</code> and <code>transmute()</code></a></li>
<li class="chapter" data-level="4.3.7" data-path="descriptive-statistics-and-data-manipulation.html"><a href="descriptive-statistics-and-data-manipulation.html#joining-tibbles-with-full_join-left_join-right_join-and-all-the-others"><i class="fa fa-check"></i><b>4.3.7</b> Joining <code>tibble</code>s with <code>full_join()</code>, <code>left_join()</code>, <code>right_join()</code> and all the others</a></li>
</ul></li>
<li class="chapter" data-level="4.4" data-path="descriptive-statistics-and-data-manipulation.html"><a href="descriptive-statistics-and-data-manipulation.html#reshaping-data-with-tidyr"><i class="fa fa-check"></i><b>4.4</b> Reshaping data with <code>tidyr</code></a><ul>
<li class="chapter" data-level="4.4.1" data-path="descriptive-statistics-and-data-manipulation.html"><a href="descriptive-statistics-and-data-manipulation.html#pivot_wide-and-pivot_long"><i class="fa fa-check"></i><b>4.4.1</b> <code>pivot_wide()</code> and <code>pivot_long()</code></a></li>
<li class="chapter" data-level="4.4.2" data-path="descriptive-statistics-and-data-manipulation.html"><a href="descriptive-statistics-and-data-manipulation.html#spread-and-gather"><i class="fa fa-check"></i><b>4.4.2</b> <code>spread()</code> and <code>gather()</code></a></li>
<li class="chapter" data-level="4.4.3" data-path="descriptive-statistics-and-data-manipulation.html"><a href="descriptive-statistics-and-data-manipulation.html#fill-and-full_seq"><i class="fa fa-check"></i><b>4.4.3</b> <code>fill()</code> and <code>full_seq()</code></a></li>
<li class="chapter" data-level="4.4.4" data-path="descriptive-statistics-and-data-manipulation.html"><a href="descriptive-statistics-and-data-manipulation.html#put-order-in-your-columns-with-separate-unite-and-in-your-rows-with-separate_rows"><i class="fa fa-check"></i><b>4.4.4</b> Put order in your columns with <code>separate()</code>, <code>unite()</code>, and in your rows with <code>separate_rows()</code></a></li>
<li class="chapter" data-level="4.4.5" data-path="descriptive-statistics-and-data-manipulation.html"><a href="descriptive-statistics-and-data-manipulation.html#a-sneak-peek-to-chapter-8-nest"><i class="fa fa-check"></i><b>4.4.5</b> A sneak peek to Chapter 8; <code>nest()</code></a></li>
</ul></li>
<li class="chapter" data-level="4.5" data-path="descriptive-statistics-and-data-manipulation.html"><a href="descriptive-statistics-and-data-manipulation.html#scoped-tidyverse-verbs"><i class="fa fa-check"></i><b>4.5</b> Scoped <code>{tidyverse}</code> verbs</a><ul>
<li class="chapter" data-level="4.5.1" data-path="descriptive-statistics-and-data-manipulation.html"><a href="descriptive-statistics-and-data-manipulation.html#filter_"><i class="fa fa-check"></i><b>4.5.1</b> filter_*()</a></li>
<li class="chapter" data-level="4.5.2" data-path="descriptive-statistics-and-data-manipulation.html"><a href="descriptive-statistics-and-data-manipulation.html#select_-and-rename_"><i class="fa fa-check"></i><b>4.5.2</b> select_*() and rename_*()</a></li>
<li class="chapter" data-level="4.5.3" data-path="descriptive-statistics-and-data-manipulation.html"><a href="descriptive-statistics-and-data-manipulation.html#group_by_"><i class="fa fa-check"></i><b>4.5.3</b> group_by_*()</a></li>
<li class="chapter" data-level="4.5.4" data-path="descriptive-statistics-and-data-manipulation.html"><a href="descriptive-statistics-and-data-manipulation.html#summarise_"><i class="fa fa-check"></i><b>4.5.4</b> summarise_()</a></li>
<li class="chapter" data-level="4.5.5" data-path="descriptive-statistics-and-data-manipulation.html"><a href="descriptive-statistics-and-data-manipulation.html#mutate_"><i class="fa fa-check"></i><b>4.5.5</b> mutate_*()</a></li>
</ul></li>
<li class="chapter" data-level="4.6" data-path="descriptive-statistics-and-data-manipulation.html"><a href="descriptive-statistics-and-data-manipulation.html#other-useful-tidyverse-functions"><i class="fa fa-check"></i><b>4.6</b> Other useful <code>{tidyverse}</code> functions</a><ul>
<li class="chapter" data-level="4.6.1" data-path="descriptive-statistics-and-data-manipulation.html"><a href="descriptive-statistics-and-data-manipulation.html#if_else-case_when-and-recode"><i class="fa fa-check"></i><b>4.6.1</b> <code>if_else()</code>, <code>case_when()</code> and <code>recode()</code></a></li>
<li class="chapter" data-level="4.6.2" data-path="descriptive-statistics-and-data-manipulation.html"><a href="descriptive-statistics-and-data-manipulation.html#lead-and-lag"><i class="fa fa-check"></i><b>4.6.2</b> <code>lead()</code> and <code>lag()</code></a></li>
<li class="chapter" data-level="4.6.3" data-path="descriptive-statistics-and-data-manipulation.html"><a href="descriptive-statistics-and-data-manipulation.html#ntile"><i class="fa fa-check"></i><b>4.6.3</b> <code>ntile()</code></a></li>
<li class="chapter" data-level="4.6.4" data-path="descriptive-statistics-and-data-manipulation.html"><a href="descriptive-statistics-and-data-manipulation.html#arrange"><i class="fa fa-check"></i><b>4.6.4</b> <code>arrange()</code></a></li>
<li class="chapter" data-level="4.6.5" data-path="descriptive-statistics-and-data-manipulation.html"><a href="descriptive-statistics-and-data-manipulation.html#tally-and-count"><i class="fa fa-check"></i><b>4.6.5</b> <code>tally()</code> and <code>count()</code></a></li>
</ul></li>
<li class="chapter" data-level="4.7" data-path="descriptive-statistics-and-data-manipulation.html"><a href="descriptive-statistics-and-data-manipulation.html#special-packages-for-special-kinds-of-data-forcats-lubridate-and-stringr"><i class="fa fa-check"></i><b>4.7</b> Special packages for special kinds of data: <code>{forcats}</code>, <code>{lubridate}</code>, and <code>{stringr}</code></a><ul>
<li class="chapter" data-level="4.7.1" data-path="descriptive-statistics-and-data-manipulation.html"><a href="descriptive-statistics-and-data-manipulation.html#section"><i class="fa fa-check"></i><b>4.7.1</b> üêàüêàüêàüêà</a></li>
<li class="chapter" data-level="4.7.2" data-path="descriptive-statistics-and-data-manipulation.html"><a href="descriptive-statistics-and-data-manipulation.html#get-your-dates-right-with-lubridate"><i class="fa fa-check"></i><b>4.7.2</b> Get your dates right with <code>{lubridate}</code></a></li>
<li class="chapter" data-level="4.7.3" data-path="descriptive-statistics-and-data-manipulation.html"><a href="descriptive-statistics-and-data-manipulation.html#manipulate-strings-with-stringr"><i class="fa fa-check"></i><b>4.7.3</b> Manipulate strings with <code>{stringr}</code></a></li>
<li class="chapter" data-level="4.7.4" data-path="descriptive-statistics-and-data-manipulation.html"><a href="descriptive-statistics-and-data-manipulation.html#tidy-data-frames-with-tibble"><i class="fa fa-check"></i><b>4.7.4</b> Tidy data frames with <code>{tibble}</code></a></li>
</ul></li>
<li class="chapter" data-level="4.8" data-path="descriptive-statistics-and-data-manipulation.html"><a href="descriptive-statistics-and-data-manipulation.html#list-columns"><i class="fa fa-check"></i><b>4.8</b> List-columns</a></li>
<li class="chapter" data-level="4.9" data-path="descriptive-statistics-and-data-manipulation.html"><a href="descriptive-statistics-and-data-manipulation.html#going-beyond-descriptive-statistics-and-data-manipulation"><i class="fa fa-check"></i><b>4.9</b> Going beyond descriptive statistics and data manipulation</a></li>
<li class="chapter" data-level="4.10" data-path="descriptive-statistics-and-data-manipulation.html"><a href="descriptive-statistics-and-data-manipulation.html#exercises-2"><i class="fa fa-check"></i><b>4.10</b> Exercises</a><ul>
<li class="chapter" data-level="" data-path="descriptive-statistics-and-data-manipulation.html"><a href="descriptive-statistics-and-data-manipulation.html#exercise-1-2"><i class="fa fa-check"></i>Exercise 1</a></li>
<li class="chapter" data-level="" data-path="descriptive-statistics-and-data-manipulation.html"><a href="descriptive-statistics-and-data-manipulation.html#exercise-2-1"><i class="fa fa-check"></i>Exercise 2</a></li>
<li class="chapter" data-level="" data-path="descriptive-statistics-and-data-manipulation.html"><a href="descriptive-statistics-and-data-manipulation.html#exercise-3-1"><i class="fa fa-check"></i>Exercise 3</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="5" data-path="graphs.html"><a href="graphs.html"><i class="fa fa-check"></i><b>5</b> Graphs</a><ul>
<li class="chapter" data-level="5.1" data-path="graphs.html"><a href="graphs.html#resources"><i class="fa fa-check"></i><b>5.1</b> Resources</a></li>
<li class="chapter" data-level="5.2" data-path="graphs.html"><a href="graphs.html#examples"><i class="fa fa-check"></i><b>5.2</b> Examples</a><ul>
<li class="chapter" data-level="5.2.1" data-path="graphs.html"><a href="graphs.html#barplots"><i class="fa fa-check"></i><b>5.2.1</b> Barplots</a></li>
<li class="chapter" data-level="5.2.2" data-path="graphs.html"><a href="graphs.html#scatter-plots"><i class="fa fa-check"></i><b>5.2.2</b> Scatter plots</a></li>
<li class="chapter" data-level="5.2.3" data-path="graphs.html"><a href="graphs.html#density"><i class="fa fa-check"></i><b>5.2.3</b> Density</a></li>
<li class="chapter" data-level="5.2.4" data-path="graphs.html"><a href="graphs.html#line-plots"><i class="fa fa-check"></i><b>5.2.4</b> Line plots</a></li>
<li class="chapter" data-level="5.2.5" data-path="graphs.html"><a href="graphs.html#facets"><i class="fa fa-check"></i><b>5.2.5</b> Facets</a></li>
<li class="chapter" data-level="5.2.6" data-path="graphs.html"><a href="graphs.html#pie-charts"><i class="fa fa-check"></i><b>5.2.6</b> Pie Charts</a></li>
<li class="chapter" data-level="5.2.7" data-path="graphs.html"><a href="graphs.html#adding-text-to-plots"><i class="fa fa-check"></i><b>5.2.7</b> Adding text to plots</a></li>
</ul></li>
<li class="chapter" data-level="5.3" data-path="graphs.html"><a href="graphs.html#customization"><i class="fa fa-check"></i><b>5.3</b> Customization</a><ul>
<li class="chapter" data-level="5.3.1" data-path="graphs.html"><a href="graphs.html#changing-titles-axes-labels-options-mixing-geoms-and-changing-themes"><i class="fa fa-check"></i><b>5.3.1</b> Changing titles, axes labels, options, mixing geoms and changing themes</a></li>
<li class="chapter" data-level="5.3.2" data-path="graphs.html"><a href="graphs.html#colour-schemes"><i class="fa fa-check"></i><b>5.3.2</b> Colour schemes</a></li>
</ul></li>
<li class="chapter" data-level="5.4" data-path="graphs.html"><a href="graphs.html#saving-plots-to-disk"><i class="fa fa-check"></i><b>5.4</b> Saving plots to disk</a></li>
<li class="chapter" data-level="5.5" data-path="graphs.html"><a href="graphs.html#exercises-3"><i class="fa fa-check"></i><b>5.5</b> Exercises</a><ul>
<li class="chapter" data-level="" data-path="graphs.html"><a href="graphs.html#exercise-1-3"><i class="fa fa-check"></i>Exercise 1</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="6" data-path="statistical-models.html"><a href="statistical-models.html"><i class="fa fa-check"></i><b>6</b> Statistical models</a><ul>
<li class="chapter" data-level="6.1" data-path="statistical-models.html"><a href="statistical-models.html#terminology"><i class="fa fa-check"></i><b>6.1</b> Terminology</a></li>
<li class="chapter" data-level="6.2" data-path="statistical-models.html"><a href="statistical-models.html#fitting-a-model-to-data"><i class="fa fa-check"></i><b>6.2</b> Fitting a model to data</a></li>
<li class="chapter" data-level="6.3" data-path="statistical-models.html"><a href="statistical-models.html#diagnostics"><i class="fa fa-check"></i><b>6.3</b> Diagnostics</a></li>
<li class="chapter" data-level="6.4" data-path="statistical-models.html"><a href="statistical-models.html#interpreting-models"><i class="fa fa-check"></i><b>6.4</b> Interpreting models</a></li>
<li class="chapter" data-level="6.5" data-path="statistical-models.html"><a href="statistical-models.html#comparing-models"><i class="fa fa-check"></i><b>6.5</b> Comparing models</a></li>
<li class="chapter" data-level="6.6" data-path="statistical-models.html"><a href="statistical-models.html#using-a-model-for-prediction"><i class="fa fa-check"></i><b>6.6</b> Using a model for prediction</a></li>
<li class="chapter" data-level="6.7" data-path="statistical-models.html"><a href="statistical-models.html#beyond-linear-regression"><i class="fa fa-check"></i><b>6.7</b> Beyond linear regression</a></li>
<li class="chapter" data-level="6.8" data-path="statistical-models.html"><a href="statistical-models.html#hyper-parameters"><i class="fa fa-check"></i><b>6.8</b> Hyper-parameters</a><ul>
<li class="chapter" data-level="6.8.1" data-path="statistical-models.html"><a href="statistical-models.html#ridge-regression"><i class="fa fa-check"></i><b>6.8.1</b> Ridge regression</a></li>
</ul></li>
<li class="chapter" data-level="6.9" data-path="statistical-models.html"><a href="statistical-models.html#training-validating-and-testing-models"><i class="fa fa-check"></i><b>6.9</b> Training, validating, and testing models</a><ul>
<li class="chapter" data-level="6.9.1" data-path="statistical-models.html"><a href="statistical-models.html#set-up"><i class="fa fa-check"></i><b>6.9.1</b> Set up</a></li>
<li class="chapter" data-level="6.9.2" data-path="statistical-models.html"><a href="statistical-models.html#bayesian-hyperparameter-optimization"><i class="fa fa-check"></i><b>6.9.2</b> Bayesian hyperparameter optimization</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="7" data-path="defining-your-own-functions.html"><a href="defining-your-own-functions.html"><i class="fa fa-check"></i><b>7</b> Defining your own functions</a><ul>
<li class="chapter" data-level="7.1" data-path="defining-your-own-functions.html"><a href="defining-your-own-functions.html#control-flow"><i class="fa fa-check"></i><b>7.1</b> Control flow</a><ul>
<li class="chapter" data-level="7.1.1" data-path="defining-your-own-functions.html"><a href="defining-your-own-functions.html#if-else"><i class="fa fa-check"></i><b>7.1.1</b> If-else</a></li>
<li class="chapter" data-level="7.1.2" data-path="defining-your-own-functions.html"><a href="defining-your-own-functions.html#for-loops"><i class="fa fa-check"></i><b>7.1.2</b> For loops</a></li>
<li class="chapter" data-level="7.1.3" data-path="defining-your-own-functions.html"><a href="defining-your-own-functions.html#while-loops"><i class="fa fa-check"></i><b>7.1.3</b> While loops</a></li>
</ul></li>
<li class="chapter" data-level="7.2" data-path="defining-your-own-functions.html"><a href="defining-your-own-functions.html#writing-your-own-functions"><i class="fa fa-check"></i><b>7.2</b> Writing your own functions</a><ul>
<li class="chapter" data-level="7.2.1" data-path="defining-your-own-functions.html"><a href="defining-your-own-functions.html#declaring-functions-in-r"><i class="fa fa-check"></i><b>7.2.1</b> Declaring functions in R</a></li>
<li class="chapter" data-level="7.2.2" data-path="defining-your-own-functions.html"><a href="defining-your-own-functions.html#fibonacci-numbers"><i class="fa fa-check"></i><b>7.2.2</b> Fibonacci numbers</a></li>
</ul></li>
<li class="chapter" data-level="7.3" data-path="defining-your-own-functions.html"><a href="defining-your-own-functions.html#exercises-4"><i class="fa fa-check"></i><b>7.3</b> Exercises</a><ul>
<li class="chapter" data-level="" data-path="defining-your-own-functions.html"><a href="defining-your-own-functions.html#exercise-1-4"><i class="fa fa-check"></i>Exercise 1</a></li>
<li class="chapter" data-level="" data-path="defining-your-own-functions.html"><a href="defining-your-own-functions.html#exercise-2-2"><i class="fa fa-check"></i>Exercise 2</a></li>
<li class="chapter" data-level="" data-path="defining-your-own-functions.html"><a href="defining-your-own-functions.html#exercise-3-2"><i class="fa fa-check"></i>Exercise 3</a></li>
</ul></li>
<li class="chapter" data-level="7.4" data-path="defining-your-own-functions.html"><a href="defining-your-own-functions.html#functions-that-take-functions-as-arguments-writing-your-own-higher-order-functions"><i class="fa fa-check"></i><b>7.4</b> Functions that take functions as arguments: writing your own higher-order functions</a></li>
<li class="chapter" data-level="7.5" data-path="defining-your-own-functions.html"><a href="defining-your-own-functions.html#functions-that-take-columns-of-data-as-arguments"><i class="fa fa-check"></i><b>7.5</b> Functions that take columns of data as arguments</a></li>
<li class="chapter" data-level="7.6" data-path="defining-your-own-functions.html"><a href="defining-your-own-functions.html#functions-that-use-loops"><i class="fa fa-check"></i><b>7.6</b> Functions that use loops</a></li>
<li class="chapter" data-level="7.7" data-path="defining-your-own-functions.html"><a href="defining-your-own-functions.html#anonymous-functions"><i class="fa fa-check"></i><b>7.7</b> Anonymous functions</a></li>
<li class="chapter" data-level="7.8" data-path="defining-your-own-functions.html"><a href="defining-your-own-functions.html#exercises-5"><i class="fa fa-check"></i><b>7.8</b> Exercises</a><ul>
<li class="chapter" data-level="" data-path="defining-your-own-functions.html"><a href="defining-your-own-functions.html#exercise-1-5"><i class="fa fa-check"></i>Exercise 1</a></li>
<li class="chapter" data-level="" data-path="defining-your-own-functions.html"><a href="defining-your-own-functions.html#exercise-2-3"><i class="fa fa-check"></i>Exercise 2</a></li>
<li class="chapter" data-level="" data-path="defining-your-own-functions.html"><a href="defining-your-own-functions.html#exercise-3-3"><i class="fa fa-check"></i>Exercise 3</a></li>
<li class="chapter" data-level="" data-path="defining-your-own-functions.html"><a href="defining-your-own-functions.html#exercise-4-1"><i class="fa fa-check"></i>Exercise 4</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="8" data-path="functional-programming.html"><a href="functional-programming.html"><i class="fa fa-check"></i><b>8</b> Functional programming</a><ul>
<li class="chapter" data-level="8.1" data-path="functional-programming.html"><a href="functional-programming.html#functions-definition"><i class="fa fa-check"></i><b>8.1</b> Functions definition</a></li>
<li class="chapter" data-level="8.2" data-path="functional-programming.html"><a href="functional-programming.html#properties-of-functions"><i class="fa fa-check"></i><b>8.2</b> Properties of functions</a></li>
<li class="chapter" data-level="8.3" data-path="functional-programming.html"><a href="functional-programming.html#functional-programming-with-purrr"><i class="fa fa-check"></i><b>8.3</b> Functional programming with <code>{purrr}</code></a><ul>
<li class="chapter" data-level="8.3.1" data-path="functional-programming.html"><a href="functional-programming.html#doing-away-with-loops-the-map-family-of-functions"><i class="fa fa-check"></i><b>8.3.1</b> Doing away with loops: the <code>map*()</code> family of functions</a></li>
<li class="chapter" data-level="8.3.2" data-path="functional-programming.html"><a href="functional-programming.html#reducing-with-purrr"><i class="fa fa-check"></i><b>8.3.2</b> Reducing with <code>purrr</code></a></li>
<li class="chapter" data-level="8.3.3" data-path="functional-programming.html"><a href="functional-programming.html#error-handling-with-safely-and-possibly"><i class="fa fa-check"></i><b>8.3.3</b> Error handling with <code>safely()</code> and <code>possibly()</code></a></li>
<li class="chapter" data-level="8.3.4" data-path="functional-programming.html"><a href="functional-programming.html#partial-applications-with-partial"><i class="fa fa-check"></i><b>8.3.4</b> Partial applications with <code>partial()</code></a></li>
<li class="chapter" data-level="8.3.5" data-path="functional-programming.html"><a href="functional-programming.html#function-composition-using-compose"><i class="fa fa-check"></i><b>8.3.5</b> Function composition using <code>compose</code></a></li>
<li class="chapter" data-level="8.3.6" data-path="functional-programming.html"><a href="functional-programming.html#is_-and-as_-functions"><i class="fa fa-check"></i><b>8.3.6</b> <code>is_*()</code> and <code>as_*()</code> functions</a></li>
<li class="chapter" data-level="8.3.7" data-path="functional-programming.html"><a href="functional-programming.html#transposing-lists"><i class="fa fa-check"></i><b>8.3.7</b> ¬´Transposing lists¬ª</a></li>
</ul></li>
<li class="chapter" data-level="8.4" data-path="functional-programming.html"><a href="functional-programming.html#using-your-functions-inside-mutate"><i class="fa fa-check"></i><b>8.4</b> Using your functions inside <code>mutate()</code></a></li>
<li class="chapter" data-level="8.5" data-path="functional-programming.html"><a href="functional-programming.html#working-with-a-list-of-datasets"><i class="fa fa-check"></i><b>8.5</b> Working with a list of datasets</a><ul>
<li class="chapter" data-level="8.5.1" data-path="functional-programming.html"><a href="functional-programming.html#using-map-to-work-on-lists-of-datasets"><i class="fa fa-check"></i><b>8.5.1</b> Using <code>map()</code> to work on lists of datasets</a></li>
</ul></li>
<li class="chapter" data-level="8.6" data-path="functional-programming.html"><a href="functional-programming.html#mapping-your-homebrewed-functions-to-lists-of-datasets"><i class="fa fa-check"></i><b>8.6</b> Mapping your homebrewed functions to lists of datasets</a><ul>
<li class="chapter" data-level="8.6.1" data-path="functional-programming.html"><a href="functional-programming.html#data-frames-and-reduce"><i class="fa fa-check"></i><b>8.6.1</b> Data frames and <code>reduce</code></a></li>
</ul></li>
<li class="chapter" data-level="8.7" data-path="functional-programming.html"><a href="functional-programming.html#functional-programming-and-plotting"><i class="fa fa-check"></i><b>8.7</b> Functional programming and plotting</a></li>
<li class="chapter" data-level="8.8" data-path="functional-programming.html"><a href="functional-programming.html#exercises-6"><i class="fa fa-check"></i><b>8.8</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="9" data-path="package-development.html"><a href="package-development.html"><i class="fa fa-check"></i><b>9</b> Package development</a><ul>
<li class="chapter" data-level="9.1" data-path="package-development.html"><a href="package-development.html#why-you-need-to-write-your-own-package"><i class="fa fa-check"></i><b>9.1</b> Why you need to write your own package</a></li>
<li class="chapter" data-level="9.2" data-path="package-development.html"><a href="package-development.html#unit-testing-your-package"><i class="fa fa-check"></i><b>9.2</b> Unit testing your package</a></li>
</ul></li>
<li class="chapter" data-level="10" data-path="further-topics.html"><a href="further-topics.html"><i class="fa fa-check"></i><b>10</b> Further topics</a><ul>
<li class="chapter" data-level="10.1" data-path="further-topics.html"><a href="further-topics.html#using-python-from-r-with-reticulate"><i class="fa fa-check"></i><b>10.1</b> Using Python from R with <code>{reticulate}</code></a></li>
<li class="chapter" data-level="10.2" data-path="further-topics.html"><a href="further-topics.html#generating-pdf-or-word-reports-with-r"><i class="fa fa-check"></i><b>10.2</b> Generating Pdf or Word reports with R</a></li>
<li class="chapter" data-level="10.3" data-path="further-topics.html"><a href="further-topics.html#scraping-the-internet"><i class="fa fa-check"></i><b>10.3</b> Scraping the internet</a></li>
<li class="chapter" data-level="10.4" data-path="further-topics.html"><a href="further-topics.html#regular-expressions"><i class="fa fa-check"></i><b>10.4</b> Regular expressions</a></li>
<li class="chapter" data-level="10.5" data-path="further-topics.html"><a href="further-topics.html#setting-up-a-blog-with-blogdown"><i class="fa fa-check"></i><b>10.5</b> Setting up a blog with <code>{blogdown}</code></a></li>
</ul></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>References</a></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Modern R with the tidyverse</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="descriptive-statistics-and-data-manipulation" class="section level1">
<h1><span class="header-section-number">Chapter 4</span> Descriptive statistics and data manipulation</h1>
<p>Now that we are familiar with some R objects and know how to import data, it is time to write some
code. In this chapter, we are going to compute descriptive statistics for a single dataset, but
also for a list of datasets. However, I will not give a list of functions to compute descriptive
statistics; if you need a specific function you can find easily in the <em>Help</em> pane in Rstudio or
using any modern internet search engine. What I will do is show you a workflow that allows you to
compute the descripitive statisics you need fast.
R has a lot of built-in functions for descriptive statistics; however, if you want to compute
statistics by, say, gender, some more complex manipulations are needed. At least this was true in
the past. Nowadays, thanks to the packages from the <code>tidyverse</code>, it is very easy and fast to
compute descriptive statistics by any stratifying variable(s). The package we are going to use for
this is called <code>dplyr</code>. <code>dplyr</code> contains a lot of functions that make manipulating
data and computing descriptive statistics very easy. To make things easier for now, we are going to
use example data included with <code>dplyr</code>. So no need to import an external dataset; this does not
change anything to the example that we are going to study here; the source of the data does not
matter for this. Using <code>dplyr</code> is possible only if the data you are working with is already in
a useful shape. When data is more messy, you will need to first manipulate it to bring it a <em>tidy</em>
format. For this, we will use <code>tidyr</code>, which is very useful package to reshape data and to do
advanced cleaning of your data.
All these tidyverse functions are also called <em>verbs</em>. However, before getting to know these verbs,
let‚Äôs do an analysis using standard, or <em>base</em> R functions. This will be the benchmark against
which we are going to measure a <code>{tidyverse}</code> workflow.</p>
<div id="a-data-exploration-exercice-using-base-r" class="section level2">
<h2><span class="header-section-number">4.1</span> A data exploration exercice using <em>base</em> R</h2>
<p>Let‚Äôs first load the <code>starwars</code> data set, included in the <code>{dplyr}</code> package:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(dplyr)
<span class="kw">data</span>(starwars)</code></pre>
<p>Let‚Äôs first take a look at the data:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">head</span>(starwars)</code></pre>
<pre><code>## # A tibble: 6 x 13
##   name  height  mass hair_color skin_color eye_color birth_year gender
##   &lt;chr&gt;  &lt;int&gt; &lt;dbl&gt; &lt;chr&gt;      &lt;chr&gt;      &lt;chr&gt;          &lt;dbl&gt; &lt;chr&gt; 
## 1 Luke‚Ä¶    172    77 blond      fair       blue            19   male  
## 2 C-3PO    167    75 &lt;NA&gt;       gold       yellow         112   &lt;NA&gt;  
## 3 R2-D2     96    32 &lt;NA&gt;       white, bl‚Ä¶ red             33   &lt;NA&gt;  
## 4 Dart‚Ä¶    202   136 none       white      yellow          41.9 male  
## 5 Leia‚Ä¶    150    49 brown      light      brown           19   female
## 6 Owen‚Ä¶    178   120 brown, gr‚Ä¶ light      blue            52   male  
## # ‚Ä¶ with 5 more variables: homeworld &lt;chr&gt;, species &lt;chr&gt;, films &lt;list&gt;,
## #   vehicles &lt;list&gt;, starships &lt;list&gt;</code></pre>
<p>This data contains information on Star Wars characters. The first question you have to answer is
to find the average height of the characters:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">mean</span>(starwars<span class="op">$</span>height)</code></pre>
<pre><code>## [1] NA</code></pre>
<p>Let‚Äôs also take a look at the standard deviation:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">sd</span>(starwars<span class="op">$</span>height)</code></pre>
<pre><code>## [1] NA</code></pre>
<p>It might be more informative to compute these two statistics by species, so for this, we are going
to use <code>aggregate()</code>:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">aggregate</span>(starwars<span class="op">$</span>height,
          <span class="dt">by =</span> <span class="kw">list</span>(<span class="dt">Species =</span> starwars<span class="op">$</span>species),
          mean)</code></pre>
<pre><code>##           Species        x
## 1          Aleena  79.0000
## 2        Besalisk 198.0000
## 3          Cerean 198.0000
## 4        Chagrian 196.0000
## 5        Clawdite 168.0000
## 6           Droid       NA
## 7             Dug 112.0000
## 8            Ewok  88.0000
## 9       Geonosian 183.0000
## 10         Gungan 208.6667
## 11          Human       NA
## 12           Hutt 175.0000
## 13       Iktotchi 188.0000
## 14        Kaleesh 216.0000
## 15       Kaminoan 221.0000
## 16        Kel Dor 188.0000
## 17       Mirialan 168.0000
## 18   Mon Calamari 180.0000
## 19           Muun 191.0000
## 20       Nautolan 196.0000
## 21      Neimodian 191.0000
## 22         Pau&#39;an 206.0000
## 23       Quermian 264.0000
## 24         Rodian 173.0000
## 25        Skakoan 193.0000
## 26      Sullustan 160.0000
## 27     Tholothian 184.0000
## 28        Togruta 178.0000
## 29          Toong 163.0000
## 30      Toydarian 137.0000
## 31     Trandoshan 190.0000
## 32        Twi&#39;lek 179.0000
## 33     Vulptereen  94.0000
## 34        Wookiee 231.0000
## 35          Xexto 122.0000
## 36 Yoda&#39;s species  66.0000
## 37         Zabrak 173.0000</code></pre>
<p>Even if you are not familiar with <code>aggregate()</code>, I believe the above lines are quite self-explanatory.
You need to provide <code>aggregate()</code> with 3 things; the variable you want to summarize (or only the
data frame, if you want to summarize all variables), a list of grouping variables and then the
function that will be applied to each subset. You can easily add another grouping variable:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">aggregate</span>(starwars<span class="op">$</span>height,
          <span class="dt">by =</span> <span class="kw">list</span>(<span class="dt">Species =</span> starwars<span class="op">$</span>species,
                    <span class="dt">Homeworld =</span> starwars<span class="op">$</span>homeworld),
          mean)</code></pre>
<pre><code>##         Species      Homeworld        x
## 1         Human       Alderaan 176.3333
## 2        Aleena    Aleen Minor  79.0000
## 3         Human         Bespin 175.0000
## 4         Human     Bestine IV 180.0000
## 5     Neimodian Cato Neimoidia 191.0000
## 6        Cerean          Cerea 198.0000
## 7      Chagrian       Champala 196.0000
## 8         Human      Chandrila 150.0000
## 9         Human   Concord Dawn 183.0000
## 10        Human       Corellia 175.0000
## 11        Human      Coruscant 168.5000
## 12   Tholothian      Coruscant 184.0000
## 13       Zabrak       Dathomir 175.0000
## 14      Kel Dor          Dorin 188.0000
## 15         Ewok          Endor  88.0000
## 16        Human         Eriadu 180.0000
## 17    Geonosian       Geonosis 183.0000
## 18     Nautolan    Glee Anselm 196.0000
## 19        Human     Haruun Kal 188.0000
## 20     Iktotchi        Iktotch 188.0000
## 21       Zabrak       Iridonia 171.0000
## 22      Kaleesh          Kalee 216.0000
## 23        Human         Kamino 183.0000
## 24     Kaminoan         Kamino 221.0000
## 25      Wookiee       Kashyyyk 231.0000
## 26          Dug      Malastare 112.0000
## 27     Mirialan         Mirial 168.0000
## 28 Mon Calamari       Mon Cala 180.0000
## 29         Muun     Muunilinst 191.0000
## 30        Droid          Naboo  96.0000
## 31       Gungan          Naboo 208.6667
## 32        Human          Naboo 168.4000
## 33         Hutt      Nal Hutta 175.0000
## 34     Besalisk           Ojom 198.0000
## 35     Quermian        Quermia 264.0000
## 36       Rodian          Rodia 173.0000
## 37      Twi&#39;lek         Ryloth 179.0000
## 38        Human        Serenno 193.0000
## 39      Togruta          Shili 178.0000
## 40      Skakoan          Skako 193.0000
## 41        Human        Socorro 177.0000
## 42        Human        Stewjon 182.0000
## 43    Sullustan        Sullust 160.0000
## 44        Droid       Tatooine 132.0000
## 45        Human       Tatooine 179.2500
## 46    Toydarian       Toydaria 137.0000
## 47   Trandoshan      Trandosha 190.0000
## 48        Xexto        Troiken 122.0000
## 49        Toong           Tund 163.0000
## 50       Pau&#39;an         Utapau 206.0000
## 51   Vulptereen        Vulpter  94.0000
## 52     Clawdite          Zolan 168.0000</code></pre>
<p>or use another function:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">aggregate</span>(starwars<span class="op">$</span>height,
          <span class="dt">by =</span> <span class="kw">list</span>(<span class="dt">Species =</span> starwars<span class="op">$</span>species),
          sd)</code></pre>
<pre><code>##           Species         x
## 1          Aleena        NA
## 2        Besalisk        NA
## 3          Cerean        NA
## 4        Chagrian        NA
## 5        Clawdite        NA
## 6           Droid        NA
## 7             Dug        NA
## 8            Ewok        NA
## 9       Geonosian        NA
## 10         Gungan 14.189198
## 11          Human        NA
## 12           Hutt        NA
## 13       Iktotchi        NA
## 14        Kaleesh        NA
## 15       Kaminoan 11.313708
## 16        Kel Dor        NA
## 17       Mirialan  2.828427
## 18   Mon Calamari        NA
## 19           Muun        NA
## 20       Nautolan        NA
## 21      Neimodian        NA
## 22         Pau&#39;an        NA
## 23       Quermian        NA
## 24         Rodian        NA
## 25        Skakoan        NA
## 26      Sullustan        NA
## 27     Tholothian        NA
## 28        Togruta        NA
## 29          Toong        NA
## 30      Toydarian        NA
## 31     Trandoshan        NA
## 32        Twi&#39;lek  1.414214
## 33     Vulptereen        NA
## 34        Wookiee  4.242641
## 35          Xexto        NA
## 36 Yoda&#39;s species        NA
## 37         Zabrak  2.828427</code></pre>
<p><code>aggregate()</code> returns a <code>data.frame</code> object:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">class</span>(<span class="kw">aggregate</span>(starwars<span class="op">$</span>height, <span class="dt">by =</span> <span class="kw">list</span>(<span class="dt">Species =</span> starwars<span class="op">$</span>species), mean))</code></pre>
<pre><code>## [1] &quot;data.frame&quot;</code></pre>
<p><code>tapply()</code> is another <em>base</em> R alternative:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">tapply</span>(starwars<span class="op">$</span>height, <span class="kw">list</span>(starwars<span class="op">$</span>species), mean)</code></pre>
<pre><code>##         Aleena       Besalisk         Cerean       Chagrian       Clawdite 
##        79.0000       198.0000       198.0000       196.0000       168.0000 
##          Droid            Dug           Ewok      Geonosian         Gungan 
##             NA       112.0000        88.0000       183.0000       208.6667 
##          Human           Hutt       Iktotchi        Kaleesh       Kaminoan 
##             NA       175.0000       188.0000       216.0000       221.0000 
##        Kel Dor       Mirialan   Mon Calamari           Muun       Nautolan 
##       188.0000       168.0000       180.0000       191.0000       196.0000 
##      Neimodian         Pau&#39;an       Quermian         Rodian        Skakoan 
##       191.0000       206.0000       264.0000       173.0000       193.0000 
##      Sullustan     Tholothian        Togruta          Toong      Toydarian 
##       160.0000       184.0000       178.0000       163.0000       137.0000 
##     Trandoshan        Twi&#39;lek     Vulptereen        Wookiee          Xexto 
##       190.0000       179.0000        94.0000       231.0000       122.0000 
## Yoda&#39;s species         Zabrak 
##        66.0000       173.0000</code></pre>
<p>which returns an <code>array</code> object, which is similar to a vector.</p>
<p>However, <code>tapply()</code> does not work if you want the mean by species for all the variables in the
data frame:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">tapply</span>(starwars, <span class="kw">list</span>(starwars<span class="op">$</span>species), mean)</code></pre>
<pre><code>Error in tapply(starwars, list(starwars$species), mean) :
  arguments must have same length</code></pre>
<p>In both cases, you can only specify one function. So if you need the average and the standard
deviation you have to do it in two steps.</p>
<p>Let‚Äôs continue now, by only computing the average height by species, but for males:</p>
<pre class="sourceCode r"><code class="sourceCode r">starwars_males &lt;-<span class="st"> </span><span class="kw">subset</span>(starwars, gender <span class="op">==</span><span class="st"> &quot;male&quot;</span>)

<span class="kw">aggregate</span>(starwars_males<span class="op">$</span>height,
          <span class="dt">by =</span> <span class="kw">list</span>(<span class="dt">Species =</span> starwars_males<span class="op">$</span>species),
          mean)</code></pre>
<pre><code>##           Species        x
## 1          Aleena  79.0000
## 2        Besalisk 198.0000
## 3          Cerean 198.0000
## 4        Chagrian 196.0000
## 5             Dug 112.0000
## 6            Ewok  88.0000
## 7       Geonosian 183.0000
## 8          Gungan 208.6667
## 9           Human       NA
## 10       Iktotchi 188.0000
## 11        Kaleesh 216.0000
## 12       Kaminoan 229.0000
## 13        Kel Dor 188.0000
## 14   Mon Calamari 180.0000
## 15           Muun 191.0000
## 16       Nautolan 196.0000
## 17      Neimodian 191.0000
## 18         Pau&#39;an 206.0000
## 19       Quermian 264.0000
## 20         Rodian 173.0000
## 21        Skakoan 193.0000
## 22      Sullustan 160.0000
## 23          Toong 163.0000
## 24      Toydarian 137.0000
## 25     Trandoshan 190.0000
## 26        Twi&#39;lek 180.0000
## 27     Vulptereen  94.0000
## 28        Wookiee 231.0000
## 29          Xexto 122.0000
## 30 Yoda&#39;s species  66.0000
## 31         Zabrak 173.0000</code></pre>
<p>I first use <code>subset()</code> to create a subset of the data in which I only kept males. Then, I rerun
the analysis from before again. <code>subset()</code> can also be used to select columns. So if you want
the average of the height and mass for males, you could do something like this:</p>
<pre class="sourceCode r"><code class="sourceCode r">starwars_males_height_mass &lt;-<span class="st"> </span><span class="kw">subset</span>(starwars, gender <span class="op">==</span><span class="st"> &quot;male&quot;</span>, <span class="dt">select =</span> <span class="kw">c</span>(height, mass, species))

<span class="kw">aggregate</span>(starwars_males_height_mass,
          <span class="dt">by =</span> <span class="kw">list</span>(<span class="dt">Species =</span> starwars_males_height_mass<span class="op">$</span>species),
          mean)</code></pre>
<pre><code>## Warning in mean.default(X[[i]], ...): argument is not numeric or logical:
## returning NA

## Warning in mean.default(X[[i]], ...): argument is not numeric or logical:
## returning NA

## Warning in mean.default(X[[i]], ...): argument is not numeric or logical:
## returning NA

## Warning in mean.default(X[[i]], ...): argument is not numeric or logical:
## returning NA

## Warning in mean.default(X[[i]], ...): argument is not numeric or logical:
## returning NA

## Warning in mean.default(X[[i]], ...): argument is not numeric or logical:
## returning NA

## Warning in mean.default(X[[i]], ...): argument is not numeric or logical:
## returning NA

## Warning in mean.default(X[[i]], ...): argument is not numeric or logical:
## returning NA

## Warning in mean.default(X[[i]], ...): argument is not numeric or logical:
## returning NA

## Warning in mean.default(X[[i]], ...): argument is not numeric or logical:
## returning NA

## Warning in mean.default(X[[i]], ...): argument is not numeric or logical:
## returning NA

## Warning in mean.default(X[[i]], ...): argument is not numeric or logical:
## returning NA

## Warning in mean.default(X[[i]], ...): argument is not numeric or logical:
## returning NA

## Warning in mean.default(X[[i]], ...): argument is not numeric or logical:
## returning NA

## Warning in mean.default(X[[i]], ...): argument is not numeric or logical:
## returning NA

## Warning in mean.default(X[[i]], ...): argument is not numeric or logical:
## returning NA

## Warning in mean.default(X[[i]], ...): argument is not numeric or logical:
## returning NA

## Warning in mean.default(X[[i]], ...): argument is not numeric or logical:
## returning NA

## Warning in mean.default(X[[i]], ...): argument is not numeric or logical:
## returning NA

## Warning in mean.default(X[[i]], ...): argument is not numeric or logical:
## returning NA

## Warning in mean.default(X[[i]], ...): argument is not numeric or logical:
## returning NA

## Warning in mean.default(X[[i]], ...): argument is not numeric or logical:
## returning NA

## Warning in mean.default(X[[i]], ...): argument is not numeric or logical:
## returning NA

## Warning in mean.default(X[[i]], ...): argument is not numeric or logical:
## returning NA

## Warning in mean.default(X[[i]], ...): argument is not numeric or logical:
## returning NA

## Warning in mean.default(X[[i]], ...): argument is not numeric or logical:
## returning NA

## Warning in mean.default(X[[i]], ...): argument is not numeric or logical:
## returning NA

## Warning in mean.default(X[[i]], ...): argument is not numeric or logical:
## returning NA

## Warning in mean.default(X[[i]], ...): argument is not numeric or logical:
## returning NA

## Warning in mean.default(X[[i]], ...): argument is not numeric or logical:
## returning NA

## Warning in mean.default(X[[i]], ...): argument is not numeric or logical:
## returning NA</code></pre>
<pre><code>##           Species   height mass species
## 1          Aleena  79.0000   15      NA
## 2        Besalisk 198.0000  102      NA
## 3          Cerean 198.0000   82      NA
## 4        Chagrian 196.0000   NA      NA
## 5             Dug 112.0000   40      NA
## 6            Ewok  88.0000   20      NA
## 7       Geonosian 183.0000   80      NA
## 8          Gungan 208.6667   NA      NA
## 9           Human       NA   NA      NA
## 10       Iktotchi 188.0000   NA      NA
## 11        Kaleesh 216.0000  159      NA
## 12       Kaminoan 229.0000   88      NA
## 13        Kel Dor 188.0000   80      NA
## 14   Mon Calamari 180.0000   83      NA
## 15           Muun 191.0000   NA      NA
## 16       Nautolan 196.0000   87      NA
## 17      Neimodian 191.0000   90      NA
## 18         Pau&#39;an 206.0000   80      NA
## 19       Quermian 264.0000   NA      NA
## 20         Rodian 173.0000   74      NA
## 21        Skakoan 193.0000   48      NA
## 22      Sullustan 160.0000   68      NA
## 23          Toong 163.0000   65      NA
## 24      Toydarian 137.0000   NA      NA
## 25     Trandoshan 190.0000  113      NA
## 26        Twi&#39;lek 180.0000   NA      NA
## 27     Vulptereen  94.0000   45      NA
## 28        Wookiee 231.0000  124      NA
## 29          Xexto 122.0000   NA      NA
## 30 Yoda&#39;s species  66.0000   17      NA
## 31         Zabrak 173.0000   NA      NA</code></pre>
<p>This is starting to get a bit verbose, but it is quite easy to follow and very powerful. It certainly
beats having to write loops to achieve the same thing.</p>
<p>Let‚Äôs now consider this new dataset:</p>
<pre class="sourceCode r"><code class="sourceCode r">survey_data_base</code></pre>
<pre><code>##   id var1 var2 var3
## 1  1  1.0  0.2  0.3
## 2  2  1.4  1.9  4.1
## 3  3  0.1  2.8  8.9
## 4  4  1.7  1.9  7.6</code></pre>
<p>I will explain later where this comes from. Depending on what you want to do with this data, it is
not in the right shape. So let‚Äôs reshape it, using the aptly-called <code>reshape()</code> command:</p>
<pre class="sourceCode r"><code class="sourceCode r">survey_data_long &lt;-<span class="st"> </span><span class="kw">reshape</span>(survey_data_base,
        <span class="dt">varying =</span> <span class="kw">list</span>(<span class="dv">2</span><span class="op">:</span><span class="dv">4</span>), <span class="dt">v.names =</span> <span class="st">&quot;variable&quot;</span>, <span class="dt">direction =</span> <span class="st">&quot;long&quot;</span>)</code></pre>
<p>We can now easily compute the average of <code>variable</code> for each <code>id</code>:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">aggregate</span>(survey_data_long<span class="op">$</span>variable,
          <span class="dt">by =</span> <span class="kw">list</span>(<span class="dt">Id =</span> survey_data_long<span class="op">$</span>id),
          mean)</code></pre>
<pre><code>##   Id        x
## 1  1 0.500000
## 2  2 2.466667
## 3  3 3.933333
## 4  4 3.733333</code></pre>
<p>There is also the possiblity to merge two datasets with <code>merge()</code>. I won‚Äôt go into that however.
As you can see, R comes with very powerful functions right out of the box, ready to use. When I was
studying, unfortunately, my professors had been brought up on FORTRAN loops, so we had to do to all
this using loops (not reshaping, thankfully), which was not so easy.
Now that we have seen how <em>base</em> R works, let‚Äôs redo the analysis using <code>{tidyverse}</code> verbs.
But before deep diving into the <code>{tidyverse}</code>, let‚Äôs take a moment to discuss about our lord and
saviour, <code>%&gt;%</code>.</p>
</div>
<div id="smoking-is-bad-for-you-but-pipes-are-your-friend" class="section level2">
<h2><span class="header-section-number">4.2</span> Smoking is bad for you, but pipes are your friend</h2>
<p>The title of this section might sound weird at first, but by the end of it, you‚Äôll get this
(terrible) pun.</p>
<p>You probably know the following painting by Ren√© Magritte, <em>La trahison des images</em>:</p>
<p><img src="assets/pas_une_pipe.png" width="350" /></p>
<p>It turns out there‚Äôs an R package from the <code>tidyverse</code> that is called <code>magrittr</code>. What does this
package do? It brings <em>pipes</em> to R. Pipes are a concept from the Unix operating system; if you‚Äôre
using a GNU+Linux distribution or macOS, you‚Äôre basically using a <em>modern</em> unix (that‚Äôs an
oversimplification, but I‚Äôm an economist by training, and outrageously oversimplifying things is
what we do, deal with it).</p>
<p>The idea of pipes is to take the output of a command, and <em>feed</em> it as the input of another
command. The <code>magrittr</code> package brings pipes to R, by using the weird looking <code>%&gt;%</code>. Try the
following:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(magrittr)</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="dv">16</span> <span class="op">%&gt;%</span><span class="st"> </span>sqrt</code></pre>
<pre><code>## [1] 4</code></pre>
<p>This looks quite weird, but you probably understand what happened; <code>16</code> got <em>fed</em> as the first
argument of the function <code>sqrt()</code>. You can chain multiple functions:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="dv">16</span> <span class="op">%&gt;%</span><span class="st"> </span>sqrt <span class="op">%&gt;%</span><span class="st"> `</span><span class="dt">+</span><span class="st">`</span>(<span class="dv">18</span>)</code></pre>
<pre><code>## [1] 22</code></pre>
<p>The output of <code>16</code> (<code>16</code>) got fed to <code>sqrt()</code>, and the output of <code>sqrt(16)</code> (4) got fed to <code>+(18)</code>
(22). Without <code>%&gt;%</code> you‚Äôd write the line just above like this:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">sqrt</span>(<span class="dv">16</span>) <span class="op">+</span><span class="st"> </span><span class="dv">18</span></code></pre>
<pre><code>## [1] 22</code></pre>
<p>It might not be very clear right now why this is useful, but the <code>%&gt;%</code> is probably one of the
most useful infix operators, because when using packages from the <code>tidyverse</code>, you will
naturally want to chain a lot of functions together. Without the <code>%&gt;%</code> it would become messy very fast.</p>
<p><code>%&gt;%</code> is not the only pipe operator in <code>magrittr</code>. There‚Äôs <code>%T%</code>, <code>%&lt;&gt;%</code> and <code>%$%</code>. All have their
uses, but are basically shortcuts to some common tasks with <code>%&gt;%</code> plus another function. Which
means that you can live without them, and because of this, I will not discuss them.</p>
</div>
<div id="the-tidyverses-enfant-prodige-dplyr" class="section level2">
<h2><span class="header-section-number">4.3</span> The <code>{tidyverse}</code>‚Äôs <em>enfant prodige</em>: <code>{dplyr}</code></h2>
<p>The best way to get started with the tidyverse packages is to get to know <code>{dplyr}</code>. <code>{dplyr}</code> provides
a lot of very useful functions that makes it very easy to get discriptive statistics or add new columns
to your data.</p>
<div id="a-first-taste-of-data-manipulation-with-dplyr" class="section level3">
<h3><span class="header-section-number">4.3.1</span> A first taste of data manipulation with <code>{dplyr}</code></h3>
<p>This section will walk you through a typical analysis using <code>{dplyr}</code> funcitons. Just go with it; I
will give more details in the next sections.</p>
<p>First, let‚Äôs load <code>dplyr</code> and the included <code>starwars</code> dataset. Let‚Äôs also take a look at the first 5
lines of the dataset:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(dplyr)

<span class="kw">data</span>(starwars)

<span class="kw">head</span>(starwars)</code></pre>
<pre><code>## # A tibble: 6 x 13
##   name  height  mass hair_color skin_color eye_color birth_year gender
##   &lt;chr&gt;  &lt;int&gt; &lt;dbl&gt; &lt;chr&gt;      &lt;chr&gt;      &lt;chr&gt;          &lt;dbl&gt; &lt;chr&gt; 
## 1 Luke‚Ä¶    172    77 blond      fair       blue            19   male  
## 2 C-3PO    167    75 &lt;NA&gt;       gold       yellow         112   &lt;NA&gt;  
## 3 R2-D2     96    32 &lt;NA&gt;       white, bl‚Ä¶ red             33   &lt;NA&gt;  
## 4 Dart‚Ä¶    202   136 none       white      yellow          41.9 male  
## 5 Leia‚Ä¶    150    49 brown      light      brown           19   female
## 6 Owen‚Ä¶    178   120 brown, gr‚Ä¶ light      blue            52   male  
## # ‚Ä¶ with 5 more variables: homeworld &lt;chr&gt;, species &lt;chr&gt;, films &lt;list&gt;,
## #   vehicles &lt;list&gt;, starships &lt;list&gt;</code></pre>
<p><code>data(starwars)</code> loads the example dataset called <code>starwars</code> that is included in the package <code>dplyr</code>.
As I said earlier, this is just an example; you could have loaded an external dataset, from a
<code>.csv</code> file for instance. This does not matter for what comes next.</p>
<p>R includes a lot of functions for descriptive statistics, such as <code>mean()</code>, <code>sd()</code>, <code>cov()</code>, and many
more. What <code>dplyr</code> brings to the table (among other niceties) is the possibility to apply these
functions to the dataset easily. For example, imagine you want the average height of everyone in
the dataset. Using the basic R functions, you could write this:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">mean</span>(starwars<span class="op">$</span>height)</code></pre>
<pre><code>## [1] NA</code></pre>
<p><code>starwars$height</code> means that the user wants to access the column called <code>height</code> from the dataset
<code>starwars</code>. Remember that the <code>$</code> symbol is how you access elements of a named list. This is the
same for columns of datasets as you can see. This is then given as an argument to the function
<code>mean()</code>. But what if the user wants the average height by species? Before <code>dplyr</code>, a solution to
this simple problem would have required more than a single command. Now this is as easy as:</p>
<pre class="sourceCode r"><code class="sourceCode r">starwars <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">group_by</span>(species) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">summarise</span>(<span class="kw">mean</span>(height))</code></pre>
<pre><code>## # A tibble: 38 x 2
##    species   `mean(height)`
##    &lt;chr&gt;              &lt;dbl&gt;
##  1 &lt;NA&gt;                  NA
##  2 Aleena                79
##  3 Besalisk             198
##  4 Cerean               198
##  5 Chagrian             196
##  6 Clawdite             168
##  7 Droid                 NA
##  8 Dug                  112
##  9 Ewok                  88
## 10 Geonosian            183
## # ‚Ä¶ with 28 more rows</code></pre>
<p>The usefulness of the <code>%&gt;%</code> (pipe operator) becomes apparent now. Without it, one would write
instead:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">summarise</span>(<span class="kw">group_by</span>(starwars, species), <span class="kw">mean</span>(height))</code></pre>
<pre><code>## # A tibble: 38 x 2
##    species   `mean(height)`
##    &lt;chr&gt;              &lt;dbl&gt;
##  1 &lt;NA&gt;                  NA
##  2 Aleena                79
##  3 Besalisk             198
##  4 Cerean               198
##  5 Chagrian             196
##  6 Clawdite             168
##  7 Droid                 NA
##  8 Dug                  112
##  9 Ewok                  88
## 10 Geonosian            183
## # ‚Ä¶ with 28 more rows</code></pre>
<p>as you can clearly see, it is much more difficult to read. Imagine now that I want the average height
by species, but only for males. Again, this is very easy using <code>%&gt;%</code>:</p>
<pre class="sourceCode r"><code class="sourceCode r">starwars <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">filter</span>(gender <span class="op">==</span><span class="st"> &quot;male&quot;</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">group_by</span>(species) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">summarise</span>(<span class="kw">mean</span>(height))</code></pre>
<pre><code>## # A tibble: 32 x 2
##    species   `mean(height)`
##    &lt;chr&gt;              &lt;dbl&gt;
##  1 &lt;NA&gt;                183 
##  2 Aleena               79 
##  3 Besalisk            198 
##  4 Cerean              198 
##  5 Chagrian            196 
##  6 Dug                 112 
##  7 Ewok                 88 
##  8 Geonosian           183 
##  9 Gungan              209.
## 10 Human                NA 
## # ‚Ä¶ with 22 more rows</code></pre>
<p>Again, the <code>%&gt;%</code> makes the above lines of code very easy to read. Without it, one would need to write:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">summarise</span>(<span class="kw">group_by</span>(<span class="kw">filter</span>(starwars, gender <span class="op">==</span><span class="st"> &quot;male&quot;</span>), species), <span class="kw">mean</span>(height))</code></pre>
<pre><code>## # A tibble: 32 x 2
##    species   `mean(height)`
##    &lt;chr&gt;              &lt;dbl&gt;
##  1 &lt;NA&gt;                183 
##  2 Aleena               79 
##  3 Besalisk            198 
##  4 Cerean              198 
##  5 Chagrian            196 
##  6 Dug                 112 
##  7 Ewok                 88 
##  8 Geonosian           183 
##  9 Gungan              209.
## 10 Human                NA 
## # ‚Ä¶ with 22 more rows</code></pre>
<p>I think you agree with me that this is not very readable. One way to make it more readable would
be to save intermediary variables:</p>
<pre class="sourceCode r"><code class="sourceCode r">filtered_data &lt;-<span class="st"> </span><span class="kw">filter</span>(starwars, gender <span class="op">==</span><span class="st"> &quot;male&quot;</span>)

grouped_data &lt;-<span class="st"> </span><span class="kw">group_by</span>(<span class="kw">filter</span>(starwars, gender <span class="op">==</span><span class="st"> &quot;male&quot;</span>), species)

<span class="kw">summarise</span>(grouped_data, <span class="kw">mean</span>(height))</code></pre>
<pre><code>## # A tibble: 32 x 2
##    species   `mean(height)`
##    &lt;chr&gt;              &lt;dbl&gt;
##  1 &lt;NA&gt;                183 
##  2 Aleena               79 
##  3 Besalisk            198 
##  4 Cerean              198 
##  5 Chagrian            196 
##  6 Dug                 112 
##  7 Ewok                 88 
##  8 Geonosian           183 
##  9 Gungan              209.
## 10 Human                NA 
## # ‚Ä¶ with 22 more rows</code></pre>
<p>But this can get very tedious. Once you‚Äôre used to <code>%&gt;%</code>, you won‚Äôt go back to not use it.</p>
<p>Before continuing and to make things clearer; <code>filter()</code>, <code>group_by()</code> and <code>summarise()</code> are
functions that are included in <code>dplyr</code>. <code>%&gt;%</code> is actually a function from <code>magrittr</code>, but this
package gets loaded on the fly when you load <code>dplyr</code>, so you do not need to worry about it.
<code>mean()</code> is a function <em>native</em> to R.</p>
<p>The result of all these operations that use <code>dplyr</code> functions are actually other datasets, or
<code>tibbles</code>. This means that you can save them in variable, and then work with these as any other
datasets.</p>
<pre class="sourceCode r"><code class="sourceCode r">mean_height &lt;-<span class="st"> </span>starwars <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">group_by</span>(species) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">summarise</span>(<span class="kw">mean</span>(height))

<span class="kw">class</span>(mean_height)</code></pre>
<pre><code>## [1] &quot;tbl_df&quot;     &quot;tbl&quot;        &quot;data.frame&quot;</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">head</span>(mean_height)</code></pre>
<pre><code>## # A tibble: 6 x 2
##   species  `mean(height)`
##   &lt;chr&gt;             &lt;dbl&gt;
## 1 &lt;NA&gt;                 NA
## 2 Aleena               79
## 3 Besalisk            198
## 4 Cerean              198
## 5 Chagrian            196
## 6 Clawdite            168</code></pre>
<p>You could then write this data to disk using <code>rio::export()</code> for instance. If you need more than the
mean of the height, you can keep adding as many functions as needed:</p>
<pre class="sourceCode r"><code class="sourceCode r">summary_table &lt;-<span class="st"> </span>starwars <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">group_by</span>(species) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">summarise</span>(<span class="dt">ave_height =</span> <span class="kw">mean</span>(height), <span class="dt">var_height =</span> <span class="kw">var</span>(height), <span class="dt">n_obs =</span> <span class="kw">n</span>())

<span class="kw">print</span>(summary_table)</code></pre>
<pre><code>## # A tibble: 38 x 4
##    species   ave_height var_height n_obs
##    &lt;chr&gt;          &lt;dbl&gt;      &lt;dbl&gt; &lt;int&gt;
##  1 &lt;NA&gt;              NA         NA     5
##  2 Aleena            79         NA     1
##  3 Besalisk         198         NA     1
##  4 Cerean           198         NA     1
##  5 Chagrian         196         NA     1
##  6 Clawdite         168         NA     1
##  7 Droid             NA         NA     5
##  8 Dug              112         NA     1
##  9 Ewok              88         NA     1
## 10 Geonosian        183         NA     1
## # ‚Ä¶ with 28 more rows</code></pre>
<p>I‚Äôve added more functions, namely <code>var()</code>, to get the variance of height, and <code>n()</code>, which
is a function from <code>dplyr</code>, not base R, to get the number of observations. This is quite useful,
because we see that for a lot of species we only have one single individual! Let‚Äôs focus on the
species for which we have more than 1 individual. Since we save all the previous operations (which
produce a <code>tibble</code>) in a variable, we can keep going from there:</p>
<pre class="sourceCode r"><code class="sourceCode r">summary_table2 &lt;-<span class="st"> </span>summary_table <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">filter</span>(n_obs <span class="op">&gt;</span><span class="st"> </span><span class="dv">1</span>)

<span class="kw">print</span>(summary_table2)</code></pre>
<pre><code>## # A tibble: 9 x 4
##   species  ave_height var_height n_obs
##   &lt;chr&gt;         &lt;dbl&gt;      &lt;dbl&gt; &lt;int&gt;
## 1 &lt;NA&gt;            NA         NA      5
## 2 Droid           NA         NA      5
## 3 Gungan         209.       201.     3
## 4 Human           NA         NA     35
## 5 Kaminoan       221        128      2
## 6 Mirialan       168          8      2
## 7 Twi&#39;lek        179          2      2
## 8 Wookiee        231         18      2
## 9 Zabrak         173          8      2</code></pre>
<p>There‚Äôs a lot of <code>NA</code>s; this is because by default, <code>mean()</code> and <code>var()</code> return <code>NA</code> if even one
single observation is <code>NA</code>. This is good, because it forces you to look at the data
to see what is going on. If you would get a number, even if there were <code>NA</code>s you could very easily
miss these missing values. It is better for functions to fail early and often than the opposite.
<code>mean()</code> and <code>var()</code> have a <code>na.rm</code> option that the user can set to <code>TRUE</code> to get the result by
ignoring the <code>NA</code>s:</p>
<pre class="sourceCode r"><code class="sourceCode r">starwars <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">group_by</span>(species) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">summarise</span>(<span class="dt">ave_height =</span> <span class="kw">mean</span>(height, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>), <span class="dt">var_height =</span> <span class="kw">var</span>(height, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>), <span class="dt">n_obs =</span> <span class="kw">n</span>()) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">filter</span>(n_obs <span class="op">&gt;</span><span class="st"> </span><span class="dv">1</span>)</code></pre>
<pre><code>## # A tibble: 9 x 4
##   species  ave_height var_height n_obs
##   &lt;chr&gt;         &lt;dbl&gt;      &lt;dbl&gt; &lt;int&gt;
## 1 &lt;NA&gt;           160       1826      5
## 2 Droid          140       2705.     5
## 3 Gungan         209.       201.     3
## 4 Human          177.       157.    35
## 5 Kaminoan       221        128      2
## 6 Mirialan       168          8      2
## 7 Twi&#39;lek        179          2      2
## 8 Wookiee        231         18      2
## 9 Zabrak         173          8      2</code></pre>
<p>In the code above, I have combined the two previous steps to get the result I‚Äôm interested in. There‚Äôs
a line in the final output that says <code>NA</code> for the species. Let‚Äôs go back to the raw data and find
these lines:</p>
<pre class="sourceCode r"><code class="sourceCode r">starwars <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">filter</span>(<span class="kw">is.na</span>(species))</code></pre>
<pre><code>## # A tibble: 5 x 13
##   name  height  mass hair_color skin_color eye_color birth_year gender
##   &lt;chr&gt;  &lt;int&gt; &lt;dbl&gt; &lt;chr&gt;      &lt;chr&gt;      &lt;chr&gt;          &lt;dbl&gt; &lt;chr&gt; 
## 1 Ric ‚Ä¶    183    NA brown      fair       blue              NA male  
## 2 Quar‚Ä¶    183    NA black      dark       brown             62 male  
## 3 R4-P‚Ä¶     96    NA none       silver, r‚Ä¶ red, blue         NA female
## 4 Sly ‚Ä¶    178    48 none       pale       white             NA female
## 5 Capt‚Ä¶     NA    NA unknown    unknown    unknown           NA female
## # ‚Ä¶ with 5 more variables: homeworld &lt;chr&gt;, species &lt;chr&gt;, films &lt;list&gt;,
## #   vehicles &lt;list&gt;, starships &lt;list&gt;</code></pre>
<p>To test for <code>NA</code>, one uses the function <code>is.na()</code> not something like <code>species == "NA"</code> or anything
like that. <code>!is.na()</code> does the opposite:</p>
<pre class="sourceCode r"><code class="sourceCode r">starwars <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">filter</span>(<span class="op">!</span><span class="kw">is.na</span>(species))</code></pre>
<pre><code>## # A tibble: 82 x 13
##    name  height  mass hair_color skin_color eye_color birth_year gender
##    &lt;chr&gt;  &lt;int&gt; &lt;dbl&gt; &lt;chr&gt;      &lt;chr&gt;      &lt;chr&gt;          &lt;dbl&gt; &lt;chr&gt; 
##  1 Luke‚Ä¶    172    77 blond      fair       blue            19   male  
##  2 C-3PO    167    75 &lt;NA&gt;       gold       yellow         112   &lt;NA&gt;  
##  3 R2-D2     96    32 &lt;NA&gt;       white, bl‚Ä¶ red             33   &lt;NA&gt;  
##  4 Dart‚Ä¶    202   136 none       white      yellow          41.9 male  
##  5 Leia‚Ä¶    150    49 brown      light      brown           19   female
##  6 Owen‚Ä¶    178   120 brown, gr‚Ä¶ light      blue            52   male  
##  7 Beru‚Ä¶    165    75 brown      light      blue            47   female
##  8 R5-D4     97    32 &lt;NA&gt;       white, red red             NA   &lt;NA&gt;  
##  9 Bigg‚Ä¶    183    84 black      light      brown           24   male  
## 10 Obi-‚Ä¶    182    77 auburn, w‚Ä¶ fair       blue-gray       57   male  
## # ‚Ä¶ with 72 more rows, and 5 more variables: homeworld &lt;chr&gt;,
## #   species &lt;chr&gt;, films &lt;list&gt;, vehicles &lt;list&gt;, starships &lt;list&gt;</code></pre>
<p>The <code>!</code> function negates a predicate function (a predicate function is a function that returns
<code>TRUE</code> or <code>FALSE</code>). We can then rerun our analysis from before:</p>
<pre class="sourceCode r"><code class="sourceCode r">starwars <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">filter</span>(<span class="op">!</span><span class="kw">is.na</span>(species)) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">group_by</span>(species) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">summarise</span>(<span class="dt">ave_height =</span> <span class="kw">mean</span>(height, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>), <span class="dt">var_height =</span> <span class="kw">var</span>(height, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>), <span class="dt">n_obs =</span> <span class="kw">n</span>()) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">filter</span>(n_obs <span class="op">&gt;</span><span class="st"> </span><span class="dv">1</span>)</code></pre>
<pre><code>## # A tibble: 8 x 4
##   species  ave_height var_height n_obs
##   &lt;chr&gt;         &lt;dbl&gt;      &lt;dbl&gt; &lt;int&gt;
## 1 Droid          140       2705.     5
## 2 Gungan         209.       201.     3
## 3 Human          177.       157.    35
## 4 Kaminoan       221        128      2
## 5 Mirialan       168          8      2
## 6 Twi&#39;lek        179          2      2
## 7 Wookiee        231         18      2
## 8 Zabrak         173          8      2</code></pre>
<p>And why not compute the same table, but first add another stratifying variable?</p>
<pre class="sourceCode r"><code class="sourceCode r">starwars <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">filter</span>(<span class="op">!</span><span class="kw">is.na</span>(species)) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">group_by</span>(species, gender) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">summarise</span>(<span class="dt">ave_height =</span> <span class="kw">mean</span>(height, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>), <span class="dt">var_height =</span> <span class="kw">var</span>(height, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>), <span class="dt">n_obs =</span> <span class="kw">n</span>()) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">filter</span>(n_obs <span class="op">&gt;</span><span class="st"> </span><span class="dv">1</span>)</code></pre>
<pre><code>## # A tibble: 8 x 5
## # Groups:   species [6]
##   species  gender ave_height var_height n_obs
##   &lt;chr&gt;    &lt;chr&gt;       &lt;dbl&gt;      &lt;dbl&gt; &lt;int&gt;
## 1 Droid    &lt;NA&gt;         120      1657       3
## 2 Droid    none         200        NA       2
## 3 Gungan   male         209.      201.      3
## 4 Human    female       160.       48.8     9
## 5 Human    male         182.       67.1    26
## 6 Mirialan female       168         8       2
## 7 Wookiee  male         231        18       2
## 8 Zabrak   male         173         8       2</code></pre>
<p>Ok, that‚Äôs it for a first taste. We have already discovered some very useful <code>{dplyr}</code> functions,
<code>filter()</code>, <code>group_by()</code> and summarise <code>summarise()</code>.</p>
<p>Now, we are going to learn more about these functions in more detail.</p>
</div>
<div id="filter-the-rows-of-a-dataset-with-filter" class="section level3">
<h3><span class="header-section-number">4.3.2</span> Filter the rows of a dataset with <code>filter()</code></h3>
<p>We‚Äôre going to use the <code>Gasoline</code> dataset from the <code>plm</code> package, so install that first:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">install.packages</span>(<span class="st">&quot;plm&quot;</span>)</code></pre>
<p>Then load the required data:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">data</span>(Gasoline, <span class="dt">package =</span> <span class="st">&quot;plm&quot;</span>)</code></pre>
<p>and load dplyr:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(dplyr)</code></pre>
<p>This dataset gives the consumption of gasoline for 18 countries from 1960 to 1978. When you load
the data like this, it is a standard <code>data.frame</code>. <code>dplyr</code> functions can be used on standard
<code>data.frame</code> objects, but also on <code>tibble</code>s. <code>tibble</code>s are just like data frame, but with a better
print method (and other niceties). I‚Äôll discuss the <code>{tibble}</code> package later, but for now, let‚Äôs
convert the data to a <code>tibble</code> and change its name:</p>
<pre class="sourceCode r"><code class="sourceCode r">gasoline &lt;-<span class="st"> </span><span class="kw">as_tibble</span>(Gasoline)</code></pre>
<p><code>filter()</code> is pretty straightforward. What if you would like to subset the data to focus on the
year 1969? Simple:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">filter</span>(gasoline, year <span class="op">==</span><span class="st"> </span><span class="dv">1969</span>)</code></pre>
<pre><code>## # A tibble: 18 x 6
##    country   year lgaspcar lincomep  lrpmg lcarpcap
##    &lt;fct&gt;    &lt;int&gt;    &lt;dbl&gt;    &lt;dbl&gt;  &lt;dbl&gt;    &lt;dbl&gt;
##  1 AUSTRIA   1969     4.05    -6.15 -0.559    -8.79
##  2 BELGIUM   1969     3.85    -5.86 -0.355    -8.52
##  3 CANADA    1969     4.86    -5.56 -1.04     -8.10
##  4 DENMARK   1969     4.17    -5.72 -0.407    -8.47
##  5 FRANCE    1969     3.77    -5.84 -0.315    -8.37
##  6 GERMANY   1969     3.90    -5.83 -0.589    -8.44
##  7 GREECE    1969     4.89    -6.59 -0.180   -10.7 
##  8 IRELAND   1969     4.21    -6.38 -0.272    -8.95
##  9 ITALY     1969     3.74    -6.28 -0.248    -8.67
## 10 JAPAN     1969     4.52    -6.16 -0.417    -9.61
## 11 NETHERLA  1969     3.99    -5.88 -0.417    -8.63
## 12 NORWAY    1969     4.09    -5.74 -0.338    -8.69
## 13 SPAIN     1969     3.99    -5.60  0.669    -9.72
## 14 SWEDEN    1969     3.99    -7.77 -2.73     -8.20
## 15 SWITZERL  1969     4.21    -5.91 -0.918    -8.47
## 16 TURKEY    1969     5.72    -7.39 -0.298   -12.5 
## 17 U.K.      1969     3.95    -6.03 -0.383    -8.47
## 18 U.S.A.    1969     4.84    -5.41 -1.22     -7.79</code></pre>
<p>Let‚Äôs use <code>%&gt;%</code>, since we‚Äôre familiar with it now:</p>
<pre class="sourceCode r"><code class="sourceCode r">gasoline <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(year <span class="op">==</span><span class="st"> </span><span class="dv">1969</span>)</code></pre>
<pre><code>## # A tibble: 18 x 6
##    country   year lgaspcar lincomep  lrpmg lcarpcap
##    &lt;fct&gt;    &lt;int&gt;    &lt;dbl&gt;    &lt;dbl&gt;  &lt;dbl&gt;    &lt;dbl&gt;
##  1 AUSTRIA   1969     4.05    -6.15 -0.559    -8.79
##  2 BELGIUM   1969     3.85    -5.86 -0.355    -8.52
##  3 CANADA    1969     4.86    -5.56 -1.04     -8.10
##  4 DENMARK   1969     4.17    -5.72 -0.407    -8.47
##  5 FRANCE    1969     3.77    -5.84 -0.315    -8.37
##  6 GERMANY   1969     3.90    -5.83 -0.589    -8.44
##  7 GREECE    1969     4.89    -6.59 -0.180   -10.7 
##  8 IRELAND   1969     4.21    -6.38 -0.272    -8.95
##  9 ITALY     1969     3.74    -6.28 -0.248    -8.67
## 10 JAPAN     1969     4.52    -6.16 -0.417    -9.61
## 11 NETHERLA  1969     3.99    -5.88 -0.417    -8.63
## 12 NORWAY    1969     4.09    -5.74 -0.338    -8.69
## 13 SPAIN     1969     3.99    -5.60  0.669    -9.72
## 14 SWEDEN    1969     3.99    -7.77 -2.73     -8.20
## 15 SWITZERL  1969     4.21    -5.91 -0.918    -8.47
## 16 TURKEY    1969     5.72    -7.39 -0.298   -12.5 
## 17 U.K.      1969     3.95    -6.03 -0.383    -8.47
## 18 U.S.A.    1969     4.84    -5.41 -1.22     -7.79</code></pre>
<p>You can also filter more than just one year, by using the <code>%in%</code> operator:</p>
<pre class="sourceCode r"><code class="sourceCode r">gasoline <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(year <span class="op">%in%</span><span class="st"> </span><span class="kw">seq</span>(<span class="dv">1969</span>, <span class="dv">1973</span>))</code></pre>
<pre><code>## # A tibble: 90 x 6
##    country  year lgaspcar lincomep  lrpmg lcarpcap
##    &lt;fct&gt;   &lt;int&gt;    &lt;dbl&gt;    &lt;dbl&gt;  &lt;dbl&gt;    &lt;dbl&gt;
##  1 AUSTRIA  1969     4.05    -6.15 -0.559    -8.79
##  2 AUSTRIA  1970     4.08    -6.08 -0.597    -8.73
##  3 AUSTRIA  1971     4.11    -6.04 -0.654    -8.64
##  4 AUSTRIA  1972     4.13    -5.98 -0.596    -8.54
##  5 AUSTRIA  1973     4.20    -5.90 -0.594    -8.49
##  6 BELGIUM  1969     3.85    -5.86 -0.355    -8.52
##  7 BELGIUM  1970     3.87    -5.80 -0.378    -8.45
##  8 BELGIUM  1971     3.87    -5.76 -0.399    -8.41
##  9 BELGIUM  1972     3.91    -5.71 -0.311    -8.36
## 10 BELGIUM  1973     3.90    -5.64 -0.373    -8.31
## # ‚Ä¶ with 80 more rows</code></pre>
<p>It is also possible use <code>between()</code>, a helper function:</p>
<pre class="sourceCode r"><code class="sourceCode r">gasoline <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(<span class="kw">between</span>(year, <span class="dv">1969</span>, <span class="dv">1973</span>))</code></pre>
<pre><code>## # A tibble: 90 x 6
##    country  year lgaspcar lincomep  lrpmg lcarpcap
##    &lt;fct&gt;   &lt;int&gt;    &lt;dbl&gt;    &lt;dbl&gt;  &lt;dbl&gt;    &lt;dbl&gt;
##  1 AUSTRIA  1969     4.05    -6.15 -0.559    -8.79
##  2 AUSTRIA  1970     4.08    -6.08 -0.597    -8.73
##  3 AUSTRIA  1971     4.11    -6.04 -0.654    -8.64
##  4 AUSTRIA  1972     4.13    -5.98 -0.596    -8.54
##  5 AUSTRIA  1973     4.20    -5.90 -0.594    -8.49
##  6 BELGIUM  1969     3.85    -5.86 -0.355    -8.52
##  7 BELGIUM  1970     3.87    -5.80 -0.378    -8.45
##  8 BELGIUM  1971     3.87    -5.76 -0.399    -8.41
##  9 BELGIUM  1972     3.91    -5.71 -0.311    -8.36
## 10 BELGIUM  1973     3.90    -5.64 -0.373    -8.31
## # ‚Ä¶ with 80 more rows</code></pre>
<p>To select non-consecutive years:</p>
<pre class="sourceCode r"><code class="sourceCode r">gasoline <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(year <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(<span class="dv">1969</span>, <span class="dv">1973</span>, <span class="dv">1977</span>))</code></pre>
<pre><code>## # A tibble: 54 x 6
##    country  year lgaspcar lincomep  lrpmg lcarpcap
##    &lt;fct&gt;   &lt;int&gt;    &lt;dbl&gt;    &lt;dbl&gt;  &lt;dbl&gt;    &lt;dbl&gt;
##  1 AUSTRIA  1969     4.05    -6.15 -0.559    -8.79
##  2 AUSTRIA  1973     4.20    -5.90 -0.594    -8.49
##  3 AUSTRIA  1977     3.93    -5.83 -0.422    -8.25
##  4 BELGIUM  1969     3.85    -5.86 -0.355    -8.52
##  5 BELGIUM  1973     3.90    -5.64 -0.373    -8.31
##  6 BELGIUM  1977     3.85    -5.56 -0.432    -8.14
##  7 CANADA   1969     4.86    -5.56 -1.04     -8.10
##  8 CANADA   1973     4.90    -5.41 -1.13     -7.94
##  9 CANADA   1977     4.81    -5.34 -1.07     -7.77
## 10 DENMARK  1969     4.17    -5.72 -0.407    -8.47
## # ‚Ä¶ with 44 more rows</code></pre>
<p><code>%in%</code> tests if an object is part of a set.</p>
</div>
<div id="select-columns-with-select" class="section level3">
<h3><span class="header-section-number">4.3.3</span> Select columns with <code>select()</code></h3>
<p>While <code>filter()</code> allows you to keep or discard rows of data, <code>select()</code>
allows you to keep or discard entire columns. To keep columns:</p>
<pre class="sourceCode r"><code class="sourceCode r">gasoline <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(country, year, lrpmg)</code></pre>
<pre><code>## # A tibble: 342 x 3
##    country  year  lrpmg
##    &lt;fct&gt;   &lt;int&gt;  &lt;dbl&gt;
##  1 AUSTRIA  1960 -0.335
##  2 AUSTRIA  1961 -0.351
##  3 AUSTRIA  1962 -0.380
##  4 AUSTRIA  1963 -0.414
##  5 AUSTRIA  1964 -0.445
##  6 AUSTRIA  1965 -0.497
##  7 AUSTRIA  1966 -0.467
##  8 AUSTRIA  1967 -0.506
##  9 AUSTRIA  1968 -0.522
## 10 AUSTRIA  1969 -0.559
## # ‚Ä¶ with 332 more rows</code></pre>
<p>To discard them:</p>
<pre class="sourceCode r"><code class="sourceCode r">gasoline <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(<span class="op">-</span>country, <span class="op">-</span>year, <span class="op">-</span>lrpmg)</code></pre>
<pre><code>## # A tibble: 342 x 3
##    lgaspcar lincomep lcarpcap
##       &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;
##  1     4.17    -6.47    -9.77
##  2     4.10    -6.43    -9.61
##  3     4.07    -6.41    -9.46
##  4     4.06    -6.37    -9.34
##  5     4.04    -6.32    -9.24
##  6     4.03    -6.29    -9.12
##  7     4.05    -6.25    -9.02
##  8     4.05    -6.23    -8.93
##  9     4.05    -6.21    -8.85
## 10     4.05    -6.15    -8.79
## # ‚Ä¶ with 332 more rows</code></pre>
<p>To rename them:</p>
<pre class="sourceCode r"><code class="sourceCode r">gasoline <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(country, <span class="dt">date =</span> year, lrpmg)</code></pre>
<pre><code>## # A tibble: 342 x 3
##    country  date  lrpmg
##    &lt;fct&gt;   &lt;int&gt;  &lt;dbl&gt;
##  1 AUSTRIA  1960 -0.335
##  2 AUSTRIA  1961 -0.351
##  3 AUSTRIA  1962 -0.380
##  4 AUSTRIA  1963 -0.414
##  5 AUSTRIA  1964 -0.445
##  6 AUSTRIA  1965 -0.497
##  7 AUSTRIA  1966 -0.467
##  8 AUSTRIA  1967 -0.506
##  9 AUSTRIA  1968 -0.522
## 10 AUSTRIA  1969 -0.559
## # ‚Ä¶ with 332 more rows</code></pre>
<p>There‚Äôs also <code>rename()</code>:</p>
<pre class="sourceCode r"><code class="sourceCode r">gasoline <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">rename</span>(<span class="dt">date =</span> year)</code></pre>
<pre><code>## # A tibble: 342 x 6
##    country  date lgaspcar lincomep  lrpmg lcarpcap
##    &lt;fct&gt;   &lt;int&gt;    &lt;dbl&gt;    &lt;dbl&gt;  &lt;dbl&gt;    &lt;dbl&gt;
##  1 AUSTRIA  1960     4.17    -6.47 -0.335    -9.77
##  2 AUSTRIA  1961     4.10    -6.43 -0.351    -9.61
##  3 AUSTRIA  1962     4.07    -6.41 -0.380    -9.46
##  4 AUSTRIA  1963     4.06    -6.37 -0.414    -9.34
##  5 AUSTRIA  1964     4.04    -6.32 -0.445    -9.24
##  6 AUSTRIA  1965     4.03    -6.29 -0.497    -9.12
##  7 AUSTRIA  1966     4.05    -6.25 -0.467    -9.02
##  8 AUSTRIA  1967     4.05    -6.23 -0.506    -8.93
##  9 AUSTRIA  1968     4.05    -6.21 -0.522    -8.85
## 10 AUSTRIA  1969     4.05    -6.15 -0.559    -8.79
## # ‚Ä¶ with 332 more rows</code></pre>
<p><code>rename()</code> does not do any kind of selection, but just renames.</p>
<p>You can also use <code>select()</code> to re-order columns:</p>
<pre class="sourceCode r"><code class="sourceCode r">gasoline <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(year, country, lrpmg, <span class="kw">everything</span>())</code></pre>
<pre><code>## # A tibble: 342 x 6
##     year country  lrpmg lgaspcar lincomep lcarpcap
##    &lt;int&gt; &lt;fct&gt;    &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;
##  1  1960 AUSTRIA -0.335     4.17    -6.47    -9.77
##  2  1961 AUSTRIA -0.351     4.10    -6.43    -9.61
##  3  1962 AUSTRIA -0.380     4.07    -6.41    -9.46
##  4  1963 AUSTRIA -0.414     4.06    -6.37    -9.34
##  5  1964 AUSTRIA -0.445     4.04    -6.32    -9.24
##  6  1965 AUSTRIA -0.497     4.03    -6.29    -9.12
##  7  1966 AUSTRIA -0.467     4.05    -6.25    -9.02
##  8  1967 AUSTRIA -0.506     4.05    -6.23    -8.93
##  9  1968 AUSTRIA -0.522     4.05    -6.21    -8.85
## 10  1969 AUSTRIA -0.559     4.05    -6.15    -8.79
## # ‚Ä¶ with 332 more rows</code></pre>
<p><code>everything()</code> is a helper function, and there‚Äôs also <code>starts_with()</code>,
and <code>ends_with()</code>. For example, what if we are only interested
in columns whose name start with ‚Äúl‚Äù?</p>
<pre class="sourceCode r"><code class="sourceCode r">gasoline <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(<span class="kw">starts_with</span>(<span class="st">&quot;l&quot;</span>))</code></pre>
<pre><code>## # A tibble: 342 x 4
##    lgaspcar lincomep  lrpmg lcarpcap
##       &lt;dbl&gt;    &lt;dbl&gt;  &lt;dbl&gt;    &lt;dbl&gt;
##  1     4.17    -6.47 -0.335    -9.77
##  2     4.10    -6.43 -0.351    -9.61
##  3     4.07    -6.41 -0.380    -9.46
##  4     4.06    -6.37 -0.414    -9.34
##  5     4.04    -6.32 -0.445    -9.24
##  6     4.03    -6.29 -0.497    -9.12
##  7     4.05    -6.25 -0.467    -9.02
##  8     4.05    -6.23 -0.506    -8.93
##  9     4.05    -6.21 -0.522    -8.85
## 10     4.05    -6.15 -0.559    -8.79
## # ‚Ä¶ with 332 more rows</code></pre>
<p><code>ends_with()</code> works in a similar fashion. There is also <code>contains()</code>:</p>
<pre class="sourceCode r"><code class="sourceCode r">gasoline <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(country, year, <span class="kw">contains</span>(<span class="st">&quot;car&quot;</span>))</code></pre>
<pre><code>## # A tibble: 342 x 4
##    country  year lgaspcar lcarpcap
##    &lt;fct&gt;   &lt;int&gt;    &lt;dbl&gt;    &lt;dbl&gt;
##  1 AUSTRIA  1960     4.17    -9.77
##  2 AUSTRIA  1961     4.10    -9.61
##  3 AUSTRIA  1962     4.07    -9.46
##  4 AUSTRIA  1963     4.06    -9.34
##  5 AUSTRIA  1964     4.04    -9.24
##  6 AUSTRIA  1965     4.03    -9.12
##  7 AUSTRIA  1966     4.05    -9.02
##  8 AUSTRIA  1967     4.05    -8.93
##  9 AUSTRIA  1968     4.05    -8.85
## 10 AUSTRIA  1969     4.05    -8.79
## # ‚Ä¶ with 332 more rows</code></pre>
<p>Another verb, similar to <code>select()</code>, is <code>pull()</code>. Let‚Äôs compare the two:</p>
<pre class="sourceCode r"><code class="sourceCode r">gasoline <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(lrpmg)</code></pre>
<pre><code>## # A tibble: 342 x 1
##     lrpmg
##     &lt;dbl&gt;
##  1 -0.335
##  2 -0.351
##  3 -0.380
##  4 -0.414
##  5 -0.445
##  6 -0.497
##  7 -0.467
##  8 -0.506
##  9 -0.522
## 10 -0.559
## # ‚Ä¶ with 332 more rows</code></pre>
<pre class="sourceCode r"><code class="sourceCode r">gasoline <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">pull</span>(lrpmg)</code></pre>
<pre><code>##   [1] -0.33454761 -0.35132761 -0.37951769 -0.41425139 -0.44533536
##   [6] -0.49706066 -0.46683773 -0.50588340 -0.52241255 -0.55911051
##  [11] -0.59656122 -0.65445914 -0.59633184 -0.59444681 -0.46602693
##  [16] -0.45414221 -0.50008372 -0.42191563 -0.46960312 -0.16570961
##  [21] -0.17173098 -0.22229138 -0.25046225 -0.27591057 -0.34493695
##  [26] -0.23639770 -0.26699499 -0.31116076 -0.35480852 -0.37794044
##  [31] -0.39922992 -0.31064584 -0.37309192 -0.36223563 -0.36430848
##  [36] -0.37896584 -0.43164133 -0.59094964 -0.97210650 -0.97229024
##  [41] -0.97860756 -1.01904791 -1.00285696 -1.01712549 -1.01694436
##  [46] -1.02359713 -1.01984524 -1.03686389 -1.06733308 -1.05803676
##  [51] -1.09966703 -1.13316142 -1.12379997 -1.18568427 -1.06179659
##  [56] -1.07084448 -1.07495073 -0.19570260 -0.25361844 -0.21875400
##  [61] -0.24800936 -0.30654923 -0.32701542 -0.39618846 -0.44257369
##  [66] -0.35204752 -0.40687922 -0.44046082 -0.45473954 -0.49918863
##  [71] -0.43257185 -0.42517720 -0.39395431 -0.35361534 -0.35690917
##  [76] -0.29068135 -0.01959833 -0.02386000 -0.06892022 -0.13792900
##  [81] -0.19784646 -0.23365325 -0.26427164 -0.29405795 -0.32316179
##  [86] -0.31519087 -0.33384616 -0.37945667 -0.40781642 -0.47503429
##  [91] -0.21698191 -0.25838174 -0.24651309 -0.22550681 -0.38075942
##  [96] -0.18591078 -0.23095384 -0.34384171 -0.37464672 -0.39965256
## [101] -0.43987825 -0.54000197 -0.54998139 -0.43824222 -0.58923137
## [106] -0.63329520 -0.67176311 -0.71797458 -0.72587521 -0.56982876
## [111] -0.56482380 -0.62481298 -0.59761210 -0.62817279 -0.08354740
## [116] -0.10421997 -0.13320751 -0.15653576 -0.18051772 -0.07793999
## [121] -0.11491900 -0.13775849 -0.15375883 -0.17986997 -0.20252426
## [126] -0.06761078 -0.11973059 -0.05191029  0.31625351  0.20631574
## [131]  0.19319312  0.23502961  0.16896037 -0.07648118 -0.12040874
## [136] -0.14160039 -0.15232915 -0.24428212 -0.16899366 -0.21071901
## [141] -0.17383533 -0.21339314 -0.27162842 -0.32069023 -0.36041067
## [146] -0.42393131 -0.64567297 -0.55343875 -0.64126416 -0.66134256
## [151] -0.56011483 -0.66277808  0.16507708 -0.08559038 -0.18351291
## [156] -0.26541405 -0.42609643 -0.32712637 -0.24887418 -0.19160048
## [161] -0.20616656 -0.24756681 -0.23271512 -0.14822267 -0.21508857
## [166] -0.32508487 -0.22290860 -0.03270913  0.10292798  0.16418805
## [171]  0.03482212 -0.14532271 -0.14874940 -0.18731459 -0.19996473
## [176] -0.20386433 -0.23786571 -0.27411537 -0.33167240 -0.35126918
## [181] -0.41685019 -0.46203546 -0.43941354 -0.52100094 -0.46270739
## [186] -0.19090636 -0.15948473 -0.20726559 -0.21904447 -0.28707638
## [191] -0.20148480 -0.21599265 -0.25968008 -0.29718661 -0.36929389
## [196] -0.34197503 -0.34809007 -0.31232019 -0.44450431 -0.41694955
## [201] -0.39954544 -0.43393029 -0.31903240 -0.42728193 -0.35253685
## [206] -0.43426178 -0.42908393 -0.46474195 -0.55791459 -0.13968957
## [211] -0.15790514 -0.19908809 -0.23263318 -0.26374731 -0.31593124
## [216] -0.25011726 -0.26555763 -0.30036775 -0.33823045 -0.39072560
## [221] -0.30127223 -0.26023925 -0.33880765 -0.15100924 -0.32726757
## [226] -0.35308752 -0.38255762 -0.30765935  1.12531070  1.10956235
## [231]  1.05700394  0.97683534  0.91532254  0.81666055  0.75671751
## [236]  0.74130811  0.70386453  0.66948950  0.61217208  0.60699563
## [241]  0.53716844  0.43377166  0.52492096  0.62955545  0.68385409
## [246]  0.52627167  0.62141374 -2.52041588 -2.57148340 -2.53448158
## [251] -2.60511224 -2.65801626 -2.64476790 -2.63901460 -2.65609762
## [256] -2.67918662 -2.73190414 -2.73359211 -2.77884554 -2.77467537
## [261] -2.84142900 -2.79840677 -2.76731461 -2.82294480 -2.82005896
## [266] -2.89649671 -0.82321833 -0.86558473 -0.82218510 -0.86012004
## [271] -0.86767682 -0.90528668 -0.85956665 -0.90656671 -0.87232520
## [276] -0.91812162 -0.96344188 -1.03746081 -0.94015345 -0.86722756
## [281] -0.88692306 -0.88475790 -0.90736205 -0.91147285 -1.03208811
## [286] -0.25340821 -0.34252375 -0.40820484 -0.22499174 -0.25219448
## [291] -0.29347614 -0.35640491 -0.33515022 -0.36507386 -0.29845417
## [296] -0.39882648 -0.30461880 -0.54637424 -0.69162023 -0.33965308
## [301] -0.53794675 -0.75141027 -0.95552413 -0.35290961 -0.39108581
## [306] -0.45185308 -0.42287690 -0.46335147 -0.49577430 -0.42654915
## [311] -0.47068145 -0.44118786 -0.46245080 -0.38332457 -0.41899030
## [316] -0.46135978 -0.52777246 -0.56529718 -0.56641296 -0.20867428
## [321] -0.27354010 -0.50886285 -0.78652911 -1.12111489 -1.14624034
## [326] -1.16187449 -1.17991524 -1.20026222 -1.19428750 -1.19026054
## [331] -1.18991215 -1.20730059 -1.22314272 -1.25176347 -1.28131560
## [336] -1.33116930 -1.29066967 -1.23146686 -1.20037697 -1.15468197
## [341] -1.17590974 -1.21206183</code></pre>
<p><code>pull()</code>, unlike <code>select()</code>, does not return a <code>tibble</code>, but only the column you want.</p>
</div>
<div id="group-the-observations-of-your-dataset-with-group_by" class="section level3">
<h3><span class="header-section-number">4.3.4</span> Group the observations of your dataset with <code>group_by()</code></h3>
<p><code>group_by()</code> is a very useful verb; as the name implies, it allows you to create groups and then,
for example, compute descriptive statistics by groups. For example, let‚Äôs group our data by
country:</p>
<pre class="sourceCode r"><code class="sourceCode r">gasoline <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">group_by</span>(country)</code></pre>
<pre><code>## # A tibble: 342 x 6
## # Groups:   country [18]
##    country  year lgaspcar lincomep  lrpmg lcarpcap
##    &lt;fct&gt;   &lt;int&gt;    &lt;dbl&gt;    &lt;dbl&gt;  &lt;dbl&gt;    &lt;dbl&gt;
##  1 AUSTRIA  1960     4.17    -6.47 -0.335    -9.77
##  2 AUSTRIA  1961     4.10    -6.43 -0.351    -9.61
##  3 AUSTRIA  1962     4.07    -6.41 -0.380    -9.46
##  4 AUSTRIA  1963     4.06    -6.37 -0.414    -9.34
##  5 AUSTRIA  1964     4.04    -6.32 -0.445    -9.24
##  6 AUSTRIA  1965     4.03    -6.29 -0.497    -9.12
##  7 AUSTRIA  1966     4.05    -6.25 -0.467    -9.02
##  8 AUSTRIA  1967     4.05    -6.23 -0.506    -8.93
##  9 AUSTRIA  1968     4.05    -6.21 -0.522    -8.85
## 10 AUSTRIA  1969     4.05    -6.15 -0.559    -8.79
## # ‚Ä¶ with 332 more rows</code></pre>
<p>It looks like nothing much happened, but if you look at the second line of the output you can read
the following:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co">## # Groups:   country [18]</span></code></pre>
<p>this means that the data is grouped, and every computation you will do now will take these groups
into account. It is also possible to group by more than one variable:</p>
<pre class="sourceCode r"><code class="sourceCode r">gasoline <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">group_by</span>(country, year)</code></pre>
<pre><code>## # A tibble: 342 x 6
## # Groups:   country, year [342]
##    country  year lgaspcar lincomep  lrpmg lcarpcap
##    &lt;fct&gt;   &lt;int&gt;    &lt;dbl&gt;    &lt;dbl&gt;  &lt;dbl&gt;    &lt;dbl&gt;
##  1 AUSTRIA  1960     4.17    -6.47 -0.335    -9.77
##  2 AUSTRIA  1961     4.10    -6.43 -0.351    -9.61
##  3 AUSTRIA  1962     4.07    -6.41 -0.380    -9.46
##  4 AUSTRIA  1963     4.06    -6.37 -0.414    -9.34
##  5 AUSTRIA  1964     4.04    -6.32 -0.445    -9.24
##  6 AUSTRIA  1965     4.03    -6.29 -0.497    -9.12
##  7 AUSTRIA  1966     4.05    -6.25 -0.467    -9.02
##  8 AUSTRIA  1967     4.05    -6.23 -0.506    -8.93
##  9 AUSTRIA  1968     4.05    -6.21 -0.522    -8.85
## 10 AUSTRIA  1969     4.05    -6.15 -0.559    -8.79
## # ‚Ä¶ with 332 more rows</code></pre>
<p>and so on. You can then also ungroup:</p>
<pre class="sourceCode r"><code class="sourceCode r">gasoline <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">group_by</span>(country, year) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">ungroup</span>()</code></pre>
<pre><code>## # A tibble: 342 x 6
##    country  year lgaspcar lincomep  lrpmg lcarpcap
##    &lt;fct&gt;   &lt;int&gt;    &lt;dbl&gt;    &lt;dbl&gt;  &lt;dbl&gt;    &lt;dbl&gt;
##  1 AUSTRIA  1960     4.17    -6.47 -0.335    -9.77
##  2 AUSTRIA  1961     4.10    -6.43 -0.351    -9.61
##  3 AUSTRIA  1962     4.07    -6.41 -0.380    -9.46
##  4 AUSTRIA  1963     4.06    -6.37 -0.414    -9.34
##  5 AUSTRIA  1964     4.04    -6.32 -0.445    -9.24
##  6 AUSTRIA  1965     4.03    -6.29 -0.497    -9.12
##  7 AUSTRIA  1966     4.05    -6.25 -0.467    -9.02
##  8 AUSTRIA  1967     4.05    -6.23 -0.506    -8.93
##  9 AUSTRIA  1968     4.05    -6.21 -0.522    -8.85
## 10 AUSTRIA  1969     4.05    -6.15 -0.559    -8.79
## # ‚Ä¶ with 332 more rows</code></pre>
<p>Once your data is grouped, the operations that will follow will be executed inside each group.</p>
</div>
<div id="get-summary-statistics-with-summarise" class="section level3">
<h3><span class="header-section-number">4.3.5</span> Get summary statistics with <code>summarise()</code></h3>
<p>Ok, now that we have learned the basic verbs, we can start to do more interesting stuff. For
example, one might want to compute the average gasoline consumption in each country, for
the whole period:</p>
<pre class="sourceCode r"><code class="sourceCode r">gasoline <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">group_by</span>(country) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">summarise</span>(<span class="kw">mean</span>(lgaspcar))</code></pre>
<pre><code>## # A tibble: 18 x 2
##    country  `mean(lgaspcar)`
##    &lt;fct&gt;               &lt;dbl&gt;
##  1 AUSTRIA              4.06
##  2 BELGIUM              3.92
##  3 CANADA               4.86
##  4 DENMARK              4.19
##  5 FRANCE               3.82
##  6 GERMANY              3.89
##  7 GREECE               4.88
##  8 IRELAND              4.23
##  9 ITALY                3.73
## 10 JAPAN                4.70
## 11 NETHERLA             4.08
## 12 NORWAY               4.11
## 13 SPAIN                4.06
## 14 SWEDEN               4.01
## 15 SWITZERL             4.24
## 16 TURKEY               5.77
## 17 U.K.                 3.98
## 18 U.S.A.               4.82</code></pre>
<p><code>mean()</code> was given as an argument to <code>summarise()</code>, which is a <code>dplyr</code> verb. What we get is another
tibble, that contains the variable we used to group, as well as the average per country. We can
also rename this column:</p>
<pre class="sourceCode r"><code class="sourceCode r">gasoline <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">group_by</span>(country) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">summarise</span>(<span class="dt">mean_gaspcar =</span> <span class="kw">mean</span>(lgaspcar))</code></pre>
<pre><code>## # A tibble: 18 x 2
##    country  mean_gaspcar
##    &lt;fct&gt;           &lt;dbl&gt;
##  1 AUSTRIA          4.06
##  2 BELGIUM          3.92
##  3 CANADA           4.86
##  4 DENMARK          4.19
##  5 FRANCE           3.82
##  6 GERMANY          3.89
##  7 GREECE           4.88
##  8 IRELAND          4.23
##  9 ITALY            3.73
## 10 JAPAN            4.70
## 11 NETHERLA         4.08
## 12 NORWAY           4.11
## 13 SPAIN            4.06
## 14 SWEDEN           4.01
## 15 SWITZERL         4.24
## 16 TURKEY           5.77
## 17 U.K.             3.98
## 18 U.S.A.           4.82</code></pre>
<p>and because the output is a <code>tibble</code>, we can continue to use <code>dplyr</code> verbs on it:</p>
<pre class="sourceCode r"><code class="sourceCode r">gasoline <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">group_by</span>(country) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">summarise</span>(<span class="dt">mean_gaspcar =</span> <span class="kw">mean</span>(lgaspcar)) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">filter</span>(country <span class="op">==</span><span class="st"> &quot;france&quot;</span>)</code></pre>
<pre><code>## # A tibble: 0 x 2
## # ‚Ä¶ with 2 variables: country &lt;fct&gt;, mean_gaspcar &lt;dbl&gt;</code></pre>
<p><code>summarise()</code> is a very useful verb. For example, we can compute several descriptive statistics at once:</p>
<pre class="sourceCode r"><code class="sourceCode r">gasoline <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">group_by</span>(country) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">summarise</span>(<span class="dt">mean_gaspcar =</span> <span class="kw">mean</span>(lgaspcar),
            <span class="dt">sd_gaspcar =</span> <span class="kw">sd</span>(lgaspcar),
            <span class="dt">max_gaspcar =</span> <span class="kw">max</span>(lgaspcar),
            <span class="dt">min_gaspcar =</span> <span class="kw">min</span>(lgaspcar))</code></pre>
<pre><code>## # A tibble: 18 x 5
##    country  mean_gaspcar sd_gaspcar max_gaspcar min_gaspcar
##    &lt;fct&gt;           &lt;dbl&gt;      &lt;dbl&gt;       &lt;dbl&gt;       &lt;dbl&gt;
##  1 AUSTRIA          4.06     0.0693        4.20        3.92
##  2 BELGIUM          3.92     0.103         4.16        3.82
##  3 CANADA           4.86     0.0262        4.90        4.81
##  4 DENMARK          4.19     0.158         4.50        4.00
##  5 FRANCE           3.82     0.0499        3.91        3.75
##  6 GERMANY          3.89     0.0239        3.93        3.85
##  7 GREECE           4.88     0.255         5.38        4.48
##  8 IRELAND          4.23     0.0437        4.33        4.16
##  9 ITALY            3.73     0.220         4.05        3.38
## 10 JAPAN            4.70     0.684         6.00        3.95
## 11 NETHERLA         4.08     0.286         4.65        3.71
## 12 NORWAY           4.11     0.123         4.44        3.96
## 13 SPAIN            4.06     0.317         4.75        3.62
## 14 SWEDEN           4.01     0.0364        4.07        3.91
## 15 SWITZERL         4.24     0.102         4.44        4.05
## 16 TURKEY           5.77     0.329         6.16        5.14
## 17 U.K.             3.98     0.0479        4.10        3.91
## 18 U.S.A.           4.82     0.0219        4.86        4.79</code></pre>
<p>Because the output is a <code>tibble</code>, you can save it in a variable of course:</p>
<pre class="sourceCode r"><code class="sourceCode r">desc_gasoline &lt;-<span class="st"> </span>gasoline <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">group_by</span>(country) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">summarise</span>(<span class="dt">mean_gaspcar =</span> <span class="kw">mean</span>(lgaspcar),
            <span class="dt">sd_gaspcar =</span> <span class="kw">sd</span>(lgaspcar),
            <span class="dt">max_gaspcar =</span> <span class="kw">max</span>(lgaspcar),
            <span class="dt">min_gaspcar =</span> <span class="kw">min</span>(lgaspcar))</code></pre>
<p>And then you can answer questions such as, <em>which country has the maximum average gasoline
consumption?</em>:</p>
<pre class="sourceCode r"><code class="sourceCode r">desc_gasoline <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">filter</span>(<span class="kw">max</span>(mean_gaspcar) <span class="op">==</span><span class="st"> </span>mean_gaspcar)</code></pre>
<pre><code>## # A tibble: 1 x 5
##   country mean_gaspcar sd_gaspcar max_gaspcar min_gaspcar
##   &lt;fct&gt;          &lt;dbl&gt;      &lt;dbl&gt;       &lt;dbl&gt;       &lt;dbl&gt;
## 1 TURKEY          5.77      0.329        6.16        5.14</code></pre>
<p>Turns out it‚Äôs Turkey. What about the minimum consumption?</p>
<pre class="sourceCode r"><code class="sourceCode r">desc_gasoline <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">filter</span>(<span class="kw">min</span>(mean_gaspcar) <span class="op">==</span><span class="st"> </span>mean_gaspcar)</code></pre>
<pre><code>## # A tibble: 1 x 5
##   country mean_gaspcar sd_gaspcar max_gaspcar min_gaspcar
##   &lt;fct&gt;          &lt;dbl&gt;      &lt;dbl&gt;       &lt;dbl&gt;       &lt;dbl&gt;
## 1 ITALY           3.73      0.220        4.05        3.38</code></pre>
<p>Because the output of <code>dplyr</code> verbs is a tibble, it is possible to continue working with it. This
is one shortcoming of using the base <code>summary()</code> function. The object returned by that function
is not very easy to manipulate.</p>
</div>
<div id="adding-columns-with-mutate-and-transmute" class="section level3">
<h3><span class="header-section-number">4.3.6</span> Adding columns with <code>mutate()</code> and <code>transmute()</code></h3>
<p><code>mutate()</code> adds a column to the <code>tibble</code>, which can contain any transformation of any other
variable:</p>
<pre class="sourceCode r"><code class="sourceCode r">gasoline <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">group_by</span>(country) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="kw">n</span>())</code></pre>
<pre><code>## # A tibble: 342 x 7
## # Groups:   country [18]
##    country  year lgaspcar lincomep  lrpmg lcarpcap `n()`
##    &lt;fct&gt;   &lt;int&gt;    &lt;dbl&gt;    &lt;dbl&gt;  &lt;dbl&gt;    &lt;dbl&gt; &lt;int&gt;
##  1 AUSTRIA  1960     4.17    -6.47 -0.335    -9.77    19
##  2 AUSTRIA  1961     4.10    -6.43 -0.351    -9.61    19
##  3 AUSTRIA  1962     4.07    -6.41 -0.380    -9.46    19
##  4 AUSTRIA  1963     4.06    -6.37 -0.414    -9.34    19
##  5 AUSTRIA  1964     4.04    -6.32 -0.445    -9.24    19
##  6 AUSTRIA  1965     4.03    -6.29 -0.497    -9.12    19
##  7 AUSTRIA  1966     4.05    -6.25 -0.467    -9.02    19
##  8 AUSTRIA  1967     4.05    -6.23 -0.506    -8.93    19
##  9 AUSTRIA  1968     4.05    -6.21 -0.522    -8.85    19
## 10 AUSTRIA  1969     4.05    -6.15 -0.559    -8.79    19
## # ‚Ä¶ with 332 more rows</code></pre>
<p>Using <code>mutate()</code> I‚Äôve added a column that counts how many times the country appears in the <code>tibble</code>,
using <code>n()</code>, another <code>dplyr</code> function. There‚Äôs also <code>count()</code> and <code>tally()</code>, which we are going to
see further down. It is also possible to rename the column on the fly:</p>
<pre class="sourceCode r"><code class="sourceCode r">gasoline <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">group_by</span>(country) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">count =</span> <span class="kw">n</span>())</code></pre>
<pre><code>## # A tibble: 342 x 7
## # Groups:   country [18]
##    country  year lgaspcar lincomep  lrpmg lcarpcap count
##    &lt;fct&gt;   &lt;int&gt;    &lt;dbl&gt;    &lt;dbl&gt;  &lt;dbl&gt;    &lt;dbl&gt; &lt;int&gt;
##  1 AUSTRIA  1960     4.17    -6.47 -0.335    -9.77    19
##  2 AUSTRIA  1961     4.10    -6.43 -0.351    -9.61    19
##  3 AUSTRIA  1962     4.07    -6.41 -0.380    -9.46    19
##  4 AUSTRIA  1963     4.06    -6.37 -0.414    -9.34    19
##  5 AUSTRIA  1964     4.04    -6.32 -0.445    -9.24    19
##  6 AUSTRIA  1965     4.03    -6.29 -0.497    -9.12    19
##  7 AUSTRIA  1966     4.05    -6.25 -0.467    -9.02    19
##  8 AUSTRIA  1967     4.05    -6.23 -0.506    -8.93    19
##  9 AUSTRIA  1968     4.05    -6.21 -0.522    -8.85    19
## 10 AUSTRIA  1969     4.05    -6.15 -0.559    -8.79    19
## # ‚Ä¶ with 332 more rows</code></pre>
<p>It is possible to do any arbitrary operation:</p>
<pre class="sourceCode r"><code class="sourceCode r">gasoline <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">group_by</span>(country) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">spam =</span> <span class="kw">exp</span>(lgaspcar <span class="op">+</span><span class="st"> </span>lincomep))</code></pre>
<pre><code>## # A tibble: 342 x 7
## # Groups:   country [18]
##    country  year lgaspcar lincomep  lrpmg lcarpcap   spam
##    &lt;fct&gt;   &lt;int&gt;    &lt;dbl&gt;    &lt;dbl&gt;  &lt;dbl&gt;    &lt;dbl&gt;  &lt;dbl&gt;
##  1 AUSTRIA  1960     4.17    -6.47 -0.335    -9.77 0.100 
##  2 AUSTRIA  1961     4.10    -6.43 -0.351    -9.61 0.0978
##  3 AUSTRIA  1962     4.07    -6.41 -0.380    -9.46 0.0969
##  4 AUSTRIA  1963     4.06    -6.37 -0.414    -9.34 0.0991
##  5 AUSTRIA  1964     4.04    -6.32 -0.445    -9.24 0.102 
##  6 AUSTRIA  1965     4.03    -6.29 -0.497    -9.12 0.104 
##  7 AUSTRIA  1966     4.05    -6.25 -0.467    -9.02 0.110 
##  8 AUSTRIA  1967     4.05    -6.23 -0.506    -8.93 0.113 
##  9 AUSTRIA  1968     4.05    -6.21 -0.522    -8.85 0.115 
## 10 AUSTRIA  1969     4.05    -6.15 -0.559    -8.79 0.122 
## # ‚Ä¶ with 332 more rows</code></pre>
<p><code>transmute()</code> is the same as <code>mutate()</code>, but only returns the created variable:</p>
<pre class="sourceCode r"><code class="sourceCode r">gasoline <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">group_by</span>(country) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">transmute</span>(<span class="dt">spam =</span> <span class="kw">exp</span>(lgaspcar <span class="op">+</span><span class="st"> </span>lincomep))</code></pre>
<pre><code>## # A tibble: 342 x 2
## # Groups:   country [18]
##    country   spam
##    &lt;fct&gt;    &lt;dbl&gt;
##  1 AUSTRIA 0.100 
##  2 AUSTRIA 0.0978
##  3 AUSTRIA 0.0969
##  4 AUSTRIA 0.0991
##  5 AUSTRIA 0.102 
##  6 AUSTRIA 0.104 
##  7 AUSTRIA 0.110 
##  8 AUSTRIA 0.113 
##  9 AUSTRIA 0.115 
## 10 AUSTRIA 0.122 
## # ‚Ä¶ with 332 more rows</code></pre>
</div>
<div id="joining-tibbles-with-full_join-left_join-right_join-and-all-the-others" class="section level3">
<h3><span class="header-section-number">4.3.7</span> Joining <code>tibble</code>s with <code>full_join()</code>, <code>left_join()</code>, <code>right_join()</code> and all the others</h3>
<p>I will end this section on <code>dplyr</code> with the very useful verbs: the <code>*_join()</code> verbs. Let‚Äôs first
start by loading another dataset from the <code>plm</code> package. <code>SumHes</code> and let‚Äôs convert it to <code>tibble</code>
and rename it:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">data</span>(SumHes, <span class="dt">package =</span> <span class="st">&quot;plm&quot;</span>)

pwt &lt;-<span class="st"> </span>SumHes <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">as_tibble</span>() <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">country =</span> <span class="kw">tolower</span>(country))</code></pre>
<p>Let‚Äôs take a quick look at the data:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">glimpse</span>(pwt)</code></pre>
<pre><code>## Observations: 3,250
## Variables: 7
## $ year    &lt;int&gt; 1960, 1961, 1962, 1963, 1964, 1965, 1966, 1967, 1968, 19‚Ä¶
## $ country &lt;chr&gt; &quot;algeria&quot;, &quot;algeria&quot;, &quot;algeria&quot;, &quot;algeria&quot;, &quot;algeria&quot;, &quot;‚Ä¶
## $ opec    &lt;fct&gt; no, no, no, no, no, no, no, no, no, no, no, no, no, no, ‚Ä¶
## $ com     &lt;fct&gt; no, no, no, no, no, no, no, no, no, no, no, no, no, no, ‚Ä¶
## $ pop     &lt;int&gt; 10800, 11016, 11236, 11460, 11690, 11923, 12267, 12622, ‚Ä¶
## $ gdp     &lt;int&gt; 1723, 1599, 1275, 1517, 1589, 1584, 1548, 1600, 1758, 18‚Ä¶
## $ sr      &lt;dbl&gt; 19.9, 21.1, 15.0, 13.9, 10.6, 11.0, 8.3, 11.3, 15.1, 18.‚Ä¶</code></pre>
<p>We can merge both <code>gasoline</code> and <code>pwt</code> by country and year, as these two variables are common to
both datasets. There are more countries and years in the <code>pwt</code> dataset, so when merging both, and
depending on which function you use, you will either have <code>NA</code>‚Äôs for the variables where there is
no match, or rows that will be dropped. Let‚Äôs start with <code>full_join</code>:</p>
<pre class="sourceCode r"><code class="sourceCode r">gas_pwt_full &lt;-<span class="st"> </span>gasoline <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">full_join</span>(pwt, <span class="dt">by =</span> <span class="kw">c</span>(<span class="st">&quot;country&quot;</span>, <span class="st">&quot;year&quot;</span>))</code></pre>
<pre><code>## Warning: Column `country` joining factor and character vector, coercing
## into character vector</code></pre>
<p>Let‚Äôs see which countries and years are included:</p>
<pre class="sourceCode r"><code class="sourceCode r">gas_pwt_full <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">count</span>(country, year)</code></pre>
<pre><code>## # A tibble: 3,592 x 3
##    country  year     n
##    &lt;chr&gt;   &lt;int&gt; &lt;int&gt;
##  1 algeria  1960     1
##  2 algeria  1961     1
##  3 algeria  1962     1
##  4 algeria  1963     1
##  5 algeria  1964     1
##  6 algeria  1965     1
##  7 algeria  1966     1
##  8 algeria  1967     1
##  9 algeria  1968     1
## 10 algeria  1969     1
## # ‚Ä¶ with 3,582 more rows</code></pre>
<p>As you see, every country and year was included, but what happened for, say, the U.S.S.R? This country
is in <code>pwt</code> but not in <code>gasoline</code> at all:</p>
<pre class="sourceCode r"><code class="sourceCode r">gas_pwt_full <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">filter</span>(country <span class="op">==</span><span class="st"> &quot;u.s.s.r.&quot;</span>)</code></pre>
<pre><code>## # A tibble: 26 x 11
##    country  year lgaspcar lincomep lrpmg lcarpcap opec  com      pop   gdp
##    &lt;chr&gt;   &lt;int&gt;    &lt;dbl&gt;    &lt;dbl&gt; &lt;dbl&gt;    &lt;dbl&gt; &lt;fct&gt; &lt;fct&gt;  &lt;int&gt; &lt;int&gt;
##  1 u.s.s.‚Ä¶  1960       NA       NA    NA       NA no    yes   214400  2397
##  2 u.s.s.‚Ä¶  1961       NA       NA    NA       NA no    yes   217896  2542
##  3 u.s.s.‚Ä¶  1962       NA       NA    NA       NA no    yes   221449  2656
##  4 u.s.s.‚Ä¶  1963       NA       NA    NA       NA no    yes   225060  2681
##  5 u.s.s.‚Ä¶  1964       NA       NA    NA       NA no    yes   227571  2854
##  6 u.s.s.‚Ä¶  1965       NA       NA    NA       NA no    yes   230109  3049
##  7 u.s.s.‚Ä¶  1966       NA       NA    NA       NA no    yes   232676  3247
##  8 u.s.s.‚Ä¶  1967       NA       NA    NA       NA no    yes   235272  3454
##  9 u.s.s.‚Ä¶  1968       NA       NA    NA       NA no    yes   237896  3730
## 10 u.s.s.‚Ä¶  1969       NA       NA    NA       NA no    yes   240550  3808
## # ‚Ä¶ with 16 more rows, and 1 more variable: sr &lt;dbl&gt;</code></pre>
<p>As you probably guessed, the variables from <code>gasoline</code> that are not included in <code>pwt</code> are filled with
<code>NA</code>s. One could remove all these lines and only keep countries for which these variables are not
<code>NA</code> everywhere with <code>filter()</code>, but there is a simpler solution:</p>
<pre class="sourceCode r"><code class="sourceCode r">gas_pwt_inner &lt;-<span class="st"> </span>gasoline <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">inner_join</span>(pwt, <span class="dt">by =</span> <span class="kw">c</span>(<span class="st">&quot;country&quot;</span>, <span class="st">&quot;year&quot;</span>))</code></pre>
<pre><code>## Warning: Column `country` joining factor and character vector, coercing
## into character vector</code></pre>
<p>Let‚Äôs use the <code>tabyl()</code> from the <code>janitor</code> packages which is a very nice alternative to the <code>table()</code>
function from base R:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(janitor)

gas_pwt_inner <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">tabyl</span>(country)</code></pre>
<pre><code>## [1] country n       percent
## &lt;0 rows&gt; (or 0-length row.names)</code></pre>
<p>Only countries with values in both datasets were returned. It‚Äôs almost every country from <code>gasoline</code>,
apart from Germany (called ‚Äúgermany west‚Äù in <code>pwt</code> and ‚Äúgermany‚Äù in <code>gasoline</code>. I left it as is to
provide an example of a country not in <code>pwt</code>). Let‚Äôs also look at the variables:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">glimpse</span>(gas_pwt_inner)</code></pre>
<pre><code>## Observations: 0
## Variables: 11
## $ country  &lt;chr&gt; 
## $ year     &lt;int&gt; 
## $ lgaspcar &lt;dbl&gt; 
## $ lincomep &lt;dbl&gt; 
## $ lrpmg    &lt;dbl&gt; 
## $ lcarpcap &lt;dbl&gt; 
## $ opec     &lt;fct&gt; 
## $ com      &lt;fct&gt; 
## $ pop      &lt;int&gt; 
## $ gdp      &lt;int&gt; 
## $ sr       &lt;dbl&gt;</code></pre>
<p>The variables from both datasets are in the joined data.</p>
<p>Contrast this to <code>semi_join()</code>:</p>
<pre class="sourceCode r"><code class="sourceCode r">gas_pwt_semi &lt;-<span class="st"> </span>gasoline <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">semi_join</span>(pwt, <span class="dt">by =</span> <span class="kw">c</span>(<span class="st">&quot;country&quot;</span>, <span class="st">&quot;year&quot;</span>))</code></pre>
<pre><code>## Warning: Column `country` joining factor and character vector, coercing
## into character vector</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">glimpse</span>(gas_pwt_semi)</code></pre>
<pre><code>## Observations: 0
## Variables: 6
## $ country  &lt;fct&gt; 
## $ year     &lt;int&gt; 
## $ lgaspcar &lt;dbl&gt; 
## $ lincomep &lt;dbl&gt; 
## $ lrpmg    &lt;dbl&gt; 
## $ lcarpcap &lt;dbl&gt;</code></pre>
<pre class="sourceCode r"><code class="sourceCode r">gas_pwt_semi <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">tabyl</span>(country)</code></pre>
<pre><code>## Warning: Factor `dat` contains implicit NA, consider using
## `forcats::fct_explicit_na`</code></pre>
<pre><code>##   country n percent
##   AUSTRIA 0     NaN
##   BELGIUM 0     NaN
##    CANADA 0     NaN
##   DENMARK 0     NaN
##    FRANCE 0     NaN
##   GERMANY 0     NaN
##    GREECE 0     NaN
##   IRELAND 0     NaN
##     ITALY 0     NaN
##     JAPAN 0     NaN
##  NETHERLA 0     NaN
##    NORWAY 0     NaN
##     SPAIN 0     NaN
##    SWEDEN 0     NaN
##  SWITZERL 0     NaN
##    TURKEY 0     NaN
##      U.K. 0     NaN
##    U.S.A. 0     NaN</code></pre>
<p>Only columns of <code>gasoline</code> are returned, and only rows of <code>gasoline</code> that were matched with rows
from <code>pwt</code>. <code>semi_join()</code> is not a commutative operation:</p>
<pre class="sourceCode r"><code class="sourceCode r">pwt_gas_semi &lt;-<span class="st"> </span>pwt <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">semi_join</span>(gasoline, <span class="dt">by =</span> <span class="kw">c</span>(<span class="st">&quot;country&quot;</span>, <span class="st">&quot;year&quot;</span>))</code></pre>
<pre><code>## Warning: Column `country` joining character vector and factor, coercing
## into character vector</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">glimpse</span>(pwt_gas_semi)</code></pre>
<pre><code>## Observations: 0
## Variables: 7
## $ year    &lt;int&gt; 
## $ country &lt;chr&gt; 
## $ opec    &lt;fct&gt; 
## $ com     &lt;fct&gt; 
## $ pop     &lt;int&gt; 
## $ gdp     &lt;int&gt; 
## $ sr      &lt;dbl&gt;</code></pre>
<pre class="sourceCode r"><code class="sourceCode r">gas_pwt_semi <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">tabyl</span>(country)</code></pre>
<pre><code>## Warning: Factor `dat` contains implicit NA, consider using
## `forcats::fct_explicit_na`</code></pre>
<pre><code>##   country n percent
##   AUSTRIA 0     NaN
##   BELGIUM 0     NaN
##    CANADA 0     NaN
##   DENMARK 0     NaN
##    FRANCE 0     NaN
##   GERMANY 0     NaN
##    GREECE 0     NaN
##   IRELAND 0     NaN
##     ITALY 0     NaN
##     JAPAN 0     NaN
##  NETHERLA 0     NaN
##    NORWAY 0     NaN
##     SPAIN 0     NaN
##    SWEDEN 0     NaN
##  SWITZERL 0     NaN
##    TURKEY 0     NaN
##      U.K. 0     NaN
##    U.S.A. 0     NaN</code></pre>
<p>The rows are the same, but not the columns.</p>
<p><code>left_join()</code> and <code>right_join()</code> return all the rows from either the dataset that is on the
‚Äúleft‚Äù (the first argument of the fonction) or on the ‚Äúright‚Äù (the second argument of the
function) but all columns from both datasets. So depending on which countries you‚Äôre interested in,
you‚Äôre going to use either one of these functions:</p>
<pre class="sourceCode r"><code class="sourceCode r">gas_pwt_left &lt;-<span class="st"> </span>gasoline <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">left_join</span>(pwt, <span class="dt">by =</span> <span class="kw">c</span>(<span class="st">&quot;country&quot;</span>, <span class="st">&quot;year&quot;</span>))</code></pre>
<pre><code>## Warning: Column `country` joining factor and character vector, coercing
## into character vector</code></pre>
<pre class="sourceCode r"><code class="sourceCode r">gas_pwt_left <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">tabyl</span>(country)</code></pre>
<pre><code>##   country  n    percent
##   AUSTRIA 19 0.05555556
##   BELGIUM 19 0.05555556
##    CANADA 19 0.05555556
##   DENMARK 19 0.05555556
##    FRANCE 19 0.05555556
##   GERMANY 19 0.05555556
##    GREECE 19 0.05555556
##   IRELAND 19 0.05555556
##     ITALY 19 0.05555556
##     JAPAN 19 0.05555556
##  NETHERLA 19 0.05555556
##    NORWAY 19 0.05555556
##     SPAIN 19 0.05555556
##    SWEDEN 19 0.05555556
##  SWITZERL 19 0.05555556
##    TURKEY 19 0.05555556
##      U.K. 19 0.05555556
##    U.S.A. 19 0.05555556</code></pre>
<pre class="sourceCode r"><code class="sourceCode r">gas_pwt_right &lt;-<span class="st"> </span>gasoline <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">right_join</span>(pwt, <span class="dt">by =</span> <span class="kw">c</span>(<span class="st">&quot;country&quot;</span>, <span class="st">&quot;year&quot;</span>))</code></pre>
<pre><code>## Warning: Column `country` joining factor and character vector, coercing
## into character vector</code></pre>
<pre class="sourceCode r"><code class="sourceCode r">gas_pwt_right <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">tabyl</span>(country)</code></pre>
<pre><code>##          country  n percent
##          algeria 26   0.008
##           angola 26   0.008
##        argentina 26   0.008
##        australia 26   0.008
##          austria 26   0.008
##       bangladesh 26   0.008
##         barbados 26   0.008
##          belgium 26   0.008
##            benin 26   0.008
##          bolivia 26   0.008
##         botswana 26   0.008
##           brazil 26   0.008
##     burkina faso 26   0.008
##          burundi 26   0.008
##         cameroon 26   0.008
##           canada 26   0.008
##   cape verde is. 26   0.008
##   central afr.r. 26   0.008
##             chad 26   0.008
##            chile 26   0.008
##            china 26   0.008
##         colombia 26   0.008
##          comoros 26   0.008
##            congo 26   0.008
##       costa rica 26   0.008
##           cyprus 26   0.008
##   czechoslovakia 26   0.008
##          denmark 26   0.008
##   dominican rep. 26   0.008
##          ecuador 26   0.008
##            egypt 26   0.008
##      el salvador 26   0.008
##         ethiopia 26   0.008
##             fiji 26   0.008
##          finland 26   0.008
##           france 26   0.008
##            gabon 26   0.008
##           gambia 26   0.008
##     germany west 26   0.008
##            ghana 26   0.008
##           greece 26   0.008
##        guatemala 26   0.008
##           guinea 26   0.008
##      guinea-biss 26   0.008
##           guyana 26   0.008
##            haiti 26   0.008
##         honduras 26   0.008
##        hong kong 26   0.008
##          iceland 26   0.008
##            india 26   0.008
##        indonesia 26   0.008
##             iran 26   0.008
##             iraq 26   0.008
##          ireland 26   0.008
##           israel 26   0.008
##            italy 26   0.008
##      ivory coast 26   0.008
##          jamaica 26   0.008
##            japan 26   0.008
##           jordan 26   0.008
##            kenya 26   0.008
##            korea 26   0.008
##          lesotho 26   0.008
##          liberia 26   0.008
##       luxembourg 26   0.008
##       madagascar 26   0.008
##           malawi 26   0.008
##         malaysia 26   0.008
##             mali 26   0.008
##            malta 26   0.008
##       mauritania 26   0.008
##        mauritius 26   0.008
##           mexico 26   0.008
##          morocco 26   0.008
##       mozambique 26   0.008
##          myanmar 26   0.008
##          namibia 26   0.008
##            nepal 26   0.008
##      netherlands 26   0.008
##      new zealand 26   0.008
##        nicaragua 26   0.008
##            niger 26   0.008
##          nigeria 26   0.008
##           norway 26   0.008
##         pakistan 26   0.008
##           panama 26   0.008
##  papua n.guinea  26   0.008
##         paraguay 26   0.008
##             peru 26   0.008
##      philippines 26   0.008
##         portugal 26   0.008
##      puerto rico 26   0.008
##          reunion 26   0.008
##          romania 26   0.008
##           rwanda 26   0.008
##     saudi arabia 26   0.008
##          senegal 26   0.008
##       seychelles 26   0.008
##        singapore 26   0.008
##          somalia 26   0.008
##     south africa 26   0.008
##            spain 26   0.008
##        sri lanka 26   0.008
##         suriname 26   0.008
##        swaziland 26   0.008
##           sweden 26   0.008
##      switzerland 26   0.008
##            syria 26   0.008
##           taiwan 26   0.008
##         tanzania 26   0.008
##         thailand 26   0.008
##             togo 26   0.008
##  trinidad&amp;tobago 26   0.008
##          tunisia 26   0.008
##           turkey 26   0.008
##             u.k. 26   0.008
##           u.s.a. 26   0.008
##         u.s.s.r. 26   0.008
##           uganda 26   0.008
##          uruguay 26   0.008
##        venezuela 26   0.008
##       yugoslavia 26   0.008
##            zaire 26   0.008
##           zambia 26   0.008
##         zimbabwe 26   0.008</code></pre>
<p>The last merge function is <code>anti_join()</code>:</p>
<pre class="sourceCode r"><code class="sourceCode r">gas_pwt_anti &lt;-<span class="st"> </span>gasoline <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">anti_join</span>(pwt, <span class="dt">by =</span> <span class="kw">c</span>(<span class="st">&quot;country&quot;</span>, <span class="st">&quot;year&quot;</span>))</code></pre>
<pre><code>## Warning: Column `country` joining factor and character vector, coercing
## into character vector</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">glimpse</span>(gas_pwt_anti)</code></pre>
<pre><code>## Observations: 342
## Variables: 6
## $ country  &lt;fct&gt; AUSTRIA, AUSTRIA, AUSTRIA, AUSTRIA, AUSTRIA, AUSTRIA, A‚Ä¶
## $ year     &lt;int&gt; 1960, 1961, 1962, 1963, 1964, 1965, 1966, 1967, 1968, 1‚Ä¶
## $ lgaspcar &lt;dbl&gt; 4.173244, 4.100989, 4.073177, 4.059509, 4.037689, 4.033‚Ä¶
## $ lincomep &lt;dbl&gt; -6.474277, -6.426006, -6.407308, -6.370679, -6.322247, ‚Ä¶
## $ lrpmg    &lt;dbl&gt; -0.3345476, -0.3513276, -0.3795177, -0.4142514, -0.4453‚Ä¶
## $ lcarpcap &lt;dbl&gt; -9.766840, -9.608622, -9.457257, -9.343155, -9.237739, ‚Ä¶</code></pre>
<pre class="sourceCode r"><code class="sourceCode r">gas_pwt_anti <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">tabyl</span>(country)</code></pre>
<pre><code>##   country  n    percent
##   AUSTRIA 19 0.05555556
##   BELGIUM 19 0.05555556
##    CANADA 19 0.05555556
##   DENMARK 19 0.05555556
##    FRANCE 19 0.05555556
##   GERMANY 19 0.05555556
##    GREECE 19 0.05555556
##   IRELAND 19 0.05555556
##     ITALY 19 0.05555556
##     JAPAN 19 0.05555556
##  NETHERLA 19 0.05555556
##    NORWAY 19 0.05555556
##     SPAIN 19 0.05555556
##    SWEDEN 19 0.05555556
##  SWITZERL 19 0.05555556
##    TURKEY 19 0.05555556
##      U.K. 19 0.05555556
##    U.S.A. 19 0.05555556</code></pre>
<p><code>gas_pwt_anti</code> has the columns the <code>gasoline</code> dataset as well as the only country from <code>gasoline</code>
that is not in <code>pwt</code>: ‚Äúgermany‚Äù.</p>
<p>That was it for the basic <code>{dplyr}</code> verbs. Next, we‚Äôre going to learn about <code>{tidyr}</code>.</p>
</div>
</div>
<div id="reshaping-data-with-tidyr" class="section level2">
<h2><span class="header-section-number">4.4</span> Reshaping data with <code>tidyr</code></h2>
<p>Another important package from the <code>tidyverse</code> that goes hand in hand with <code>dplyr</code> is <code>tidyr</code>. <code>tidyr</code>
is the package you need when it‚Äôs time to reshape data. As of March 2019, the development version
of <code>tidyr</code> introduced two new functions that make reshaping data easier, <code>pivot_long()</code> and <code>pivot_wide()</code>.
To install the development version of <code>tidyr</code>, use the following line:</p>
<pre class="sourceCode r"><code class="sourceCode r">devtools<span class="op">::</span><span class="kw">install_github</span>(<span class="st">&quot;tidyverse/tidyr&quot;</span>)</code></pre>
<p>The legacy functions, <code>spread()</code> and <code>gather()</code> will remain in the package but their use will be
discouraged.</p>
<p>I will start by presenting <code>pivot_wide()</code> and <code>pivot_long()</code>, and then, for reference, will show
how to solve the similar problems using <code>gather()</code> and <code>spread()</code>.</p>
<div id="pivot_wide-and-pivot_long" class="section level3">
<h3><span class="header-section-number">4.4.1</span> <code>pivot_wide()</code> and <code>pivot_long()</code></h3>
<p>Let‚Äôs first create a fake dataset:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(tidyr)</code></pre>
<pre class="sourceCode r"><code class="sourceCode r">survey_data &lt;-<span class="st"> </span><span class="kw">tribble</span>(
  <span class="op">~</span>id, <span class="op">~</span>variable, <span class="op">~</span>value,
  <span class="dv">1</span>, <span class="st">&quot;var1&quot;</span>, <span class="dv">1</span>,
  <span class="dv">1</span>, <span class="st">&quot;var2&quot;</span>, <span class="fl">0.2</span>,
  <span class="ot">NA</span>, <span class="st">&quot;var3&quot;</span>, <span class="fl">0.3</span>,
  <span class="dv">2</span>, <span class="st">&quot;var1&quot;</span>, <span class="fl">1.4</span>,
  <span class="dv">2</span>, <span class="st">&quot;var2&quot;</span>, <span class="fl">1.9</span>,
  <span class="dv">2</span>, <span class="st">&quot;var3&quot;</span>, <span class="fl">4.1</span>,
  <span class="dv">3</span>, <span class="st">&quot;var1&quot;</span>, <span class="fl">0.1</span>,
  <span class="dv">3</span>, <span class="st">&quot;var2&quot;</span>, <span class="fl">2.8</span>,
  <span class="dv">3</span>, <span class="st">&quot;var3&quot;</span>, <span class="fl">8.9</span>,
  <span class="dv">4</span>, <span class="st">&quot;var1&quot;</span>, <span class="fl">1.7</span>,
  <span class="ot">NA</span>, <span class="st">&quot;var2&quot;</span>, <span class="fl">1.9</span>,
  <span class="dv">4</span>, <span class="st">&quot;var3&quot;</span>, <span class="fl">7.6</span>
)

<span class="kw">head</span>(survey_data)</code></pre>
<pre><code>## # A tibble: 6 x 3
##      id variable value
##   &lt;dbl&gt; &lt;chr&gt;    &lt;dbl&gt;
## 1     1 var1       1  
## 2     1 var2       0.2
## 3    NA var3       0.3
## 4     2 var1       1.4
## 5     2 var2       1.9
## 6     2 var3       4.1</code></pre>
<p>I used the <code>tribble()</code> function from the <code>{tibble}</code> package to create this fake dataset.
I‚Äôll discuss this package later, for now, let‚Äôs focus on <code>{tidyr}.</code></p>
<p>Let‚Äôs suppose that we need the data to be in the wide format which means <code>var1</code>, <code>var2</code> and <code>var3</code>
need to be their own columns. To do this, we need to use the <code>pivot_wide()</code> function. Why <em>wide</em>?
Because the data set will be wide, meaning, having more columns than rows.</p>
<pre class="sourceCode r"><code class="sourceCode r">survey_data <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">pivot_wide</span>(<span class="dt">keys =</span> id, <span class="dt">names_from =</span> variable, <span class="dt">values_from =</span> value)</code></pre>
<pre><code>## # A tibble: 5 x 4
##      id  var1  var2  var3
##   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
## 1     1   1     0.2  NA  
## 2    NA  NA     1.9   0.3
## 3     2   1.4   1.9   4.1
## 4     3   0.1   2.8   8.9
## 5     4   1.7  NA     7.6</code></pre>
<p>Let‚Äôs go through <code>pivot_wide()</code>‚Äôs arguments: the first is <code>keys =</code> which requires the variable
that uniquely identifies the rows to be supplied. <code>names_from =</code> is where you input the variable that will
generate the names of the new columns. In our case, the <code>variable</code> colmuns has three values; <code>var1</code>,
<code>var2</code> and <code>var3</code>, and these are now the names of the new columns. Finally, <code>values_from =</code> is where
you can specify the column containing the values that will fill the data frame.
I find the argument names <code>names_from =</code> and <code>values_from =</code> quite explicit.</p>
<p>As you can see, there are some missing values. Let‚Äôs suppose that we know that these missing values
are true 0‚Äôs. <code>pivot_wide()</code> has an argument called <code>values_fill =</code> that makes it easy to replace
the missing values:</p>
<pre class="sourceCode r"><code class="sourceCode r">survey_data <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">pivot_wide</span>(<span class="dt">keys =</span> id, <span class="dt">names_from =</span> variable, <span class="dt">values_from =</span> value, <span class="dt">values_fill =</span> <span class="kw">list</span>(<span class="dt">value =</span> <span class="dv">0</span>))</code></pre>
<pre><code>## # A tibble: 5 x 4
##      id  var1  var2  var3
##   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
## 1     1   1     0.2   0  
## 2    NA   0     1.9   0.3
## 3     2   1.4   1.9   4.1
## 4     3   0.1   2.8   8.9
## 5     4   1.7   0     7.6</code></pre>
<p>A list of variables and their respective values to replace NA‚Äôs with must be supplied to <code>values_fill</code>.</p>
<p>Let‚Äôs now use another dataset, which you can get from
<a href="https://github.com/b-rodrigues/modern_R/tree/master/datasets/unemployment/all">here</a>
(downloaded from: <a href="http://www.statistiques.public.lu/stat/TableViewer/tableView.aspx?ReportId=12950&amp;IF_Language=eng&amp;MainTheme=2&amp;FldrName=3&amp;RFPath=91" class="uri">http://www.statistiques.public.lu/stat/TableViewer/tableView.aspx?ReportId=12950&amp;IF_Language=eng&amp;MainTheme=2&amp;FldrName=3&amp;RFPath=91</a>). This data set gives the unemployment rate for each Luxembourguish
canton from 2001 to 2015. We will come back to this data later on to learn how to plot it. For now,
let‚Äôs use it to learn more about <code>{tidyr}</code>.</p>
<pre class="sourceCode r"><code class="sourceCode r">unemp_lux_data &lt;-<span class="st"> </span>rio<span class="op">::</span><span class="kw">import</span>(<span class="st">&quot;datasets/unemployment/all/unemployment_lux_all.csv&quot;</span>)

<span class="kw">head</span>(unemp_lux_data)</code></pre>
<pre><code>##   division year active_population of_which_non_wage_earners
## 1 Beaufort 2001               688                        85
## 2 Beaufort 2002               742                        85
## 3 Beaufort 2003               773                        85
## 4 Beaufort 2004               828                        80
## 5 Beaufort 2005               866                        96
## 6 Beaufort 2006               893                        87
##   of_which_wage_earners total_employed_population unemployed
## 1                   568                       653         35
## 2                   631                       716         26
## 3                   648                       733         40
## 4                   706                       786         42
## 5                   719                       815         51
## 6                   746                       833         60
##   unemployment_rate_in_percent
## 1                         5.09
## 2                         3.50
## 3                         5.17
## 4                         5.07
## 5                         5.89
## 6                         6.72</code></pre>
<p>Now, let‚Äôs suppose that for our purposes, it would make more sense to have the data in a wide format,
where columns are ‚Äúdivison times year‚Äù and the value is the unemployment rate. This can be easily done
with providing more columns to <code>names_from =</code>.</p>
<pre class="sourceCode r"><code class="sourceCode r">unemp_lux_data2 &lt;-<span class="st"> </span>unemp_lux_data <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">filter</span>(year <span class="op">%in%</span><span class="st"> </span><span class="kw">seq</span>(<span class="dv">2013</span>, <span class="dv">2017</span>), <span class="kw">str_detect</span>(division, <span class="st">&quot;.*ange$&quot;</span>), <span class="op">!</span><span class="kw">str_detect</span>(division, <span class="st">&quot;.*Canton.*&quot;</span>)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">select</span>(division, year, unemployment_rate_in_percent) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">rowid_to_column</span>()

unemp_lux_data2 <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">pivot_wide</span>(<span class="dt">names_from =</span> <span class="kw">c</span>(division, year), <span class="dt">values_from =</span> unemployment_rate_in_percent)</code></pre>
<pre><code>## # A tibble: 48 x 49
##    rowid Bertrange_2013 Bertrange_2014 Bertrange_2015 Differdange_2013
##    &lt;int&gt;          &lt;dbl&gt;          &lt;dbl&gt;          &lt;dbl&gt;            &lt;dbl&gt;
##  1     1           5.69          NA             NA                NA  
##  2     2          NA              5.65          NA                NA  
##  3     3          NA             NA              5.35             NA  
##  4     4          NA             NA             NA                13.2
##  5     5          NA             NA             NA                NA  
##  6     6          NA             NA             NA                NA  
##  7     7          NA             NA             NA                NA  
##  8     8          NA             NA             NA                NA  
##  9     9          NA             NA             NA                NA  
## 10    10          NA             NA             NA                NA  
## # ‚Ä¶ with 38 more rows, and 44 more variables: Differdange_2014 &lt;dbl&gt;,
## #   Differdange_2015 &lt;dbl&gt;, Dudelange_2013 &lt;dbl&gt;, Dudelange_2014 &lt;dbl&gt;,
## #   Dudelange_2015 &lt;dbl&gt;, Frisange_2013 &lt;dbl&gt;, Frisange_2014 &lt;dbl&gt;,
## #   Frisange_2015 &lt;dbl&gt;, Hesperange_2013 &lt;dbl&gt;, Hesperange_2014 &lt;dbl&gt;,
## #   Hesperange_2015 &lt;dbl&gt;, Leudelange_2013 &lt;dbl&gt;, Leudelange_2014 &lt;dbl&gt;,
## #   Leudelange_2015 &lt;dbl&gt;, Mondercange_2013 &lt;dbl&gt;, Mondercange_2014 &lt;dbl&gt;,
## #   Mondercange_2015 &lt;dbl&gt;, P√©tange_2013 &lt;dbl&gt;, P√©tange_2014 &lt;dbl&gt;,
## #   P√©tange_2015 &lt;dbl&gt;, Rumelange_2013 &lt;dbl&gt;, Rumelange_2014 &lt;dbl&gt;,
## #   Rumelange_2015 &lt;dbl&gt;, Schifflange_2013 &lt;dbl&gt;, Schifflange_2014 &lt;dbl&gt;,
## #   Schifflange_2015 &lt;dbl&gt;, Schuttrange_2013 &lt;dbl&gt;,
## #   Schuttrange_2014 &lt;dbl&gt;, Schuttrange_2015 &lt;dbl&gt;, Tuntange_2013 &lt;dbl&gt;,
## #   Tuntange_2014 &lt;dbl&gt;, Tuntange_2015 &lt;dbl&gt;, Useldange_2013 &lt;dbl&gt;,
## #   Useldange_2014 &lt;dbl&gt;, Useldange_2015 &lt;dbl&gt;, Walferdange_2013 &lt;dbl&gt;,
## #   Walferdange_2014 &lt;dbl&gt;, Walferdange_2015 &lt;dbl&gt;, Wincrange_2013 &lt;dbl&gt;,
## #   Wincrange_2014 &lt;dbl&gt;, Wincrange_2015 &lt;dbl&gt;, Wormeldange_2013 &lt;dbl&gt;,
## #   Wormeldange_2014 &lt;dbl&gt;, Wormeldange_2015 &lt;dbl&gt;</code></pre>
<p>In the <code>filter()</code> statement, I only kept data from 2013 to 2017, ‚Äúdivision‚Äùs ending with the string ‚Äúange‚Äù
(‚Äúdivision‚Äù can be a canton or a commune, for example ‚ÄúCanton Redange‚Äù, a canton, or ‚ÄúHesperange‚Äù a commune),
and removed the cantons as I‚Äôm only interested in communes.
I then only kept the columns I‚Äôm interested in and pivoted the data to a wide format.
Also, I needed to add a unique identifier to the data frame. For this, I used <code>rowid_to_column()</code> function,
from the <code>{tibble}</code> package, which adds a new column to the data frame with an id, going from 1 to
the number of rows in the data frame. If I did not add this identifier, the statement would work still:</p>
<pre class="sourceCode r"><code class="sourceCode r">unemp_lux_data3 &lt;-<span class="st"> </span>unemp_lux_data <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">filter</span>(year <span class="op">%in%</span><span class="st"> </span><span class="kw">seq</span>(<span class="dv">2013</span>, <span class="dv">2017</span>), <span class="kw">str_detect</span>(division, <span class="st">&quot;.*ange$&quot;</span>), <span class="op">!</span><span class="kw">str_detect</span>(division, <span class="st">&quot;.*Canton.*&quot;</span>)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">select</span>(division, year, unemployment_rate_in_percent)

unemp_lux_data3 <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">pivot_wide</span>(<span class="dt">names_from =</span> <span class="kw">c</span>(division, year), <span class="dt">values_from =</span> unemployment_rate_in_percent)</code></pre>
<pre><code>## # A tibble: 1 x 48
##   Bertrange_2013 Bertrange_2014 Bertrange_2015 Differdange_2013
##            &lt;dbl&gt;          &lt;dbl&gt;          &lt;dbl&gt;            &lt;dbl&gt;
## 1           5.69           5.65           5.35             13.2
## # ‚Ä¶ with 44 more variables: Differdange_2014 &lt;dbl&gt;,
## #   Differdange_2015 &lt;dbl&gt;, Dudelange_2013 &lt;dbl&gt;, Dudelange_2014 &lt;dbl&gt;,
## #   Dudelange_2015 &lt;dbl&gt;, Frisange_2013 &lt;dbl&gt;, Frisange_2014 &lt;dbl&gt;,
## #   Frisange_2015 &lt;dbl&gt;, Hesperange_2013 &lt;dbl&gt;, Hesperange_2014 &lt;dbl&gt;,
## #   Hesperange_2015 &lt;dbl&gt;, Leudelange_2013 &lt;dbl&gt;, Leudelange_2014 &lt;dbl&gt;,
## #   Leudelange_2015 &lt;dbl&gt;, Mondercange_2013 &lt;dbl&gt;, Mondercange_2014 &lt;dbl&gt;,
## #   Mondercange_2015 &lt;dbl&gt;, P√©tange_2013 &lt;dbl&gt;, P√©tange_2014 &lt;dbl&gt;,
## #   P√©tange_2015 &lt;dbl&gt;, Rumelange_2013 &lt;dbl&gt;, Rumelange_2014 &lt;dbl&gt;,
## #   Rumelange_2015 &lt;dbl&gt;, Schifflange_2013 &lt;dbl&gt;, Schifflange_2014 &lt;dbl&gt;,
## #   Schifflange_2015 &lt;dbl&gt;, Schuttrange_2013 &lt;dbl&gt;,
## #   Schuttrange_2014 &lt;dbl&gt;, Schuttrange_2015 &lt;dbl&gt;, Tuntange_2013 &lt;dbl&gt;,
## #   Tuntange_2014 &lt;dbl&gt;, Tuntange_2015 &lt;dbl&gt;, Useldange_2013 &lt;dbl&gt;,
## #   Useldange_2014 &lt;dbl&gt;, Useldange_2015 &lt;dbl&gt;, Walferdange_2013 &lt;dbl&gt;,
## #   Walferdange_2014 &lt;dbl&gt;, Walferdange_2015 &lt;dbl&gt;, Wincrange_2013 &lt;dbl&gt;,
## #   Wincrange_2014 &lt;dbl&gt;, Wincrange_2015 &lt;dbl&gt;, Wormeldange_2013 &lt;dbl&gt;,
## #   Wormeldange_2014 &lt;dbl&gt;, Wormeldange_2015 &lt;dbl&gt;</code></pre>
<p>and actually look even better, but only because there are no repeated values; there is only one
unemployment rate for each ‚Äúcommune times year‚Äù. I will come back to this later on, with another
example that might be clearer.</p>
<p>You might have noticed that because there is no data for
the years 2016 and 2017, these columns do not appear in the data. But suppose that we need to have
these columns, so that a colleague from another department can fill in the values. This is possible
by providing a data frame with the detailed specifications of the result data frame. This optional
data frame must have at least two columns, <code>.name</code>, which are the column names you want, and
<code>.value</code> which contains the values.</p>
<pre class="sourceCode r"><code class="sourceCode r">unemp_spec &lt;-<span class="st"> </span>unemp_lux_data <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">expand</span>(division, <span class="dt">year =</span> <span class="kw">c</span>(year, <span class="dv">2016</span>, <span class="dv">2017</span>), <span class="dt">.value =</span> <span class="st">&quot;unemployment_rate_in_percent&quot;</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">unite</span>(<span class="st">&quot;.name&quot;</span>, division, year, <span class="dt">remove =</span> <span class="ot">FALSE</span>)

unemp_spec</code></pre>
<p>The spec has more rows than the data frame (80 vs 48), so this will cause issues if you try to use
the specification directly:</p>
<pre class="sourceCode r"><code class="sourceCode r">unemp_lux_data  <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">pivot_wide</span>(<span class="dt">spec =</span> unemp_spec)</code></pre>
<pre><code>Error in data.frame(row = row_id, col = col_id) : arguments imply differing number of rows: 80, 48</code></pre>
<p>So to make it work, we first need to create a column that uniquely identifies each row:</p>
<pre class="sourceCode r"><code class="sourceCode r">unemp_lux_data4 &lt;-<span class="st"> </span>unemp_lux_data <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">select</span>(division, year, unemployment_rate_in_percent) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">rowid_to_column</span>() <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">pivot_wide</span>(<span class="dt">spec =</span> unemp_spec) 

unemp_lux_data4</code></pre>
<pre><code>## # A tibble: 1,770 x 2,007
##    rowid Beaufort_2001 Beaufort_2002 Beaufort_2003 Beaufort_2004
##    &lt;int&gt;         &lt;dbl&gt;         &lt;dbl&gt;         &lt;dbl&gt;         &lt;dbl&gt;
##  1     1          5.09          NA           NA            NA   
##  2     2         NA              3.5         NA            NA   
##  3     3         NA             NA            5.17         NA   
##  4     4         NA             NA           NA             5.07
##  5     5         NA             NA           NA            NA   
##  6     6         NA             NA           NA            NA   
##  7     7         NA             NA           NA            NA   
##  8     8         NA             NA           NA            NA   
##  9     9         NA             NA           NA            NA   
## 10    10         NA             NA           NA            NA   
## # ‚Ä¶ with 1,760 more rows, and 2,002 more variables: Beaufort_2005 &lt;dbl&gt;,
## #   Beaufort_2006 &lt;dbl&gt;, Beaufort_2007 &lt;dbl&gt;, Beaufort_2008 &lt;dbl&gt;,
## #   Beaufort_2009 &lt;dbl&gt;, Beaufort_2010 &lt;dbl&gt;, Beaufort_2011 &lt;dbl&gt;,
## #   Beaufort_2012 &lt;dbl&gt;, Beaufort_2013 &lt;dbl&gt;, Beaufort_2014 &lt;dbl&gt;,
## #   Beaufort_2015 &lt;dbl&gt;, Beaufort_2016 &lt;dbl&gt;, Beaufort_2017 &lt;dbl&gt;,
## #   Bech_2001 &lt;dbl&gt;, Bech_2002 &lt;dbl&gt;, Bech_2003 &lt;dbl&gt;, Bech_2004 &lt;dbl&gt;,
## #   Bech_2005 &lt;dbl&gt;, Bech_2006 &lt;dbl&gt;, Bech_2007 &lt;dbl&gt;, Bech_2008 &lt;dbl&gt;,
## #   Bech_2009 &lt;dbl&gt;, Bech_2010 &lt;dbl&gt;, Bech_2011 &lt;dbl&gt;, Bech_2012 &lt;dbl&gt;,
## #   Bech_2013 &lt;dbl&gt;, Bech_2014 &lt;dbl&gt;, Bech_2015 &lt;dbl&gt;, Bech_2016 &lt;dbl&gt;,
## #   Bech_2017 &lt;dbl&gt;, Beckerich_2001 &lt;dbl&gt;, Beckerich_2002 &lt;dbl&gt;,
## #   Beckerich_2003 &lt;dbl&gt;, Beckerich_2004 &lt;dbl&gt;, Beckerich_2005 &lt;dbl&gt;,
## #   Beckerich_2006 &lt;dbl&gt;, Beckerich_2007 &lt;dbl&gt;, Beckerich_2008 &lt;dbl&gt;,
## #   Beckerich_2009 &lt;dbl&gt;, Beckerich_2010 &lt;dbl&gt;, Beckerich_2011 &lt;dbl&gt;,
## #   Beckerich_2012 &lt;dbl&gt;, Beckerich_2013 &lt;dbl&gt;, Beckerich_2014 &lt;dbl&gt;,
## #   Beckerich_2015 &lt;dbl&gt;, Beckerich_2016 &lt;dbl&gt;, Beckerich_2017 &lt;dbl&gt;,
## #   Berdorf_2001 &lt;dbl&gt;, Berdorf_2002 &lt;dbl&gt;, Berdorf_2003 &lt;dbl&gt;,
## #   Berdorf_2004 &lt;dbl&gt;, Berdorf_2005 &lt;dbl&gt;, Berdorf_2006 &lt;dbl&gt;,
## #   Berdorf_2007 &lt;dbl&gt;, Berdorf_2008 &lt;dbl&gt;, Berdorf_2009 &lt;dbl&gt;,
## #   Berdorf_2010 &lt;dbl&gt;, Berdorf_2011 &lt;dbl&gt;, Berdorf_2012 &lt;dbl&gt;,
## #   Berdorf_2013 &lt;dbl&gt;, Berdorf_2014 &lt;dbl&gt;, Berdorf_2015 &lt;dbl&gt;,
## #   Berdorf_2016 &lt;dbl&gt;, Berdorf_2017 &lt;dbl&gt;, Bertrange_2001 &lt;dbl&gt;,
## #   Bertrange_2002 &lt;dbl&gt;, Bertrange_2003 &lt;dbl&gt;, Bertrange_2004 &lt;dbl&gt;,
## #   Bertrange_2005 &lt;dbl&gt;, Bertrange_2006 &lt;dbl&gt;, Bertrange_2007 &lt;dbl&gt;,
## #   Bertrange_2008 &lt;dbl&gt;, Bertrange_2009 &lt;dbl&gt;, Bertrange_2010 &lt;dbl&gt;,
## #   Bertrange_2011 &lt;dbl&gt;, Bertrange_2012 &lt;dbl&gt;, Bertrange_2013 &lt;dbl&gt;,
## #   Bertrange_2014 &lt;dbl&gt;, Bertrange_2015 &lt;dbl&gt;, Bertrange_2016 &lt;dbl&gt;,
## #   Bertrange_2017 &lt;dbl&gt;, Bettembourg_2001 &lt;dbl&gt;, Bettembourg_2002 &lt;dbl&gt;,
## #   Bettembourg_2003 &lt;dbl&gt;, Bettembourg_2004 &lt;dbl&gt;,
## #   Bettembourg_2005 &lt;dbl&gt;, Bettembourg_2006 &lt;dbl&gt;,
## #   Bettembourg_2007 &lt;dbl&gt;, Bettembourg_2008 &lt;dbl&gt;,
## #   Bettembourg_2009 &lt;dbl&gt;, Bettembourg_2010 &lt;dbl&gt;,
## #   Bettembourg_2011 &lt;dbl&gt;, Bettembourg_2012 &lt;dbl&gt;,
## #   Bettembourg_2013 &lt;dbl&gt;, Bettembourg_2014 &lt;dbl&gt;,
## #   Bettembourg_2015 &lt;dbl&gt;, Bettembourg_2016 &lt;dbl&gt;,
## #   Bettembourg_2017 &lt;dbl&gt;, Bettendorf_2001 &lt;dbl&gt;, Bettendorf_2002 &lt;dbl&gt;,
## #   ‚Ä¶</code></pre>
<p>You can notice that now we have columns for 2016 and 2017 too. Let‚Äôs clean the data a little bit more:</p>
<pre class="sourceCode r"><code class="sourceCode r">unemp_lux_data4 <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>rowid) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">fill</span>(<span class="kw">matches</span>(<span class="st">&quot;.*&quot;</span>), <span class="dt">.direction =</span> <span class="st">&quot;down&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">slice</span>(<span class="kw">n</span>())</code></pre>
<pre><code>## # A tibble: 1 x 2,006
##   Beaufort_2001 Beaufort_2002 Beaufort_2003 Beaufort_2004 Beaufort_2005
##           &lt;dbl&gt;         &lt;dbl&gt;         &lt;dbl&gt;         &lt;dbl&gt;         &lt;dbl&gt;
## 1          5.09           3.5          5.17          5.07          5.89
## # ‚Ä¶ with 2,001 more variables: Beaufort_2006 &lt;dbl&gt;, Beaufort_2007 &lt;dbl&gt;,
## #   Beaufort_2008 &lt;dbl&gt;, Beaufort_2009 &lt;dbl&gt;, Beaufort_2010 &lt;dbl&gt;,
## #   Beaufort_2011 &lt;dbl&gt;, Beaufort_2012 &lt;dbl&gt;, Beaufort_2013 &lt;dbl&gt;,
## #   Beaufort_2014 &lt;dbl&gt;, Beaufort_2015 &lt;dbl&gt;, Beaufort_2016 &lt;dbl&gt;,
## #   Beaufort_2017 &lt;dbl&gt;, Bech_2001 &lt;dbl&gt;, Bech_2002 &lt;dbl&gt;,
## #   Bech_2003 &lt;dbl&gt;, Bech_2004 &lt;dbl&gt;, Bech_2005 &lt;dbl&gt;, Bech_2006 &lt;dbl&gt;,
## #   Bech_2007 &lt;dbl&gt;, Bech_2008 &lt;dbl&gt;, Bech_2009 &lt;dbl&gt;, Bech_2010 &lt;dbl&gt;,
## #   Bech_2011 &lt;dbl&gt;, Bech_2012 &lt;dbl&gt;, Bech_2013 &lt;dbl&gt;, Bech_2014 &lt;dbl&gt;,
## #   Bech_2015 &lt;dbl&gt;, Bech_2016 &lt;dbl&gt;, Bech_2017 &lt;dbl&gt;,
## #   Beckerich_2001 &lt;dbl&gt;, Beckerich_2002 &lt;dbl&gt;, Beckerich_2003 &lt;dbl&gt;,
## #   Beckerich_2004 &lt;dbl&gt;, Beckerich_2005 &lt;dbl&gt;, Beckerich_2006 &lt;dbl&gt;,
## #   Beckerich_2007 &lt;dbl&gt;, Beckerich_2008 &lt;dbl&gt;, Beckerich_2009 &lt;dbl&gt;,
## #   Beckerich_2010 &lt;dbl&gt;, Beckerich_2011 &lt;dbl&gt;, Beckerich_2012 &lt;dbl&gt;,
## #   Beckerich_2013 &lt;dbl&gt;, Beckerich_2014 &lt;dbl&gt;, Beckerich_2015 &lt;dbl&gt;,
## #   Beckerich_2016 &lt;dbl&gt;, Beckerich_2017 &lt;dbl&gt;, Berdorf_2001 &lt;dbl&gt;,
## #   Berdorf_2002 &lt;dbl&gt;, Berdorf_2003 &lt;dbl&gt;, Berdorf_2004 &lt;dbl&gt;,
## #   Berdorf_2005 &lt;dbl&gt;, Berdorf_2006 &lt;dbl&gt;, Berdorf_2007 &lt;dbl&gt;,
## #   Berdorf_2008 &lt;dbl&gt;, Berdorf_2009 &lt;dbl&gt;, Berdorf_2010 &lt;dbl&gt;,
## #   Berdorf_2011 &lt;dbl&gt;, Berdorf_2012 &lt;dbl&gt;, Berdorf_2013 &lt;dbl&gt;,
## #   Berdorf_2014 &lt;dbl&gt;, Berdorf_2015 &lt;dbl&gt;, Berdorf_2016 &lt;dbl&gt;,
## #   Berdorf_2017 &lt;dbl&gt;, Bertrange_2001 &lt;dbl&gt;, Bertrange_2002 &lt;dbl&gt;,
## #   Bertrange_2003 &lt;dbl&gt;, Bertrange_2004 &lt;dbl&gt;, Bertrange_2005 &lt;dbl&gt;,
## #   Bertrange_2006 &lt;dbl&gt;, Bertrange_2007 &lt;dbl&gt;, Bertrange_2008 &lt;dbl&gt;,
## #   Bertrange_2009 &lt;dbl&gt;, Bertrange_2010 &lt;dbl&gt;, Bertrange_2011 &lt;dbl&gt;,
## #   Bertrange_2012 &lt;dbl&gt;, Bertrange_2013 &lt;dbl&gt;, Bertrange_2014 &lt;dbl&gt;,
## #   Bertrange_2015 &lt;dbl&gt;, Bertrange_2016 &lt;dbl&gt;, Bertrange_2017 &lt;dbl&gt;,
## #   Bettembourg_2001 &lt;dbl&gt;, Bettembourg_2002 &lt;dbl&gt;,
## #   Bettembourg_2003 &lt;dbl&gt;, Bettembourg_2004 &lt;dbl&gt;,
## #   Bettembourg_2005 &lt;dbl&gt;, Bettembourg_2006 &lt;dbl&gt;,
## #   Bettembourg_2007 &lt;dbl&gt;, Bettembourg_2008 &lt;dbl&gt;,
## #   Bettembourg_2009 &lt;dbl&gt;, Bettembourg_2010 &lt;dbl&gt;,
## #   Bettembourg_2011 &lt;dbl&gt;, Bettembourg_2012 &lt;dbl&gt;,
## #   Bettembourg_2013 &lt;dbl&gt;, Bettembourg_2014 &lt;dbl&gt;,
## #   Bettembourg_2015 &lt;dbl&gt;, Bettembourg_2016 &lt;dbl&gt;,
## #   Bettembourg_2017 &lt;dbl&gt;, Bettendorf_2001 &lt;dbl&gt;, Bettendorf_2002 &lt;dbl&gt;,
## #   Bettendorf_2003 &lt;dbl&gt;, ‚Ä¶</code></pre>
<p>We will learn about <code>fill()</code>, anoher <code>{tidyr}</code> function a bit later in this chapter, but its basic
purpose is to fill rows with whatever value comes before or after the missing values. <code>slice(n())</code>
then only keeps the last row of the data frame, which is the row that contains all the values (expect
for 2016 and 2017, which has missing values, as we wanted).</p>
<p>Here is another example of the importance of having an identifier column when using a spec:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">data</span>(mtcars)
mtcars_spec &lt;-<span class="st"> </span>mtcars <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">expand</span>(am, cyl, <span class="dt">.value =</span> <span class="st">&quot;mpg&quot;</span>) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">unite</span>(<span class="st">&quot;.name&quot;</span>, am, cyl, <span class="dt">remove =</span> <span class="ot">FALSE</span>)

mtcars_spec</code></pre>
<p>We can now transform the data:</p>
<pre class="sourceCode r"><code class="sourceCode r">mtcars <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">pivot_wide</span>(<span class="dt">spec =</span> mtcars_spec)</code></pre>
<pre><code>## # A tibble: 32 x 14
##     disp    hp  drat    wt  qsec    vs  gear  carb `0_4` `0_6` `0_8` `1_4`
##    &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
##  1  160    110  3.9   2.62  16.5     0     4     4  NA    NA    NA    NA  
##  2  160    110  3.9   2.88  17.0     0     4     4  NA    NA    NA    NA  
##  3  108     93  3.85  2.32  18.6     1     4     1  NA    NA    NA    22.8
##  4  258    110  3.08  3.22  19.4     1     3     1  NA    21.4  NA    NA  
##  5  360    175  3.15  3.44  17.0     0     3     2  NA    NA    18.7  NA  
##  6  225    105  2.76  3.46  20.2     1     3     1  NA    18.1  NA    NA  
##  7  360    245  3.21  3.57  15.8     0     3     4  NA    NA    14.3  NA  
##  8  147.    62  3.69  3.19  20       1     4     2  24.4  NA    NA    NA  
##  9  141.    95  3.92  3.15  22.9     1     4     2  22.8  NA    NA    NA  
## 10  168.   123  3.92  3.44  18.3     1     4     4  NA    19.2  NA    NA  
## # ‚Ä¶ with 22 more rows, and 2 more variables: `1_6` &lt;dbl&gt;, `1_8` &lt;dbl&gt;</code></pre>
<p>As you can see, there are several values of ‚Äúmpg‚Äù for some combinations of ‚Äúam‚Äù times ‚Äúcyl‚Äù. If
we remove the other columns, each row will not be uniquely identified anymore, and thus an error will be
returned:</p>
<pre class="sourceCode r"><code class="sourceCode r">mtcars <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">select</span>(am, cyl, mpg) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">pivot_wide</span>(<span class="dt">spec =</span> mtcars_spec)</code></pre>
<pre><code>Error in data.frame(row = row_id, col = col_id) : arguments imply differing number of rows: 6, 32</code></pre>
<p>So you have to be careful with this.</p>
<p><code>pivot_long()</code> is used when you need to go from a wide to a long dataset, meaning, a dataset where
there are some columns that should not be columns, but rather, the levels of a factor variable.
Let‚Äôs suppose that the ‚Äúam‚Äù column is split into two columns, <code>1</code> for
automatic and <code>0</code> for manual transmissions, and that the values filling these colums are miles per
gallon, ‚Äúmpg‚Äù:</p>
<pre class="sourceCode r"><code class="sourceCode r">mtcars_wide_am &lt;-<span class="st"> </span>mtcars <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">pivot_wide</span>(<span class="dt">names_from =</span> am, <span class="dt">values_from =</span> mpg)

mtcars_wide_am <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">select</span>(<span class="st">`</span><span class="dt">0</span><span class="st">`</span>, <span class="st">`</span><span class="dt">1</span><span class="st">`</span>, <span class="kw">everything</span>())</code></pre>
<pre><code>## # A tibble: 32 x 11
##      `0`   `1`   cyl  disp    hp  drat    wt  qsec    vs  gear  carb
##    &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
##  1  NA    21       6  160    110  3.9   2.62  16.5     0     4     4
##  2  NA    21       6  160    110  3.9   2.88  17.0     0     4     4
##  3  NA    22.8     4  108     93  3.85  2.32  18.6     1     4     1
##  4  21.4  NA       6  258    110  3.08  3.22  19.4     1     3     1
##  5  18.7  NA       8  360    175  3.15  3.44  17.0     0     3     2
##  6  18.1  NA       6  225    105  2.76  3.46  20.2     1     3     1
##  7  14.3  NA       8  360    245  3.21  3.57  15.8     0     3     4
##  8  24.4  NA       4  147.    62  3.69  3.19  20       1     4     2
##  9  22.8  NA       4  141.    95  3.92  3.15  22.9     1     4     2
## 10  19.2  NA       6  168.   123  3.92  3.44  18.3     1     4     4
## # ‚Ä¶ with 22 more rows</code></pre>
<p>As you can see, the ‚Äú0‚Äù and ‚Äú1‚Äù columns should not be their own columns, unless there is a very
specific and good reason they should‚Ä¶ but rather, they should be the levels of another column (in
our case, ‚Äúam‚Äù).</p>
<p>We can go back to a long dataset like so:</p>
<pre class="sourceCode r"><code class="sourceCode r">mtcars_wide_am <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">pivot_long</span>(<span class="dt">cols =</span> <span class="kw">c</span>(<span class="st">`</span><span class="dt">1</span><span class="st">`</span>, <span class="st">`</span><span class="dt">0</span><span class="st">`</span>), <span class="dt">names_to =</span> <span class="st">&quot;am&quot;</span>, <span class="dt">values_to =</span> <span class="st">&quot;mpg&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">select</span>(am, mpg, <span class="kw">everything</span>())</code></pre>
<pre><code>## # A tibble: 64 x 11
##    am      mpg   cyl  disp    hp  drat    wt  qsec    vs  gear  carb
##    &lt;chr&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
##  1 1      21       6   160   110  3.9   2.62  16.5     0     4     4
##  2 0      NA       6   160   110  3.9   2.62  16.5     0     4     4
##  3 1      21       6   160   110  3.9   2.88  17.0     0     4     4
##  4 0      NA       6   160   110  3.9   2.88  17.0     0     4     4
##  5 1      22.8     4   108    93  3.85  2.32  18.6     1     4     1
##  6 0      NA       4   108    93  3.85  2.32  18.6     1     4     1
##  7 1      NA       6   258   110  3.08  3.22  19.4     1     3     1
##  8 0      21.4     6   258   110  3.08  3.22  19.4     1     3     1
##  9 1      NA       8   360   175  3.15  3.44  17.0     0     3     2
## 10 0      18.7     8   360   175  3.15  3.44  17.0     0     3     2
## # ‚Ä¶ with 54 more rows</code></pre>
<p>In the cols argument, you need to list all the variables that need to be transformed. Only <code>1</code> and
<code>0</code> must be pivoted, so I list them. Just for illustration purposes, imagine that we would need
to pivot 50 columns. It would be faster to list the columns that do not need to be pivoted. This
can be achieved by listing the columns that must be excluded with <code>-</code> in front, and maybe using
<code>match()</code> with a regular expression:</p>
<pre class="sourceCode r"><code class="sourceCode r">mtcars_wide_am <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">pivot_long</span>(<span class="dt">cols =</span> <span class="op">-</span><span class="kw">matches</span>(<span class="st">&quot;^[[:alpha:]]&quot;</span>), <span class="dt">names_to =</span> <span class="st">&quot;am&quot;</span>, <span class="dt">values_to =</span> <span class="st">&quot;mpg&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">select</span>(am, mpg, <span class="kw">everything</span>())</code></pre>
<pre><code>## # A tibble: 64 x 11
##    am      mpg   cyl  disp    hp  drat    wt  qsec    vs  gear  carb
##    &lt;chr&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
##  1 1      21       6   160   110  3.9   2.62  16.5     0     4     4
##  2 0      NA       6   160   110  3.9   2.62  16.5     0     4     4
##  3 1      21       6   160   110  3.9   2.88  17.0     0     4     4
##  4 0      NA       6   160   110  3.9   2.88  17.0     0     4     4
##  5 1      22.8     4   108    93  3.85  2.32  18.6     1     4     1
##  6 0      NA       4   108    93  3.85  2.32  18.6     1     4     1
##  7 1      NA       6   258   110  3.08  3.22  19.4     1     3     1
##  8 0      21.4     6   258   110  3.08  3.22  19.4     1     3     1
##  9 1      NA       8   360   175  3.15  3.44  17.0     0     3     2
## 10 0      18.7     8   360   175  3.15  3.44  17.0     0     3     2
## # ‚Ä¶ with 54 more rows</code></pre>
<p>Every column that starts with a letter is ok, so there is no need to pivot them. I use the <code>match()</code>
function with a regular expression so that I don‚Äôt have to type the names of all the columns. <code>select()</code>
is used to re-order the columns, only for viewing purposes</p>
<p><code>names_to =</code> takes a string as argument, which will be the name of the name column containing the
levels <code>0</code> and <code>1</code>, and <code>values_to =</code> also takes a string as argument, which will be the name of
the column containing the values. Finally, you can see that there are a lot of <code>NA</code>s in the
output. These can be removed easily:</p>
<pre class="sourceCode r"><code class="sourceCode r">mtcars_wide_am <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">pivot_long</span>(<span class="dt">cols =</span> <span class="kw">c</span>(<span class="st">`</span><span class="dt">1</span><span class="st">`</span>, <span class="st">`</span><span class="dt">0</span><span class="st">`</span>), <span class="dt">names_to =</span> <span class="st">&quot;am&quot;</span>, <span class="dt">values_to =</span> <span class="st">&quot;mpg&quot;</span>, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">select</span>(am, mpg, <span class="kw">everything</span>())</code></pre>
<pre><code>## # A tibble: 32 x 11
##    am      mpg   cyl  disp    hp  drat    wt  qsec    vs  gear  carb
##    &lt;chr&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
##  1 1      21       6  160    110  3.9   2.62  16.5     0     4     4
##  2 1      21       6  160    110  3.9   2.88  17.0     0     4     4
##  3 1      22.8     4  108     93  3.85  2.32  18.6     1     4     1
##  4 0      21.4     6  258    110  3.08  3.22  19.4     1     3     1
##  5 0      18.7     8  360    175  3.15  3.44  17.0     0     3     2
##  6 0      18.1     6  225    105  2.76  3.46  20.2     1     3     1
##  7 0      14.3     8  360    245  3.21  3.57  15.8     0     3     4
##  8 0      24.4     4  147.    62  3.69  3.19  20       1     4     2
##  9 0      22.8     4  141.    95  3.92  3.15  22.9     1     4     2
## 10 0      19.2     6  168.   123  3.92  3.44  18.3     1     4     4
## # ‚Ä¶ with 22 more rows</code></pre>
<p>Now for a more advanced example, let‚Äôs suppose that we are dealing with the following wide dataset:</p>
<pre class="sourceCode r"><code class="sourceCode r">mtcars_wide &lt;-<span class="st"> </span>mtcars <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">pivot_wide</span>(<span class="dt">spec =</span> mtcars_spec)

mtcars_wide</code></pre>
<pre><code>## # A tibble: 32 x 14
##     disp    hp  drat    wt  qsec    vs  gear  carb `0_4` `0_6` `0_8` `1_4`
##    &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
##  1  160    110  3.9   2.62  16.5     0     4     4  NA    NA    NA    NA  
##  2  160    110  3.9   2.88  17.0     0     4     4  NA    NA    NA    NA  
##  3  108     93  3.85  2.32  18.6     1     4     1  NA    NA    NA    22.8
##  4  258    110  3.08  3.22  19.4     1     3     1  NA    21.4  NA    NA  
##  5  360    175  3.15  3.44  17.0     0     3     2  NA    NA    18.7  NA  
##  6  225    105  2.76  3.46  20.2     1     3     1  NA    18.1  NA    NA  
##  7  360    245  3.21  3.57  15.8     0     3     4  NA    NA    14.3  NA  
##  8  147.    62  3.69  3.19  20       1     4     2  24.4  NA    NA    NA  
##  9  141.    95  3.92  3.15  22.9     1     4     2  22.8  NA    NA    NA  
## 10  168.   123  3.92  3.44  18.3     1     4     4  NA    19.2  NA    NA  
## # ‚Ä¶ with 22 more rows, and 2 more variables: `1_6` &lt;dbl&gt;, `1_8` &lt;dbl&gt;</code></pre>
<p>The difficulty here is that we have columns with two levels of information. For instance, the
column ‚Äú0_4‚Äù contains the miles per gallon values for manual cars (<code>0</code>) with <code>4</code> cylinders.
The first step is to first pivot the columns:</p>
<pre class="sourceCode r"><code class="sourceCode r">mtcars_wide <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">pivot_long</span>(<span class="dt">cols =</span> <span class="kw">matches</span>(<span class="st">&quot;0|1&quot;</span>), <span class="dt">names_to =</span> <span class="st">&quot;am_cyl&quot;</span>, <span class="dt">values_to =</span> <span class="st">&quot;mpg&quot;</span>, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">select</span>(am_cyl, mpg, <span class="kw">everything</span>())</code></pre>
<pre><code>## # A tibble: 32 x 10
##    am_cyl   mpg  disp    hp  drat    wt  qsec    vs  gear  carb
##    &lt;chr&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
##  1 1_6     21    160    110  3.9   2.62  16.5     0     4     4
##  2 1_6     21    160    110  3.9   2.88  17.0     0     4     4
##  3 1_4     22.8  108     93  3.85  2.32  18.6     1     4     1
##  4 0_6     21.4  258    110  3.08  3.22  19.4     1     3     1
##  5 0_8     18.7  360    175  3.15  3.44  17.0     0     3     2
##  6 0_6     18.1  225    105  2.76  3.46  20.2     1     3     1
##  7 0_8     14.3  360    245  3.21  3.57  15.8     0     3     4
##  8 0_4     24.4  147.    62  3.69  3.19  20       1     4     2
##  9 0_4     22.8  141.    95  3.92  3.15  22.9     1     4     2
## 10 0_6     19.2  168.   123  3.92  3.44  18.3     1     4     4
## # ‚Ä¶ with 22 more rows</code></pre>
<p>Now we only need to separate the ‚Äúam_cyl‚Äù column into two new columns, ‚Äúam‚Äù and ‚Äúcyl‚Äù:</p>
<pre class="sourceCode r"><code class="sourceCode r">mtcars_wide <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">pivot_long</span>(<span class="dt">cols =</span> <span class="kw">matches</span>(<span class="st">&quot;0|1&quot;</span>), <span class="dt">names_to =</span> <span class="st">&quot;am_cyl&quot;</span>, <span class="dt">values_to =</span> <span class="st">&quot;mpg&quot;</span>, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">separate</span>(am_cyl, <span class="dt">into =</span> <span class="kw">c</span>(<span class="st">&quot;am&quot;</span>, <span class="st">&quot;cyl&quot;</span>), <span class="dt">sep =</span> <span class="st">&quot;_&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">select</span>(am, cyl, mpg, <span class="kw">everything</span>())</code></pre>
<pre><code>## # A tibble: 32 x 11
##    am    cyl     mpg  disp    hp  drat    wt  qsec    vs  gear  carb
##    &lt;chr&gt; &lt;chr&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
##  1 1     6      21    160    110  3.9   2.62  16.5     0     4     4
##  2 1     6      21    160    110  3.9   2.88  17.0     0     4     4
##  3 1     4      22.8  108     93  3.85  2.32  18.6     1     4     1
##  4 0     6      21.4  258    110  3.08  3.22  19.4     1     3     1
##  5 0     8      18.7  360    175  3.15  3.44  17.0     0     3     2
##  6 0     6      18.1  225    105  2.76  3.46  20.2     1     3     1
##  7 0     8      14.3  360    245  3.21  3.57  15.8     0     3     4
##  8 0     4      24.4  147.    62  3.69  3.19  20       1     4     2
##  9 0     4      22.8  141.    95  3.92  3.15  22.9     1     4     2
## 10 0     6      19.2  168.   123  3.92  3.44  18.3     1     4     4
## # ‚Ä¶ with 22 more rows</code></pre>
<p>It is also possible to construct a specification data frame, just like for <code>pivot_wide()</code>:</p>
<pre class="sourceCode r"><code class="sourceCode r">mtcars_spec_long &lt;-<span class="st"> </span>mtcars_wide <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">pivot_long_spec</span>(<span class="kw">matches</span>(<span class="st">&quot;0|1&quot;</span>), <span class="dt">values_to =</span> <span class="st">&quot;mpg&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">separate</span>(name, <span class="kw">c</span>(<span class="st">&quot;am&quot;</span>, <span class="st">&quot;cyl&quot;</span>), <span class="dt">sep =</span> <span class="st">&quot;_&quot;</span>)

mtcars_spec_long</code></pre>
<pre><code>## # A tibble: 6 x 4
##   .name .value am    cyl  
##   &lt;chr&gt; &lt;chr&gt;  &lt;chr&gt; &lt;chr&gt;
## 1 0_4   mpg    0     4    
## 2 0_6   mpg    0     6    
## 3 0_8   mpg    0     8    
## 4 1_4   mpg    1     4    
## 5 1_6   mpg    1     6    
## 6 1_8   mpg    1     8</code></pre>
<p>This spec can now be specified to <code>pivot_long()</code>:</p>
<pre class="sourceCode r"><code class="sourceCode r">mtcars_wide <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">pivot_long</span>(<span class="dt">spec =</span> mtcars_spec_long, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">select</span>(am, cyl, mpg, <span class="kw">everything</span>())</code></pre>
<pre><code>## # A tibble: 32 x 11
##    am    cyl     mpg  disp    hp  drat    wt  qsec    vs  gear  carb
##    &lt;chr&gt; &lt;chr&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
##  1 1     6      21    160    110  3.9   2.62  16.5     0     4     4
##  2 1     6      21    160    110  3.9   2.88  17.0     0     4     4
##  3 1     4      22.8  108     93  3.85  2.32  18.6     1     4     1
##  4 0     6      21.4  258    110  3.08  3.22  19.4     1     3     1
##  5 0     8      18.7  360    175  3.15  3.44  17.0     0     3     2
##  6 0     6      18.1  225    105  2.76  3.46  20.2     1     3     1
##  7 0     8      14.3  360    245  3.21  3.57  15.8     0     3     4
##  8 0     4      24.4  147.    62  3.69  3.19  20       1     4     2
##  9 0     4      22.8  141.    95  3.92  3.15  22.9     1     4     2
## 10 0     6      19.2  168.   123  3.92  3.44  18.3     1     4     4
## # ‚Ä¶ with 22 more rows</code></pre>
<p>Defining specifications give a lot of flexibility and in some complicated cases are the way to go.</p>
</div>
<div id="spread-and-gather" class="section level3">
<h3><span class="header-section-number">4.4.2</span> <code>spread()</code> and <code>gather()</code></h3>
<p><code>survey_data</code> is a long dataset. We can reshape it to be wide using the <code>spread()</code> function:</p>
<pre class="sourceCode r"><code class="sourceCode r">wide_data &lt;-<span class="st"> </span>survey_data <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">spread</span>(variable, value)

<span class="kw">head</span>(wide_data)</code></pre>
<pre><code>## # A tibble: 5 x 4
##      id  var1  var2  var3
##   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
## 1     1   1     0.2  NA  
## 2     2   1.4   1.9   4.1
## 3     3   0.1   2.8   8.9
## 4     4   1.7  NA     7.6
## 5    NA  NA     1.9   0.3</code></pre>
<p>This means that we spread the column called ‚Äúvariable‚Äù, which will produce one column per category
of ‚Äúvariable‚Äù. Then we fill in the rows with the data contained in the column ‚Äúvalue‚Äù.</p>
<p>To go from a wide dataset to a long one, we use <code>gather()</code>:</p>
<pre class="sourceCode r"><code class="sourceCode r">long_data &lt;-<span class="st"> </span>wide_data <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">gather</span>(variable, value, var1, var2)

<span class="kw">print</span>(long_data)</code></pre>
<pre><code>## # A tibble: 10 x 4
##       id  var3 variable value
##    &lt;dbl&gt; &lt;dbl&gt; &lt;chr&gt;    &lt;dbl&gt;
##  1     1  NA   var1       1  
##  2     2   4.1 var1       1.4
##  3     3   8.9 var1       0.1
##  4     4   7.6 var1       1.7
##  5    NA   0.3 var1      NA  
##  6     1  NA   var2       0.2
##  7     2   4.1 var2       1.9
##  8     3   8.9 var2       2.8
##  9     4   7.6 var2      NA  
## 10    NA   0.3 var2       1.9</code></pre>
<p><code>long_data</code> and <code>survey_data</code> are the same datasets, but in a different order.</p>
<p>In the <code>wide_data</code> <code>tibble</code>, we had 3 columns: <code>id</code>, <code>var1</code> and <code>var2</code>. We want to stack ‚Äòvar1‚Äô and
‚Äòvar2‚Äô in a new column, that we choose to call ‚Äúvariable‚Äù. This is the ‚Äúkey‚Äù. For the value, we are
using the values contained in <code>var1</code> and <code>var2</code>. Sometimes using <code>spread()</code> or <code>gather()</code> requires
some trial and error. I advise you play around with the examples above to really grasp how these
powerful functions work.</p>
</div>
<div id="fill-and-full_seq" class="section level3">
<h3><span class="header-section-number">4.4.3</span> <code>fill()</code> and <code>full_seq()</code></h3>
<p><code>fill()</code> is pretty useful to‚Ä¶ fill in missing values. For instance, in <code>survey_data</code>, some ‚Äúid‚Äùs
are missing:</p>
<pre class="sourceCode r"><code class="sourceCode r">survey_data</code></pre>
<pre><code>## # A tibble: 12 x 3
##       id variable value
##    &lt;dbl&gt; &lt;chr&gt;    &lt;dbl&gt;
##  1     1 var1       1  
##  2     1 var2       0.2
##  3    NA var3       0.3
##  4     2 var1       1.4
##  5     2 var2       1.9
##  6     2 var3       4.1
##  7     3 var1       0.1
##  8     3 var2       2.8
##  9     3 var3       8.9
## 10     4 var1       1.7
## 11    NA var2       1.9
## 12     4 var3       7.6</code></pre>
<p>It seems pretty obvious that the first <code>NA</code> is supposed to be <code>1</code> and the second missing is supposed
to be <code>4</code>. With <code>fill()</code>, this is pretty easy to achieve:</p>
<pre class="sourceCode r"><code class="sourceCode r">survey_data <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">fill</span>(<span class="dt">.direction =</span> <span class="st">&quot;down&quot;</span>, <span class="dt">variable =</span> <span class="st">&quot;id&quot;</span>)</code></pre>
<p><code>full_seq()</code> is similar:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">full_seq</span>(<span class="kw">c</span>(<span class="kw">as.Date</span>(<span class="st">&quot;2018-08-01&quot;</span>), <span class="kw">as.Date</span>(<span class="st">&quot;2018-08-03&quot;</span>)), <span class="dv">1</span>)</code></pre>
<pre><code>## [1] &quot;2018-08-01&quot; &quot;2018-08-02&quot; &quot;2018-08-03&quot;</code></pre>
<p>We can add this as the date column to our survey data:</p>
<pre class="sourceCode r"><code class="sourceCode r">survey_data <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">mutate</span>(<span class="dt">date =</span> <span class="kw">rep</span>(<span class="kw">full_seq</span>(<span class="kw">c</span>(<span class="kw">as.Date</span>(<span class="st">&quot;2018-08-01&quot;</span>), <span class="kw">as.Date</span>(<span class="st">&quot;2018-08-03&quot;</span>)), <span class="dv">1</span>), <span class="dv">4</span>))</code></pre>
<pre><code>## # A tibble: 12 x 4
##       id variable value date      
##    &lt;dbl&gt; &lt;chr&gt;    &lt;dbl&gt; &lt;date&gt;    
##  1     1 var1       1   2018-08-01
##  2     1 var2       0.2 2018-08-02
##  3    NA var3       0.3 2018-08-03
##  4     2 var1       1.4 2018-08-01
##  5     2 var2       1.9 2018-08-02
##  6     2 var3       4.1 2018-08-03
##  7     3 var1       0.1 2018-08-01
##  8     3 var2       2.8 2018-08-02
##  9     3 var3       8.9 2018-08-03
## 10     4 var1       1.7 2018-08-01
## 11    NA var2       1.9 2018-08-02
## 12     4 var3       7.6 2018-08-03</code></pre>
<p>I use the base <code>rep()</code> function to repeat the date 4 times and then using <code>mutate()</code> I have added
it the data frame.</p>
<p>Putting all these operations together:</p>
<pre class="sourceCode r"><code class="sourceCode r">survey_data <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">fill</span>(<span class="dt">.direction =</span> <span class="st">&quot;down&quot;</span>, <span class="dt">variable =</span> <span class="st">&quot;id&quot;</span>) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">mutate</span>(<span class="dt">date =</span> <span class="kw">rep</span>(<span class="kw">full_seq</span>(<span class="kw">c</span>(<span class="kw">as.Date</span>(<span class="st">&quot;2018-08-01&quot;</span>), <span class="kw">as.Date</span>(<span class="st">&quot;2018-08-03&quot;</span>)), <span class="dv">1</span>), <span class="dv">4</span>)) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">spread</span>(variable, value)</code></pre>
<p>As you can see, this creates a lot of explicit <code>NA</code> values. The best would be to fill in the missing
values and add the date column, and then work with that format. For example, to get the average
of the values by date:</p>
<pre class="sourceCode r"><code class="sourceCode r">survey_data <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">fill</span>(<span class="dt">.direction =</span> <span class="st">&quot;down&quot;</span>, <span class="dt">variable =</span> <span class="st">&quot;id&quot;</span>) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">mutate</span>(<span class="dt">date =</span> <span class="kw">rep</span>(<span class="kw">full_seq</span>(<span class="kw">c</span>(<span class="kw">as.Date</span>(<span class="st">&quot;2018-08-01&quot;</span>), <span class="kw">as.Date</span>(<span class="st">&quot;2018-08-03&quot;</span>)), <span class="dv">1</span>), <span class="dv">4</span>)) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">group_by</span>(date) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">summarise</span>(<span class="kw">mean</span>(value))</code></pre>
<p>Or by <code>date</code> and <code>variable</code>:</p>
<pre class="sourceCode r"><code class="sourceCode r">survey_data <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">fill</span>(<span class="dt">.direction =</span> <span class="st">&quot;down&quot;</span>, <span class="dt">variable =</span> <span class="st">&quot;id&quot;</span>) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">mutate</span>(<span class="dt">date =</span> <span class="kw">rep</span>(<span class="kw">full_seq</span>(<span class="kw">c</span>(<span class="kw">as.Date</span>(<span class="st">&quot;2018-08-01&quot;</span>), <span class="kw">as.Date</span>(<span class="st">&quot;2018-08-03&quot;</span>)), <span class="dv">1</span>), <span class="dv">4</span>)) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">group_by</span>(date, variable) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">summarise</span>(<span class="kw">mean</span>(value))</code></pre>
<p>As you can see, you can chain any <code>{tidyverse}</code> verbs, wether they come from <code>{dplyr}</code> or <code>{tidyr}</code>.</p>
</div>
<div id="put-order-in-your-columns-with-separate-unite-and-in-your-rows-with-separate_rows" class="section level3">
<h3><span class="header-section-number">4.4.4</span> Put order in your columns with <code>separate()</code>, <code>unite()</code>, and in your rows with <code>separate_rows()</code></h3>
<p>Sometimes, data can be in a format that makes working with it needlessly painful. For example, you
get this:</p>
<pre class="sourceCode r"><code class="sourceCode r">survey_data_not_tidy</code></pre>
<pre><code>## # A tibble: 12 x 3
##       id variable_date value
##    &lt;dbl&gt; &lt;chr&gt;         &lt;dbl&gt;
##  1     1 1/2018-08-01    1  
##  2     1 1/2018-08-02    0.2
##  3    NA 1/2018-08-03    0.3
##  4     2 2/2018-08-01    1.4
##  5     2 2/2018-08-02    1.9
##  6     2 2/2018-08-03    4.1
##  7     3 3/2018-08-01    0.1
##  8     3 3/2018-08-02    2.8
##  9     3 3/2018-08-03    8.9
## 10     4 4/2018-08-01    1.7
## 11    NA 4/2018-08-02    1.9
## 12     4 4/2018-08-03    7.6</code></pre>
<p>Dealing with this is simple, thanks to <code>separate()</code>:</p>
<pre class="sourceCode r"><code class="sourceCode r">survey_data_not_tidy <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">separate</span>(variable_date, <span class="dt">into =</span> <span class="kw">c</span>(<span class="st">&quot;variable&quot;</span>, <span class="st">&quot;date&quot;</span>), <span class="dt">sep =</span> <span class="st">&quot;/&quot;</span>)</code></pre>
<pre><code>## # A tibble: 12 x 4
##       id variable date       value
##    &lt;dbl&gt; &lt;chr&gt;    &lt;chr&gt;      &lt;dbl&gt;
##  1     1 1        2018-08-01   1  
##  2     1 1        2018-08-02   0.2
##  3    NA 1        2018-08-03   0.3
##  4     2 2        2018-08-01   1.4
##  5     2 2        2018-08-02   1.9
##  6     2 2        2018-08-03   4.1
##  7     3 3        2018-08-01   0.1
##  8     3 3        2018-08-02   2.8
##  9     3 3        2018-08-03   8.9
## 10     4 4        2018-08-01   1.7
## 11    NA 4        2018-08-02   1.9
## 12     4 4        2018-08-03   7.6</code></pre>
<p>The <code>variable_date</code> column gets separated into two columns, <code>variable</code> and <code>date</code>. One also needs
to specify the separator, in this case ‚Äú/‚Äù.</p>
<p><code>unite()</code> is the reverse operation, which can be useful when you are confronted to this situation:</p>
<pre class="sourceCode r"><code class="sourceCode r">survey_data2</code></pre>
<pre><code>## # A tibble: 12 x 6
##       id variable year  month day   value
##    &lt;dbl&gt; &lt;chr&gt;    &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;dbl&gt;
##  1     1 1        2018  08    01      1  
##  2     1 1        2018  08    02      0.2
##  3    NA 1        2018  08    03      0.3
##  4     2 2        2018  08    01      1.4
##  5     2 2        2018  08    02      1.9
##  6     2 2        2018  08    03      4.1
##  7     3 3        2018  08    01      0.1
##  8     3 3        2018  08    02      2.8
##  9     3 3        2018  08    03      8.9
## 10     4 4        2018  08    01      1.7
## 11    NA 4        2018  08    02      1.9
## 12     4 4        2018  08    03      7.6</code></pre>
<p>In some situation, it is better to have the date as a single column:</p>
<pre class="sourceCode r"><code class="sourceCode r">survey_data2 <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">unite</span>(date, year, month, day, <span class="dt">sep =</span> <span class="st">&quot;-&quot;</span>)</code></pre>
<pre><code>## # A tibble: 12 x 4
##       id variable date       value
##    &lt;dbl&gt; &lt;chr&gt;    &lt;chr&gt;      &lt;dbl&gt;
##  1     1 1        2018-08-01   1  
##  2     1 1        2018-08-02   0.2
##  3    NA 1        2018-08-03   0.3
##  4     2 2        2018-08-01   1.4
##  5     2 2        2018-08-02   1.9
##  6     2 2        2018-08-03   4.1
##  7     3 3        2018-08-01   0.1
##  8     3 3        2018-08-02   2.8
##  9     3 3        2018-08-03   8.9
## 10     4 4        2018-08-01   1.7
## 11    NA 4        2018-08-02   1.9
## 12     4 4        2018-08-03   7.6</code></pre>
<p>Another awful situation is the following:</p>
<pre class="sourceCode r"><code class="sourceCode r">survey_data_from_hell</code></pre>
<pre><code>##   id         variable         value
## 1  1             var1             1
## 2  1             var2           0.2
## 3 NA             var3           0.3
## 4  2 var1, var2, var3 1.4, 1.9, 4.1
## 5  3       var1, var2      0.1, 2.8
## 6  3             var3           8.9
## 7  4             var1           1.7
## 8 NA             var2           1.9
## 9  4             var3           7.6</code></pre>
<p><code>separate_rows()</code> saves the day:</p>
<pre class="sourceCode r"><code class="sourceCode r">survey_data_from_hell <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">separate_rows</span>(variable, value)</code></pre>
<pre><code>##    id variable value
## 1   1     var1     1
## 2   1     var2   0.2
## 3  NA     var3   0.3
## 4   2     var1   1.4
## 5   2     var2   1.9
## 6   2     var3   4.1
## 7   3     var1   0.1
## 8   3     var2   2.8
## 9   3     var3   8.9
## 10  4     var1   1.7
## 11 NA     var2   1.9
## 12  4     var3   7.6</code></pre>
<p>So to summarise‚Ä¶ you can go from this:</p>
<pre class="sourceCode r"><code class="sourceCode r">survey_data_from_hell</code></pre>
<pre><code>##   id         variable         value
## 1  1             var1             1
## 2  1             var2           0.2
## 3 NA             var3           0.3
## 4  2 var1, var2, var3 1.4, 1.9, 4.1
## 5  3       var1, var2      0.1, 2.8
## 6  3             var3           8.9
## 7  4             var1           1.7
## 8 NA             var2           1.9
## 9  4             var3           7.6</code></pre>
<p>to this:</p>
<pre class="sourceCode r"><code class="sourceCode r">survey_data_clean</code></pre>
<pre><code>## # A tibble: 12 x 4
##       id variable date       value
##    &lt;dbl&gt; &lt;chr&gt;    &lt;chr&gt;      &lt;dbl&gt;
##  1     1 1        2018-08-01   1  
##  2     1 1        2018-08-02   0.2
##  3    NA 1        2018-08-03   0.3
##  4     2 2        2018-08-01   1.4
##  5     2 2        2018-08-02   1.9
##  6     2 2        2018-08-03   4.1
##  7     3 3        2018-08-01   0.1
##  8     3 3        2018-08-02   2.8
##  9     3 3        2018-08-03   8.9
## 10     4 4        2018-08-01   1.7
## 11    NA 4        2018-08-02   1.9
## 12     4 4        2018-08-03   7.6</code></pre>
<p>quite easily:</p>
<pre class="sourceCode r"><code class="sourceCode r">survey_data_from_hell <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">separate_rows</span>(variable, value, <span class="dt">convert =</span> <span class="ot">TRUE</span>) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">fill</span>(<span class="dt">.direction =</span> <span class="st">&quot;down&quot;</span>, <span class="dt">variable =</span> <span class="st">&quot;id&quot;</span>) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">mutate</span>(<span class="dt">date =</span> <span class="kw">rep</span>(<span class="kw">full_seq</span>(<span class="kw">c</span>(<span class="kw">as.Date</span>(<span class="st">&quot;2018-08-01&quot;</span>), <span class="kw">as.Date</span>(<span class="st">&quot;2018-08-03&quot;</span>)), <span class="dv">1</span>), <span class="dv">4</span>))</code></pre>
</div>
<div id="a-sneak-peek-to-chapter-8-nest" class="section level3">
<h3><span class="header-section-number">4.4.5</span> A sneak peek to Chapter 8; <code>nest()</code></h3>
<p>Let‚Äôs take a look at our clean survey data:</p>
<pre class="sourceCode r"><code class="sourceCode r">survey_data_clean</code></pre>
<pre><code>## # A tibble: 12 x 4
##       id variable date       value
##    &lt;dbl&gt; &lt;chr&gt;    &lt;chr&gt;      &lt;dbl&gt;
##  1     1 1        2018-08-01   1  
##  2     1 1        2018-08-02   0.2
##  3    NA 1        2018-08-03   0.3
##  4     2 2        2018-08-01   1.4
##  5     2 2        2018-08-02   1.9
##  6     2 2        2018-08-03   4.1
##  7     3 3        2018-08-01   0.1
##  8     3 3        2018-08-02   2.8
##  9     3 3        2018-08-03   8.9
## 10     4 4        2018-08-01   1.7
## 11    NA 4        2018-08-02   1.9
## 12     4 4        2018-08-03   7.6</code></pre>
<p><code>{tidyr}</code> has another very useful function, called <code>nest()</code>:</p>
<pre class="sourceCode r"><code class="sourceCode r">survey_data_clean <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">nest</span>(<span class="op">-</span>id)</code></pre>
<pre><code>## # A tibble: 5 x 2
##      id data            
##   &lt;dbl&gt; &lt;list&gt;          
## 1     1 &lt;tibble [2 √ó 3]&gt;
## 2    NA &lt;tibble [2 √ó 3]&gt;
## 3     2 &lt;tibble [3 √ó 3]&gt;
## 4     3 &lt;tibble [3 √ó 3]&gt;
## 5     4 &lt;tibble [2 √ó 3]&gt;</code></pre>
<p>You can achieve the same result by using <code>group_by()</code> first:</p>
<pre class="sourceCode r"><code class="sourceCode r">survey_data_clean <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">group_by</span>(id) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">nest</span>()</code></pre>
<pre><code>## # A tibble: 5 x 2
##      id data            
##   &lt;dbl&gt; &lt;list&gt;          
## 1     1 &lt;tibble [2 √ó 3]&gt;
## 2    NA &lt;tibble [2 √ó 3]&gt;
## 3     2 &lt;tibble [3 √ó 3]&gt;
## 4     3 &lt;tibble [3 √ó 3]&gt;
## 5     4 &lt;tibble [2 √ó 3]&gt;</code></pre>
<p>This cerates a new tibble object, whith two columns, one with the <code>id</code> column, and a new one called
<code>data</code>. Let‚Äôs take a look at the first element of this column:</p>
<pre class="sourceCode r"><code class="sourceCode r">nested_survey_data &lt;-<span class="st"> </span>survey_data_clean <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">group_by</span>(id) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">nest</span>()

nested_survey_data<span class="op">$</span>data[<span class="dv">1</span>]</code></pre>
<pre><code>## [[1]]
## # A tibble: 2 x 3
##   variable date       value
##   &lt;chr&gt;    &lt;chr&gt;      &lt;dbl&gt;
## 1 1        2018-08-01   1  
## 2 1        2018-08-02   0.2</code></pre>
<p>As you can see, the first element of the <code>data</code> is also a tibble! You may wonder why this is useful;
I¬†will give you a small taste of what‚Äôs waiting in chapter 9. Imagine that you want to create a
barplot for each <code>id</code>. For instance, for the first <code>id</code> (we are going to learn about making plots
with <code>{ggplot2}</code> in the next chapter. For now, just follow along, even if you don‚Äôt understand
everything I¬†write):</p>
<pre class="sourceCode r"><code class="sourceCode r">survey_data_id1 &lt;-<span class="st"> </span>survey_data_clean <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">filter</span>(id <span class="op">==</span><span class="st"> </span><span class="dv">1</span>)</code></pre>
<p>Now, let‚Äôs create the plot:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>(<span class="dt">data =</span> survey_data_id1) <span class="op">+</span>
<span class="st">    </span><span class="kw">geom_bar</span>(<span class="kw">aes</span>(<span class="dt">y =</span> value, <span class="dt">x =</span> date, <span class="dt">fill =</span> variable), <span class="dt">stat =</span> <span class="st">&quot;identity&quot;</span>) <span class="op">+</span>
<span class="st">    </span><span class="kw">ggtitle</span>(<span class="st">&quot;id 1&quot;</span>)</code></pre>
<p><img src="modern_R_files/figure-html/unnamed-chunk-272-1.png" width="672" /></p>
<p>Ok great. But now I want to create this plot for each <code>id</code>‚Ä¶ so I have to copy paste this 3 times.
But copy-pasting is error prone. So there are two alternatives; I either write a function that
takes as argument the data and the <code>id</code> I¬†want to plot and run it for each <code>id</code> (we will learn to
do this in Chapter 8), or I can use <code>tidyr::nest()</code>, combined with <code>purrr::map()</code>. <code>{purrr}</code> is
another very useful <code>{tidevyrse}</code> package, and we are going to learn about it in Chapter 9. Again,
just follow along for now:</p>
<pre class="sourceCode r"><code class="sourceCode r">my_plots &lt;-<span class="st"> </span>nested_survey_data <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">mutate</span>(<span class="dt">plot =</span> <span class="kw">map2</span>(<span class="dt">.x =</span> id,
                       <span class="dt">.y =</span> data,
                       <span class="op">~</span><span class="kw">ggplot</span>(<span class="dt">data =</span> .y) <span class="op">+</span>
<span class="st">                           </span><span class="kw">geom_bar</span>(<span class="kw">aes</span>(<span class="dt">y =</span> value, <span class="dt">x =</span> date, <span class="dt">fill =</span> variable), <span class="dt">stat =</span> <span class="st">&quot;identity&quot;</span>) <span class="op">+</span>
<span class="st">                           </span><span class="kw">ggtitle</span>(<span class="kw">paste0</span>(<span class="st">&quot;id&quot;</span>, .x))))</code></pre>
<p>This is some very advanced stuff, and again, do not worry if you don‚Äôt understand everything now.
We are going to learn about this in detail in Chapter 9. Let‚Äôs go through each line.
In the first line, I have started from my clean data <code>nested_survey_data</code> and then, using the <code>%&gt;%</code>
and <code>mutate()</code> I create a new column called <code>plot</code>. Inside the <code>mutate()</code> function, I called <code>map2</code>.
<code>map2</code> is a <code>{purrr}</code> function that takes three inputs: <code>.x</code>, <code>.y</code> and a function. <code>.x</code> is the <code>id</code>
column from my data, and <code>.y</code> is the <code>data</code> column from <code>nested_survey_data</code>. The function is the
ggplot I created before. Think of <code>map2()</code> has a loop over two lists, all while applying a function.</p>
<p>The following illustration, taken from <span class="citation">Vaudor (<a href="#ref-vaudor_purrr_2018" role="doc-biblioref">2018</a>)</span> by
<a href="https://twitter.com/LVaudor">Lise Vaudor</a>, illustrates this perfectly:</p>
<p><img src="assets/purrr3.png" width="663" /></p>
<p>Two inputs go in at the same type, the factory, your function, does what it has to do, and an
output comes out. Forget about the factory‚Äôs chimney, which represents <code>walk2()</code> for now. We‚Äôll
learn about it in due time. By the way, you really should read Lise‚Äôs blog, her posts are really
great and informative. It‚Äôs in French, but that‚Äôs not a problem, you know how to read R code, right?
Here‚Äôs a link to <a href="http://perso.ens-lyon.fr/lise.vaudor/">her blog</a>.</p>
<p>Now, let‚Äôs take a look at the result:</p>
<pre class="sourceCode r"><code class="sourceCode r">my_plots</code></pre>
<pre><code>## # A tibble: 5 x 3
##      id data             plot    
##   &lt;dbl&gt; &lt;list&gt;           &lt;list&gt;  
## 1     1 &lt;tibble [2 √ó 3]&gt; &lt;S3: gg&gt;
## 2    NA &lt;tibble [2 √ó 3]&gt; &lt;S3: gg&gt;
## 3     2 &lt;tibble [3 √ó 3]&gt; &lt;S3: gg&gt;
## 4     3 &lt;tibble [3 √ó 3]&gt; &lt;S3: gg&gt;
## 5     4 &lt;tibble [2 √ó 3]&gt; &lt;S3: gg&gt;</code></pre>
<p><code>my_plots</code> is a tibble with three columns: <code>id</code>, <code>data</code> and.. <code>plot</code>! <code>plot</code> is a very interesting
column. It is a list, where each element is of type <code>S3: gg</code>. Yes, you guessed it, each element of
that list-column is a ggplot! If you now want to take a look at the plots, it is enough to do this:</p>
<pre class="sourceCode r"><code class="sourceCode r">my_plots<span class="op">$</span>plot</code></pre>
<pre><code>## [[1]]</code></pre>
<p><img src="modern_R_files/figure-html/unnamed-chunk-276-1.png" width="672" /></p>
<pre><code>## 
## [[2]]</code></pre>
<p><img src="modern_R_files/figure-html/unnamed-chunk-276-2.png" width="672" /></p>
<pre><code>## 
## [[3]]</code></pre>
<p><img src="modern_R_files/figure-html/unnamed-chunk-276-3.png" width="672" /></p>
<pre><code>## 
## [[4]]</code></pre>
<p><img src="modern_R_files/figure-html/unnamed-chunk-276-4.png" width="672" /></p>
<pre><code>## 
## [[5]]</code></pre>
<p><img src="modern_R_files/figure-html/unnamed-chunk-276-5.png" width="672" /></p>
<p>Ok, that was quite complicated, but again, this was only to introduce <code>nest()</code> and give you a taste
of the power of the <code>{tidyverse}</code>. By the end of Chapter 9, you‚Äôll be used to this.</p>
<p>That was it for a first introduction to <code>{tidyr}</code>. Now, it‚Äôs time to learn about <em>scoped</em> verbs.</p>
</div>
</div>
<div id="scoped-tidyverse-verbs" class="section level2">
<h2><span class="header-section-number">4.5</span> Scoped <code>{tidyverse}</code> verbs</h2>
<p>Scoped verbs are special versions of the verbs you are now familiar with.</p>
<div id="filter_" class="section level3">
<h3><span class="header-section-number">4.5.1</span> filter_*()</h3>
<p>Let‚Äôs go back to the <code>gasoline</code> data from the <code>{plm}</code> package.</p>
<p><code>filter()</code> is not the only <em>filtering</em> verb there is. Suppose that we have a condition that we want
to use to filter out a lot of columns at once. For example, for every column that is of type
<code>numeric</code>, keep only the lines where the condition <em>value &gt; -8</em> is satisfied. The next line does
that:</p>
<pre class="sourceCode r"><code class="sourceCode r">gasoline <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter_if</span>( <span class="op">~</span><span class="kw">all</span>(<span class="kw">is.numeric</span>(.)), <span class="kw">all_vars</span>(. <span class="op">&gt;</span><span class="st"> </span><span class="dv">-8</span>))</code></pre>
<pre><code>## # A tibble: 30 x 6
##    country  year lgaspcar lincomep  lrpmg lcarpcap
##    &lt;fct&gt;   &lt;int&gt;    &lt;dbl&gt;    &lt;dbl&gt;  &lt;dbl&gt;    &lt;dbl&gt;
##  1 CANADA   1972     4.89    -5.44 -1.10     -7.99
##  2 CANADA   1973     4.90    -5.41 -1.13     -7.94
##  3 CANADA   1974     4.89    -5.42 -1.12     -7.90
##  4 CANADA   1975     4.89    -5.38 -1.19     -7.87
##  5 CANADA   1976     4.84    -5.36 -1.06     -7.81
##  6 CANADA   1977     4.81    -5.34 -1.07     -7.77
##  7 CANADA   1978     4.86    -5.31 -1.07     -7.79
##  8 GERMANY  1978     3.88    -5.56 -0.628    -7.95
##  9 SWEDEN   1975     3.97    -7.68 -2.77     -7.99
## 10 SWEDEN   1976     3.98    -7.67 -2.82     -7.96
## # ‚Ä¶ with 20 more rows</code></pre>
<p>This is a bit more complicated than before, but let‚Äôs go through it, step by step.
<code>filter_if()</code> needs 3 arguments to work; the data, a
predicate function (a function that returns <code>TRUE</code>, or <code>FALSE</code>) which will select the columns we
want to work on, and then the condition. The condition can be applied to <em>all</em> the columns that
were selected by the predicate function (hence the <code>all_vars()</code>) or only to at least one (you‚Äôd use
<code>any_vars()</code> then). Try to change the condition, or the predicate function, to figure out how
<code>filter_if()</code> works. The dot is a placeholder that stands for whatever columns where selected.</p>
<p>Another scoped <code>filter()</code> verb is <code>filter_at()</code>; it allows the user to filter columns by position:</p>
<pre class="sourceCode r"><code class="sourceCode r">gasoline <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter_at</span>(<span class="kw">vars</span>(<span class="kw">ends_with</span>(<span class="st">&quot;p&quot;</span>)), <span class="kw">all_vars</span>(. <span class="op">&gt;</span><span class="st"> </span><span class="dv">-8</span>))</code></pre>
<pre><code>## # A tibble: 30 x 6
##    country  year lgaspcar lincomep  lrpmg lcarpcap
##    &lt;fct&gt;   &lt;int&gt;    &lt;dbl&gt;    &lt;dbl&gt;  &lt;dbl&gt;    &lt;dbl&gt;
##  1 CANADA   1972     4.89    -5.44 -1.10     -7.99
##  2 CANADA   1973     4.90    -5.41 -1.13     -7.94
##  3 CANADA   1974     4.89    -5.42 -1.12     -7.90
##  4 CANADA   1975     4.89    -5.38 -1.19     -7.87
##  5 CANADA   1976     4.84    -5.36 -1.06     -7.81
##  6 CANADA   1977     4.81    -5.34 -1.07     -7.77
##  7 CANADA   1978     4.86    -5.31 -1.07     -7.79
##  8 GERMANY  1978     3.88    -5.56 -0.628    -7.95
##  9 SWEDEN   1975     3.97    -7.68 -2.77     -7.99
## 10 SWEDEN   1976     3.98    -7.67 -2.82     -7.96
## # ‚Ä¶ with 20 more rows</code></pre>
<p>we already know about <code>ends_with()</code> and <code>starts_with()</code>. So the above line means ‚Äúfor the columns
whose name end with a ‚Äòp‚Äô only keep the lines where, for all the selected columns, the values are
strictly superior to <code>-8</code>‚Äù. Again, this is not very easy the first time you deal with that, so
play around with it for a bit.</p>
<p>Finally, there is also <code>filter_all()</code> which, as the name implies, uses all the variables for
the filtering step.</p>
<p><code>filter_if()</code> and <code>filter_at()</code> are very useful when you have very large datasets with a lot of
variables and you want to apply a filtering function only to a subset of them. <code>filter_all()</code> is
useful if, for example, you only want to keep the positive values for all the columns.</p>
</div>
<div id="select_-and-rename_" class="section level3">
<h3><span class="header-section-number">4.5.2</span> select_*() and rename_*()</h3>
<p>Just as with <code>filter()</code>, <code>select()</code> also has scoped versions. <code>select_if()</code> makes it easy to
select columns that satisfy a criterium:</p>
<pre class="sourceCode r"><code class="sourceCode r">gasoline <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select_if</span>(is.numeric)</code></pre>
<pre><code>## # A tibble: 342 x 5
##     year lgaspcar lincomep  lrpmg lcarpcap
##    &lt;int&gt;    &lt;dbl&gt;    &lt;dbl&gt;  &lt;dbl&gt;    &lt;dbl&gt;
##  1  1960     4.17    -6.47 -0.335    -9.77
##  2  1961     4.10    -6.43 -0.351    -9.61
##  3  1962     4.07    -6.41 -0.380    -9.46
##  4  1963     4.06    -6.37 -0.414    -9.34
##  5  1964     4.04    -6.32 -0.445    -9.24
##  6  1965     4.03    -6.29 -0.497    -9.12
##  7  1966     4.05    -6.25 -0.467    -9.02
##  8  1967     4.05    -6.23 -0.506    -8.93
##  9  1968     4.05    -6.21 -0.522    -8.85
## 10  1969     4.05    -6.15 -0.559    -8.79
## # ‚Ä¶ with 332 more rows</code></pre>
<p>You can even pass a further function to <code>select_if()</code> that will be applied to the selected columns:</p>
<pre class="sourceCode r"><code class="sourceCode r">gasoline <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select_if</span>(is.numeric, toupper)</code></pre>
<pre><code>## # A tibble: 342 x 5
##     YEAR LGASPCAR LINCOMEP  LRPMG LCARPCAP
##    &lt;int&gt;    &lt;dbl&gt;    &lt;dbl&gt;  &lt;dbl&gt;    &lt;dbl&gt;
##  1  1960     4.17    -6.47 -0.335    -9.77
##  2  1961     4.10    -6.43 -0.351    -9.61
##  3  1962     4.07    -6.41 -0.380    -9.46
##  4  1963     4.06    -6.37 -0.414    -9.34
##  5  1964     4.04    -6.32 -0.445    -9.24
##  6  1965     4.03    -6.29 -0.497    -9.12
##  7  1966     4.05    -6.25 -0.467    -9.02
##  8  1967     4.05    -6.23 -0.506    -8.93
##  9  1968     4.05    -6.21 -0.522    -8.85
## 10  1969     4.05    -6.15 -0.559    -8.79
## # ‚Ä¶ with 332 more rows</code></pre>
<p><code>select_at()</code> makes it easy to select all the variables that start with ‚Äúl‚Äù for example:</p>
<pre class="sourceCode r"><code class="sourceCode r">gasoline <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select_at</span>(<span class="kw">vars</span>(<span class="kw">starts_with</span>(<span class="st">&quot;l&quot;</span>)))</code></pre>
<pre><code>## # A tibble: 342 x 4
##    lgaspcar lincomep  lrpmg lcarpcap
##       &lt;dbl&gt;    &lt;dbl&gt;  &lt;dbl&gt;    &lt;dbl&gt;
##  1     4.17    -6.47 -0.335    -9.77
##  2     4.10    -6.43 -0.351    -9.61
##  3     4.07    -6.41 -0.380    -9.46
##  4     4.06    -6.37 -0.414    -9.34
##  5     4.04    -6.32 -0.445    -9.24
##  6     4.03    -6.29 -0.497    -9.12
##  7     4.05    -6.25 -0.467    -9.02
##  8     4.05    -6.23 -0.506    -8.93
##  9     4.05    -6.21 -0.522    -8.85
## 10     4.05    -6.15 -0.559    -8.79
## # ‚Ä¶ with 332 more rows</code></pre>
<p><code>select_at()</code> also works if you specify the position of the columns you‚Äôre interested in:</p>
<pre class="sourceCode r"><code class="sourceCode r">gasoline <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select_at</span>(<span class="kw">vars</span>(<span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">5</span>)))</code></pre>
<pre><code>## # A tibble: 342 x 3
##    country  year  lrpmg
##    &lt;fct&gt;   &lt;int&gt;  &lt;dbl&gt;
##  1 AUSTRIA  1960 -0.335
##  2 AUSTRIA  1961 -0.351
##  3 AUSTRIA  1962 -0.380
##  4 AUSTRIA  1963 -0.414
##  5 AUSTRIA  1964 -0.445
##  6 AUSTRIA  1965 -0.497
##  7 AUSTRIA  1966 -0.467
##  8 AUSTRIA  1967 -0.506
##  9 AUSTRIA  1968 -0.522
## 10 AUSTRIA  1969 -0.559
## # ‚Ä¶ with 332 more rows</code></pre>
<p>Notice that I use a new helper function, <code>vars()</code>, which allows me to specify which variables I want
to select. This is similar to the helper functions we have seen before, <code>all_vars()</code>
and <code>any_vars()</code>. So the way to read the above line would be something like ‚ÄúStart with the
gasoline data, then select the variables at position 1, 2, 5‚Äù. Knowing how to read your code makes
it even easier to write.</p>
<p>There is also a <code>select_all()</code>, and you might be wondering why it is useful:</p>
<pre class="sourceCode r"><code class="sourceCode r">gasoline <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select_all</span>()</code></pre>
<pre><code>## # A tibble: 342 x 6
##    country  year lgaspcar lincomep  lrpmg lcarpcap
##    &lt;fct&gt;   &lt;int&gt;    &lt;dbl&gt;    &lt;dbl&gt;  &lt;dbl&gt;    &lt;dbl&gt;
##  1 AUSTRIA  1960     4.17    -6.47 -0.335    -9.77
##  2 AUSTRIA  1961     4.10    -6.43 -0.351    -9.61
##  3 AUSTRIA  1962     4.07    -6.41 -0.380    -9.46
##  4 AUSTRIA  1963     4.06    -6.37 -0.414    -9.34
##  5 AUSTRIA  1964     4.04    -6.32 -0.445    -9.24
##  6 AUSTRIA  1965     4.03    -6.29 -0.497    -9.12
##  7 AUSTRIA  1966     4.05    -6.25 -0.467    -9.02
##  8 AUSTRIA  1967     4.05    -6.23 -0.506    -8.93
##  9 AUSTRIA  1968     4.05    -6.21 -0.522    -8.85
## 10 AUSTRIA  1969     4.05    -6.15 -0.559    -8.79
## # ‚Ä¶ with 332 more rows</code></pre>
<p>This simply returns all the columns of the data frame‚Ä¶ but wait, <code>selec_all()</code> allows you to do
something very useful, which is rename all the columns in bulk:</p>
<pre class="sourceCode r"><code class="sourceCode r">gasoline <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select_all</span>(toupper)</code></pre>
<pre><code>## # A tibble: 342 x 6
##    COUNTRY  YEAR LGASPCAR LINCOMEP  LRPMG LCARPCAP
##    &lt;fct&gt;   &lt;int&gt;    &lt;dbl&gt;    &lt;dbl&gt;  &lt;dbl&gt;    &lt;dbl&gt;
##  1 AUSTRIA  1960     4.17    -6.47 -0.335    -9.77
##  2 AUSTRIA  1961     4.10    -6.43 -0.351    -9.61
##  3 AUSTRIA  1962     4.07    -6.41 -0.380    -9.46
##  4 AUSTRIA  1963     4.06    -6.37 -0.414    -9.34
##  5 AUSTRIA  1964     4.04    -6.32 -0.445    -9.24
##  6 AUSTRIA  1965     4.03    -6.29 -0.497    -9.12
##  7 AUSTRIA  1966     4.05    -6.25 -0.467    -9.02
##  8 AUSTRIA  1967     4.05    -6.23 -0.506    -8.93
##  9 AUSTRIA  1968     4.05    -6.21 -0.522    -8.85
## 10 AUSTRIA  1969     4.05    -6.15 -0.559    -8.79
## # ‚Ä¶ with 332 more rows</code></pre>
<p>You can apply any arbitrary function:</p>
<pre class="sourceCode r"><code class="sourceCode r">gasoline <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select_all</span>(<span class="kw">funs</span>(<span class="kw">paste0</span>(<span class="st">&quot;hello_&quot;</span>, .)))</code></pre>
<pre><code>## Warning: funs() is soft deprecated as of dplyr 0.8.0
## please use list() instead
## 
## # Before:
## funs(name = f(.)
## 
## # After: 
## list(name = ~f(.))
## This warning is displayed once per session.</code></pre>
<pre><code>## # A tibble: 342 x 6
##    hello_country hello_year hello_lgaspcar hello_lincomep hello_lrpmg
##    &lt;fct&gt;              &lt;int&gt;          &lt;dbl&gt;          &lt;dbl&gt;       &lt;dbl&gt;
##  1 AUSTRIA             1960           4.17          -6.47      -0.335
##  2 AUSTRIA             1961           4.10          -6.43      -0.351
##  3 AUSTRIA             1962           4.07          -6.41      -0.380
##  4 AUSTRIA             1963           4.06          -6.37      -0.414
##  5 AUSTRIA             1964           4.04          -6.32      -0.445
##  6 AUSTRIA             1965           4.03          -6.29      -0.497
##  7 AUSTRIA             1966           4.05          -6.25      -0.467
##  8 AUSTRIA             1967           4.05          -6.23      -0.506
##  9 AUSTRIA             1968           4.05          -6.21      -0.522
## 10 AUSTRIA             1969           4.05          -6.15      -0.559
## # ‚Ä¶ with 332 more rows, and 1 more variable: hello_lcarpcap &lt;dbl&gt;</code></pre>
<p>I have passed the <code>paste0()</code> function to the <code>funs()</code> helper function of <code>select_all()</code>. <code>funs()</code> is
used a lot with scoped verbs, just like <code>vars()</code>, which we have already seen.</p>
<p>The scoped version of <code>rename()</code> work just as you expect. But I‚Äôll leave these for the exercices
down below.</p>
</div>
<div id="group_by_" class="section level3">
<h3><span class="header-section-number">4.5.3</span> group_by_*()</h3>
<p>To illustrate <code>group_by_*()</code> I have to first modify the <code>gasoline</code> data a little bit. As you can
see below, the data column is of type integer:</p>
<pre class="sourceCode r"><code class="sourceCode r">gasoline</code></pre>
<pre><code>## # A tibble: 342 x 6
##    country  year lgaspcar lincomep  lrpmg lcarpcap
##    &lt;fct&gt;   &lt;int&gt;    &lt;dbl&gt;    &lt;dbl&gt;  &lt;dbl&gt;    &lt;dbl&gt;
##  1 AUSTRIA  1960     4.17    -6.47 -0.335    -9.77
##  2 AUSTRIA  1961     4.10    -6.43 -0.351    -9.61
##  3 AUSTRIA  1962     4.07    -6.41 -0.380    -9.46
##  4 AUSTRIA  1963     4.06    -6.37 -0.414    -9.34
##  5 AUSTRIA  1964     4.04    -6.32 -0.445    -9.24
##  6 AUSTRIA  1965     4.03    -6.29 -0.497    -9.12
##  7 AUSTRIA  1966     4.05    -6.25 -0.467    -9.02
##  8 AUSTRIA  1967     4.05    -6.23 -0.506    -8.93
##  9 AUSTRIA  1968     4.05    -6.21 -0.522    -8.85
## 10 AUSTRIA  1969     4.05    -6.15 -0.559    -8.79
## # ‚Ä¶ with 332 more rows</code></pre>
<p>Let‚Äôs change that to character:</p>
<pre class="sourceCode r"><code class="sourceCode r">gasoline &lt;-<span class="st"> </span>gasoline <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">mutate</span>(<span class="dt">year =</span> <span class="kw">as.character</span>(year))</code></pre>
<p>Now, this allows me to do the following:</p>
<pre class="sourceCode r"><code class="sourceCode r">gasoline <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">group_by_if</span>(is.character) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">summarise</span>(<span class="kw">mean</span>(lincomep))</code></pre>
<pre><code>## # A tibble: 19 x 2
##    year  `mean(lincomep)`
##    &lt;chr&gt;            &lt;dbl&gt;
##  1 1960             -6.50
##  2 1961             -6.46
##  3 1962             -6.42
##  4 1963             -6.37
##  5 1964             -6.33
##  6 1965             -6.29
##  7 1966             -6.25
##  8 1967             -6.21
##  9 1968             -6.18
## 10 1969             -6.12
## 11 1970             -6.07
## 12 1971             -6.04
## 13 1972             -5.99
## 14 1973             -5.94
## 15 1974             -5.93
## 16 1975             -5.93
## 17 1976             -5.89
## 18 1977             -5.87
## 19 1978             -5.84</code></pre>
<p>This is faster than having to write:</p>
<pre class="sourceCode r"><code class="sourceCode r">gasoline <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">group_by</span>(country, year) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">summarise</span>(<span class="kw">mean</span>(lincomep))</code></pre>
<pre><code>## # A tibble: 342 x 3
## # Groups:   country [18]
##    country year  `mean(lincomep)`
##    &lt;fct&gt;   &lt;chr&gt;            &lt;dbl&gt;
##  1 AUSTRIA 1960             -6.47
##  2 AUSTRIA 1961             -6.43
##  3 AUSTRIA 1962             -6.41
##  4 AUSTRIA 1963             -6.37
##  5 AUSTRIA 1964             -6.32
##  6 AUSTRIA 1965             -6.29
##  7 AUSTRIA 1966             -6.25
##  8 AUSTRIA 1967             -6.23
##  9 AUSTRIA 1968             -6.21
## 10 AUSTRIA 1969             -6.15
## # ‚Ä¶ with 332 more rows</code></pre>
<p>You may think that having two write the name of two variables is not a huge hassle, which is true.
But imagine that you have dozens of character columns that you want to group by. This is the kind
of situation where <code>group_by_if()</code> is very useful. If you prefer, you can specify the position of
the columns instead of the name of the columns, with <code>group_by_at()</code>:</p>
<pre class="sourceCode r"><code class="sourceCode r">gasoline <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">group_by_at</span>(<span class="kw">vars</span>(<span class="dv">1</span>, <span class="dv">2</span>)) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">summarise</span>(<span class="kw">mean</span>(lincomep))</code></pre>
<pre><code>## # A tibble: 342 x 3
## # Groups:   country [18]
##    country year  `mean(lincomep)`
##    &lt;fct&gt;   &lt;chr&gt;            &lt;dbl&gt;
##  1 AUSTRIA 1960             -6.47
##  2 AUSTRIA 1961             -6.43
##  3 AUSTRIA 1962             -6.41
##  4 AUSTRIA 1963             -6.37
##  5 AUSTRIA 1964             -6.32
##  6 AUSTRIA 1965             -6.29
##  7 AUSTRIA 1966             -6.25
##  8 AUSTRIA 1967             -6.23
##  9 AUSTRIA 1968             -6.21
## 10 AUSTRIA 1969             -6.15
## # ‚Ä¶ with 332 more rows</code></pre>
<p>There is also a <code>group_by_all()</code>, but I fail to see the use case‚Ä¶</p>
</div>
<div id="summarise_" class="section level3">
<h3><span class="header-section-number">4.5.4</span> summarise_()</h3>
<p>Just like for <code>filter()</code>, <code>select()</code>, and <code>group_by()</code>, summarise()` comes with scoped versions:</p>
<pre class="sourceCode r"><code class="sourceCode r">gasoline <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">group_by</span>(country) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">summarise_at</span>(<span class="kw">vars</span>(<span class="kw">starts_with</span>(<span class="st">&quot;l&quot;</span>)), mean)</code></pre>
<pre><code>## # A tibble: 18 x 5
##    country  lgaspcar lincomep   lrpmg lcarpcap
##    &lt;fct&gt;       &lt;dbl&gt;    &lt;dbl&gt;   &lt;dbl&gt;    &lt;dbl&gt;
##  1 AUSTRIA      4.06    -6.12 -0.486     -8.85
##  2 BELGIUM      3.92    -5.85 -0.326     -8.63
##  3 CANADA       4.86    -5.58 -1.05      -8.08
##  4 DENMARK      4.19    -5.76 -0.358     -8.58
##  5 FRANCE       3.82    -5.87 -0.253     -8.45
##  6 GERMANY      3.89    -5.85 -0.517     -8.51
##  7 GREECE       4.88    -6.61 -0.0339   -10.8 
##  8 IRELAND      4.23    -6.44 -0.348     -9.04
##  9 ITALY        3.73    -6.35 -0.152     -8.83
## 10 JAPAN        4.70    -6.25 -0.287     -9.95
## 11 NETHERLA     4.08    -5.92 -0.370     -8.82
## 12 NORWAY       4.11    -5.75 -0.278     -8.77
## 13 SPAIN        4.06    -5.63  0.739     -9.90
## 14 SWEDEN       4.01    -7.82 -2.71      -8.25
## 15 SWITZERL     4.24    -5.93 -0.902     -8.54
## 16 TURKEY       5.77    -7.34 -0.422    -12.5 
## 17 U.K.         3.98    -6.02 -0.459     -8.55
## 18 U.S.A.       4.82    -5.45 -1.21      -7.78</code></pre>
<p>See how I managed to summarise every variable in one simple call to <code>summarise_at()</code>? Simply by
using <code>vars()</code> and specifying that I was interested in the ones that started with ‚Äúl‚Äù and then I
specified the function I wanted. But what if I wanted to use more than one function to summarise
the data? Very easy:</p>
<pre class="sourceCode r"><code class="sourceCode r">gasoline <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">group_by</span>(country) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">summarise_at</span>(<span class="kw">vars</span>(<span class="kw">starts_with</span>(<span class="st">&quot;l&quot;</span>)), <span class="kw">funs</span>(mean, sd, max, min))</code></pre>
<pre><code>## # A tibble: 18 x 17
##    country lgaspcar_mean lincomep_mean lrpmg_mean lcarpcap_mean lgaspcar_sd
##    &lt;fct&gt;           &lt;dbl&gt;         &lt;dbl&gt;      &lt;dbl&gt;         &lt;dbl&gt;       &lt;dbl&gt;
##  1 AUSTRIA          4.06         -6.12    -0.486          -8.85      0.0693
##  2 BELGIUM          3.92         -5.85    -0.326          -8.63      0.103 
##  3 CANADA           4.86         -5.58    -1.05           -8.08      0.0262
##  4 DENMARK          4.19         -5.76    -0.358          -8.58      0.158 
##  5 FRANCE           3.82         -5.87    -0.253          -8.45      0.0499
##  6 GERMANY          3.89         -5.85    -0.517          -8.51      0.0239
##  7 GREECE           4.88         -6.61    -0.0339        -10.8       0.255 
##  8 IRELAND          4.23         -6.44    -0.348          -9.04      0.0437
##  9 ITALY            3.73         -6.35    -0.152          -8.83      0.220 
## 10 JAPAN            4.70         -6.25    -0.287          -9.95      0.684 
## 11 NETHER‚Ä¶          4.08         -5.92    -0.370          -8.82      0.286 
## 12 NORWAY           4.11         -5.75    -0.278          -8.77      0.123 
## 13 SPAIN            4.06         -5.63     0.739          -9.90      0.317 
## 14 SWEDEN           4.01         -7.82    -2.71           -8.25      0.0364
## 15 SWITZE‚Ä¶          4.24         -5.93    -0.902          -8.54      0.102 
## 16 TURKEY           5.77         -7.34    -0.422         -12.5       0.329 
## 17 U.K.             3.98         -6.02    -0.459          -8.55      0.0479
## 18 U.S.A.           4.82         -5.45    -1.21           -7.78      0.0219
## # ‚Ä¶ with 11 more variables: lincomep_sd &lt;dbl&gt;, lrpmg_sd &lt;dbl&gt;,
## #   lcarpcap_sd &lt;dbl&gt;, lgaspcar_max &lt;dbl&gt;, lincomep_max &lt;dbl&gt;,
## #   lrpmg_max &lt;dbl&gt;, lcarpcap_max &lt;dbl&gt;, lgaspcar_min &lt;dbl&gt;,
## #   lincomep_min &lt;dbl&gt;, lrpmg_min &lt;dbl&gt;, lcarpcap_min &lt;dbl&gt;</code></pre>
<p>Just use <code>vars()</code> to specify the variables you want to summarise, and then <code>funs()</code> to list all the
functions you want to use on each of the columns.</p>
<p>But maybe you‚Äôre just interested in descriptive statistics for some variables, but not all those
that start with ‚Äúl‚Äù? What if you want to use another pattern? Easy to do with the <code>contains()</code>
helper:</p>
<pre class="sourceCode r"><code class="sourceCode r">gasoline <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">group_by</span>(country) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">summarise_at</span>(<span class="kw">vars</span>(dplyr<span class="op">::</span><span class="kw">contains</span>(<span class="st">&quot;car&quot;</span>)), <span class="kw">funs</span>(mean, sd, max, min))</code></pre>
<pre><code>## # A tibble: 18 x 9
##    country lgaspcar_mean lcarpcap_mean lgaspcar_sd lcarpcap_sd lgaspcar_max
##    &lt;fct&gt;           &lt;dbl&gt;         &lt;dbl&gt;       &lt;dbl&gt;       &lt;dbl&gt;        &lt;dbl&gt;
##  1 AUSTRIA          4.06         -8.85      0.0693       0.473         4.20
##  2 BELGIUM          3.92         -8.63      0.103        0.417         4.16
##  3 CANADA           4.86         -8.08      0.0262       0.195         4.90
##  4 DENMARK          4.19         -8.58      0.158        0.349         4.50
##  5 FRANCE           3.82         -8.45      0.0499       0.344         3.91
##  6 GERMANY          3.89         -8.51      0.0239       0.406         3.93
##  7 GREECE           4.88        -10.8       0.255        0.839         5.38
##  8 IRELAND          4.23         -9.04      0.0437       0.345         4.33
##  9 ITALY            3.73         -8.83      0.220        0.639         4.05
## 10 JAPAN            4.70         -9.95      0.684        1.20          6.00
## 11 NETHER‚Ä¶          4.08         -8.82      0.286        0.617         4.65
## 12 NORWAY           4.11         -8.77      0.123        0.438         4.44
## 13 SPAIN            4.06         -9.90      0.317        0.960         4.75
## 14 SWEDEN           4.01         -8.25      0.0364       0.242         4.07
## 15 SWITZE‚Ä¶          4.24         -8.54      0.102        0.378         4.44
## 16 TURKEY           5.77        -12.5       0.329        0.751         6.16
## 17 U.K.             3.98         -8.55      0.0479       0.281         4.10
## 18 U.S.A.           4.82         -7.78      0.0219       0.162         4.86
## # ‚Ä¶ with 3 more variables: lcarpcap_max &lt;dbl&gt;, lgaspcar_min &lt;dbl&gt;,
## #   lcarpcap_min &lt;dbl&gt;</code></pre>
<p>I used <code>dplyr::contains()</code> instead of simply <code>contains()</code> because there‚Äôs also a
<code>purrr::contains()</code>. If you load <code>purrr</code> after <code>dplyr</code>, <code>contains()</code> will actually be
<code>purrr::contains()</code> and not <code>dplyr::contains()</code> which causes the above code to fail.</p>
<p>There‚Äôs also <code>summarise_if()</code>:</p>
<pre class="sourceCode r"><code class="sourceCode r">gasoline <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">group_by</span>(country) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">summarise_if</span>(is.double, <span class="kw">funs</span>(mean, sd, min, max))</code></pre>
<pre><code>## # A tibble: 18 x 17
##    country lgaspcar_mean lincomep_mean lrpmg_mean lcarpcap_mean lgaspcar_sd
##    &lt;fct&gt;           &lt;dbl&gt;         &lt;dbl&gt;      &lt;dbl&gt;         &lt;dbl&gt;       &lt;dbl&gt;
##  1 AUSTRIA          4.06         -6.12    -0.486          -8.85      0.0693
##  2 BELGIUM          3.92         -5.85    -0.326          -8.63      0.103 
##  3 CANADA           4.86         -5.58    -1.05           -8.08      0.0262
##  4 DENMARK          4.19         -5.76    -0.358          -8.58      0.158 
##  5 FRANCE           3.82         -5.87    -0.253          -8.45      0.0499
##  6 GERMANY          3.89         -5.85    -0.517          -8.51      0.0239
##  7 GREECE           4.88         -6.61    -0.0339        -10.8       0.255 
##  8 IRELAND          4.23         -6.44    -0.348          -9.04      0.0437
##  9 ITALY            3.73         -6.35    -0.152          -8.83      0.220 
## 10 JAPAN            4.70         -6.25    -0.287          -9.95      0.684 
## 11 NETHER‚Ä¶          4.08         -5.92    -0.370          -8.82      0.286 
## 12 NORWAY           4.11         -5.75    -0.278          -8.77      0.123 
## 13 SPAIN            4.06         -5.63     0.739          -9.90      0.317 
## 14 SWEDEN           4.01         -7.82    -2.71           -8.25      0.0364
## 15 SWITZE‚Ä¶          4.24         -5.93    -0.902          -8.54      0.102 
## 16 TURKEY           5.77         -7.34    -0.422         -12.5       0.329 
## 17 U.K.             3.98         -6.02    -0.459          -8.55      0.0479
## 18 U.S.A.           4.82         -5.45    -1.21           -7.78      0.0219
## # ‚Ä¶ with 11 more variables: lincomep_sd &lt;dbl&gt;, lrpmg_sd &lt;dbl&gt;,
## #   lcarpcap_sd &lt;dbl&gt;, lgaspcar_min &lt;dbl&gt;, lincomep_min &lt;dbl&gt;,
## #   lrpmg_min &lt;dbl&gt;, lcarpcap_min &lt;dbl&gt;, lgaspcar_max &lt;dbl&gt;,
## #   lincomep_max &lt;dbl&gt;, lrpmg_max &lt;dbl&gt;, lcarpcap_max &lt;dbl&gt;</code></pre>
<p>This allows you to summarise every column that contain real numbers. The difference between
<code>is.double()</code> and <code>is.numeric()</code> is that <code>is.numeric()</code> returns <code>TRUE</code> for integers too, whereas
<code>is.double()</code> returns <code>TRUE</code> for real numbers only (integers are real numbers too, but you know
what I mean). To go faster, you can also use <code>summarise_all()</code>:</p>
<pre class="sourceCode r"><code class="sourceCode r">gasoline <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>year) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">group_by</span>(country) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">summarise_all</span>(<span class="kw">funs</span>(mean, sd, min, max))</code></pre>
<pre><code>## # A tibble: 18 x 17
##    country lgaspcar_mean lincomep_mean lrpmg_mean lcarpcap_mean lgaspcar_sd
##    &lt;fct&gt;           &lt;dbl&gt;         &lt;dbl&gt;      &lt;dbl&gt;         &lt;dbl&gt;       &lt;dbl&gt;
##  1 AUSTRIA          4.06         -6.12    -0.486          -8.85      0.0693
##  2 BELGIUM          3.92         -5.85    -0.326          -8.63      0.103 
##  3 CANADA           4.86         -5.58    -1.05           -8.08      0.0262
##  4 DENMARK          4.19         -5.76    -0.358          -8.58      0.158 
##  5 FRANCE           3.82         -5.87    -0.253          -8.45      0.0499
##  6 GERMANY          3.89         -5.85    -0.517          -8.51      0.0239
##  7 GREECE           4.88         -6.61    -0.0339        -10.8       0.255 
##  8 IRELAND          4.23         -6.44    -0.348          -9.04      0.0437
##  9 ITALY            3.73         -6.35    -0.152          -8.83      0.220 
## 10 JAPAN            4.70         -6.25    -0.287          -9.95      0.684 
## 11 NETHER‚Ä¶          4.08         -5.92    -0.370          -8.82      0.286 
## 12 NORWAY           4.11         -5.75    -0.278          -8.77      0.123 
## 13 SPAIN            4.06         -5.63     0.739          -9.90      0.317 
## 14 SWEDEN           4.01         -7.82    -2.71           -8.25      0.0364
## 15 SWITZE‚Ä¶          4.24         -5.93    -0.902          -8.54      0.102 
## 16 TURKEY           5.77         -7.34    -0.422         -12.5       0.329 
## 17 U.K.             3.98         -6.02    -0.459          -8.55      0.0479
## 18 U.S.A.           4.82         -5.45    -1.21           -7.78      0.0219
## # ‚Ä¶ with 11 more variables: lincomep_sd &lt;dbl&gt;, lrpmg_sd &lt;dbl&gt;,
## #   lcarpcap_sd &lt;dbl&gt;, lgaspcar_min &lt;dbl&gt;, lincomep_min &lt;dbl&gt;,
## #   lrpmg_min &lt;dbl&gt;, lcarpcap_min &lt;dbl&gt;, lgaspcar_max &lt;dbl&gt;,
## #   lincomep_max &lt;dbl&gt;, lrpmg_max &lt;dbl&gt;, lcarpcap_max &lt;dbl&gt;</code></pre>
<p>I removed the <code>year</code> variable because it‚Äôs not a variable for which we want to have descriptive
statistics.</p>
</div>
<div id="mutate_" class="section level3">
<h3><span class="header-section-number">4.5.5</span> mutate_*()</h3>
<p>Of course, <code>mutate()</code> and <code>transmute()</code> also come with scoped versions:</p>
<pre class="sourceCode r"><code class="sourceCode r">gasoline <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate_if</span>(is.double, exp)</code></pre>
<pre><code>## # A tibble: 342 x 6
##    country year  lgaspcar lincomep lrpmg  lcarpcap
##    &lt;fct&gt;   &lt;chr&gt;    &lt;dbl&gt;    &lt;dbl&gt; &lt;dbl&gt;     &lt;dbl&gt;
##  1 AUSTRIA 1960      64.9  0.00154 0.716 0.0000573
##  2 AUSTRIA 1961      60.4  0.00162 0.704 0.0000671
##  3 AUSTRIA 1962      58.7  0.00165 0.684 0.0000781
##  4 AUSTRIA 1963      57.9  0.00171 0.661 0.0000876
##  5 AUSTRIA 1964      56.7  0.00180 0.641 0.0000973
##  6 AUSTRIA 1965      56.5  0.00185 0.608 0.000109 
##  7 AUSTRIA 1966      57.3  0.00193 0.627 0.000121 
##  8 AUSTRIA 1967      57.6  0.00196 0.603 0.000132 
##  9 AUSTRIA 1968      57.1  0.00202 0.593 0.000144 
## 10 AUSTRIA 1969      57.2  0.00213 0.572 0.000152 
## # ‚Ä¶ with 332 more rows</code></pre>
<pre class="sourceCode r"><code class="sourceCode r">gasoline <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate_at</span>(<span class="kw">vars</span>(<span class="kw">starts_with</span>(<span class="st">&quot;l&quot;</span>)), exp)</code></pre>
<pre><code>## # A tibble: 342 x 6
##    country year  lgaspcar lincomep lrpmg  lcarpcap
##    &lt;fct&gt;   &lt;chr&gt;    &lt;dbl&gt;    &lt;dbl&gt; &lt;dbl&gt;     &lt;dbl&gt;
##  1 AUSTRIA 1960      64.9  0.00154 0.716 0.0000573
##  2 AUSTRIA 1961      60.4  0.00162 0.704 0.0000671
##  3 AUSTRIA 1962      58.7  0.00165 0.684 0.0000781
##  4 AUSTRIA 1963      57.9  0.00171 0.661 0.0000876
##  5 AUSTRIA 1964      56.7  0.00180 0.641 0.0000973
##  6 AUSTRIA 1965      56.5  0.00185 0.608 0.000109 
##  7 AUSTRIA 1966      57.3  0.00193 0.627 0.000121 
##  8 AUSTRIA 1967      57.6  0.00196 0.603 0.000132 
##  9 AUSTRIA 1968      57.1  0.00202 0.593 0.000144 
## 10 AUSTRIA 1969      57.2  0.00213 0.572 0.000152 
## # ‚Ä¶ with 332 more rows</code></pre>
<pre class="sourceCode r"><code class="sourceCode r">gasoline <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate_all</span>(as.character)</code></pre>
<pre><code>## # A tibble: 342 x 6
##    country year  lgaspcar     lincomep     lrpmg        lcarpcap    
##    &lt;chr&gt;   &lt;chr&gt; &lt;chr&gt;        &lt;chr&gt;        &lt;chr&gt;        &lt;chr&gt;       
##  1 AUSTRIA 1960  4.173244195  -6.474277179 -0.334547613 -9.766839569
##  2 AUSTRIA 1961  4.1009891049 -6.426005835 -0.351327614 -9.608621845
##  3 AUSTRIA 1962  4.0731765511 -6.407308295 -0.379517692 -9.457256552
##  4 AUSTRIA 1963  4.0595091239 -6.370678539 -0.414251392 -9.343154947
##  5 AUSTRIA 1964  4.037688787  -6.322246805 -0.445335362 -9.237739346
##  6 AUSTRIA 1965  4.033983285  -6.294667914 -0.497060662 -9.123903477
##  7 AUSTRIA 1966  4.0475365589 -6.252545451 -0.466837731 -9.019822048
##  8 AUSTRIA 1967  4.0529106939 -6.234580709 -0.505883405 -8.934402537
##  9 AUSTRIA 1968  4.045507048  -6.206894403 -0.522412545 -8.847967407
## 10 AUSTRIA 1969  4.0463547891 -6.153139668 -0.559110514 -8.788686207
## # ‚Ä¶ with 332 more rows</code></pre>
<p>I think that by now, you are able to understand the above lines quite easily. If not, try some other
functions, or mutating other variables and you‚Äôll see that it is not that complicated!</p>
</div>
</div>
<div id="other-useful-tidyverse-functions" class="section level2">
<h2><span class="header-section-number">4.6</span> Other useful <code>{tidyverse}</code> functions</h2>
<div id="if_else-case_when-and-recode" class="section level3">
<h3><span class="header-section-number">4.6.1</span> <code>if_else()</code>, <code>case_when()</code> and <code>recode()</code></h3>
<p>Some other very useful <code>{tidyverse}</code> functions are <code>if_else()</code> and <code>case_when</code>. These two
functions, combined with <code>mutate()</code> make it easy to create a new variable whose values must
respect certain conditions. For instance, we might want to have a dummy that equals <code>1</code> if a country
in the European Union (to simplify, say as of 2017) and <code>0</code> if not. First let‚Äôs create a list of
countries that are in the EU:</p>
<pre class="sourceCode r"><code class="sourceCode r">eu_countries &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;austria&quot;</span>, <span class="st">&quot;belgium&quot;</span>, <span class="st">&quot;bulgaria&quot;</span>, <span class="st">&quot;croatia&quot;</span>, <span class="st">&quot;republic of cyprus&quot;</span>,
                  <span class="st">&quot;czech republic&quot;</span>, <span class="st">&quot;denmark&quot;</span>, <span class="st">&quot;estonia&quot;</span>, <span class="st">&quot;finland&quot;</span>, <span class="st">&quot;france&quot;</span>, <span class="st">&quot;germany&quot;</span>,
                  <span class="st">&quot;greece&quot;</span>, <span class="st">&quot;hungary&quot;</span>, <span class="st">&quot;ireland&quot;</span>, <span class="st">&quot;italy&quot;</span>, <span class="st">&quot;latvia&quot;</span>, <span class="st">&quot;lithuania&quot;</span>, <span class="st">&quot;luxembourg&quot;</span>,
                  <span class="st">&quot;malta&quot;</span>, <span class="st">&quot;netherla&quot;</span>, <span class="st">&quot;poland&quot;</span>, <span class="st">&quot;portugal&quot;</span>, <span class="st">&quot;romania&quot;</span>, <span class="st">&quot;slovakia&quot;</span>, <span class="st">&quot;slovenia&quot;</span>,
                  <span class="st">&quot;spain&quot;</span>, <span class="st">&quot;sweden&quot;</span>, <span class="st">&quot;u.k.&quot;</span>)</code></pre>
<p>I‚Äôve had to change ‚Äúnetherlands‚Äù to ‚Äúnetherla‚Äù because that‚Äôs how the country is called in the
<code>gasoline</code> data. Now let‚Äôs create a dummy variable that equals <code>1</code> for EU countries, and <code>0</code> for the others:</p>
<pre class="sourceCode r"><code class="sourceCode r">gasoline <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">country =</span> <span class="kw">tolower</span>(country)) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">in_eu =</span> <span class="kw">if_else</span>(country <span class="op">%in%</span><span class="st"> </span>eu_countries, <span class="dv">1</span>, <span class="dv">0</span>))</code></pre>
<pre><code>## # A tibble: 342 x 7
##    country  year lgaspcar lincomep  lrpmg lcarpcap in_eu
##    &lt;chr&gt;   &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;  &lt;dbl&gt;    &lt;dbl&gt; &lt;dbl&gt;
##  1 austria  1960     4.17    -6.47 -0.335    -9.77     1
##  2 austria  1961     4.10    -6.43 -0.351    -9.61     1
##  3 austria  1962     4.07    -6.41 -0.380    -9.46     1
##  4 austria  1963     4.06    -6.37 -0.414    -9.34     1
##  5 austria  1964     4.04    -6.32 -0.445    -9.24     1
##  6 austria  1965     4.03    -6.29 -0.497    -9.12     1
##  7 austria  1966     4.05    -6.25 -0.467    -9.02     1
##  8 austria  1967     4.05    -6.23 -0.506    -8.93     1
##  9 austria  1968     4.05    -6.21 -0.522    -8.85     1
## 10 austria  1969     4.05    -6.15 -0.559    -8.79     1
## # ‚Ä¶ with 332 more rows</code></pre>
<p>Instead of <code>1</code> and <code>0</code>, we can of course use strings (I add <code>filter(year == 1960)</code> at the end to
have a better view of what happened):</p>
<pre class="sourceCode r"><code class="sourceCode r">gasoline <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">country =</span> <span class="kw">tolower</span>(country)) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">in_eu =</span> <span class="kw">if_else</span>(country <span class="op">%in%</span><span class="st"> </span>eu_countries, <span class="st">&quot;yes&quot;</span>, <span class="st">&quot;no&quot;</span>)) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">filter</span>(year <span class="op">==</span><span class="st"> </span><span class="dv">1960</span>)</code></pre>
<pre><code>## # A tibble: 18 x 7
##    country   year lgaspcar lincomep   lrpmg lcarpcap in_eu
##    &lt;chr&gt;    &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;   &lt;dbl&gt;    &lt;dbl&gt; &lt;chr&gt;
##  1 austria   1960     4.17    -6.47 -0.335     -9.77 yes  
##  2 belgium   1960     4.16    -6.22 -0.166     -9.41 yes  
##  3 canada    1960     4.86    -5.89 -0.972     -8.38 no   
##  4 denmark   1960     4.50    -6.06 -0.196     -9.33 yes  
##  5 france    1960     3.91    -6.26 -0.0196    -9.15 yes  
##  6 germany   1960     3.92    -6.16 -0.186     -9.34 yes  
##  7 greece    1960     5.04    -7.16 -0.0835   -12.2  yes  
##  8 ireland   1960     4.27    -6.72 -0.0765    -9.70 yes  
##  9 italy     1960     4.05    -6.73  0.165    -10.1  yes  
## 10 japan     1960     6.00    -6.99 -0.145    -12.2  no   
## 11 netherla  1960     4.65    -6.22 -0.201    -10.00 yes  
## 12 norway    1960     4.44    -6.09 -0.140     -9.68 no   
## 13 spain     1960     4.75    -6.17  1.13     -11.6  yes  
## 14 sweden    1960     4.06    -8.07 -2.52      -8.74 yes  
## 15 switzerl  1960     4.40    -6.16 -0.823     -9.26 no   
## 16 turkey    1960     6.13    -7.80 -0.253    -13.5  no   
## 17 u.k.      1960     4.10    -6.19 -0.391     -9.12 yes  
## 18 u.s.a.    1960     4.82    -5.70 -1.12      -8.02 no</code></pre>
<p>I think that <code>if_else()</code> is fairly straightforward, especially if you know <code>ifelse()</code> already. You
might be wondering what is the difference between these two. <code>if_else()</code> is stricter than
<code>ifelse()</code> and does not do type conversion. Compare the two next lines:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ifelse</span>(<span class="dv">1</span> <span class="op">==</span><span class="st"> </span><span class="dv">1</span>, <span class="st">&quot;0&quot;</span>, <span class="dv">1</span>)</code></pre>
<pre><code>## [1] &quot;0&quot;</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">if_else</span>(<span class="dv">1</span> <span class="op">==</span><span class="st"> </span><span class="dv">1</span>, <span class="st">&quot;0&quot;</span>, <span class="dv">1</span>)</code></pre>
<pre class="sourceCode r"><code class="sourceCode r">Error<span class="op">:</span><span class="st"> `</span><span class="dt">false</span><span class="st">`</span> must be type string, not double</code></pre>
<p>Type conversion, especially without a warning is very dangerous. <code>if_else()</code>‚Äôs behaviour which
consists in failing as soon as possble avoids a lot of pain and suffering, especially when
programming non-interactively.</p>
<p><code>if_else()</code> also accepts an optional argument, that allows you to specify what should be returned
in case of <code>NA</code>:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">if_else</span>(<span class="dv">1</span> <span class="op">&lt;=</span><span class="st"> </span><span class="ot">NA</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">999</span>)</code></pre>
<pre><code>## [1] 999</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Or</span>
<span class="kw">if_else</span>(<span class="dv">1</span> <span class="op">&lt;=</span><span class="st"> </span><span class="ot">NA</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="ot">NA_real_</span>)</code></pre>
<pre><code>## [1] NA</code></pre>
<p><code>case_when()</code> can be seen as a generalization of <code>if_else()</code>. Whenever you want to use multiple
<code>if_else()</code>s, that‚Äôs when you know you should use <code>case_when()</code> (I‚Äôm adding the filter at the end
for the same reason as before, to see the output better):</p>
<pre class="sourceCode r"><code class="sourceCode r">gasoline <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">country =</span> <span class="kw">tolower</span>(country)) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">region =</span> <span class="kw">case_when</span>(
           country <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;france&quot;</span>, <span class="st">&quot;italy&quot;</span>, <span class="st">&quot;turkey&quot;</span>, <span class="st">&quot;greece&quot;</span>, <span class="st">&quot;spain&quot;</span>) <span class="op">~</span><span class="st"> &quot;mediterranean&quot;</span>,
           country <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;germany&quot;</span>, <span class="st">&quot;austria&quot;</span>, <span class="st">&quot;switzerl&quot;</span>, <span class="st">&quot;belgium&quot;</span>, <span class="st">&quot;netherla&quot;</span>) <span class="op">~</span><span class="st"> &quot;central europe&quot;</span>,
           country <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;canada&quot;</span>, <span class="st">&quot;u.s.a.&quot;</span>, <span class="st">&quot;u.k.&quot;</span>, <span class="st">&quot;ireland&quot;</span>) <span class="op">~</span><span class="st"> &quot;anglosphere&quot;</span>,
           country <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;denmark&quot;</span>, <span class="st">&quot;norway&quot;</span>, <span class="st">&quot;sweden&quot;</span>) <span class="op">~</span><span class="st"> &quot;nordic&quot;</span>,
           country <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;japan&quot;</span>) <span class="op">~</span><span class="st"> &quot;asia&quot;</span>)) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">filter</span>(year <span class="op">==</span><span class="st"> </span><span class="dv">1960</span>)</code></pre>
<pre><code>## # A tibble: 18 x 7
##    country   year lgaspcar lincomep   lrpmg lcarpcap region        
##    &lt;chr&gt;    &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;   &lt;dbl&gt;    &lt;dbl&gt; &lt;chr&gt;         
##  1 austria   1960     4.17    -6.47 -0.335     -9.77 central europe
##  2 belgium   1960     4.16    -6.22 -0.166     -9.41 central europe
##  3 canada    1960     4.86    -5.89 -0.972     -8.38 anglosphere   
##  4 denmark   1960     4.50    -6.06 -0.196     -9.33 nordic        
##  5 france    1960     3.91    -6.26 -0.0196    -9.15 mediterranean 
##  6 germany   1960     3.92    -6.16 -0.186     -9.34 central europe
##  7 greece    1960     5.04    -7.16 -0.0835   -12.2  mediterranean 
##  8 ireland   1960     4.27    -6.72 -0.0765    -9.70 anglosphere   
##  9 italy     1960     4.05    -6.73  0.165    -10.1  mediterranean 
## 10 japan     1960     6.00    -6.99 -0.145    -12.2  asia          
## 11 netherla  1960     4.65    -6.22 -0.201    -10.00 central europe
## 12 norway    1960     4.44    -6.09 -0.140     -9.68 nordic        
## 13 spain     1960     4.75    -6.17  1.13     -11.6  mediterranean 
## 14 sweden    1960     4.06    -8.07 -2.52      -8.74 nordic        
## 15 switzerl  1960     4.40    -6.16 -0.823     -9.26 central europe
## 16 turkey    1960     6.13    -7.80 -0.253    -13.5  mediterranean 
## 17 u.k.      1960     4.10    -6.19 -0.391     -9.12 anglosphere   
## 18 u.s.a.    1960     4.82    -5.70 -1.12      -8.02 anglosphere</code></pre>
<p>If all you want is to recode values, you can use <code>recode()</code>. For example, the Netherlands is
written as ‚ÄúNETHERLA‚Äù in the <code>gasoline</code> data, which is quite ugly. Same for Switzerland:</p>
<pre class="sourceCode r"><code class="sourceCode r">gasoline &lt;-<span class="st"> </span>gasoline <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">country =</span> <span class="kw">tolower</span>(country)) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">country =</span> <span class="kw">recode</span>(country, <span class="st">&quot;netherla&quot;</span> =<span class="st"> &quot;netherlands&quot;</span>, <span class="st">&quot;switzerl&quot;</span> =<span class="st"> &quot;switzerland&quot;</span>))</code></pre>
<p>I saved the data with these changes as they will become useful in the future. Let‚Äôs take a look at
the data:</p>
<pre class="sourceCode r"><code class="sourceCode r">gasoline <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">filter</span>(country <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;netherlands&quot;</span>, <span class="st">&quot;switzerland&quot;</span>), year <span class="op">==</span><span class="st"> </span><span class="dv">1960</span>)</code></pre>
<pre><code>## # A tibble: 2 x 6
##   country      year lgaspcar lincomep  lrpmg lcarpcap
##   &lt;chr&gt;       &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;  &lt;dbl&gt;    &lt;dbl&gt;
## 1 netherlands  1960     4.65    -6.22 -0.201   -10.00
## 2 switzerland  1960     4.40    -6.16 -0.823    -9.26</code></pre>
</div>
<div id="lead-and-lag" class="section level3">
<h3><span class="header-section-number">4.6.2</span> <code>lead()</code> and <code>lag()</code></h3>
<p><code>lead()</code> and <code>lag()</code> are especially useful in econometrics. When I was doing my masters, in 4 B.d.
(<em>Before dplyr</em>) lagging variables in panel data was quite tricky. Now, with <code>dplyr</code> it‚Äôs really
very easy:</p>
<pre class="sourceCode r"><code class="sourceCode r">gasoline <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">group_by</span>(country) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">lag_lgaspcar =</span> <span class="kw">lag</span>(lgaspcar)) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">lead_lgaspcar =</span> <span class="kw">lead</span>(lgaspcar)) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">filter</span>(year <span class="op">%in%</span><span class="st"> </span><span class="kw">seq</span>(<span class="dv">1960</span>, <span class="dv">1963</span>))</code></pre>
<pre><code>## # A tibble: 72 x 8
## # Groups:   country [18]
##    country  year lgaspcar lincomep  lrpmg lcarpcap lag_lgaspcar
##    &lt;chr&gt;   &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;  &lt;dbl&gt;    &lt;dbl&gt;        &lt;dbl&gt;
##  1 austria  1960     4.17    -6.47 -0.335    -9.77        NA   
##  2 austria  1961     4.10    -6.43 -0.351    -9.61         4.17
##  3 austria  1962     4.07    -6.41 -0.380    -9.46         4.10
##  4 austria  1963     4.06    -6.37 -0.414    -9.34         4.07
##  5 belgium  1960     4.16    -6.22 -0.166    -9.41        NA   
##  6 belgium  1961     4.12    -6.18 -0.172    -9.30         4.16
##  7 belgium  1962     4.08    -6.13 -0.222    -9.22         4.12
##  8 belgium  1963     4.00    -6.09 -0.250    -9.11         4.08
##  9 canada   1960     4.86    -5.89 -0.972    -8.38        NA   
## 10 canada   1961     4.83    -5.88 -0.972    -8.35         4.86
## # ‚Ä¶ with 62 more rows, and 1 more variable: lead_lgaspcar &lt;dbl&gt;</code></pre>
<p>To lag every variable, remember that you can use <code>mutate_if()</code>:</p>
<pre class="sourceCode r"><code class="sourceCode r">gasoline <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">group_by</span>(country) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate_if</span>(is.double, lag) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">filter</span>(year <span class="op">%in%</span><span class="st"> </span><span class="kw">seq</span>(<span class="dv">1960</span>, <span class="dv">1963</span>))</code></pre>
<pre><code>## `mutate_if()` ignored the following grouping variables:
## Column `country`</code></pre>
<pre><code>## # A tibble: 72 x 6
## # Groups:   country [18]
##    country  year lgaspcar lincomep  lrpmg lcarpcap
##    &lt;chr&gt;   &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;  &lt;dbl&gt;    &lt;dbl&gt;
##  1 austria  1960     4.17    -6.47 -0.335    -9.77
##  2 austria  1961     4.10    -6.43 -0.351    -9.61
##  3 austria  1962     4.07    -6.41 -0.380    -9.46
##  4 austria  1963     4.06    -6.37 -0.414    -9.34
##  5 belgium  1960     4.16    -6.22 -0.166    -9.41
##  6 belgium  1961     4.12    -6.18 -0.172    -9.30
##  7 belgium  1962     4.08    -6.13 -0.222    -9.22
##  8 belgium  1963     4.00    -6.09 -0.250    -9.11
##  9 canada   1960     4.86    -5.89 -0.972    -8.38
## 10 canada   1961     4.83    -5.88 -0.972    -8.35
## # ‚Ä¶ with 62 more rows</code></pre>
<p>you can replace <code>lag()</code> with <code>lead()</code>, but just keep in mind that the columns get transformed in
place.</p>
</div>
<div id="ntile" class="section level3">
<h3><span class="header-section-number">4.6.3</span> <code>ntile()</code></h3>
<p>The last helper function I will discuss is <code>ntile()</code>. There are some other, so do read <code>mutate()</code>‚Äôs
documentation with <code>help(mutate)</code>!</p>
<p>If you need quantiles, you need <code>ntile()</code>. Let‚Äôs see how it works:</p>
<pre class="sourceCode r"><code class="sourceCode r">gasoline <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">quintile =</span> <span class="kw">ntile</span>(lgaspcar, <span class="dv">5</span>)) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">decile =</span> <span class="kw">ntile</span>(lgaspcar, <span class="dv">10</span>)) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">select</span>(country, year, lgaspcar, quintile, decile)</code></pre>
<pre><code>## # A tibble: 342 x 5
##    country  year lgaspcar quintile decile
##    &lt;chr&gt;   &lt;dbl&gt;    &lt;dbl&gt;    &lt;int&gt;  &lt;int&gt;
##  1 austria  1960     4.17        3      6
##  2 austria  1961     4.10        3      6
##  3 austria  1962     4.07        3      5
##  4 austria  1963     4.06        3      5
##  5 austria  1964     4.04        3      5
##  6 austria  1965     4.03        3      5
##  7 austria  1966     4.05        3      5
##  8 austria  1967     4.05        3      5
##  9 austria  1968     4.05        3      5
## 10 austria  1969     4.05        3      5
## # ‚Ä¶ with 332 more rows</code></pre>
<p><code>quintile</code> and <code>decile</code> do not hold the values but the quantile the value lies in. If you want to
have a column that contains the median for instance, you can use good ol‚Äô <code>quantile()</code>:</p>
<pre class="sourceCode r"><code class="sourceCode r">gasoline <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">group_by</span>(country) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">median =</span> <span class="kw">quantile</span>(lgaspcar, <span class="fl">0.5</span>)) <span class="op">%&gt;%</span><span class="st"> </span><span class="co"># quantile(x, 0.5) is equivalent to median(x)</span>
<span class="st">  </span><span class="kw">filter</span>(year <span class="op">==</span><span class="st"> </span><span class="dv">1960</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">select</span>(country, year, median)</code></pre>
<pre><code>## # A tibble: 18 x 3
## # Groups:   country [18]
##    country      year median
##    &lt;chr&gt;       &lt;dbl&gt;  &lt;dbl&gt;
##  1 austria      1960   4.05
##  2 belgium      1960   3.88
##  3 canada       1960   4.86
##  4 denmark      1960   4.16
##  5 france       1960   3.81
##  6 germany      1960   3.89
##  7 greece       1960   4.89
##  8 ireland      1960   4.22
##  9 italy        1960   3.74
## 10 japan        1960   4.52
## 11 netherlands  1960   3.99
## 12 norway       1960   4.08
## 13 spain        1960   3.99
## 14 sweden       1960   4.00
## 15 switzerland  1960   4.26
## 16 turkey       1960   5.72
## 17 u.k.         1960   3.98
## 18 u.s.a.       1960   4.81</code></pre>
</div>
<div id="arrange" class="section level3">
<h3><span class="header-section-number">4.6.4</span> <code>arrange()</code></h3>
<p><code>arrange()</code> re-orders the whole <code>tibble</code> according to values of the supplied variable:</p>
<pre class="sourceCode r"><code class="sourceCode r">gasoline <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">arrange</span>(lgaspcar)</code></pre>
<pre><code>## # A tibble: 342 x 6
##    country  year lgaspcar lincomep   lrpmg lcarpcap
##    &lt;chr&gt;   &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;   &lt;dbl&gt;    &lt;dbl&gt;
##  1 italy    1977     3.38    -6.10  0.164     -8.15
##  2 italy    1978     3.39    -6.08  0.0348    -8.11
##  3 italy    1976     3.43    -6.12  0.103     -8.17
##  4 italy    1974     3.50    -6.13 -0.223     -8.26
##  5 italy    1975     3.52    -6.17 -0.0327    -8.22
##  6 spain    1978     3.62    -5.29  0.621     -8.63
##  7 italy    1972     3.63    -6.21 -0.215     -8.38
##  8 italy    1971     3.65    -6.22 -0.148     -8.47
##  9 spain    1977     3.65    -5.30  0.526     -8.73
## 10 italy    1973     3.65    -6.16 -0.325     -8.32
## # ‚Ä¶ with 332 more rows</code></pre>
<p>If you want to re-order the <code>tibble</code> in descending order of the variable:</p>
<pre class="sourceCode r"><code class="sourceCode r">gasoline <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">arrange</span>(<span class="kw">desc</span>(lgaspcar))</code></pre>
<pre><code>## # A tibble: 342 x 6
##    country  year lgaspcar lincomep  lrpmg lcarpcap
##    &lt;chr&gt;   &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;  &lt;dbl&gt;    &lt;dbl&gt;
##  1 turkey   1966     6.16    -7.51 -0.356    -13.0
##  2 turkey   1960     6.13    -7.80 -0.253    -13.5
##  3 turkey   1961     6.11    -7.79 -0.343    -13.4
##  4 turkey   1962     6.08    -7.84 -0.408    -13.2
##  5 turkey   1968     6.08    -7.42 -0.365    -12.8
##  6 turkey   1963     6.08    -7.63 -0.225    -13.3
##  7 turkey   1964     6.06    -7.63 -0.252    -13.2
##  8 turkey   1967     6.04    -7.46 -0.335    -12.8
##  9 japan    1960     6.00    -6.99 -0.145    -12.2
## 10 turkey   1965     5.82    -7.62 -0.293    -12.9
## # ‚Ä¶ with 332 more rows</code></pre>
<p><code>arrange</code>‚Äôs documentation alerts the user that re-ording by group is only possible by explicitely
specifying an option:</p>
<pre class="sourceCode r"><code class="sourceCode r">gasoline <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">filter</span>(year <span class="op">%in%</span><span class="st"> </span><span class="kw">seq</span>(<span class="dv">1960</span>, <span class="dv">1963</span>)) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">group_by</span>(country) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">arrange</span>(<span class="kw">desc</span>(lgaspcar), <span class="dt">.by_group =</span> <span class="ot">TRUE</span>)</code></pre>
<pre><code>## # A tibble: 72 x 6
## # Groups:   country [18]
##    country  year lgaspcar lincomep  lrpmg lcarpcap
##    &lt;chr&gt;   &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;  &lt;dbl&gt;    &lt;dbl&gt;
##  1 austria  1960     4.17    -6.47 -0.335    -9.77
##  2 austria  1961     4.10    -6.43 -0.351    -9.61
##  3 austria  1962     4.07    -6.41 -0.380    -9.46
##  4 austria  1963     4.06    -6.37 -0.414    -9.34
##  5 belgium  1960     4.16    -6.22 -0.166    -9.41
##  6 belgium  1961     4.12    -6.18 -0.172    -9.30
##  7 belgium  1962     4.08    -6.13 -0.222    -9.22
##  8 belgium  1963     4.00    -6.09 -0.250    -9.11
##  9 canada   1960     4.86    -5.89 -0.972    -8.38
## 10 canada   1962     4.85    -5.84 -0.979    -8.32
## # ‚Ä¶ with 62 more rows</code></pre>
<p>This is especially useful for plotting. We‚Äôll see this in Chapter 6.</p>
</div>
<div id="tally-and-count" class="section level3">
<h3><span class="header-section-number">4.6.5</span> <code>tally()</code> and <code>count()</code></h3>
<p><code>tally()</code> and <code>count()</code> count the number of observations in your data. I believe <code>count()</code> is the
more useful of the two, as it counts the number of observations within a group that you can provide:</p>
<pre class="sourceCode r"><code class="sourceCode r">gasoline <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">count</span>(country)</code></pre>
<pre><code>## # A tibble: 18 x 2
##    country         n
##    &lt;chr&gt;       &lt;int&gt;
##  1 austria        19
##  2 belgium        19
##  3 canada         19
##  4 denmark        19
##  5 france         19
##  6 germany        19
##  7 greece         19
##  8 ireland        19
##  9 italy          19
## 10 japan          19
## 11 netherlands    19
## 12 norway         19
## 13 spain          19
## 14 sweden         19
## 15 switzerland    19
## 16 turkey         19
## 17 u.k.           19
## 18 u.s.a.         19</code></pre>
<p>There‚Äôs also <code>add_count()</code> which adds the column to the data:</p>
<pre class="sourceCode r"><code class="sourceCode r">gasoline <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">add_count</span>(country)</code></pre>
<pre><code>## # A tibble: 342 x 7
##    country  year lgaspcar lincomep  lrpmg lcarpcap     n
##    &lt;chr&gt;   &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;  &lt;dbl&gt;    &lt;dbl&gt; &lt;int&gt;
##  1 austria  1960     4.17    -6.47 -0.335    -9.77    19
##  2 austria  1961     4.10    -6.43 -0.351    -9.61    19
##  3 austria  1962     4.07    -6.41 -0.380    -9.46    19
##  4 austria  1963     4.06    -6.37 -0.414    -9.34    19
##  5 austria  1964     4.04    -6.32 -0.445    -9.24    19
##  6 austria  1965     4.03    -6.29 -0.497    -9.12    19
##  7 austria  1966     4.05    -6.25 -0.467    -9.02    19
##  8 austria  1967     4.05    -6.23 -0.506    -8.93    19
##  9 austria  1968     4.05    -6.21 -0.522    -8.85    19
## 10 austria  1969     4.05    -6.15 -0.559    -8.79    19
## # ‚Ä¶ with 332 more rows</code></pre>
<p><code>add_count()</code> is a shortcut for the following code:</p>
<pre class="sourceCode r"><code class="sourceCode r">gasoline <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">group_by</span>(country) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">n =</span> <span class="kw">n</span>())</code></pre>
<pre><code>## # A tibble: 342 x 7
## # Groups:   country [18]
##    country  year lgaspcar lincomep  lrpmg lcarpcap     n
##    &lt;chr&gt;   &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;  &lt;dbl&gt;    &lt;dbl&gt; &lt;int&gt;
##  1 austria  1960     4.17    -6.47 -0.335    -9.77    19
##  2 austria  1961     4.10    -6.43 -0.351    -9.61    19
##  3 austria  1962     4.07    -6.41 -0.380    -9.46    19
##  4 austria  1963     4.06    -6.37 -0.414    -9.34    19
##  5 austria  1964     4.04    -6.32 -0.445    -9.24    19
##  6 austria  1965     4.03    -6.29 -0.497    -9.12    19
##  7 austria  1966     4.05    -6.25 -0.467    -9.02    19
##  8 austria  1967     4.05    -6.23 -0.506    -8.93    19
##  9 austria  1968     4.05    -6.21 -0.522    -8.85    19
## 10 austria  1969     4.05    -6.15 -0.559    -8.79    19
## # ‚Ä¶ with 332 more rows</code></pre>
<p>where <code>n()</code> is a <code>dplyr</code> function that can only be used within <code>summarise()</code>, <code>mutate()</code> and
<code>filter()</code>.</p>
</div>
</div>
<div id="special-packages-for-special-kinds-of-data-forcats-lubridate-and-stringr" class="section level2">
<h2><span class="header-section-number">4.7</span> Special packages for special kinds of data: <code>{forcats}</code>, <code>{lubridate}</code>, and <code>{stringr}</code></h2>
<div id="section" class="section level3">
<h3><span class="header-section-number">4.7.1</span> üêàüêàüêàüêà</h3>
<p>Factor variables are very useful but not very easy to manipulate. <code>forcats</code> contains very useful
functions that make working on factor variables painless. In my opinion, the four following functions, <code>fct_recode()</code>, <code>fct_relevel()</code>, <code>fct_reorder()</code> and <code>fct_relabel()</code>, are the ones you must
know, so that‚Äôs what I‚Äôll be showing.</p>
<p>Remember in chapter 3 when I very quickly explained what were <code>factor</code> variables? In this section,
we are going to work a little bit with these type of variable. <code>factor</code>s are very useful, and the
<code>forcats</code> package includes some handy functions to work with them. First, let‚Äôs load the <code>forcats</code> package:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(forcats)</code></pre>
<p>as an example, we are going to work with the <code>gss_cat</code> dataset that is included in <code>forcats</code>. Let‚Äôs
load the data:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">data</span>(gss_cat)

<span class="kw">head</span>(gss_cat)</code></pre>
<pre><code>## # A tibble: 6 x 9
##    year marital     age race  rincome   partyid    relig    denom   tvhours
##   &lt;int&gt; &lt;fct&gt;     &lt;int&gt; &lt;fct&gt; &lt;fct&gt;     &lt;fct&gt;      &lt;fct&gt;    &lt;fct&gt;     &lt;int&gt;
## 1  2000 Never ma‚Ä¶    26 White $8000 to‚Ä¶ Ind,near ‚Ä¶ Protest‚Ä¶ Southe‚Ä¶      12
## 2  2000 Divorced     48 White $8000 to‚Ä¶ Not str r‚Ä¶ Protest‚Ä¶ Baptis‚Ä¶      NA
## 3  2000 Widowed      67 White Not appl‚Ä¶ Independe‚Ä¶ Protest‚Ä¶ No den‚Ä¶       2
## 4  2000 Never ma‚Ä¶    39 White Not appl‚Ä¶ Ind,near ‚Ä¶ Orthodo‚Ä¶ Not ap‚Ä¶       4
## 5  2000 Divorced     25 White Not appl‚Ä¶ Not str d‚Ä¶ None     Not ap‚Ä¶       1
## 6  2000 Married      25 White $20000 -‚Ä¶ Strong de‚Ä¶ Protest‚Ä¶ Southe‚Ä¶      NA</code></pre>
<p>as you can see, <code>marital</code>, <code>race</code>, <code>rincome</code> and <code>partyid</code> are all factor variables. Let‚Äôs take a closer
look at <code>marital</code>:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">str</span>(gss_cat<span class="op">$</span>marital)</code></pre>
<pre><code>##  Factor w/ 6 levels &quot;No answer&quot;,&quot;Never married&quot;,..: 2 4 5 2 4 6 2 4 6 6 ...</code></pre>
<p>and let‚Äôs see <code>rincome</code>:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">str</span>(gss_cat<span class="op">$</span>rincome)</code></pre>
<pre><code>##  Factor w/ 16 levels &quot;No answer&quot;,&quot;Don&#39;t know&quot;,..: 8 8 16 16 16 5 4 9 4 4 ...</code></pre>
<p><code>factor</code> variables have different levels and the <code>forcats</code> package includes functions that allow
you to recode, collapse and do all sorts of things on these levels. For example , using
<code>forcats::fct_recode()</code> you can recode levels:</p>
<pre class="sourceCode r"><code class="sourceCode r">gss_cat &lt;-<span class="st"> </span>gss_cat <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">marital =</span> <span class="kw">fct_recode</span>(marital,
                              <span class="dt">refuse =</span> <span class="st">&quot;No answer&quot;</span>,
                              <span class="dt">never_married =</span> <span class="st">&quot;Never married&quot;</span>,
                              <span class="dt">divorced =</span> <span class="st">&quot;Separated&quot;</span>,
                              <span class="dt">divorced =</span> <span class="st">&quot;Divorced&quot;</span>,
                              <span class="dt">widowed =</span> <span class="st">&quot;Widowed&quot;</span>,
                              <span class="dt">married =</span> <span class="st">&quot;Married&quot;</span>))

gss_cat <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">tabyl</span>(marital)</code></pre>
<pre><code>##        marital     n      percent
##         refuse    17 0.0007913234
##  never_married  5416 0.2521063166
##       divorced  4126 0.1920588372
##        widowed  1807 0.0841130196
##        married 10117 0.4709305032</code></pre>
<p>Using <code>fct_recode()</code>, I was able to recode the levels and collapse <code>Separated</code> and <code>Divorced</code> to
a single category called <code>divorced</code>. As you can see, <code>refuse</code> and <code>widowed</code> are less than 10%, so
maybe you‚Äôd want to lump these categories together:</p>
<pre class="sourceCode r"><code class="sourceCode r">gss_cat &lt;-<span class="st"> </span>gss_cat <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">marital =</span> <span class="kw">fct_lump</span>(marital, <span class="dt">prop =</span> <span class="fl">0.10</span>, <span class="dt">other_level =</span> <span class="st">&quot;other&quot;</span>))

gss_cat <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">tabyl</span>(marital)</code></pre>
<pre><code>##        marital     n    percent
##  never_married  5416 0.25210632
##       divorced  4126 0.19205884
##        married 10117 0.47093050
##          other  1824 0.08490434</code></pre>
<p><code>fct_reorder()</code> is especially useful for plotting. We will explore plotting in the next chapter,
but to show you why <code>fct_reorder()</code> is so useful, I will create a barplot, first without
using <code>fct_reorder()</code> to re-order the factors, then with reordering. Do not worry if you don‚Äôt
understand all the code for now:</p>
<pre class="sourceCode r"><code class="sourceCode r">gss_cat <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">tabyl</span>(marital) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">ggplot</span>() <span class="op">+</span>
<span class="st">    </span><span class="kw">geom_col</span>(<span class="kw">aes</span>(<span class="dt">y =</span> n, <span class="dt">x =</span> marital)) <span class="op">+</span>
<span class="st">    </span><span class="kw">coord_flip</span>()</code></pre>
<p><img src="modern_R_files/figure-html/unnamed-chunk-326-1.png" width="672" /></p>
<p>It would be much better if the categories were ordered by frequency. This is easy to do with
<code>fct_reorder()</code>:</p>
<pre class="sourceCode r"><code class="sourceCode r">gss_cat <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">tabyl</span>(marital) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">mutate</span>(<span class="dt">marital =</span> <span class="kw">fct_reorder</span>(marital, n, <span class="dt">.desc =</span> <span class="ot">FALSE</span>)) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">ggplot</span>() <span class="op">+</span>
<span class="st">    </span><span class="kw">geom_col</span>(<span class="kw">aes</span>(<span class="dt">y =</span> n, <span class="dt">x =</span> marital)) <span class="op">+</span>
<span class="st">    </span><span class="kw">coord_flip</span>()</code></pre>
<p><img src="modern_R_files/figure-html/unnamed-chunk-327-1.png" width="672" /></p>
<p>Much better! In Chapter 6, we are going to learn about <code>{ggplot2}</code>.</p>
<p><code>{forcats}</code> contains other very useful functions, so I urge you to go through the documentation.</p>
</div>
<div id="get-your-dates-right-with-lubridate" class="section level3">
<h3><span class="header-section-number">4.7.2</span> Get your dates right with <code>{lubridate}</code></h3>
<p><code>{lubridate}</code> is yet another tidyverse package, that makes dealing with dates or durations (and intervals) as
painless as possible. I do not use every function contained in the package daily, and as such will
only focus on some of the functions. However, if you have to deal with dates often,
you might want to explore the package thouroughly.</p>
<div id="defining-dates-the-tidy-way" class="section level4">
<h4><span class="header-section-number">4.7.2.1</span> Defining dates, the tidy way</h4>
<p>Let‚Äôs load new dataset, called <em>independence</em> from the datasets folder:</p>
<pre class="sourceCode r"><code class="sourceCode r">independence &lt;-<span class="st"> </span><span class="kw">readRDS</span>(<span class="st">&quot;datasets/independence.rds&quot;</span>)</code></pre>
<p>This dataset was scraped from the following Wikipedia <a href="https://en.wikipedia.org/wiki/Decolonisation_of_Africa#Timeline">page</a>.
It shows when African countries gained independence from which colonial powers. In Chapter 11, I
will show you how to scrape Wikipedia pages using R. For now, let‚Äôs take a look at the contents
of the dataset:</p>
<pre class="sourceCode r"><code class="sourceCode r">independence</code></pre>
<pre><code>## # A tibble: 54 x 6
##    country colonial_name colonial_power independence_da‚Ä¶ first_head_of_s‚Ä¶
##    &lt;chr&gt;   &lt;chr&gt;         &lt;chr&gt;          &lt;chr&gt;            &lt;chr&gt;           
##  1 Liberia Liberia       United States  26 July 1847     Joseph Jenkins ‚Ä¶
##  2 South ‚Ä¶ Cape Colony ‚Ä¶ United Kingdom 31 May 1910      Louis Botha     
##  3 Egypt   Sultanate of‚Ä¶ United Kingdom 28 February 1922 Fuad I          
##  4 Eritrea Italian Erit‚Ä¶ Italy          10 February 1947 Haile Selassie  
##  5 Libya   British Mili‚Ä¶ United Kingdo‚Ä¶ 24 December 1951 Idris           
##  6 Sudan   Anglo-Egypti‚Ä¶ United Kingdo‚Ä¶ 1 January 1956   Ismail al-Azhari
##  7 Tunisia French Prote‚Ä¶ France         20 March 1956    Muhammad VIII a‚Ä¶
##  8 Morocco French Prote‚Ä¶ France¬†Spain   2 March 19567 A‚Ä¶ Mohammed V      
##  9 Ghana   Gold Coast    United Kingdom 6 March 1957     Kwame Nkrumah   
## 10 Guinea  French West ‚Ä¶ France         2 October 1958   Ahmed S√©kou Tou‚Ä¶
## # ‚Ä¶ with 44 more rows, and 1 more variable: independence_won_through &lt;chr&gt;</code></pre>
<p>as you can see, the date of independence is in a format that might make it difficult to answer questions
such as <em>Which African countries gained independence before 1960 ?</em> for two reasons. First of all,
the date uses the name of the month instead of the number of the month, and second of all the type of
the independence day column is <em>character</em> and not ‚Äúdate‚Äù. So our first task is to correctly define the column
as being of type date, while making sure that R understands that <em>January</em> is supposed to be ‚Äú01‚Äù, and so
on. There are several helpful functions included in <code>{lubridate}</code> to convert columns to dates. For instance
if the column you want to convert is of the form ‚Äú2012-11-21‚Äù, then you would use the function <code>ymd()</code>,
for ‚Äúyear-month-day‚Äù. If, however the column is ‚Äú2012-21-11‚Äù, then you would use <code>ydm()</code>. There‚Äôs
a few of these helper functions, and they can handle a lot of different formats for dates. In our case,
having the name of the month instead of the number might seem quite problematic, but it turns out
that this is a case that <code>{lubridate}</code> handles painfully:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(lubridate)</code></pre>
<pre><code>## 
## Attaching package: &#39;lubridate&#39;</code></pre>
<pre><code>## The following object is masked from &#39;package:base&#39;:
## 
##     date</code></pre>
<pre class="sourceCode r"><code class="sourceCode r">independence &lt;-<span class="st"> </span>independence <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">independence_date =</span> <span class="kw">dmy</span>(independence_date))</code></pre>
<pre><code>## Warning: 5 failed to parse.</code></pre>
<p>Some dates failed to parse, for instance for Morocco. This is because these countries have several
independence dates; this means that the string to convert looks like:</p>
<pre><code>&quot;2 March 1956
7 April 1956
10 April 1958
4 January 1969&quot;</code></pre>
<p>which obviously cannot be converted by <code>{lubridate}</code> without further manipulation. I ignore these cases for
simplicity‚Äôs sake.</p>
</div>
<div id="data-manipulation-with-dates" class="section level4">
<h4><span class="header-section-number">4.7.2.2</span> Data manipulation with dates</h4>
<p>Let‚Äôs take a look at the data now:</p>
<pre class="sourceCode r"><code class="sourceCode r">independence</code></pre>
<pre><code>## # A tibble: 54 x 6
##    country colonial_name colonial_power independence_da‚Ä¶ first_head_of_s‚Ä¶
##    &lt;chr&gt;   &lt;chr&gt;         &lt;chr&gt;          &lt;date&gt;           &lt;chr&gt;           
##  1 Liberia Liberia       United States  1847-07-26       Joseph Jenkins ‚Ä¶
##  2 South ‚Ä¶ Cape Colony ‚Ä¶ United Kingdom 1910-05-31       Louis Botha     
##  3 Egypt   Sultanate of‚Ä¶ United Kingdom 1922-02-28       Fuad I          
##  4 Eritrea Italian Erit‚Ä¶ Italy          1947-02-10       Haile Selassie  
##  5 Libya   British Mili‚Ä¶ United Kingdo‚Ä¶ 1951-12-24       Idris           
##  6 Sudan   Anglo-Egypti‚Ä¶ United Kingdo‚Ä¶ 1956-01-01       Ismail al-Azhari
##  7 Tunisia French Prote‚Ä¶ France         1956-03-20       Muhammad VIII a‚Ä¶
##  8 Morocco French Prote‚Ä¶ France¬†Spain   NA               Mohammed V      
##  9 Ghana   Gold Coast    United Kingdom 1957-03-06       Kwame Nkrumah   
## 10 Guinea  French West ‚Ä¶ France         1958-10-02       Ahmed S√©kou Tou‚Ä¶
## # ‚Ä¶ with 44 more rows, and 1 more variable: independence_won_through &lt;chr&gt;</code></pre>
<p>As you can see, we now have a date column in the right format. We can now answer questions such as
<em>Which countries gained independence before 1960?</em> quite easily, by using the functions <code>year()</code>,
<code>month()</code> and <code>day()</code>. Let‚Äôs see which countries gained independence before 1960:</p>
<pre class="sourceCode r"><code class="sourceCode r">independence <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">filter</span>(<span class="kw">year</span>(independence_date) <span class="op">&lt;=</span><span class="st"> </span><span class="dv">1960</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">pull</span>(country)</code></pre>
<pre><code>##  [1] &quot;Liberia&quot;                          &quot;South Africa&quot;                    
##  [3] &quot;Egypt&quot;                            &quot;Eritrea&quot;                         
##  [5] &quot;Libya&quot;                            &quot;Sudan&quot;                           
##  [7] &quot;Tunisia&quot;                          &quot;Ghana&quot;                           
##  [9] &quot;Guinea&quot;                           &quot;Cameroon&quot;                        
## [11] &quot;Togo&quot;                             &quot;Mali&quot;                            
## [13] &quot;Madagascar&quot;                       &quot;Democratic Republic of the Congo&quot;
## [15] &quot;Benin&quot;                            &quot;Niger&quot;                           
## [17] &quot;Burkina Faso&quot;                     &quot;Ivory Coast&quot;                     
## [19] &quot;Chad&quot;                             &quot;Central African Republic&quot;        
## [21] &quot;Republic of the Congo&quot;            &quot;Gabon&quot;                           
## [23] &quot;Mauritania&quot;</code></pre>
<p>You guessed it, <code>year()</code> extracts the year of the date column and converts it as a <em>numeric</em> so that we can work
on it. This is the same for <code>month()</code> or <code>day()</code>. Let‚Äôs try to see if countries gained their independence on
Christmas Eve:</p>
<pre class="sourceCode r"><code class="sourceCode r">independence <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">filter</span>(<span class="kw">month</span>(independence_date) <span class="op">==</span><span class="st"> </span><span class="dv">12</span>,
         <span class="kw">day</span>(independence_date) <span class="op">==</span><span class="st"> </span><span class="dv">24</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">pull</span>(country)</code></pre>
<pre><code>## [1] &quot;Libya&quot;</code></pre>
<p>Seems like Libya was the only one! You can also operate on dates. For instance, let‚Äôs compute the difference between
two dates, using the <code>interval()</code> column:</p>
<pre class="sourceCode r"><code class="sourceCode r">independence <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">today =</span> lubridate<span class="op">::</span><span class="kw">today</span>()) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">independent_since =</span> <span class="kw">interval</span>(independence_date, today)) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">select</span>(country, independent_since)</code></pre>
<pre><code>## # A tibble: 54 x 2
##    country      independent_since             
##    &lt;chr&gt;        &lt;S4: Interval&gt;                
##  1 Liberia      1847-07-26 UTC--2019-05-09 UTC
##  2 South Africa 1910-05-31 UTC--2019-05-09 UTC
##  3 Egypt        1922-02-28 UTC--2019-05-09 UTC
##  4 Eritrea      1947-02-10 UTC--2019-05-09 UTC
##  5 Libya        1951-12-24 UTC--2019-05-09 UTC
##  6 Sudan        1956-01-01 UTC--2019-05-09 UTC
##  7 Tunisia      1956-03-20 UTC--2019-05-09 UTC
##  8 Morocco      NA--NA                        
##  9 Ghana        1957-03-06 UTC--2019-05-09 UTC
## 10 Guinea       1958-10-02 UTC--2019-05-09 UTC
## # ‚Ä¶ with 44 more rows</code></pre>
<p>The <code>independent_since</code> column now contains an <em>interval</em> object that we can convert to years:</p>
<pre class="sourceCode r"><code class="sourceCode r">independence <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">today =</span> lubridate<span class="op">::</span><span class="kw">today</span>()) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">independent_since =</span> <span class="kw">interval</span>(independence_date, today)) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">select</span>(country, independent_since) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">years_independent =</span> <span class="kw">as.numeric</span>(independent_since, <span class="st">&quot;years&quot;</span>))</code></pre>
<pre><code>## # A tibble: 54 x 3
##    country      independent_since              years_independent
##    &lt;chr&gt;        &lt;S4: Interval&gt;                             &lt;dbl&gt;
##  1 Liberia      1847-07-26 UTC--2019-05-09 UTC             172. 
##  2 South Africa 1910-05-31 UTC--2019-05-09 UTC             109. 
##  3 Egypt        1922-02-28 UTC--2019-05-09 UTC              97.2
##  4 Eritrea      1947-02-10 UTC--2019-05-09 UTC              72.2
##  5 Libya        1951-12-24 UTC--2019-05-09 UTC              67.4
##  6 Sudan        1956-01-01 UTC--2019-05-09 UTC              63.4
##  7 Tunisia      1956-03-20 UTC--2019-05-09 UTC              63.1
##  8 Morocco      NA--NA                                      NA  
##  9 Ghana        1957-03-06 UTC--2019-05-09 UTC              62.2
## 10 Guinea       1958-10-02 UTC--2019-05-09 UTC              60.6
## # ‚Ä¶ with 44 more rows</code></pre>
<p>We can now see for how long the last country to gain independence has been independent.
Because the data is not tidy (in some cases, an African country was colonized by two powers,
see Libya), I will only focus on 4 European colonial powers: Belgium, France, Portugal and the United Kingdom:</p>
<pre class="sourceCode r"><code class="sourceCode r">independence <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">filter</span>(colonial_power <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;Belgium&quot;</span>, <span class="st">&quot;France&quot;</span>, <span class="st">&quot;Portugal&quot;</span>, <span class="st">&quot;United Kingdom&quot;</span>)) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">today =</span> lubridate<span class="op">::</span><span class="kw">today</span>()) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">independent_since =</span> <span class="kw">interval</span>(independence_date, today)) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">years_independent =</span> <span class="kw">as.numeric</span>(independent_since, <span class="st">&quot;years&quot;</span>)) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">group_by</span>(colonial_power) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">summarise</span>(<span class="dt">last_colony_independent_for =</span> <span class="kw">min</span>(years_independent, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>))</code></pre>
<pre><code>## # A tibble: 4 x 2
##   colonial_power last_colony_independent_for
##   &lt;chr&gt;                                &lt;dbl&gt;
## 1 Belgium                               56.9
## 2 France                                41.9
## 3 Portugal                              43.5
## 4 United Kingdom                        42.9</code></pre>
</div>
<div id="arithmetic-with-dates" class="section level4">
<h4><span class="header-section-number">4.7.2.3</span> Arithmetic with dates</h4>
<p>Adding or substracting days to dates is quite easy:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ymd</span>(<span class="st">&quot;2018-12-31&quot;</span>) <span class="op">+</span><span class="st"> </span><span class="dv">16</span></code></pre>
<pre><code>## [1] &quot;2019-01-16&quot;</code></pre>
<p>It is also possible to be more explicit and use <code>days()</code>:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ymd</span>(<span class="st">&quot;2018-12-31&quot;</span>) <span class="op">+</span><span class="st"> </span><span class="kw">days</span>(<span class="dv">16</span>)</code></pre>
<pre><code>## [1] &quot;2019-01-16&quot;</code></pre>
<p>To add years, you can use <code>years()</code>:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ymd</span>(<span class="st">&quot;2018-12-31&quot;</span>) <span class="op">+</span><span class="st"> </span><span class="kw">years</span>(<span class="dv">1</span>)</code></pre>
<pre><code>## [1] &quot;2019-12-31&quot;</code></pre>
<p>But you have to be careful with leap years:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ymd</span>(<span class="st">&quot;2016-02-29&quot;</span>) <span class="op">+</span><span class="st"> </span><span class="kw">years</span>(<span class="dv">1</span>)</code></pre>
<pre><code>## [1] NA</code></pre>
<p>Because 2017 is not a leap year, the above computation returns <code>NA</code>. The same goes for months with
a different number of days:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ymd</span>(<span class="st">&quot;2018-12-31&quot;</span>) <span class="op">+</span><span class="st"> </span><span class="kw">months</span>(<span class="dv">2</span>)</code></pre>
<pre><code>## [1] NA</code></pre>
<p>The way to solve these issues is to use the special <code>%m+%</code> infix operator:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ymd</span>(<span class="st">&quot;2016-02-29&quot;</span>) <span class="op">%m+%</span><span class="st"> </span><span class="kw">years</span>(<span class="dv">1</span>)</code></pre>
<pre><code>## [1] &quot;2017-02-28&quot;</code></pre>
<p>and for months:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ymd</span>(<span class="st">&quot;2018-12-31&quot;</span>) <span class="op">%m+%</span><span class="st"> </span><span class="kw">months</span>(<span class="dv">2</span>)</code></pre>
<pre><code>## [1] &quot;2019-02-28&quot;</code></pre>
<p><code>{lubridate}</code> contains many more functions. If you often work with dates, duration or interval
data, <code>{lubridate}</code> is a package that you have to add to your toolbox.</p>
</div>
</div>
<div id="manipulate-strings-with-stringr" class="section level3">
<h3><span class="header-section-number">4.7.3</span> Manipulate strings with <code>{stringr}</code></h3>
<p><code>{stringr}</code> contains functions to manipulate strings. In Chapter 10, I will teach you about regular
expressions, but the functions contained in <code>{stringr}</code> allow you to already do a lot of work on
strings, without needing to be a regular expression expert.</p>
<p>I will discuss the most common string operations: detecting, locating, matching, searching and
replacing, and exctracting/removing strings.</p>
<p>To introduce these operations, let us use an ALTO file of an issue of <em>The Winchester News</em> from
October 31, 1910, which you can find on this
<a href="https://gist.githubusercontent.com/b-rodrigues/5139560e7d0f2ecebe5da1df3629e015/raw/e3031d894ffb97217ddbad1ade1b307c9937d2c8/gistfile1.txt">link</a> (to see
how the newspaper looked like,
<a href="https://chroniclingamerica.loc.gov/lccn/sn86069133/1910-10-31/ed-1/seq-1/">click here</a>). I re-hosted
the file on a public gist for archiving purposes. While working on the book, the original site went
down several times‚Ä¶</p>
<p>ALTO is an XML schema for the description of text OCR and layout information of pages for digitzed
material, such as newspapers (source: <a href="https://en.wikipedia.org/wiki/ALTO_(XML)">ALTO Wikipedia page</a>).
For more details, you can read my
<a href="https://www.brodrigues.co/blog/2019-01-13-newspapers_mets_alto/">blogpost</a>
on the matter, but for our current purposes, it is enough to know that the file contains the text
of newspaper articles. The file looks like this:</p>
<pre><code>&lt;TextLine HEIGHT=&quot;138.0&quot; WIDTH=&quot;2434.0&quot; HPOS=&quot;4056.0&quot; VPOS=&quot;5814.0&quot;&gt;
&lt;String STYLEREFS=&quot;ID7&quot; HEIGHT=&quot;108.0&quot; WIDTH=&quot;393.0&quot; HPOS=&quot;4056.0&quot; VPOS=&quot;5838.0&quot; CONTENT=&quot;timore&quot; WC=&quot;0.82539684&quot;&gt;
&lt;ALTERNATIVE&gt;timole&lt;/ALTERNATIVE&gt;
&lt;ALTERNATIVE&gt;tlnldre&lt;/ALTERNATIVE&gt;
&lt;ALTERNATIVE&gt;timor&lt;/ALTERNATIVE&gt;
&lt;ALTERNATIVE&gt;insole&lt;/ALTERNATIVE&gt;
&lt;ALTERNATIVE&gt;landed&lt;/ALTERNATIVE&gt;
&lt;/String&gt;
&lt;SP WIDTH=&quot;74.0&quot; HPOS=&quot;4449.0&quot; VPOS=&quot;5838.0&quot;/&gt;
&lt;String STYLEREFS=&quot;ID7&quot; HEIGHT=&quot;105.0&quot; WIDTH=&quot;432.0&quot; HPOS=&quot;4524.0&quot; VPOS=&quot;5847.0&quot; CONTENT=&quot;market&quot; WC=&quot;0.95238096&quot;/&gt;
&lt;SP WIDTH=&quot;116.0&quot; HPOS=&quot;4956.0&quot; VPOS=&quot;5847.0&quot;/&gt;
&lt;String STYLEREFS=&quot;ID7&quot; HEIGHT=&quot;69.0&quot; WIDTH=&quot;138.0&quot; HPOS=&quot;5073.0&quot; VPOS=&quot;5883.0&quot; CONTENT=&quot;as&quot; WC=&quot;0.96825397&quot;/&gt;
&lt;SP WIDTH=&quot;74.0&quot; HPOS=&quot;5211.0&quot; VPOS=&quot;5883.0&quot;/&gt;
&lt;String STYLEREFS=&quot;ID7&quot; HEIGHT=&quot;69.0&quot; WIDTH=&quot;285.0&quot; HPOS=&quot;5286.0&quot; VPOS=&quot;5877.0&quot; CONTENT=&quot;were&quot; WC=&quot;1.0&quot;&gt;
&lt;ALTERNATIVE&gt;verc&lt;/ALTERNATIVE&gt;
&lt;ALTERNATIVE&gt;veer&lt;/ALTERNATIVE&gt;
&lt;/String&gt;
&lt;SP WIDTH=&quot;68.0&quot; HPOS=&quot;5571.0&quot; VPOS=&quot;5877.0&quot;/&gt;
&lt;String STYLEREFS=&quot;ID7&quot; HEIGHT=&quot;111.0&quot; WIDTH=&quot;147.0&quot; HPOS=&quot;5640.0&quot; VPOS=&quot;5838.0&quot; CONTENT=&quot;all&quot; WC=&quot;1.0&quot;/&gt;
&lt;SP WIDTH=&quot;83.0&quot; HPOS=&quot;5787.0&quot; VPOS=&quot;5838.0&quot;/&gt;
&lt;String STYLEREFS=&quot;ID7&quot; HEIGHT=&quot;111.0&quot; WIDTH=&quot;183.0&quot; HPOS=&quot;5871.0&quot; VPOS=&quot;5835.0&quot; CONTENT=&quot;the&quot; WC=&quot;0.95238096&quot;&gt;
&lt;ALTERNATIVE&gt;tll&lt;/ALTERNATIVE&gt;
&lt;ALTERNATIVE&gt;Cu&lt;/ALTERNATIVE&gt;
&lt;ALTERNATIVE&gt;tall&lt;/ALTERNATIVE&gt;
&lt;/String&gt;
&lt;SP WIDTH=&quot;75.0&quot; HPOS=&quot;6054.0&quot; VPOS=&quot;5835.0&quot;/&gt;
&lt;String STYLEREFS=&quot;ID3&quot; HEIGHT=&quot;132.0&quot; WIDTH=&quot;351.0&quot; HPOS=&quot;6129.0&quot; VPOS=&quot;5814.0&quot; CONTENT=&quot;cattle&quot; WC=&quot;0.95238096&quot;/&gt;
&lt;/TextLine&gt;</code></pre>
<p>We are interested in the strings after <code>CONTENT=</code>. We are going to use functions from the <code>{stringr}</code>
package to get the strings after <code>CONTENT=</code>. In Chapter 10, we are going to explore this file
again, but using complex regular expressions to get all the content in one go.</p>
<div id="getting-text-data-into-rstudio" class="section level4">
<h4><span class="header-section-number">4.7.3.1</span> Getting text data into Rstudio</h4>
<p>First of all, let us read in the file:</p>
<pre class="sourceCode r"><code class="sourceCode r">winchester &lt;-<span class="st"> </span><span class="kw">read_lines</span>(<span class="st">&quot;https://gist.githubusercontent.com/b-rodrigues/5139560e7d0f2ecebe5da1df3629e015/raw/e3031d894ffb97217ddbad1ade1b307c9937d2c8/gistfile1.txt&quot;</span>)</code></pre>
<p>Even though the file is an XML file, I still read it in using <code>read_lines()</code> and not <code>read_xml()</code>
from the <code>{xml2}</code> package. This is for the purposes of the current exercise, and also because I
always have trouble with XML files, and prefer to treat them as simple text files, and use regular
expressions to get what I need.</p>
<p>Now that the ALTO file is read in and saved in the <code>winchester</code> variable, you might want to print
the whole thing in the console. Before that, take a look at the structure:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">str</span>(winchester)</code></pre>
<pre><code>##  chr [1:43] &quot;&quot; ...</code></pre>
<p>So the <code>winchester</code> variable is a character atomic vector with 43 elements. So first, we need to
understand what these elements are. Let‚Äôs start with the first one:</p>
<pre class="sourceCode r"><code class="sourceCode r">winchester[<span class="dv">1</span>]</code></pre>
<pre><code>## [1] &quot;&quot;</code></pre>
<p>Ok, so it seems like the first element is part of the header of the file. What about the second one?</p>
<pre class="sourceCode r"><code class="sourceCode r">winchester[<span class="dv">2</span>]</code></pre>
<pre><code>## [1] &quot;&lt;meta http-equiv=\&quot;Content-Type\&quot; content=\&quot;text/html; charset=UTF-8\&quot;&gt;&lt;base href=\&quot;https://chroniclingamerica.loc.gov/lccn/sn86069133/1910-10-31/ed-1/seq-1/ocr.xml\&quot;&gt;&lt;style&gt;body{margin-left:0;margin-right:0;margin-top:0}#bN015htcoyT__google-cache-hdr{background:#f5f5f5;font:13px arial,sans-serif;text-align:left;color:#202020;border:0;margin:0;border-bottom:1px solid #cecece;line-height:16px;padding:16px 28px 24px 28px}#bN015htcoyT__google-cache-hdr *{display:inline;font:inherit;text-align:inherit;color:inherit;line-height:inherit;background:none;border:0;margin:0;padding:0;letter-spacing:0}#bN015htcoyT__google-cache-hdr a{text-decoration:none;color:#1a0dab}#bN015htcoyT__google-cache-hdr a:hover{text-decoration:underline}#bN015htcoyT__google-cache-hdr a:visited{color:#609}#bN015htcoyT__google-cache-hdr div{display:block;margin-top:4px}#bN015htcoyT__google-cache-hdr b{font-weight:bold;display:inline-block;direction:ltr}&lt;/style&gt;&lt;div id=\&quot;bN015htcoyT__google-cache-hdr\&quot;&gt;&lt;div&gt;&lt;span&gt;This is Google&#39;s cache of &lt;a href=\&quot;https://chroniclingamerica.loc.gov/lccn/sn86069133/1910-10-31/ed-1/seq-1/ocr.xml\&quot;&gt;https://chroniclingamerica.loc.gov/lccn/sn86069133/1910-10-31/ed-1/seq-1/ocr.xml&lt;/a&gt;.&lt;/span&gt;&amp;nbsp;&lt;span&gt;It is a snapshot of the page as it appeared on 21 Jan 2019 05:18:18 GMT.&lt;/span&gt;&amp;nbsp;&lt;span&gt;The &lt;a href=\&quot;https://chroniclingamerica.loc.gov/lccn/sn86069133/1910-10-31/ed-1/seq-1/ocr.xml\&quot;&gt;current page&lt;/a&gt; could have changed in the meantime.&lt;/span&gt;&amp;nbsp;&lt;a href=\&quot;http://support.google.com/websearch/bin/answer.py?hl=en&amp;amp;p=cached&amp;amp;answer=1687222\&quot;&gt;&lt;span&gt;Learn more&lt;/span&gt;.&lt;/a&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=\&quot;display:inline-block;margin-top:8px;margin-right:104px;white-space:nowrap\&quot;&gt;&lt;span style=\&quot;margin-right:28px\&quot;&gt;&lt;span style=\&quot;font-weight:bold\&quot;&gt;Full version&lt;/span&gt;&lt;/span&gt;&lt;span style=\&quot;margin-right:28px\&quot;&gt;&lt;a href=\&quot;http://webcache.googleusercontent.com/search?q=cache:2BVPV8QGj3oJ:https://chroniclingamerica.loc.gov/lccn/sn86069133/1910-10-31/ed-1/seq-1/ocr.xml&amp;amp;hl=en&amp;amp;gl=lu&amp;amp;strip=1&amp;amp;vwsrc=0\&quot;&gt;&lt;span&gt;Text-only version&lt;/span&gt;&lt;/a&gt;&lt;/span&gt;&lt;span style=\&quot;margin-right:28px\&quot;&gt;&lt;a href=\&quot;http://webcache.googleusercontent.com/search?q=cache:2BVPV8QGj3oJ:https://chroniclingamerica.loc.gov/lccn/sn86069133/1910-10-31/ed-1/seq-1/ocr.xml&amp;amp;hl=en&amp;amp;gl=lu&amp;amp;strip=0&amp;amp;vwsrc=1\&quot;&gt;&lt;span&gt;View source&lt;/span&gt;&lt;/a&gt;&lt;/span&gt;&lt;/span&gt;&lt;/div&gt;&lt;span style=\&quot;display:inline-block;margin-top:8px;color:#717171\&quot;&gt;&lt;span&gt;Tip: To quickly find your search term on this page, press &lt;b&gt;Ctrl+F&lt;/b&gt; or &lt;b&gt;‚åò-F&lt;/b&gt; (Mac) and use the find bar.&lt;/span&gt;&lt;/span&gt;&lt;/div&gt;&lt;div style=\&quot;position:relative;\&quot;&gt;&lt;?xml version=\&quot;1.0\&quot; encoding=\&quot;UTF-8\&quot;?&gt;&quot;</code></pre>
<p>Same. So where is the content? The file is very large, so if you print it in the console, it will
take quite some time to print, and you will not really be able to make out anything. The best
way would be to try to detect the string <code>CONTENT</code> and work from there.</p>
</div>
<div id="detecting-getting-the-position-and-locating-strings" class="section level4">
<h4><span class="header-section-number">4.7.3.2</span> Detecting, getting the position and locating strings</h4>
<p>When confronted to an atomic vector of strings, you might want to know inside which elements you
can find certain strings. For example, to know which elements of <code>winchester</code> contain the string
<code>CONTENT</code>, use <code>str_detect()</code>:</p>
<pre class="sourceCode r"><code class="sourceCode r">winchester <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">str_detect</span>(<span class="st">&quot;CONTENT&quot;</span>)</code></pre>
<pre><code>##  [1] FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE
## [12] FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE
## [23] FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE
## [34] FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE  TRUE</code></pre>
<p>This returns a boolean atomic vector of the same length as <code>winchester</code>. If the string <code>CONTENT</code> is
nowhere to be found, the result will equal <code>FALSE</code>, if not it will equal <code>TRUE</code>. Here it is easy to
see that the last element contains the string <code>CONTENT</code>. But what if instead of having 43 elements,
the vector had 24192 elements? And hundreds would contain the string <code>CONTENT</code>? It would be easier
to instead have the indices of the vector where one can find the word <code>CONTENT</code>. This is possible
with <code>str_which()</code>:</p>
<pre class="sourceCode r"><code class="sourceCode r">winchester <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">str_which</span>(<span class="st">&quot;CONTENT&quot;</span>)</code></pre>
<pre><code>## [1] 43</code></pre>
<p>Here, the result is 43, meaning that the 43rd element of <code>winchester</code> contains the string <code>CONTENT</code>
somewhere. If we need more precision, we can use <code>str_locate()</code> and <code>str_locate_all()</code>. To explain
how both these functions work, let‚Äôs create a very small example:</p>
<pre class="sourceCode r"><code class="sourceCode r">ancient_philosophers &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;aristotle&quot;</span>, <span class="st">&quot;plato&quot;</span>, <span class="st">&quot;epictetus&quot;</span>, <span class="st">&quot;seneca the younger&quot;</span>, <span class="st">&quot;epicurus&quot;</span>, <span class="st">&quot;marcus aurelius&quot;</span>)</code></pre>
<p>Now suppose I am interested in philosophers whose name ends in <code>us</code>. Let us use <code>str_locate()</code> first:</p>
<pre class="sourceCode r"><code class="sourceCode r">ancient_philosophers <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">str_locate</span>(<span class="st">&quot;us&quot;</span>)</code></pre>
<pre><code>##      start end
## [1,]    NA  NA
## [2,]    NA  NA
## [3,]     8   9
## [4,]    NA  NA
## [5,]     7   8
## [6,]     5   6</code></pre>
<p>You can interpret the result as follows: in the rows, the index of the vector where the
string <code>us</code> is found. So the 3rd, 5th and 6th philosopher have <code>us</code> somewhere in their name.
The result also has two columns: <code>start</code> and <code>end</code>. These give the position of the string. So the
string <code>us</code> can be found starting at position 8 of the 3rd element of the vector, and ends at position
9. Same goes for the other philisophers. However, consider Marcus Aurelius. He has two names, both
ending with <code>us</code>. However, <code>str_locate()</code> only shows the position of the <code>us</code> in <code>Marcus</code>.</p>
<p>To get both <code>us</code> strings, you need to use <code>str_locate_all()</code>:</p>
<pre class="sourceCode r"><code class="sourceCode r">ancient_philosophers <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">str_locate_all</span>(<span class="st">&quot;us&quot;</span>)</code></pre>
<pre><code>## [[1]]
##      start end
## 
## [[2]]
##      start end
## 
## [[3]]
##      start end
## [1,]     8   9
## 
## [[4]]
##      start end
## 
## [[5]]
##      start end
## [1,]     7   8
## 
## [[6]]
##      start end
## [1,]     5   6
## [2,]    14  15</code></pre>
<p>Now we get the position of the two <code>us</code> in Marcus Aurelius. Doing this on the <code>winchester</code> vector
will give use the position of the <code>CONTENT</code> string, but this is not really important right now. What
matters is that you know how <code>str_locate()</code> and <code>str_locate_all()</code> work.</p>
<p>So now that we know what interests us in the 43nd element of <code>winchester</code>, let‚Äôs take a closer
look at it:</p>
<pre class="sourceCode r"><code class="sourceCode r">winchester[<span class="dv">43</span>]</code></pre>
<p>As you can see, it‚Äôs a mess:</p>
<pre><code>&lt;TextLine HEIGHT=\&quot;126.0\&quot; WIDTH=\&quot;1731.0\&quot; HPOS=\&quot;17160.0\&quot; VPOS=\&quot;21252.0\&quot;&gt;&lt;String HEIGHT=\&quot;114.0\&quot; WIDTH=\&quot;354.0\&quot; HPOS=\&quot;17160.0\&quot; VPOS=\&quot;21264.0\&quot; CONTENT=\&quot;0tV\&quot; WC=\&quot;0.8095238\&quot;/&gt;&lt;SP WIDTH=\&quot;131.0\&quot; HPOS=\&quot;17514.0\&quot; VPOS=\&quot;21264.0\&quot;/&gt;&lt;String STYLEREFS=\&quot;ID7\&quot; HEIGHT=\&quot;111.0\&quot; WIDTH=\&quot;474.0\&quot; HPOS=\&quot;17646.0\&quot; VPOS=\&quot;21258.0\&quot; CONTENT=\&quot;BATES\&quot; WC=\&quot;1.0\&quot;/&gt;&lt;SP WIDTH=\&quot;140.0\&quot; HPOS=\&quot;18120.0\&quot; VPOS=\&quot;21258.0\&quot;/&gt;&lt;String STYLEREFS=\&quot;ID7\&quot; HEIGHT=\&quot;114.0\&quot; WIDTH=\&quot;630.0\&quot; HPOS=\&quot;18261.0\&quot; VPOS=\&quot;21252.0\&quot; CONTENT=\&quot;President\&quot; WC=\&quot;1.0\&quot;&gt;&lt;ALTERNATIVE&gt;Prcideht&lt;/ALTERNATIVE&gt;&lt;ALTERNATIVE&gt;Pride&lt;/ALTERNATIVE&gt;&lt;/String&gt;&lt;/TextLine&gt;&lt;TextLine HEIGHT=\&quot;153.0\&quot; WIDTH=\&quot;1689.0\&quot; HPOS=\&quot;17145.0\&quot; VPOS=\&quot;21417.0\&quot;&gt;&lt;String STYLEREFS=\&quot;ID7\&quot; HEIGHT=\&quot;105.0\&quot; WIDTH=\&quot;258.0\&quot; HPOS=\&quot;17145.0\&quot; VPOS=\&quot;21439.0\&quot; CONTENT=\&quot;WM\&quot; WC=\&quot;0.82539684\&quot;&gt;&lt;TextLine HEIGHT=\&quot;120.0\&quot; WIDTH=\&quot;2211.0\&quot; HPOS=\&quot;16788.0\&quot; VPOS=\&quot;21870.0\&quot;&gt;&lt;String STYLEREFS=\&quot;ID7\&quot; HEIGHT=\&quot;96.0\&quot; WIDTH=\&quot;102.0\&quot; HPOS=\&quot;16788.0\&quot; VPOS=\&quot;21894.0\&quot; CONTENT=\&quot;It\&quot; WC=\&quot;1.0\&quot;/&gt;&lt;SP WIDTH=\&quot;72.0\&quot; HPOS=\&quot;16890.0\&quot; VPOS=\&quot;21894.0\&quot;/&gt;&lt;String STYLEREFS=\&quot;ID7\&quot; HEIGHT=\&quot;96.0\&quot; WIDTH=\&quot;93.0\&quot; HPOS=\&quot;16962.0\&quot; VPOS=\&quot;21885.0\&quot; CONTENT=\&quot;is\&quot; WC=\&quot;1.0\&quot;/&gt;&lt;SP WIDTH=\&quot;80.0\&quot; HPOS=\&quot;17055.0\&quot; VPOS=\&quot;21885.0\&quot;/&gt;&lt;String STYLEREFS=\&quot;ID7\&quot; HEIGHT=\&quot;102.0\&quot; WIDTH=\&quot;417.0\&quot; HPOS=\&quot;17136.0\&quot; VPOS=\&quot;21879.0\&quot; CONTENT=\&quot;seldom\&quot; WC=\&quot;1.0\&quot;/&gt;&lt;SP WIDTH=\&quot;80.0\&quot; HPOS=\&quot;17553.0\&quot; VPOS=\&quot;21879.0\&quot;/&gt;&lt;String STYLEREFS=\&quot;ID7\&quot; HEIGHT=\&quot;96.0\&quot; WIDTH=\&quot;267.0\&quot; HPOS=\&quot;17634.0\&quot; VPOS=\&quot;21873.0\&quot; CONTENT=\&quot;hard\&quot; WC=\&quot;1.0\&quot;/&gt;&lt;SP WIDTH=\&quot;81.0\&quot; HPOS=\&quot;17901.0\&quot; VPOS=\&quot;21873.0\&quot;/&gt;&lt;String STYLEREFS=\&quot;ID7\&quot; HEIGHT=\&quot;87.0\&quot; WIDTH=\&quot;111.0\&quot; HPOS=\&quot;17982.0\&quot; VPOS=\&quot;21879.0\&quot; CONTENT=\&quot;to\&quot; WC=\&quot;1.0\&quot;/&gt;&lt;SP WIDTH=\&quot;81.0\&quot; HPOS=\&quot;18093.0\&quot; VPOS=\&quot;21879.0\&quot;/&gt;&lt;String STYLEREFS=\&quot;ID7\&quot; HEIGHT=\&quot;96.0\&quot; WIDTH=\&quot;219.0\&quot; HPOS=\&quot;18174.0\&quot; VPOS=\&quot;21870.0\&quot; CONTENT=\&quot;find\&quot; WC=\&quot;1.0\&quot;/&gt;&lt;SP WIDTH=\&quot;77.0\&quot; HPOS=\&quot;18393.0\&quot; VPOS=\&quot;21870.0\&quot;/&gt;&lt;String STYLEREFS=\&quot;ID7\&quot; HEIGHT=\&quot;69.0\&quot; WIDTH=\&quot;66.0\&quot; HPOS=\&quot;18471.0\&quot; VPOS=\&quot;21894.0\&quot; CONTENT=\&quot;a\&quot; WC=\&quot;1.0\&quot;/&gt;&lt;SP WIDTH=\&quot;77.0\&quot; HPOS=\&quot;18537.0\&quot; VPOS=\&quot;21894.0\&quot;/&gt;&lt;String STYLEREFS=\&quot;ID7\&quot; HEIGHT=\&quot;78.0\&quot; WIDTH=\&quot;384.0\&quot; HPOS=\&quot;18615.0\&quot; VPOS=\&quot;21888.0\&quot; CONTENT=\&quot;succes\&quot; WC=\&quot;0.82539684\&quot;&gt;&lt;ALTERNATIVE&gt;success&lt;/ALTERNATIVE&gt;&lt;/String&gt;&lt;/TextLine&gt;&lt;TextLine HEIGHT=\&quot;126.0\&quot; WIDTH=\&quot;2316.0\&quot; HPOS=\&quot;16662.0\&quot; VPOS=\&quot;22008.0\&quot;&gt;&lt;String STYLEREFS=\&quot;ID7\&quot; HEIGHT=\&quot;75.0\&quot; WIDTH=\&quot;183.0\&quot; HPOS=\&quot;16662.0\&quot; VPOS=\&quot;22059.0\&quot; CONTENT=\&quot;sor\&quot; WC=\&quot;1.0\&quot;&gt;&lt;ALTERNATIVE&gt;soar&lt;/ALTERNATIVE&gt;&lt;/String&gt;&lt;SP WIDTH=\&quot;72.0\&quot; HPOS=\&quot;16845.0\&quot; VPOS=\&quot;22059.0\&quot;/&gt;&lt;String STYLEREFS=\&quot;ID7\&quot; HEIGHT=\&quot;90.0\&quot; WIDTH=\&quot;168.0\&quot; HPOS=\&quot;16917.0\&quot; VPOS=\&quot;22035.0\&quot; CONTENT=\&quot;for\&quot; WC=\&quot;1.0\&quot;/&gt;&lt;SP WIDTH=\&quot;72.0\&quot; HPOS=\&quot;17085.0\&quot; VPOS=\&quot;22035.0\&quot;/&gt;&lt;String STYLEREFS=\&quot;ID7\&quot; HEIGHT=\&quot;69.0\&quot; WIDTH=\&quot;267.0\&quot; HPOS=\&quot;17157.0\&quot; VPOS=\&quot;22050.0\&quot; CONTENT=\&quot;even\&quot; WC=\&quot;1.0\&quot;&gt;&lt;ALTERNATIVE&gt;cen&lt;/ALTERNATIVE&gt;&lt;ALTERNATIVE&gt;cent&lt;/ALTERNATIVE&gt;&lt;/String&gt;&lt;SP WIDTH=\&quot;77.0\&quot; HPOS=\&quot;17434.0\&quot; VPOS=\&quot;22050.0\&quot;/&gt;&lt;String STYLEREFS=\&quot;ID7\&quot; HEIGHT=\&quot;66.0\&quot; WIDTH=\&quot;63.0\&quot; HPOS=\&quot;17502.0\&quot; VPOS=\&quot;22044.0\&quot;</code></pre>
<p>The file was imported without any newlines. So we need to insert them ourselves, by splitting the
string in a clever way.</p>
</div>
<div id="splitting-strings" class="section level4">
<h4><span class="header-section-number">4.7.3.3</span> Splitting strings</h4>
<p>There are two functions included in <code>{stringr}</code> to split strings, <code>str_split()</code> and <code>str_split_fixed()</code>.
Let‚Äôs go back to our ancient philosophers. Two of them, Seneca the Younger and Marcus Aurelius have
something else in common than both being Roman Stoic philosophers. Their names are composed of several
words. If we want to split their names at the space character, we can use <code>str_split()</code> like this:</p>
<pre class="sourceCode r"><code class="sourceCode r">ancient_philosophers <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">str_split</span>(<span class="st">&quot; &quot;</span>)</code></pre>
<pre><code>## [[1]]
## [1] &quot;aristotle&quot;
## 
## [[2]]
## [1] &quot;plato&quot;
## 
## [[3]]
## [1] &quot;epictetus&quot;
## 
## [[4]]
## [1] &quot;seneca&quot;  &quot;the&quot;     &quot;younger&quot;
## 
## [[5]]
## [1] &quot;epicurus&quot;
## 
## [[6]]
## [1] &quot;marcus&quot;   &quot;aurelius&quot;</code></pre>
<p><code>str_split()</code> also has a <code>simplify = TRUE</code> option:</p>
<pre class="sourceCode r"><code class="sourceCode r">ancient_philosophers <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">str_split</span>(<span class="st">&quot; &quot;</span>, <span class="dt">simplify =</span> <span class="ot">TRUE</span>)</code></pre>
<pre><code>##      [,1]        [,2]       [,3]     
## [1,] &quot;aristotle&quot; &quot;&quot;         &quot;&quot;       
## [2,] &quot;plato&quot;     &quot;&quot;         &quot;&quot;       
## [3,] &quot;epictetus&quot; &quot;&quot;         &quot;&quot;       
## [4,] &quot;seneca&quot;    &quot;the&quot;      &quot;younger&quot;
## [5,] &quot;epicurus&quot;  &quot;&quot;         &quot;&quot;       
## [6,] &quot;marcus&quot;    &quot;aurelius&quot; &quot;&quot;</code></pre>
<p>This time, the returned object is a matrix.</p>
<p>What about <code>str_split_fixed()</code>? The difference is that here you can specify the number of pieces
to return. For example, you could consider the name ‚ÄúAurelius‚Äù to be the middle name of Marcus Aurelius,
and the ‚Äúthe younger‚Äù to be the middle name of Seneca the younger. This means that you would want
to split the name only at the first space character, and not at all of them. This is easily achieved
with <code>str_split_fixed()</code>:</p>
<pre class="sourceCode r"><code class="sourceCode r">ancient_philosophers <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">str_split_fixed</span>(<span class="st">&quot; &quot;</span>, <span class="dv">2</span>)</code></pre>
<pre><code>##      [,1]        [,2]         
## [1,] &quot;aristotle&quot; &quot;&quot;           
## [2,] &quot;plato&quot;     &quot;&quot;           
## [3,] &quot;epictetus&quot; &quot;&quot;           
## [4,] &quot;seneca&quot;    &quot;the younger&quot;
## [5,] &quot;epicurus&quot;  &quot;&quot;           
## [6,] &quot;marcus&quot;    &quot;aurelius&quot;</code></pre>
<p>This gives the expected result.</p>
<p>So how does this help in our case? Well, if you look at how the ALTO file looks like, at the beginning
of this section, you will notice that every line ends with the ‚Äú&gt;‚Äù character. So let‚Äôs split at
that character!</p>
<pre class="sourceCode r"><code class="sourceCode r">winchester_text &lt;-<span class="st"> </span>winchester[<span class="dv">43</span>] <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">str_split</span>(<span class="st">&quot;&gt;&quot;</span>)</code></pre>
<p>Let‚Äôs take a closer look at <code>winchester_text</code>:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">str</span>(winchester_text)</code></pre>
<pre><code>## List of 1
##  $ : chr [1:19706] &quot;&lt;/processingStepSettings&quot; &quot;&lt;processingSoftware&quot; &quot;&lt;softwareCreator&quot; &quot;iArchives&lt;/softwareCreator&quot; ...</code></pre>
<p>So this is a list of length one, and the first, and only, element of that list is an atomic vector
with 19706 elements. Since this is a list of only one element, we can simplify it by saving the
atomic vector in a variable:</p>
<pre class="sourceCode r"><code class="sourceCode r">winchester_text &lt;-<span class="st"> </span>winchester_text[[<span class="dv">1</span>]]</code></pre>
<p>Let‚Äôs now look at some lines:</p>
<pre class="sourceCode r"><code class="sourceCode r">winchester_text[<span class="dv">1232</span><span class="op">:</span><span class="dv">1245</span>]</code></pre>
<pre><code>##  [1] &quot;&lt;SP WIDTH=\&quot;66.0\&quot; HPOS=\&quot;5763.0\&quot; VPOS=\&quot;9696.0\&quot;/&quot;                                                                         
##  [2] &quot;&lt;String STYLEREFS=\&quot;ID7\&quot; HEIGHT=\&quot;108.0\&quot; WIDTH=\&quot;612.0\&quot; HPOS=\&quot;5829.0\&quot; VPOS=\&quot;9693.0\&quot; CONTENT=\&quot;Louisville\&quot; WC=\&quot;1.0\&quot;&quot;
##  [3] &quot;&lt;ALTERNATIVE&quot;                                                                                                                
##  [4] &quot;Loniile&lt;/ALTERNATIVE&quot;                                                                                                        
##  [5] &quot;&lt;ALTERNATIVE&quot;                                                                                                                
##  [6] &quot;Lenities&lt;/ALTERNATIVE&quot;                                                                                                       
##  [7] &quot;&lt;/String&quot;                                                                                                                    
##  [8] &quot;&lt;/TextLine&quot;                                                                                                                  
##  [9] &quot;&lt;TextLine HEIGHT=\&quot;150.0\&quot; WIDTH=\&quot;2520.0\&quot; HPOS=\&quot;4032.0\&quot; VPOS=\&quot;9849.0\&quot;&quot;                                                 
## [10] &quot;&lt;String STYLEREFS=\&quot;ID7\&quot; HEIGHT=\&quot;108.0\&quot; WIDTH=\&quot;510.0\&quot; HPOS=\&quot;4032.0\&quot; VPOS=\&quot;9861.0\&quot; CONTENT=\&quot;Tobacco\&quot; WC=\&quot;1.0\&quot;/&quot;  
## [11] &quot;&lt;SP WIDTH=\&quot;113.0\&quot; HPOS=\&quot;4542.0\&quot; VPOS=\&quot;9861.0\&quot;/&quot;                                                                        
## [12] &quot;&lt;String STYLEREFS=\&quot;ID7\&quot; HEIGHT=\&quot;105.0\&quot; WIDTH=\&quot;696.0\&quot; HPOS=\&quot;4656.0\&quot; VPOS=\&quot;9861.0\&quot; CONTENT=\&quot;Warehouse\&quot; WC=\&quot;1.0\&quot;&quot; 
## [13] &quot;&lt;ALTERNATIVE&quot;                                                                                                                
## [14] &quot;WHrchons&lt;/ALTERNATIVE&quot;</code></pre>
<p>This now looks easier to handle. We can narrow it down to the lines that only contain the string
we are interested in, ‚ÄúCONTENT‚Äù. First, let‚Äôs get the indices:</p>
<pre class="sourceCode r"><code class="sourceCode r">content_winchester_index &lt;-<span class="st"> </span>winchester_text <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">str_which</span>(<span class="st">&quot;CONTENT&quot;</span>)</code></pre>
<p>How many lines contain the string ‚ÄúCONTENT‚Äù?</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">length</span>(content_winchester_index)</code></pre>
<pre><code>## [1] 4462</code></pre>
<p>As you can see, this reduces the amount of data we have to work with. Let us save this is a new
variable:</p>
<pre class="sourceCode r"><code class="sourceCode r">content_winchester &lt;-<span class="st"> </span>winchester_text[content_winchester_index]</code></pre>
</div>
<div id="matching-strings" class="section level4">
<h4><span class="header-section-number">4.7.3.4</span> Matching strings</h4>
<p>Matching strings is useful, but only in combination with regular expressions. As stated at the
beginning of this section, we are going to learn about regular expressions in Chapter 10, but in
order to make this section useful, we are going to learn the easiest, but perhaps the most useful
regular expression: <code>.*</code>.</p>
<p>Let‚Äôs go back to our ancient philosophers, and use <code>str_match()</code> and see what happens. Let‚Äôs match
the ‚Äúus‚Äù string:</p>
<pre class="sourceCode r"><code class="sourceCode r">ancient_philosophers <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">str_match</span>(<span class="st">&quot;us&quot;</span>)</code></pre>
<pre><code>##      [,1]
## [1,] NA  
## [2,] NA  
## [3,] &quot;us&quot;
## [4,] NA  
## [5,] &quot;us&quot;
## [6,] &quot;us&quot;</code></pre>
<p>Not very useful, but what about the regular expression <code>.*</code>? How could it help?</p>
<pre class="sourceCode r"><code class="sourceCode r">ancient_philosophers <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">str_match</span>(<span class="st">&quot;.*us&quot;</span>)</code></pre>
<pre><code>##      [,1]             
## [1,] NA               
## [2,] NA               
## [3,] &quot;epictetus&quot;      
## [4,] NA               
## [5,] &quot;epicurus&quot;       
## [6,] &quot;marcus aurelius&quot;</code></pre>
<p>That‚Äôs already very interesting! So how does <code>.*</code> work? To understand, let‚Äôs first start by using
<code>.</code> alone:</p>
<pre class="sourceCode r"><code class="sourceCode r">ancient_philosophers <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">str_match</span>(<span class="st">&quot;.us&quot;</span>)</code></pre>
<pre><code>##      [,1] 
## [1,] NA   
## [2,] NA   
## [3,] &quot;tus&quot;
## [4,] NA   
## [5,] &quot;rus&quot;
## [6,] &quot;cus&quot;</code></pre>
<p>This also matched whatever symbol comes just before the ‚Äúu‚Äù from ‚Äúus‚Äù. What if we use two <code>.</code> instead?</p>
<pre class="sourceCode r"><code class="sourceCode r">ancient_philosophers <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">str_match</span>(<span class="st">&quot;..us&quot;</span>)</code></pre>
<pre><code>##      [,1]  
## [1,] NA    
## [2,] NA    
## [3,] &quot;etus&quot;
## [4,] NA    
## [5,] &quot;urus&quot;
## [6,] &quot;rcus&quot;</code></pre>
<p>This time, we get the two symbols that immediately precede ‚Äúus‚Äù. Instead of continuing like this
we now use the <code>*</code>, which matches zero or more of <code>.</code>. So by combining <code>*</code> and <code>.</code>, we can match
any symbol repeatedly, until there is nothing more to match. Note that there is also <code>+</code>, which works
similarly to <code>*</code>, but it matches one or more symbols.</p>
<p>There is also a <code>str_match_all()</code>:</p>
<pre class="sourceCode r"><code class="sourceCode r">ancient_philosophers <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">str_match_all</span>(<span class="st">&quot;.*us&quot;</span>)</code></pre>
<pre><code>## [[1]]
##      [,1]
## 
## [[2]]
##      [,1]
## 
## [[3]]
##      [,1]       
## [1,] &quot;epictetus&quot;
## 
## [[4]]
##      [,1]
## 
## [[5]]
##      [,1]      
## [1,] &quot;epicurus&quot;
## 
## [[6]]
##      [,1]             
## [1,] &quot;marcus aurelius&quot;</code></pre>
<p>In this particular case it does not change the end result, but keep it in mind for cases like this one:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">c</span>(<span class="st">&quot;haha&quot;</span>, <span class="st">&quot;huhu&quot;</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">str_match</span>(<span class="st">&quot;ha&quot;</span>)</code></pre>
<pre><code>##      [,1]
## [1,] &quot;ha&quot;
## [2,] NA</code></pre>
<p>and:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">c</span>(<span class="st">&quot;haha&quot;</span>, <span class="st">&quot;huhu&quot;</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">str_match_all</span>(<span class="st">&quot;ha&quot;</span>)</code></pre>
<pre><code>## [[1]]
##      [,1]
## [1,] &quot;ha&quot;
## [2,] &quot;ha&quot;
## 
## [[2]]
##      [,1]</code></pre>
<p>What if we want to match names containing the letter ‚Äút‚Äù? Easy:</p>
<pre class="sourceCode r"><code class="sourceCode r">ancient_philosophers <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">str_match</span>(<span class="st">&quot;.*t.*&quot;</span>)</code></pre>
<pre><code>##      [,1]                
## [1,] &quot;aristotle&quot;         
## [2,] &quot;plato&quot;             
## [3,] &quot;epictetus&quot;         
## [4,] &quot;seneca the younger&quot;
## [5,] NA                  
## [6,] NA</code></pre>
<p>So how does this help us with our historical newspaper? Let‚Äôs try to get the strings that come
after ‚ÄúCONTENT‚Äù:</p>
<pre class="sourceCode r"><code class="sourceCode r">winchester_content &lt;-<span class="st"> </span>winchester_text <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">str_match</span>(<span class="st">&quot;CONTENT.*&quot;</span>)</code></pre>
<p>Let‚Äôs use our faithful <code>str()</code> function to take a look:</p>
<pre class="sourceCode r"><code class="sourceCode r">winchester_content <span class="op">%&gt;%</span>
<span class="st">  </span>str</code></pre>
<pre><code>##  chr [1:19706, 1] NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA ...</code></pre>
<p>Hum, there‚Äôs a lot of <code>NA</code> values! This is because a lot of the lines from the file did not have the
string ‚ÄúCONTENT‚Äù, so there is no match possible. Let‚Äôs us remove all these <code>NA</code>s. Because the
result is a matrix, we cannot use the <code>filter()</code> function from <code>{dplyr}</code>. So we need to convert it
to a tibble first:</p>
<pre class="sourceCode r"><code class="sourceCode r">winchester_content &lt;-<span class="st"> </span>winchester_content <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">as.tibble</span>() <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">filter</span>(<span class="op">!</span><span class="kw">is.na</span>(V1))</code></pre>
<pre><code>## Warning: `as.tibble()` is deprecated, use `as_tibble()` (but mind the new semantics).
## This warning is displayed once per session.</code></pre>
<p>Because matrix columns do not have names, when a matrix gets converted into a tibble, the firt column
gets automatically called <code>V1</code>. This is why I filter on this column. Let‚Äôs take a look at the data:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">head</span>(winchester_content)</code></pre>
<pre><code>## # A tibble: 6 x 1
##   V1                                  
##   &lt;chr&gt;                               
## 1 &quot;CONTENT=\&quot;J\&quot; WC=\&quot;0.8095238\&quot;/&quot;   
## 2 &quot;CONTENT=\&quot;a\&quot; WC=\&quot;0.8095238\&quot;/&quot;   
## 3 &quot;CONTENT=\&quot;Ira\&quot; WC=\&quot;0.95238096\&quot;/&quot;
## 4 &quot;CONTENT=\&quot;mj\&quot; WC=\&quot;0.8095238\&quot;/&quot;  
## 5 &quot;CONTENT=\&quot;iI\&quot; WC=\&quot;0.8095238\&quot;/&quot;  
## 6 &quot;CONTENT=\&quot;tE1r\&quot; WC=\&quot;0.8095238\&quot;/&quot;</code></pre>
</div>
<div id="searching-and-replacing-strings" class="section level4">
<h4><span class="header-section-number">4.7.3.5</span> Searching and replacing strings</h4>
<p>We are getting close to the final result. We still need to do some cleaning however. Since our data
is inside a nice tibble, we might as well stick with it. So let‚Äôs first rename the column and
change all the strings to lowercase:</p>
<pre class="sourceCode r"><code class="sourceCode r">winchester_content &lt;-<span class="st"> </span>winchester_content <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">content =</span> <span class="kw">tolower</span>(V1)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>V1)</code></pre>
<p>Let‚Äôs take a look at the result:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">head</span>(winchester_content)</code></pre>
<pre><code>## # A tibble: 6 x 1
##   content                             
##   &lt;chr&gt;                               
## 1 &quot;content=\&quot;j\&quot; wc=\&quot;0.8095238\&quot;/&quot;   
## 2 &quot;content=\&quot;a\&quot; wc=\&quot;0.8095238\&quot;/&quot;   
## 3 &quot;content=\&quot;ira\&quot; wc=\&quot;0.95238096\&quot;/&quot;
## 4 &quot;content=\&quot;mj\&quot; wc=\&quot;0.8095238\&quot;/&quot;  
## 5 &quot;content=\&quot;ii\&quot; wc=\&quot;0.8095238\&quot;/&quot;  
## 6 &quot;content=\&quot;te1r\&quot; wc=\&quot;0.8095238\&quot;/&quot;</code></pre>
<p>The second part of the string, ‚Äúwc=‚Ä¶.‚Äù is not really interesting. Let‚Äôs search and replace this
with an empty string, using <code>str_replace()</code>:</p>
<pre class="sourceCode r"><code class="sourceCode r">winchester_content &lt;-<span class="st"> </span>winchester_content <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">content =</span> <span class="kw">str_replace</span>(content, <span class="st">&quot;wc.*&quot;</span>, <span class="st">&quot;&quot;</span>))

<span class="kw">head</span>(winchester_content)</code></pre>
<pre><code>## # A tibble: 6 x 1
##   content            
##   &lt;chr&gt;              
## 1 &quot;content=\&quot;j\&quot; &quot;   
## 2 &quot;content=\&quot;a\&quot; &quot;   
## 3 &quot;content=\&quot;ira\&quot; &quot; 
## 4 &quot;content=\&quot;mj\&quot; &quot;  
## 5 &quot;content=\&quot;ii\&quot; &quot;  
## 6 &quot;content=\&quot;te1r\&quot; &quot;</code></pre>
<p>We need to use the regular expression from before to replace ‚Äúwc‚Äù and every character that follows.
The same can be use to remove ‚Äúcontent=‚Äù:</p>
<pre class="sourceCode r"><code class="sourceCode r">winchester_content &lt;-<span class="st"> </span>winchester_content <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">content =</span> <span class="kw">str_replace</span>(content, <span class="st">&quot;content=&quot;</span>, <span class="st">&quot;&quot;</span>))

<span class="kw">head</span>(winchester_content)</code></pre>
<pre><code>## # A tibble: 6 x 1
##   content    
##   &lt;chr&gt;      
## 1 &quot;\&quot;j\&quot; &quot;   
## 2 &quot;\&quot;a\&quot; &quot;   
## 3 &quot;\&quot;ira\&quot; &quot; 
## 4 &quot;\&quot;mj\&quot; &quot;  
## 5 &quot;\&quot;ii\&quot; &quot;  
## 6 &quot;\&quot;te1r\&quot; &quot;</code></pre>
<p>We are almost done, but some cleaning is still necessary:</p>
</div>
<div id="exctracting-or-removing-strings" class="section level4">
<h4><span class="header-section-number">4.7.3.6</span> Exctracting or removing strings</h4>
<p>Now, because I now the ALTO spec, I know how to find words that are split between two sentences:</p>
<pre class="sourceCode r"><code class="sourceCode r">winchester_content <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">filter</span>(<span class="kw">str_detect</span>(content, <span class="st">&quot;hyppart&quot;</span>))</code></pre>
<pre><code>## # A tibble: 64 x 1
##    content                                                               
##    &lt;chr&gt;                                                                 
##  1 &quot;\&quot;aver\&quot; subs_type=\&quot;hyppart1\&quot; subs_content=\&quot;average\&quot; &quot;           
##  2 &quot;\&quot;age\&quot; subs_type=\&quot;hyppart2\&quot; subs_content=\&quot;average\&quot; &quot;            
##  3 &quot;\&quot;considera\&quot; subs_type=\&quot;hyppart1\&quot; subs_content=\&quot;consideration\&quot; &quot;
##  4 &quot;\&quot;tion\&quot; subs_type=\&quot;hyppart2\&quot; subs_content=\&quot;consideration\&quot; &quot;     
##  5 &quot;\&quot;re\&quot; subs_type=\&quot;hyppart1\&quot; subs_content=\&quot;resigned\&quot; &quot;            
##  6 &quot;\&quot;signed\&quot; subs_type=\&quot;hyppart2\&quot; subs_content=\&quot;resigned\&quot; &quot;        
##  7 &quot;\&quot;install\&quot; subs_type=\&quot;hyppart1\&quot; subs_content=\&quot;installed\&quot; &quot;      
##  8 &quot;\&quot;ed\&quot; subs_type=\&quot;hyppart2\&quot; subs_content=\&quot;installed\&quot; &quot;           
##  9 &quot;\&quot;be\&quot; subs_type=\&quot;hyppart1\&quot; subs_content=\&quot;before\&quot; &quot;              
## 10 &quot;\&quot;fore\&quot; subs_type=\&quot;hyppart2\&quot; subs_content=\&quot;before\&quot; &quot;            
## # ‚Ä¶ with 54 more rows</code></pre>
<p>For instance, the word ‚Äúaverage‚Äù was split over two lines, the first part of the word, ‚Äúaver‚Äù on the
first line, and the second part of the word, ‚Äúage‚Äù, on the second line. We want to keep what comes
after ‚Äúsubs_content‚Äù. Let‚Äôs extract the word ‚Äúaverage‚Äù using <code>str_extract()</code>. However, because only
some words were split between two lines, we first need to detect where the string ‚Äúhyppart1‚Äù is
located, and only then can we extract what comes after ‚Äúsubs_content‚Äù. Thus, we need to combine
<code>str_detect()</code> to first detect the string, and then <code>str_extract()</code> to extract what comes after
‚Äúsubs_content‚Äù:</p>
<pre class="sourceCode r"><code class="sourceCode r">winchester_content &lt;-<span class="st"> </span>winchester_content <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">content =</span> <span class="kw">if_else</span>(<span class="kw">str_detect</span>(content, <span class="st">&quot;hyppart1&quot;</span>), 
                           <span class="kw">str_extract_all</span>(content, <span class="st">&quot;content=.*&quot;</span>, <span class="dt">simplify =</span> <span class="ot">TRUE</span>), 
                           content))</code></pre>
<p>Let‚Äôs take a look at the result:</p>
<pre class="sourceCode r"><code class="sourceCode r">winchester_content <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">filter</span>(<span class="kw">str_detect</span>(content, <span class="st">&quot;content&quot;</span>))</code></pre>
<pre><code>## # A tibble: 64 x 1
##    content                                                          
##    &lt;chr&gt;                                                            
##  1 &quot;content=\&quot;average\&quot; &quot;                                           
##  2 &quot;\&quot;age\&quot; subs_type=\&quot;hyppart2\&quot; subs_content=\&quot;average\&quot; &quot;       
##  3 &quot;content=\&quot;consideration\&quot; &quot;                                     
##  4 &quot;\&quot;tion\&quot; subs_type=\&quot;hyppart2\&quot; subs_content=\&quot;consideration\&quot; &quot;
##  5 &quot;content=\&quot;resigned\&quot; &quot;                                          
##  6 &quot;\&quot;signed\&quot; subs_type=\&quot;hyppart2\&quot; subs_content=\&quot;resigned\&quot; &quot;   
##  7 &quot;content=\&quot;installed\&quot; &quot;                                         
##  8 &quot;\&quot;ed\&quot; subs_type=\&quot;hyppart2\&quot; subs_content=\&quot;installed\&quot; &quot;      
##  9 &quot;content=\&quot;before\&quot; &quot;                                            
## 10 &quot;\&quot;fore\&quot; subs_type=\&quot;hyppart2\&quot; subs_content=\&quot;before\&quot; &quot;       
## # ‚Ä¶ with 54 more rows</code></pre>
<p>We still need to get rid of the string ‚Äúcontent=‚Äù and then of all the strings that contain ‚Äúhyppart2‚Äù,
which are not needed now:</p>
<pre class="sourceCode r"><code class="sourceCode r">winchester_content &lt;-<span class="st"> </span>winchester_content <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">content =</span> <span class="kw">str_replace</span>(content, <span class="st">&quot;content=&quot;</span>, <span class="st">&quot;&quot;</span>)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">content =</span> <span class="kw">if_else</span>(<span class="kw">str_detect</span>(content, <span class="st">&quot;hyppart2&quot;</span>), <span class="ot">NA_character_</span>, content))

<span class="kw">head</span>(winchester_content)</code></pre>
<pre><code>## # A tibble: 6 x 1
##   content    
##   &lt;chr&gt;      
## 1 &quot;\&quot;j\&quot; &quot;   
## 2 &quot;\&quot;a\&quot; &quot;   
## 3 &quot;\&quot;ira\&quot; &quot; 
## 4 &quot;\&quot;mj\&quot; &quot;  
## 5 &quot;\&quot;ii\&quot; &quot;  
## 6 &quot;\&quot;te1r\&quot; &quot;</code></pre>
<p>Almost done! We only need to remove the <code>"</code> characters:</p>
<pre class="sourceCode r"><code class="sourceCode r">winchester_content &lt;-<span class="st"> </span>winchester_content <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">content =</span> <span class="kw">str_replace_all</span>(content, <span class="st">&quot;</span><span class="ch">\&quot;</span><span class="st">&quot;</span>, <span class="st">&quot;&quot;</span>)) 

<span class="kw">head</span>(winchester_content)</code></pre>
<pre><code>## # A tibble: 6 x 1
##   content
##   &lt;chr&gt;  
## 1 &quot;j &quot;   
## 2 &quot;a &quot;   
## 3 &quot;ira &quot; 
## 4 &quot;mj &quot;  
## 5 &quot;ii &quot;  
## 6 &quot;te1r &quot;</code></pre>
<p>Let‚Äôs remove space characters with <code>str_trim()</code>:</p>
<pre class="sourceCode r"><code class="sourceCode r">winchester_content &lt;-<span class="st"> </span>winchester_content <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">content =</span> <span class="kw">str_trim</span>(content)) 

<span class="kw">head</span>(winchester_content)</code></pre>
<pre><code>## # A tibble: 6 x 1
##   content
##   &lt;chr&gt;  
## 1 j      
## 2 a      
## 3 ira    
## 4 mj     
## 5 ii     
## 6 te1r</code></pre>
<p>To finish off this section, let‚Äôs remove stop words (words that do not add any meaning to a sentence,
such as ‚Äúas‚Äù, ‚Äúand‚Äù‚Ä¶) and words that are composed of less than 3 characters. You can find a dataset
with stopwords inside the <code>{stopwords}</code> package:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(stopwords)

<span class="kw">data</span>(data_stopwords_stopwordsiso)

eng_stopwords &lt;-<span class="st"> </span><span class="kw">tibble</span>(<span class="st">&quot;content&quot;</span> =<span class="st"> </span>data_stopwords_stopwordsiso<span class="op">$</span>en)

winchester_content &lt;-<span class="st"> </span>winchester_content <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">anti_join</span>(eng_stopwords) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">filter</span>(<span class="kw">nchar</span>(content) <span class="op">&gt;</span><span class="st"> </span><span class="dv">3</span>)</code></pre>
<pre><code>## Joining, by = &quot;content&quot;</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">head</span>(winchester_content)</code></pre>
<pre><code>## # A tibble: 6 x 1
##   content   
##   &lt;chr&gt;     
## 1 te1r      
## 2 jilas     
## 3 edition   
## 4 winchester
## 5 news      
## 6 injuries</code></pre>
<p>That‚Äôs it for this section! You now know how to work with strings, but in Chapter 10 we are going
one step further by learning about regular expressions, which offer much more power.</p>
</div>
</div>
<div id="tidy-data-frames-with-tibble" class="section level3">
<h3><span class="header-section-number">4.7.4</span> Tidy data frames with <code>{tibble}</code></h3>
<p>We have already seen and used several functions from the <code>{tibble}</code> package. Let‚Äôs now go through
some more useful functions.</p>
<div id="creating-tibbles" class="section level4">
<h4><span class="header-section-number">4.7.4.1</span> Creating tibbles</h4>
<p><code>tribble()</code> makes it easy to create tibble row by row, manually:</p>
<p>It is also possible to create a tibble from a named list:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">as_tibble</span>(<span class="kw">list</span>(<span class="st">&quot;combustion&quot;</span> =<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;oil&quot;</span>, <span class="st">&quot;diesel&quot;</span>, <span class="st">&quot;oil&quot;</span>, <span class="st">&quot;electric&quot;</span>),
               <span class="st">&quot;doors&quot;</span> =<span class="st"> </span><span class="kw">c</span>(<span class="dv">3</span>, <span class="dv">5</span>, <span class="dv">5</span>, <span class="dv">5</span>)))</code></pre>
<pre><code>## # A tibble: 4 x 2
##   combustion doors
##   &lt;chr&gt;      &lt;dbl&gt;
## 1 oil            3
## 2 diesel         5
## 3 oil            5
## 4 electric       5</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">enframe</span>(<span class="kw">list</span>(<span class="st">&quot;combustion&quot;</span> =<span class="st"> </span><span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">2</span>), <span class="st">&quot;doors&quot;</span> =<span class="st"> </span><span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">4</span>), <span class="st">&quot;cylinders&quot;</span> =<span class="st"> </span><span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">8</span>,<span class="dv">9</span>,<span class="dv">10</span>)))</code></pre>
<pre><code>## # A tibble: 3 x 2
##   name       value    
##   &lt;chr&gt;      &lt;list&gt;   
## 1 combustion &lt;dbl [2]&gt;
## 2 doors      &lt;dbl [3]&gt;
## 3 cylinders  &lt;dbl [4]&gt;</code></pre>
</div>
</div>
</div>
<div id="list-columns" class="section level2">
<h2><span class="header-section-number">4.8</span> List-columns</h2>
<p>To learn about list-columns, let‚Äôs first focus on a single character of the <code>starwars</code> dataset:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">data</span>(starwars)</code></pre>
<pre class="sourceCode r"><code class="sourceCode r">starwars <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">filter</span>(name <span class="op">==</span><span class="st"> &quot;Luke Skywalker&quot;</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">glimpse</span>()</code></pre>
<pre><code>## Observations: 1
## Variables: 13
## $ name       &lt;chr&gt; &quot;Luke Skywalker&quot;
## $ height     &lt;int&gt; 172
## $ mass       &lt;dbl&gt; 77
## $ hair_color &lt;chr&gt; &quot;blond&quot;
## $ skin_color &lt;chr&gt; &quot;fair&quot;
## $ eye_color  &lt;chr&gt; &quot;blue&quot;
## $ birth_year &lt;dbl&gt; 19
## $ gender     &lt;chr&gt; &quot;male&quot;
## $ homeworld  &lt;chr&gt; &quot;Tatooine&quot;
## $ species    &lt;chr&gt; &quot;Human&quot;
## $ films      &lt;list&gt; [&lt;&quot;Revenge of the Sith&quot;, &quot;Return of the Jedi&quot;, &quot;The ‚Ä¶
## $ vehicles   &lt;list&gt; [&lt;&quot;Snowspeeder&quot;, &quot;Imperial Speeder Bike&quot;&gt;]
## $ starships  &lt;list&gt; [&lt;&quot;X-wing&quot;, &quot;Imperial shuttle&quot;&gt;]</code></pre>
<p>We see that the columns <code>films</code>, <code>vehicles</code> and <code>starships</code> are all lists, and in the case of
<code>films</code>, it lists all the films where Luke Skywalker has appeared. What if you want to take a closer look at this list?</p>
<pre class="sourceCode r"><code class="sourceCode r">starwars <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">filter</span>(name <span class="op">==</span><span class="st"> &quot;Luke Skywalker&quot;</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">pull</span>(films)</code></pre>
<pre><code>## [[1]]
## [1] &quot;Revenge of the Sith&quot;     &quot;Return of the Jedi&quot;     
## [3] &quot;The Empire Strikes Back&quot; &quot;A New Hope&quot;             
## [5] &quot;The Force Awakens&quot;</code></pre>
<p><code>pull()</code> is a <code>dplyr</code> function that extract (pulls) the column you‚Äôre interested in. It is quite
useful when you want to inspect a column.</p>
<p>Suppose we want to create a categorical variable which counts the number of movies in which the
characters have appeared. For this we need to compute the length of the list, or count the number
of elements this list has. Let‚Äôs try with <code>length()</code> a base R function:</p>
<pre class="sourceCode r"><code class="sourceCode r">starwars <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">filter</span>(name <span class="op">==</span><span class="st"> &quot;Luke Skywalker&quot;</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">pull</span>(films) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">length</span>()</code></pre>
<pre><code>## [1] 1</code></pre>
<p>This might be surprising at first, because we know that Luke Skywalker has appeared in more than 1
movie‚Ä¶ the problem here is that for each individual, <code>films</code> is a list, whose single element is
a vector of characters. This means that <code>length(films)</code> computes the length of the list, which is
one, and not the length of the vector contained in the list! How can we get the length of the
vector of characters contained in the list and for each character? For this we need to use
<code>dplyr::rowwise()</code> and remove the <code>filter()</code> function and use <code>mutate()</code> to add this column to the
dataset:</p>
<pre class="sourceCode r"><code class="sourceCode r">starwars &lt;-<span class="st"> </span>starwars <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">rowwise</span>() <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">n_films =</span> <span class="kw">length</span>(films))</code></pre>
<p><code>dplyr::rowwise()</code> is useful when working with list-columns: columns that have lists as elements.</p>
<p>Let‚Äôs take a look at the characters and the number of films they have appeared in:</p>
<pre class="sourceCode r"><code class="sourceCode r">starwars <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">select</span>(name, n_films)</code></pre>
<pre><code>## Source: local data frame [87 x 2]
## Groups: &lt;by row&gt;
## 
## # A tibble: 87 x 2
##    name               n_films
##    &lt;chr&gt;                &lt;int&gt;
##  1 Luke Skywalker           5
##  2 C-3PO                    6
##  3 R2-D2                    7
##  4 Darth Vader              4
##  5 Leia Organa              5
##  6 Owen Lars                3
##  7 Beru Whitesun lars       3
##  8 R5-D4                    1
##  9 Biggs Darklighter        1
## 10 Obi-Wan Kenobi           6
## # ‚Ä¶ with 77 more rows</code></pre>
<p>Now we can create a factor variable that groups characters by asking whether they appeared only in
1 movie, or more:</p>
<pre class="sourceCode r"><code class="sourceCode r">starwars &lt;-<span class="st"> </span>starwars <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">more_1 =</span> <span class="kw">case_when</span>(n_films <span class="op">==</span><span class="st"> </span><span class="dv">1</span> <span class="op">~</span><span class="st"> &quot;Exactly one movie&quot;</span>,
                            n_films <span class="op">!=</span><span class="st"> </span><span class="dv">1</span> <span class="op">~</span><span class="st"> &quot;More than 1 movie&quot;</span>))</code></pre>
<p><code>case_when()</code> is a <code>dplyr</code> function that works similarly to the standard <code>if..else..</code> construct of
many programming languages (R also has this, we are going to learn about it in later chapters).</p>
<p>You can also create list columns with your own datasets, by using <code>tidyr::nest()</code>. Remember the
fake <code>survey_data</code> I created to illustrate <code>spread()</code> and <code>gather()</code>? Let‚Äôs go back to that dataset
again:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">print</span>(survey_data)</code></pre>
<pre><code>## # A tibble: 12 x 3
##       id variable value
##    &lt;dbl&gt; &lt;chr&gt;    &lt;dbl&gt;
##  1     1 var1       1  
##  2     1 var2       0.2
##  3    NA var3       0.3
##  4     2 var1       1.4
##  5     2 var2       1.9
##  6     2 var3       4.1
##  7     3 var1       0.1
##  8     3 var2       2.8
##  9     3 var3       8.9
## 10     4 var1       1.7
## 11    NA var2       1.9
## 12     4 var3       7.6</code></pre>
<pre class="sourceCode r"><code class="sourceCode r">nested_data =<span class="st"> </span>survey_data <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">nest</span>(variable, value)

<span class="kw">print</span>(nested_data)</code></pre>
<pre><code>## # A tibble: 5 x 2
##      id data            
##   &lt;dbl&gt; &lt;list&gt;          
## 1     1 &lt;tibble [2 √ó 2]&gt;
## 2    NA &lt;tibble [2 √ó 2]&gt;
## 3     2 &lt;tibble [3 √ó 2]&gt;
## 4     3 &lt;tibble [3 √ó 2]&gt;
## 5     4 &lt;tibble [2 √ó 2]&gt;</code></pre>
<p>This creates a new tibble, with columns <code>id</code> and <code>data</code>. <code>data</code> is a list-column that contains
tibbles; each tibble is the <code>variable</code> and <code>value</code> for each individual:</p>
<pre class="sourceCode r"><code class="sourceCode r">nested_data <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">filter</span>(id <span class="op">==</span><span class="st"> &quot;1&quot;</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">pull</span>(data)</code></pre>
<pre><code>## [[1]]
## # A tibble: 2 x 2
##   variable value
##   &lt;chr&gt;    &lt;dbl&gt;
## 1 var1       1  
## 2 var2       0.2</code></pre>
<p>As you can see, for individual 1, the column data contains a 2x2 tibble with columns <code>variable</code> and
<code>value</code>. You might be wondering why this is useful, because this seems to introduce an unnecessary
layer of complexity. The usefulness of list-columns will become apparent in the next chapters,
where we are going to learn how to repeat actions over, say, individuals.</p>
</div>
<div id="going-beyond-descriptive-statistics-and-data-manipulation" class="section level2">
<h2><span class="header-section-number">4.9</span> Going beyond descriptive statistics and data manipulation</h2>
<p>The <code>{tidyverse}</code> collection of packages can do much more than simply data manipulation and
descriptive statisics. You can use the principles we have covered and the functions you now know
to do much more. For instance, you can use a few <code>{tidyverse}</code> functions to do Monte Carlo simulations,
for example to estimate <span class="math inline">\(\pi\)</span>.</p>
<p>Draw the unit circle inside the unit square, the ratio of the area of the circle to the area of the
square will be <span class="math inline">\(\pi/4\)</span>. Then shot K arrows at the square; roughly <span class="math inline">\(K*\pi/4\)</span> should have fallen
inside the circle. So if now you shoot N arrows at the square, and M fall inside the circle, you have
the following relationship <span class="math inline">\(M = N*\pi/4\)</span>. You can thus compute <span class="math inline">\(\pi\)</span> like so: <span class="math inline">\(\pi = 4*M/N\)</span>.</p>
<p>The more arrows N you throw at the square, the better approximation of <span class="math inline">\(\pi\)</span> you‚Äôll have. Let‚Äôs
try to do this with a tidy Monte Carlo simulation. First, let‚Äôs randomly pick some points inside
the unit square:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(tidyverse)

n &lt;-<span class="st"> </span><span class="dv">5000</span>

<span class="kw">set.seed</span>(<span class="dv">2019</span>)
points &lt;-<span class="st"> </span><span class="kw">tibble</span>(<span class="st">&quot;x&quot;</span> =<span class="st"> </span><span class="kw">runif</span>(n), <span class="st">&quot;y&quot;</span> =<span class="st"> </span><span class="kw">runif</span>(n))</code></pre>
<p>Now, to know if a point is inside the unit circle, we need to check wether <span class="math inline">\(x^2 + y^2 &lt; 1\)</span>. Let‚Äôs
add a new column to the <code>points</code> tibble, called <code>inside</code> equal to 1 if the point is inside the
unit circle and 0 if not:</p>
<pre class="sourceCode r"><code class="sourceCode r">points &lt;-<span class="st"> </span>points <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">mutate</span>(<span class="dt">inside =</span> <span class="kw">map2_dbl</span>(<span class="dt">.x =</span> x, <span class="dt">.y =</span> y, <span class="op">~</span><span class="kw">ifelse</span>(.x<span class="op">**</span><span class="dv">2</span> <span class="op">+</span><span class="st"> </span>.y<span class="op">**</span><span class="dv">2</span> <span class="op">&lt;</span><span class="st"> </span><span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>))) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">rowid_to_column</span>(<span class="st">&quot;N&quot;</span>)</code></pre>
<p>Let‚Äôs take a look at <code>points</code>:</p>
<pre class="sourceCode r"><code class="sourceCode r">points</code></pre>
<pre><code>## # A tibble: 5,000 x 4
##        N       x      y inside
##    &lt;int&gt;   &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;
##  1     1 0.770   0.984       0
##  2     2 0.713   0.0107      1
##  3     3 0.303   0.133       1
##  4     4 0.618   0.0378      1
##  5     5 0.0505  0.677       1
##  6     6 0.0432  0.0846      1
##  7     7 0.820   0.727       0
##  8     8 0.00961 0.0758      1
##  9     9 0.102   0.373       1
## 10    10 0.609   0.676       1
## # ‚Ä¶ with 4,990 more rows</code></pre>
<p>Now, I can compute the estimation
of <span class="math inline">\(\pi\)</span> at each row, by computing the cumulative sum of the 1‚Äôs in the <code>inside</code> column and dividing
that by the current value of <code>N</code> column:</p>
<pre class="sourceCode r"><code class="sourceCode r">points &lt;-<span class="st"> </span>points <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">mutate</span>(<span class="dt">estimate =</span> <span class="dv">4</span><span class="op">*</span><span class="kw">cumsum</span>(inside)<span class="op">/</span>N)</code></pre>
<p><code>cumsum(inside)</code> is the <code>M</code> from the formula. Now, we can finish by plotting the result:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>(points) <span class="op">+</span>
<span class="st">    </span><span class="kw">geom_line</span>(<span class="kw">aes</span>(<span class="dt">y =</span> estimate, <span class="dt">x =</span> N)) <span class="op">+</span>
<span class="st">    </span><span class="kw">geom_hline</span>(<span class="dt">yintercept =</span> pi)</code></pre>
<p><img src="modern_R_files/figure-html/unnamed-chunk-404-1.png" width="672" /></p>
<p>In the next chapter, we are going to learn all about <code>{ggplot2}</code>, the package I used in the lines
above to create this plot.</p>
<p>As the number of tries grows, the estimation of <span class="math inline">\(\pi\)</span> gets better.</p>
<p>Using a data frame as a structure to hold our simulated points and the results makes it very easy
to avoid loops, and thus write code that is more concise and easier to follow.
If you studied a quantitative field in university, you might have done a similar exercise at the
time, very likely by defining a matrix to hold your points, and an empty vector to hold whether a
particular point was inside the unit circle. Then you wrote a loop to compute whether
a point was inside the unit circle, save this result in the before-defined empty vector and then
compute the estimation of <span class="math inline">\(\pi\)</span>. Again, I take this opportunity here to stress that there is nothing
wrong with this approach per se, but R is better suited for a workflow where lists or data frames
are the central objects and where the analyst operates over them with functional programming techniques.</p>
</div>
<div id="exercises-2" class="section level2">
<h2><span class="header-section-number">4.10</span> Exercises</h2>
<div id="exercise-1-2" class="section level3 unnumbered">
<h3>Exercise 1</h3>
<p>Load the <code>LaborSupply</code> dataset from the <code>Ecdat</code> package and answer the following questions:</p>
<ul>
<li>Compute the average annual hours worked by year (plus standard deviation)</li>
<li>What age group worked the most hours in the year 1982?</li>
<li>Create a variable, <code>n_years</code> that equals the number of years an individual stays in the panel. Is the panel balanced?</li>
<li>Which are the individuals that do not have any kids during the whole period? Create a variable, <code>no_kids</code>, that flags these individuals (1 = no kids, 0 = kids)</li>
<li>Using the <code>no_kids</code> variable from before compute the average wage, standard deviation and number of observations in each group for the year 1980 (no kids group vs kids group).</li>
<li>Create the lagged logarithm of hours worked and wages. Remember that this is a panel.</li>
</ul>
</div>
<div id="exercise-2-1" class="section level3 unnumbered">
<h3>Exercise 2</h3>
<ul>
<li>What does the following code do? Copy and paste it in an R interpreter to find out!</li>
</ul>
<pre class="sourceCode r"><code class="sourceCode r">LaborSupply <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">group_by</span>(id) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate_at</span>(<span class="kw">vars</span>(<span class="kw">starts_with</span>(<span class="st">&quot;l&quot;</span>)), <span class="kw">funs</span>(lag, lead))</code></pre>
<p><code>mutate_at()</code> is a scoped version of <code>mutate()</code> which allows you to specify a number of columns and
functions in one go. This also exists for <code>summarise()</code>.</p>
<ul>
<li>Using <code>summarise_at()</code>, compute the mean, standard deviation and number of individuals of <code>lnhr</code> and <code>lnwg</code> for each individual.</li>
</ul>
</div>
<div id="exercise-3-1" class="section level3 unnumbered">
<h3>Exercise 3</h3>
<ul>
<li><p>In the dataset folder you downloaded at the beginning of the chapter, there is a folder called
‚Äúunemployment‚Äù. I used the data in the section about working with lists of datasets. Using
<code>rio::import_list()</code>, read the 4 datasets into R.</p></li>
<li><p>Using <code>map()</code>, map the <code>janitor::clean_names()</code> function to each dataset (just like in the example
in the section on working with lists of datasets). Then, still with <code>map()</code> and <code>mutate()</code> convert
all commune names in the <code>commune</code> column with the function <code>tolower()</code>, in a new column called <code>lcommune</code>.
This is not an easy exercise; so here are some hints:</p>
<ul>
<li>Remember that <code>all_datasets</code> is a list of datasets. Which function do you use when you want to map a function to each element of a list?</li>
<li>Each element of <code>all_datasets</code> are <code>data.frame</code> objects. Which function do you use to add a column to a <code>data.frame</code>?</li>
<li>What symbol can you use to access a column of a <code>data.frame</code>?</li>
</ul></li>
</ul>

</div>
</div>
</div>
<h3>References</h3>
<div id="refs" class="references">
<div id="ref-vaudor_purrr_2018">
<p>Vaudor, Lise. 2018. ‚ÄúIt√©ration de Fonctions Avec Purrr.‚Äù <em>R-Atique: Analyse de Donn√©es Avec R</em>. <a href="http://perso.ens-lyon.fr/lise.vaudor/iterer-des-fonctions-avec-purrr/">http://perso.ens-lyon.fr/lise.vaudor/iterer-des-fonctions-avec-purrr/</a>.</p>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="reading-and-writing-data.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="graphs.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"google": false,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"all": ["facebook", "google", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"download": null,
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:" && /^https?:/.test(src))
      src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
