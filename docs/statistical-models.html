<!DOCTYPE html>
<html >

<head>

  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Modern R with the tidyverse</title>
  <meta name="description" content="This book will teach you how to use R to solve you statistical, data science and machine learning problems. Importing data, computing descriptive statistics, running regressions (or more complex machine learning models) and generating reports are some of the topics covered. No previous experience with R is needed.">
  <meta name="generator" content="bookdown 0.7 and GitBook 2.6.7">

  <meta property="og:title" content="Modern R with the tidyverse" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="This book will teach you how to use R to solve you statistical, data science and machine learning problems. Importing data, computing descriptive statistics, running regressions (or more complex machine learning models) and generating reports are some of the topics covered. No previous experience with R is needed." />
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Modern R with the tidyverse" />
  
  <meta name="twitter:description" content="This book will teach you how to use R to solve you statistical, data science and machine learning problems. Importing data, computing descriptive statistics, running regressions (or more complex machine learning models) and generating reports are some of the topics covered. No previous experience with R is needed." />
  

<meta name="author" content="Bruno Rodrigues">


<meta name="date" content="2018-12-16">

  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  
  
<link rel="prev" href="graphs.html">
<link rel="next" href="defining-your-own-functions.html">
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />









<style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(title);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Modern R with the tidyverse</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Preface</a><ul>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#note-to-the-reader"><i class="fa fa-check"></i>Note to the reader</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#what-is-r"><i class="fa fa-check"></i>What is R?</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#who-is-this-book-for"><i class="fa fa-check"></i>Who is this book for?</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#why-this-book"><i class="fa fa-check"></i>Why this book?</a></li>
<li><a href="index.html#why-modern-r">Why <em>modern</em> R?</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#what-is-rstudio"><i class="fa fa-check"></i>What is RStudio?</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#what-to-expect-from-this-book"><i class="fa fa-check"></i>What to expect from this book?</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#prerequisites"><i class="fa fa-check"></i>Prerequisites</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#what-are-packages"><i class="fa fa-check"></i>What are packages?</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#the-author"><i class="fa fa-check"></i>The author</a></li>
</ul></li>
<li class="chapter" data-level="1" data-path="getting-to-know-rstudio.html"><a href="getting-to-know-rstudio.html"><i class="fa fa-check"></i><b>1</b> Getting to know RStudio</a><ul>
<li class="chapter" data-level="1.1" data-path="getting-to-know-rstudio.html"><a href="getting-to-know-rstudio.html#panes"><i class="fa fa-check"></i><b>1.1</b> Panes</a></li>
<li class="chapter" data-level="1.2" data-path="getting-to-know-rstudio.html"><a href="getting-to-know-rstudio.html#console"><i class="fa fa-check"></i><b>1.2</b> Console</a></li>
<li class="chapter" data-level="1.3" data-path="getting-to-know-rstudio.html"><a href="getting-to-know-rstudio.html#scripts"><i class="fa fa-check"></i><b>1.3</b> Scripts</a><ul>
<li class="chapter" data-level="1.3.1" data-path="getting-to-know-rstudio.html"><a href="getting-to-know-rstudio.html#the-help-pane"><i class="fa fa-check"></i><b>1.3.1</b> The help pane</a></li>
<li class="chapter" data-level="1.3.2" data-path="getting-to-know-rstudio.html"><a href="getting-to-know-rstudio.html#the-environment-pane"><i class="fa fa-check"></i><b>1.3.2</b> The Environment pane</a></li>
</ul></li>
<li class="chapter" data-level="1.4" data-path="getting-to-know-rstudio.html"><a href="getting-to-know-rstudio.html#options"><i class="fa fa-check"></i><b>1.4</b> Options</a></li>
<li class="chapter" data-level="1.5" data-path="getting-to-know-rstudio.html"><a href="getting-to-know-rstudio.html#keyboard-shortcuts"><i class="fa fa-check"></i><b>1.5</b> Keyboard shortcuts</a></li>
<li class="chapter" data-level="1.6" data-path="getting-to-know-rstudio.html"><a href="getting-to-know-rstudio.html#projects"><i class="fa fa-check"></i><b>1.6</b> Projects</a></li>
<li class="chapter" data-level="1.7" data-path="getting-to-know-rstudio.html"><a href="getting-to-know-rstudio.html#history"><i class="fa fa-check"></i><b>1.7</b> History</a></li>
<li class="chapter" data-level="1.8" data-path="getting-to-know-rstudio.html"><a href="getting-to-know-rstudio.html#plots"><i class="fa fa-check"></i><b>1.8</b> Plots</a></li>
<li class="chapter" data-level="1.9" data-path="getting-to-know-rstudio.html"><a href="getting-to-know-rstudio.html#addins"><i class="fa fa-check"></i><b>1.9</b> Addins</a></li>
<li class="chapter" data-level="1.10" data-path="getting-to-know-rstudio.html"><a href="getting-to-know-rstudio.html#exercises"><i class="fa fa-check"></i><b>1.10</b> Exercises</a><ul>
<li class="chapter" data-level="" data-path="getting-to-know-rstudio.html"><a href="getting-to-know-rstudio.html#exercise-1"><i class="fa fa-check"></i>Exercise 1</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="2" data-path="packages.html"><a href="packages.html"><i class="fa fa-check"></i><b>2</b> Packages</a></li>
<li class="chapter" data-level="3" data-path="data-types-and-objects.html"><a href="data-types-and-objects.html"><i class="fa fa-check"></i><b>3</b> Data types and objects</a><ul>
<li class="chapter" data-level="3.1" data-path="data-types-and-objects.html"><a href="data-types-and-objects.html#the-numeric-class"><i class="fa fa-check"></i><b>3.1</b> The <code>numeric</code> class</a></li>
<li class="chapter" data-level="3.2" data-path="data-types-and-objects.html"><a href="data-types-and-objects.html#the-character-class"><i class="fa fa-check"></i><b>3.2</b> The <code>character</code> class</a></li>
<li class="chapter" data-level="3.3" data-path="data-types-and-objects.html"><a href="data-types-and-objects.html#the-factor-class"><i class="fa fa-check"></i><b>3.3</b> The <code>factor</code> class</a></li>
<li class="chapter" data-level="3.4" data-path="data-types-and-objects.html"><a href="data-types-and-objects.html#the-date-class"><i class="fa fa-check"></i><b>3.4</b> The <code>Date</code> class</a></li>
<li class="chapter" data-level="3.5" data-path="data-types-and-objects.html"><a href="data-types-and-objects.html#vectors-and-matrices"><i class="fa fa-check"></i><b>3.5</b> Vectors and matrices</a><ul>
<li class="chapter" data-level="3.5.1" data-path="data-types-and-objects.html"><a href="data-types-and-objects.html#the-c-function"><i class="fa fa-check"></i><b>3.5.1</b> The <code>c()</code> function</a></li>
<li class="chapter" data-level="3.5.2" data-path="data-types-and-objects.html"><a href="data-types-and-objects.html#cbind-and-rbind"><i class="fa fa-check"></i><b>3.5.2</b> <code>cbind()</code> and <code>rbind()</code></a></li>
<li class="chapter" data-level="3.5.3" data-path="data-types-and-objects.html"><a href="data-types-and-objects.html#the-matrix-class"><i class="fa fa-check"></i><b>3.5.3</b> The <code>matrix</code> class</a></li>
</ul></li>
<li class="chapter" data-level="3.6" data-path="data-types-and-objects.html"><a href="data-types-and-objects.html#the-logical-class"><i class="fa fa-check"></i><b>3.6</b> The <code>logical</code> class</a></li>
<li class="chapter" data-level="3.7" data-path="data-types-and-objects.html"><a href="data-types-and-objects.html#the-list-class"><i class="fa fa-check"></i><b>3.7</b> The <code>list</code> class</a></li>
<li class="chapter" data-level="3.8" data-path="data-types-and-objects.html"><a href="data-types-and-objects.html#the-data.frame-and-tibble-classes"><i class="fa fa-check"></i><b>3.8</b> The <code>data.frame</code> and <code>tibble</code> classes</a></li>
<li class="chapter" data-level="3.9" data-path="data-types-and-objects.html"><a href="data-types-and-objects.html#formulas"><i class="fa fa-check"></i><b>3.9</b> Formulas</a></li>
<li class="chapter" data-level="3.10" data-path="data-types-and-objects.html"><a href="data-types-and-objects.html#models"><i class="fa fa-check"></i><b>3.10</b> Models</a></li>
<li class="chapter" data-level="3.11" data-path="data-types-and-objects.html"><a href="data-types-and-objects.html#the-is.-and-as.-functions"><i class="fa fa-check"></i><b>3.11</b> The <code>is.*()</code> and <code>as.*()</code> functions</a></li>
<li class="chapter" data-level="3.12" data-path="data-types-and-objects.html"><a href="data-types-and-objects.html#exercises-1"><i class="fa fa-check"></i><b>3.12</b> Exercises</a><ul>
<li class="chapter" data-level="" data-path="data-types-and-objects.html"><a href="data-types-and-objects.html#exercise-1-1"><i class="fa fa-check"></i>Exercise 1</a></li>
<li class="chapter" data-level="" data-path="data-types-and-objects.html"><a href="data-types-and-objects.html#exercise-2"><i class="fa fa-check"></i>Exercise 2</a></li>
<li class="chapter" data-level="" data-path="data-types-and-objects.html"><a href="data-types-and-objects.html#exercise-3"><i class="fa fa-check"></i>Exercise 3</a></li>
<li class="chapter" data-level="" data-path="data-types-and-objects.html"><a href="data-types-and-objects.html#exercise-4"><i class="fa fa-check"></i>Exercise 4</a></li>
<li class="chapter" data-level="" data-path="data-types-and-objects.html"><a href="data-types-and-objects.html#exercise-5"><i class="fa fa-check"></i>Exercise 5</a></li>
<li class="chapter" data-level="" data-path="data-types-and-objects.html"><a href="data-types-and-objects.html#exercise-6"><i class="fa fa-check"></i>Exercise 6</a></li>
<li class="chapter" data-level="" data-path="data-types-and-objects.html"><a href="data-types-and-objects.html#exercise-7"><i class="fa fa-check"></i>Exercise 7</a></li>
<li class="chapter" data-level="" data-path="data-types-and-objects.html"><a href="data-types-and-objects.html#exercise-8"><i class="fa fa-check"></i>Exercise 8</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="4" data-path="reading-and-writing-data.html"><a href="reading-and-writing-data.html"><i class="fa fa-check"></i><b>4</b> Reading and writing data</a><ul>
<li class="chapter" data-level="4.1" data-path="reading-and-writing-data.html"><a href="reading-and-writing-data.html#the-swiss-army-knife-of-data-import-and-export-rio"><i class="fa fa-check"></i><b>4.1</b> The swiss army knife of data import and export: <code>{rio}</code></a></li>
<li class="chapter" data-level="4.2" data-path="reading-and-writing-data.html"><a href="reading-and-writing-data.html#writing-any-object-to-disk"><i class="fa fa-check"></i><b>4.2</b> Writing any object to disk</a></li>
<li class="chapter" data-level="4.3" data-path="reading-and-writing-data.html"><a href="reading-and-writing-data.html#using-rstudio-projects-to-manage-paths"><i class="fa fa-check"></i><b>4.3</b> Using RStudio projects to manage paths</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="descriptive-statistics-and-data-manipulation.html"><a href="descriptive-statistics-and-data-manipulation.html"><i class="fa fa-check"></i><b>5</b> Descriptive statistics and data manipulation</a><ul>
<li class="chapter" data-level="5.1" data-path="descriptive-statistics-and-data-manipulation.html"><a href="descriptive-statistics-and-data-manipulation.html#a-data-exploration-exercice-using-base-r"><i class="fa fa-check"></i><b>5.1</b> A data exploration exercice using <em>base</em> R</a></li>
<li class="chapter" data-level="5.2" data-path="descriptive-statistics-and-data-manipulation.html"><a href="descriptive-statistics-and-data-manipulation.html#smoking-is-bad-for-you-but-pipes-are-your-friend"><i class="fa fa-check"></i><b>5.2</b> Smoking is bad for you, but pipes are your friend</a></li>
<li class="chapter" data-level="5.3" data-path="descriptive-statistics-and-data-manipulation.html"><a href="descriptive-statistics-and-data-manipulation.html#the-tidyverses-enfant-prodige-dplyr"><i class="fa fa-check"></i><b>5.3</b> The <code>{tidyverse}</code>‚Äôs <em>enfant prodige</em>: <code>{dplyr}</code></a><ul>
<li class="chapter" data-level="5.3.1" data-path="descriptive-statistics-and-data-manipulation.html"><a href="descriptive-statistics-and-data-manipulation.html#a-first-taste-of-data-manipulation-with-dplyr"><i class="fa fa-check"></i><b>5.3.1</b> A first taste of data manipulation with <code>{dplyr}</code></a></li>
<li class="chapter" data-level="5.3.2" data-path="descriptive-statistics-and-data-manipulation.html"><a href="descriptive-statistics-and-data-manipulation.html#filter-the-rows-of-a-dataset-with-filter"><i class="fa fa-check"></i><b>5.3.2</b> Filter the rows of a dataset with <code>filter()</code></a></li>
<li class="chapter" data-level="5.3.3" data-path="descriptive-statistics-and-data-manipulation.html"><a href="descriptive-statistics-and-data-manipulation.html#select-columns-with-select"><i class="fa fa-check"></i><b>5.3.3</b> Select columns with <code>select()</code></a></li>
<li class="chapter" data-level="5.3.4" data-path="descriptive-statistics-and-data-manipulation.html"><a href="descriptive-statistics-and-data-manipulation.html#group-the-observations-of-your-dataset-with-group_by"><i class="fa fa-check"></i><b>5.3.4</b> Group the observations of your dataset with <code>group_by()</code></a></li>
<li class="chapter" data-level="5.3.5" data-path="descriptive-statistics-and-data-manipulation.html"><a href="descriptive-statistics-and-data-manipulation.html#get-summary-statistics-with-summarise"><i class="fa fa-check"></i><b>5.3.5</b> Get summary statistics with <code>summarise()</code></a></li>
<li class="chapter" data-level="5.3.6" data-path="descriptive-statistics-and-data-manipulation.html"><a href="descriptive-statistics-and-data-manipulation.html#adding-columns-with-mutate-and-transmute"><i class="fa fa-check"></i><b>5.3.6</b> Adding columns with <code>mutate()</code> and <code>transmute()</code></a></li>
<li class="chapter" data-level="5.3.7" data-path="descriptive-statistics-and-data-manipulation.html"><a href="descriptive-statistics-and-data-manipulation.html#joining-tibbles-with-full_join-left_join-right_join-and-all-the-others"><i class="fa fa-check"></i><b>5.3.7</b> Joining <code>tibble</code>s with <code>full_join()</code>, <code>left_join()</code>, <code>right_join()</code> and all the others</a></li>
</ul></li>
<li class="chapter" data-level="5.4" data-path="descriptive-statistics-and-data-manipulation.html"><a href="descriptive-statistics-and-data-manipulation.html#reshaping-data-with-tidyr"><i class="fa fa-check"></i><b>5.4</b> Reshaping data with <code>tidyr</code></a><ul>
<li class="chapter" data-level="5.4.1" data-path="descriptive-statistics-and-data-manipulation.html"><a href="descriptive-statistics-and-data-manipulation.html#spread-and-gather"><i class="fa fa-check"></i><b>5.4.1</b> <code>spread()</code> and <code>gather()</code></a></li>
<li class="chapter" data-level="5.4.2" data-path="descriptive-statistics-and-data-manipulation.html"><a href="descriptive-statistics-and-data-manipulation.html#fill-and-full_seq"><i class="fa fa-check"></i><b>5.4.2</b> <code>fill()</code> and <code>full_seq()</code></a></li>
<li class="chapter" data-level="5.4.3" data-path="descriptive-statistics-and-data-manipulation.html"><a href="descriptive-statistics-and-data-manipulation.html#put-order-in-your-columns-with-separate-unite-and-in-your-rows-with-separate_rows"><i class="fa fa-check"></i><b>5.4.3</b> Put order in your columns with <code>separate()</code>, <code>unite()</code>, and in your rows with <code>separate_rows()</code></a></li>
<li class="chapter" data-level="5.4.4" data-path="descriptive-statistics-and-data-manipulation.html"><a href="descriptive-statistics-and-data-manipulation.html#a-sneak-peek-to-chapter-9-nest"><i class="fa fa-check"></i><b>5.4.4</b> A sneak peek to Chapter 9; <code>nest()</code></a></li>
</ul></li>
<li class="chapter" data-level="5.5" data-path="descriptive-statistics-and-data-manipulation.html"><a href="descriptive-statistics-and-data-manipulation.html#scoped-tidyverse-verbs"><i class="fa fa-check"></i><b>5.5</b> Scoped <code>{tidyverse}</code> verbs</a><ul>
<li class="chapter" data-level="5.5.1" data-path="descriptive-statistics-and-data-manipulation.html"><a href="descriptive-statistics-and-data-manipulation.html#filter_"><i class="fa fa-check"></i><b>5.5.1</b> filter_*()</a></li>
<li class="chapter" data-level="5.5.2" data-path="descriptive-statistics-and-data-manipulation.html"><a href="descriptive-statistics-and-data-manipulation.html#select_-and-rename_"><i class="fa fa-check"></i><b>5.5.2</b> select_*() and rename_*()</a></li>
<li class="chapter" data-level="5.5.3" data-path="descriptive-statistics-and-data-manipulation.html"><a href="descriptive-statistics-and-data-manipulation.html#group_by_"><i class="fa fa-check"></i><b>5.5.3</b> group_by_*()</a></li>
<li class="chapter" data-level="5.5.4" data-path="descriptive-statistics-and-data-manipulation.html"><a href="descriptive-statistics-and-data-manipulation.html#summarise_"><i class="fa fa-check"></i><b>5.5.4</b> summarise_()</a></li>
<li class="chapter" data-level="5.5.5" data-path="descriptive-statistics-and-data-manipulation.html"><a href="descriptive-statistics-and-data-manipulation.html#mutate_"><i class="fa fa-check"></i><b>5.5.5</b> mutate_*()</a></li>
</ul></li>
<li class="chapter" data-level="5.6" data-path="descriptive-statistics-and-data-manipulation.html"><a href="descriptive-statistics-and-data-manipulation.html#other-useful-tidyverse-functions"><i class="fa fa-check"></i><b>5.6</b> Other useful <code>{tidyverse}</code> functions</a><ul>
<li class="chapter" data-level="5.6.1" data-path="descriptive-statistics-and-data-manipulation.html"><a href="descriptive-statistics-and-data-manipulation.html#if_else-case_when-and-recode"><i class="fa fa-check"></i><b>5.6.1</b> <code>if_else()</code>, <code>case_when()</code> and <code>recode()</code></a></li>
<li class="chapter" data-level="5.6.2" data-path="descriptive-statistics-and-data-manipulation.html"><a href="descriptive-statistics-and-data-manipulation.html#lead-and-lag"><i class="fa fa-check"></i><b>5.6.2</b> <code>lead()</code> and <code>lag()</code></a></li>
<li class="chapter" data-level="5.6.3" data-path="descriptive-statistics-and-data-manipulation.html"><a href="descriptive-statistics-and-data-manipulation.html#ntile"><i class="fa fa-check"></i><b>5.6.3</b> <code>ntile()</code></a></li>
<li class="chapter" data-level="5.6.4" data-path="descriptive-statistics-and-data-manipulation.html"><a href="descriptive-statistics-and-data-manipulation.html#arrange"><i class="fa fa-check"></i><b>5.6.4</b> <code>arrange()</code></a></li>
<li class="chapter" data-level="5.6.5" data-path="descriptive-statistics-and-data-manipulation.html"><a href="descriptive-statistics-and-data-manipulation.html#tally-and-count"><i class="fa fa-check"></i><b>5.6.5</b> <code>tally()</code> and <code>count()</code></a></li>
</ul></li>
<li class="chapter" data-level="5.7" data-path="descriptive-statistics-and-data-manipulation.html"><a href="descriptive-statistics-and-data-manipulation.html#special-packages-for-special-kinds-of-data-forcats-lubridate-and-stringr"><i class="fa fa-check"></i><b>5.7</b> Special packages for special kinds of data: <code>{forcats}</code>, <code>{lubridate}</code>, and <code>{stringr}</code></a><ul>
<li class="chapter" data-level="5.7.1" data-path="descriptive-statistics-and-data-manipulation.html"><a href="descriptive-statistics-and-data-manipulation.html#section"><i class="fa fa-check"></i><b>5.7.1</b> üêàüêàüêàüêà</a></li>
<li class="chapter" data-level="5.7.2" data-path="descriptive-statistics-and-data-manipulation.html"><a href="descriptive-statistics-and-data-manipulation.html#get-your-dates-right-with-lubridate"><i class="fa fa-check"></i><b>5.7.2</b> Get your dates right with <code>{lubridate}</code></a></li>
</ul></li>
<li class="chapter" data-level="5.8" data-path="descriptive-statistics-and-data-manipulation.html"><a href="descriptive-statistics-and-data-manipulation.html#list-columns"><i class="fa fa-check"></i><b>5.8</b> List-columns</a></li>
<li class="chapter" data-level="5.9" data-path="descriptive-statistics-and-data-manipulation.html"><a href="descriptive-statistics-and-data-manipulation.html#going-beyond-descriptive-statistics-and-data-manipulation"><i class="fa fa-check"></i><b>5.9</b> Going beyond descriptive statistics and data manipulation</a></li>
<li class="chapter" data-level="5.10" data-path="descriptive-statistics-and-data-manipulation.html"><a href="descriptive-statistics-and-data-manipulation.html#exercises-2"><i class="fa fa-check"></i><b>5.10</b> Exercises</a><ul>
<li class="chapter" data-level="" data-path="descriptive-statistics-and-data-manipulation.html"><a href="descriptive-statistics-and-data-manipulation.html#exercise-1-2"><i class="fa fa-check"></i>Exercise 1</a></li>
<li class="chapter" data-level="" data-path="descriptive-statistics-and-data-manipulation.html"><a href="descriptive-statistics-and-data-manipulation.html#exercise-2-1"><i class="fa fa-check"></i>Exercise 2</a></li>
<li class="chapter" data-level="" data-path="descriptive-statistics-and-data-manipulation.html"><a href="descriptive-statistics-and-data-manipulation.html#exercise-3-1"><i class="fa fa-check"></i>Exercise 3</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="6" data-path="graphs.html"><a href="graphs.html"><i class="fa fa-check"></i><b>6</b> Graphs</a><ul>
<li class="chapter" data-level="6.1" data-path="graphs.html"><a href="graphs.html#resources"><i class="fa fa-check"></i><b>6.1</b> Resources</a></li>
<li class="chapter" data-level="6.2" data-path="graphs.html"><a href="graphs.html#examples"><i class="fa fa-check"></i><b>6.2</b> Examples</a><ul>
<li class="chapter" data-level="6.2.1" data-path="graphs.html"><a href="graphs.html#barplots"><i class="fa fa-check"></i><b>6.2.1</b> Barplots</a></li>
<li class="chapter" data-level="6.2.2" data-path="graphs.html"><a href="graphs.html#density"><i class="fa fa-check"></i><b>6.2.2</b> Density</a></li>
<li class="chapter" data-level="6.2.3" data-path="graphs.html"><a href="graphs.html#line-plots"><i class="fa fa-check"></i><b>6.2.3</b> Line plots</a></li>
<li class="chapter" data-level="6.2.4" data-path="graphs.html"><a href="graphs.html#facets"><i class="fa fa-check"></i><b>6.2.4</b> Facets</a></li>
<li class="chapter" data-level="6.2.5" data-path="graphs.html"><a href="graphs.html#pie-charts"><i class="fa fa-check"></i><b>6.2.5</b> Pie Charts</a></li>
<li class="chapter" data-level="6.2.6" data-path="graphs.html"><a href="graphs.html#adding-text-to-plots"><i class="fa fa-check"></i><b>6.2.6</b> Adding text to plots</a></li>
</ul></li>
<li class="chapter" data-level="6.3" data-path="graphs.html"><a href="graphs.html#customization"><i class="fa fa-check"></i><b>6.3</b> Customization</a><ul>
<li class="chapter" data-level="6.3.1" data-path="graphs.html"><a href="graphs.html#titles-axes-names-and-more"><i class="fa fa-check"></i><b>6.3.1</b> Titles, axes names and more</a></li>
<li class="chapter" data-level="6.3.2" data-path="graphs.html"><a href="graphs.html#themes"><i class="fa fa-check"></i><b>6.3.2</b> Themes</a></li>
<li class="chapter" data-level="6.3.3" data-path="graphs.html"><a href="graphs.html#colour-schemes-from-ggthemes"><i class="fa fa-check"></i><b>6.3.3</b> Colour schemes from <code>ggthemes</code></a></li>
<li class="chapter" data-level="6.3.4" data-path="graphs.html"><a href="graphs.html#using-your-own-colours"><i class="fa fa-check"></i><b>6.3.4</b> Using your own colours</a></li>
<li class="chapter" data-level="6.3.5" data-path="graphs.html"><a href="graphs.html#saving-plots-on-disk"><i class="fa fa-check"></i><b>6.3.5</b> Saving plots on disk</a></li>
</ul></li>
<li class="chapter" data-level="6.4" data-path="graphs.html"><a href="graphs.html#exercises-3"><i class="fa fa-check"></i><b>6.4</b> Exercises</a><ul>
<li class="chapter" data-level="" data-path="graphs.html"><a href="graphs.html#exercise-1-3"><i class="fa fa-check"></i>Exercise 1</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="7" data-path="statistical-models.html"><a href="statistical-models.html"><i class="fa fa-check"></i><b>7</b> Statistical models</a><ul>
<li class="chapter" data-level="7.1" data-path="statistical-models.html"><a href="statistical-models.html#terminology"><i class="fa fa-check"></i><b>7.1</b> Terminology</a></li>
<li class="chapter" data-level="7.2" data-path="statistical-models.html"><a href="statistical-models.html#fitting-a-model-to-data"><i class="fa fa-check"></i><b>7.2</b> Fitting a model to data</a></li>
<li class="chapter" data-level="7.3" data-path="statistical-models.html"><a href="statistical-models.html#diagnostics"><i class="fa fa-check"></i><b>7.3</b> Diagnostics</a></li>
<li class="chapter" data-level="7.4" data-path="statistical-models.html"><a href="statistical-models.html#interpreting-models"><i class="fa fa-check"></i><b>7.4</b> Interpreting models</a></li>
<li class="chapter" data-level="7.5" data-path="statistical-models.html"><a href="statistical-models.html#comparing-models"><i class="fa fa-check"></i><b>7.5</b> Comparing models</a></li>
<li class="chapter" data-level="7.6" data-path="statistical-models.html"><a href="statistical-models.html#using-a-model-for-prediction"><i class="fa fa-check"></i><b>7.6</b> Using a model for prediction</a></li>
<li class="chapter" data-level="7.7" data-path="statistical-models.html"><a href="statistical-models.html#beyond-linear-regression"><i class="fa fa-check"></i><b>7.7</b> Beyond linear regression</a></li>
<li class="chapter" data-level="7.8" data-path="statistical-models.html"><a href="statistical-models.html#hyper-parameters"><i class="fa fa-check"></i><b>7.8</b> Hyper-parameters</a><ul>
<li class="chapter" data-level="7.8.1" data-path="statistical-models.html"><a href="statistical-models.html#ridge-regression"><i class="fa fa-check"></i><b>7.8.1</b> Ridge regression</a></li>
</ul></li>
<li class="chapter" data-level="7.9" data-path="statistical-models.html"><a href="statistical-models.html#training-validating-and-testing-models"><i class="fa fa-check"></i><b>7.9</b> Training, validating, and testing models</a><ul>
<li class="chapter" data-level="7.9.1" data-path="statistical-models.html"><a href="statistical-models.html#set-up"><i class="fa fa-check"></i><b>7.9.1</b> Set up</a></li>
<li class="chapter" data-level="7.9.2" data-path="statistical-models.html"><a href="statistical-models.html#bayesian-hyperparameter-optimization"><i class="fa fa-check"></i><b>7.9.2</b> Bayesian hyperparameter optimization</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="8" data-path="defining-your-own-functions.html"><a href="defining-your-own-functions.html"><i class="fa fa-check"></i><b>8</b> Defining your own functions</a><ul>
<li class="chapter" data-level="8.1" data-path="defining-your-own-functions.html"><a href="defining-your-own-functions.html#control-flow"><i class="fa fa-check"></i><b>8.1</b> Control flow</a><ul>
<li class="chapter" data-level="8.1.1" data-path="defining-your-own-functions.html"><a href="defining-your-own-functions.html#if-else"><i class="fa fa-check"></i><b>8.1.1</b> If-else</a></li>
<li class="chapter" data-level="8.1.2" data-path="defining-your-own-functions.html"><a href="defining-your-own-functions.html#for-loops"><i class="fa fa-check"></i><b>8.1.2</b> For loops</a></li>
<li class="chapter" data-level="8.1.3" data-path="defining-your-own-functions.html"><a href="defining-your-own-functions.html#while-loops"><i class="fa fa-check"></i><b>8.1.3</b> While loops</a></li>
</ul></li>
<li class="chapter" data-level="8.2" data-path="defining-your-own-functions.html"><a href="defining-your-own-functions.html#writing-your-own-functions"><i class="fa fa-check"></i><b>8.2</b> Writing your own functions</a><ul>
<li class="chapter" data-level="8.2.1" data-path="defining-your-own-functions.html"><a href="defining-your-own-functions.html#declaring-functions-in-r"><i class="fa fa-check"></i><b>8.2.1</b> Declaring functions in R</a></li>
<li class="chapter" data-level="8.2.2" data-path="defining-your-own-functions.html"><a href="defining-your-own-functions.html#fibonacci-numbers"><i class="fa fa-check"></i><b>8.2.2</b> Fibonacci numbers</a></li>
</ul></li>
<li class="chapter" data-level="8.3" data-path="defining-your-own-functions.html"><a href="defining-your-own-functions.html#exercises-4"><i class="fa fa-check"></i><b>8.3</b> Exercises</a><ul>
<li class="chapter" data-level="" data-path="defining-your-own-functions.html"><a href="defining-your-own-functions.html#exercise-1-4"><i class="fa fa-check"></i>Exercise 1</a></li>
<li class="chapter" data-level="" data-path="defining-your-own-functions.html"><a href="defining-your-own-functions.html#exercise-2-2"><i class="fa fa-check"></i>Exercise 2</a></li>
<li class="chapter" data-level="" data-path="defining-your-own-functions.html"><a href="defining-your-own-functions.html#exercise-3-2"><i class="fa fa-check"></i>Exercise 3</a></li>
</ul></li>
<li class="chapter" data-level="8.4" data-path="defining-your-own-functions.html"><a href="defining-your-own-functions.html#functions-that-take-functions-as-arguments"><i class="fa fa-check"></i><b>8.4</b> Functions that take functions as arguments</a></li>
<li class="chapter" data-level="8.5" data-path="defining-your-own-functions.html"><a href="defining-your-own-functions.html#functions-that-take-columns-of-data-as-arguments"><i class="fa fa-check"></i><b>8.5</b> Functions that take columns of data as arguments</a></li>
<li class="chapter" data-level="8.6" data-path="defining-your-own-functions.html"><a href="defining-your-own-functions.html#functions-that-use-loops"><i class="fa fa-check"></i><b>8.6</b> Functions that use loops</a></li>
<li class="chapter" data-level="8.7" data-path="defining-your-own-functions.html"><a href="defining-your-own-functions.html#anonymous-functions"><i class="fa fa-check"></i><b>8.7</b> Anonymous functions</a></li>
<li class="chapter" data-level="8.8" data-path="defining-your-own-functions.html"><a href="defining-your-own-functions.html#exercises-5"><i class="fa fa-check"></i><b>8.8</b> Exercises</a><ul>
<li class="chapter" data-level="" data-path="defining-your-own-functions.html"><a href="defining-your-own-functions.html#exercise-1-5"><i class="fa fa-check"></i>Exercise 1</a></li>
<li class="chapter" data-level="" data-path="defining-your-own-functions.html"><a href="defining-your-own-functions.html#exercise-2-3"><i class="fa fa-check"></i>Exercise 2</a></li>
<li class="chapter" data-level="" data-path="defining-your-own-functions.html"><a href="defining-your-own-functions.html#exercise-3-3"><i class="fa fa-check"></i>Exercise 3</a></li>
<li class="chapter" data-level="" data-path="defining-your-own-functions.html"><a href="defining-your-own-functions.html#exercise-4-1"><i class="fa fa-check"></i>Exercise 4</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="9" data-path="functional-programming.html"><a href="functional-programming.html"><i class="fa fa-check"></i><b>9</b> Functional programming</a><ul>
<li class="chapter" data-level="9.1" data-path="functional-programming.html"><a href="functional-programming.html#functions-definition"><i class="fa fa-check"></i><b>9.1</b> Functions definition</a></li>
<li class="chapter" data-level="9.2" data-path="functional-programming.html"><a href="functional-programming.html#properties-of-functions"><i class="fa fa-check"></i><b>9.2</b> Properties of functions</a></li>
<li class="chapter" data-level="9.3" data-path="functional-programming.html"><a href="functional-programming.html#functional-programming-with-purrr"><i class="fa fa-check"></i><b>9.3</b> Functional programming with <code>{purrr}</code></a><ul>
<li class="chapter" data-level="9.3.1" data-path="functional-programming.html"><a href="functional-programming.html#the-map-family-of-functions"><i class="fa fa-check"></i><b>9.3.1</b> The <code>map*()</code> family of functions</a></li>
<li class="chapter" data-level="9.3.2" data-path="functional-programming.html"><a href="functional-programming.html#reducing-with-purrr"><i class="fa fa-check"></i><b>9.3.2</b> Reducing with <code>purrr</code></a></li>
<li class="chapter" data-level="9.3.3" data-path="functional-programming.html"><a href="functional-programming.html#safely-and-possibly"><i class="fa fa-check"></i><b>9.3.3</b> <code>safely()</code> and <code>possibly()</code></a></li>
<li class="chapter" data-level="9.3.4" data-path="functional-programming.html"><a href="functional-programming.html#is_-and-as_-functions"><i class="fa fa-check"></i><b>9.3.4</b> <code>is_*()</code> and <code>as_*()</code> functions</a></li>
<li class="chapter" data-level="9.3.5" data-path="functional-programming.html"><a href="functional-programming.html#transposing-lists"><i class="fa fa-check"></i><b>9.3.5</b> ¬´Transposing lists¬ª</a></li>
</ul></li>
<li class="chapter" data-level="9.4" data-path="functional-programming.html"><a href="functional-programming.html#using-your-functions-inside-mutate"><i class="fa fa-check"></i><b>9.4</b> Using your functions inside <code>mutate()</code></a></li>
<li class="chapter" data-level="9.5" data-path="functional-programming.html"><a href="functional-programming.html#working-with-a-list-of-datasets"><i class="fa fa-check"></i><b>9.5</b> Working with a list of datasets</a><ul>
<li class="chapter" data-level="9.5.1" data-path="functional-programming.html"><a href="functional-programming.html#using-map-to-work-on-lists-of-datasets"><i class="fa fa-check"></i><b>9.5.1</b> Using <code>map()</code> to work on lists of datasets</a></li>
</ul></li>
<li class="chapter" data-level="9.6" data-path="functional-programming.html"><a href="functional-programming.html#mapping-your-homebrewed-functions-to-lists-of-datasets"><i class="fa fa-check"></i><b>9.6</b> Mapping your homebrewed functions to lists of datasets</a><ul>
<li class="chapter" data-level="9.6.1" data-path="functional-programming.html"><a href="functional-programming.html#data-frames-and-reduce"><i class="fa fa-check"></i><b>9.6.1</b> Data frames and <code>reduce</code></a></li>
</ul></li>
<li class="chapter" data-level="9.7" data-path="functional-programming.html"><a href="functional-programming.html#functional-programming-and-plotting"><i class="fa fa-check"></i><b>9.7</b> Functional programming and plotting</a></li>
<li class="chapter" data-level="9.8" data-path="functional-programming.html"><a href="functional-programming.html#exercises-6"><i class="fa fa-check"></i><b>9.8</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="10" data-path="package-development.html"><a href="package-development.html"><i class="fa fa-check"></i><b>10</b> Package development</a><ul>
<li class="chapter" data-level="10.1" data-path="package-development.html"><a href="package-development.html#why-you-need-to-write-your-own-package"><i class="fa fa-check"></i><b>10.1</b> Why you need to write your own package</a></li>
<li class="chapter" data-level="10.2" data-path="package-development.html"><a href="package-development.html#unit-testing-your-package"><i class="fa fa-check"></i><b>10.2</b> Unit testing your package</a></li>
</ul></li>
<li class="chapter" data-level="11" data-path="further-topics.html"><a href="further-topics.html"><i class="fa fa-check"></i><b>11</b> Further topics</a><ul>
<li class="chapter" data-level="11.1" data-path="further-topics.html"><a href="further-topics.html#generating-pdf-or-word-reports-with-r"><i class="fa fa-check"></i><b>11.1</b> Generating Pdf or Word reports with R</a></li>
<li class="chapter" data-level="11.2" data-path="further-topics.html"><a href="further-topics.html#scraping-the-internet"><i class="fa fa-check"></i><b>11.2</b> Scraping the internet</a></li>
<li class="chapter" data-level="11.3" data-path="further-topics.html"><a href="further-topics.html#regular-expressions"><i class="fa fa-check"></i><b>11.3</b> Regular expressions</a></li>
<li class="chapter" data-level="11.4" data-path="further-topics.html"><a href="further-topics.html#setting-up-a-blog-with-blogdown"><i class="fa fa-check"></i><b>11.4</b> Setting up a blog with <code>{blogdown}</code></a></li>
</ul></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>References</a></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Modern R with the tidyverse</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="statistical-models" class="section level1">
<h1><span class="header-section-number">Chapter 7</span> Statistical models</h1>
<p>In this chapter, we will not learn about all the models out there that you may or may not need.
Instead, I will show you how can use what you have learned until now and how you can apply these
concepts to modeling. Also, as you read in the beginning of the book, R has many many packages. So
the model you need is most probably already implemented in some package and you will very likely
not need to write your own from scratch.</p>
<p>In the first section, I will discuss the terminology used in this book. Then I will discuss
linear regression; showing how linear regression works illsutrates very well how other models
work too, without loss of generality. Then I will introduce the concepte of hyper-parameters
with ridge regression. This chapter will then finish with an introduction to cross-validation as
a way to tune the hyper-parameters of models that features them.</p>
<div id="terminology" class="section level2">
<h2><span class="header-section-number">7.1</span> Terminology</h2>
<p>Before continuing discussing about statistical models and model fitting it is worthwhile to discuss
terminology a little bit. Depending on your background, you might call an explanatory variable a
feature or the dependent variable the target. These are the same objects. The matrix of features
is usually called a design matrix, and the what statisticians call the intercept in a linear regression
machine learning engineers call the bias. Calling the intercept the bias is unfortunate, as bias
also has a very different meaning; bias is also what we call the error in a model that may cause
<em>biased</em> estimates. To finish up, the estimated parameters of the model may be called coefficients
or weights. Here again, I don‚Äôt like the using <em>weight</em> as weight as a very different meaning in
statistics.
So, in the remainder of this chapter, and book, I will use the terminology from the statistical
litterature, using dependent and explanatory variables (<code>y</code> and <code>x</code>), and calling the
estimated parameters coefficients and the intercept‚Ä¶ well the intercept (the <span class="math inline">\(\beta\)</span>s of the model).
However, I will talk of <em>training</em> a model, instead of <em>estimating</em> a model.</p>
</div>
<div id="fitting-a-model-to-data" class="section level2">
<h2><span class="header-section-number">7.2</span> Fitting a model to data</h2>
<p>Suppose you have a variable <code>y</code> that you wish to explain using a set of other variables <code>x1</code>, <code>x2</code>,
<code>x3</code>, etc. Let‚Äôs take a look at the <code>Housing</code> dataset from the <code>Ecdat</code> package:</p>
<div class="sourceCode" id="cb539"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb539-1" title="1"><span class="kw">library</span>(Ecdat)</a>
<a class="sourceLine" id="cb539-2" title="2"></a>
<a class="sourceLine" id="cb539-3" title="3"><span class="kw">data</span>(Housing)</a></code></pre></div>
<p>You can read a description of the dataset by running:</p>
<div class="sourceCode" id="cb540"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb540-1" title="1">?Housing</a></code></pre></div>
<pre><code>Housing                 package:Ecdat                  R Documentation

Sales Prices of Houses in the City of Windsor

Description:

     a cross-section from 1987

     _number of observations_ : 546

     _observation_ : goods

     _country_ : Canada

Usage:

     data(Housing)

Format:

     A dataframe containing :

     price: sale price of a house

     lotsize: the lot size of a property in square feet

     bedrooms: number of bedrooms

     bathrms: number of full bathrooms

     stories: number of stories excluding basement

     driveway: does the house has a driveway ?

     recroom: does the house has a recreational room ?

     fullbase: does the house has a full finished basement ?

     gashw: does the house uses gas for hot water heating ?

     airco: does the house has central air conditioning ?

     garagepl: number of garage places

     prefarea: is the house located in the preferred neighbourhood of the city ?

Source:

     Anglin, P.M.  and R.  Gencay (1996) ‚ÄúSemiparametric estimation of
     a hedonic price function‚Äù, _Journal of Applied Econometrics_,
     *11(6)*, 633-648.

References:

     Verbeek, Marno (2004) _A Guide to Modern Econometrics_, John Wiley
     and Sons, chapter 3.

     Journal of Applied Econometrics data archive : &lt;URL:
     http://qed.econ.queensu.ca/jae/&gt;.

See Also:

     ‚ÄòIndex.Source‚Äô, ‚ÄòIndex.Economics‚Äô, ‚ÄòIndex.Econometrics‚Äô,
     ‚ÄòIndex.Observations‚Äô</code></pre>
<p>or by looking for <code>Housing</code> in the help pane of RStudio. Usually, you would take a look a the data
before doing any modeling:</p>
<div class="sourceCode" id="cb542"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb542-1" title="1"><span class="kw">glimpse</span>(Housing)</a></code></pre></div>
<pre><code>## Observations: 546
## Variables: 12
## $ price    &lt;dbl&gt; 42000, 38500, 49500, 60500, 61000, 66000, 66000, 6900...
## $ lotsize  &lt;dbl&gt; 5850, 4000, 3060, 6650, 6360, 4160, 3880, 4160, 4800,...
## $ bedrooms &lt;dbl&gt; 3, 2, 3, 3, 2, 3, 3, 3, 3, 3, 3, 2, 3, 3, 2, 2, 3, 4,...
## $ bathrms  &lt;dbl&gt; 1, 1, 1, 1, 1, 1, 2, 1, 1, 2, 2, 1, 1, 1, 1, 1, 1, 1,...
## $ stories  &lt;dbl&gt; 2, 1, 1, 2, 1, 1, 2, 3, 1, 4, 1, 1, 2, 1, 1, 1, 2, 3,...
## $ driveway &lt;fct&gt; yes, yes, yes, yes, yes, yes, yes, yes, yes, yes, yes...
## $ recroom  &lt;fct&gt; no, no, no, yes, no, yes, no, no, yes, yes, no, no, n...
## $ fullbase &lt;fct&gt; yes, no, no, no, no, yes, yes, no, yes, no, yes, no, ...
## $ gashw    &lt;fct&gt; no, no, no, no, no, no, no, no, no, no, no, no, no, n...
## $ airco    &lt;fct&gt; no, no, no, no, no, yes, no, no, no, yes, yes, no, no...
## $ garagepl &lt;dbl&gt; 1, 0, 0, 0, 0, 0, 2, 0, 0, 1, 3, 0, 0, 0, 0, 0, 1, 0,...
## $ prefarea &lt;fct&gt; no, no, no, no, no, no, no, no, no, no, no, no, no, n...</code></pre>
<p>Housing prices depend on a set of variables such as the number of bedrooms, the area it is located
and so on. If you believe that housing prices depend linearly on a set of explanatory variables,
you will want to estimate a linear model. To estimate a <em>linear model</em>, you will need to use the
built-in <code>lm()</code> function:</p>
<div class="sourceCode" id="cb544"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb544-1" title="1">model1 &lt;-<span class="st"> </span><span class="kw">lm</span>(price <span class="op">~</span><span class="st"> </span>lotsize <span class="op">+</span><span class="st"> </span>bedrooms, <span class="dt">data =</span> Housing)</a></code></pre></div>
<p><code>lm()</code> takes a formula as an argument, which defines the model you want to estimate. In this case,
I ran the following regression:</p>
<p><span class="math display">\[
\text{price} = \beta_0 + \beta_1 * \text{lotsize} + \beta_2 * \text{bedrooms} + \varepsilon
\]</span></p>
<p>where <span class="math inline">\(\beta_0, \beta_1\)</span> and <span class="math inline">\(\beta_2\)</span> are three parameters to estimate. To take a look at the
results, you can use the <code>summary()</code> method (not to be confused with <code>dplyr::summarise()</code>:</p>
<div class="sourceCode" id="cb545"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb545-1" title="1"><span class="kw">summary</span>(model1)</a></code></pre></div>
<pre><code>## 
## Call:
## lm(formula = price ~ lotsize + bedrooms, data = Housing)
## 
## Residuals:
##    Min     1Q Median     3Q    Max 
## -65665 -12498  -2075   8970  97205 
## 
## Coefficients:
##              Estimate Std. Error t value Pr(&gt;|t|)    
## (Intercept) 5.613e+03  4.103e+03   1.368    0.172    
## lotsize     6.053e+00  4.243e-01  14.265  &lt; 2e-16 ***
## bedrooms    1.057e+04  1.248e+03   8.470 2.31e-16 ***
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## Residual standard error: 21230 on 543 degrees of freedom
## Multiple R-squared:  0.3703, Adjusted R-squared:  0.3679 
## F-statistic: 159.6 on 2 and 543 DF,  p-value: &lt; 2.2e-16</code></pre>
<p>if you wish to remove the intercept (<span class="math inline">\(alpha\)</span>) from your model, you can do so with <code>-1</code>:</p>
<div class="sourceCode" id="cb547"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb547-1" title="1">model2 &lt;-<span class="st"> </span><span class="kw">lm</span>(price <span class="op">~</span><span class="st"> </span><span class="dv">-1</span> <span class="op">+</span><span class="st"> </span>lotsize <span class="op">+</span><span class="st"> </span>bedrooms, <span class="dt">data =</span> Housing)</a>
<a class="sourceLine" id="cb547-2" title="2"></a>
<a class="sourceLine" id="cb547-3" title="3"><span class="kw">summary</span>(model2)</a></code></pre></div>
<pre><code>## 
## Call:
## lm(formula = price ~ -1 + lotsize + bedrooms, data = Housing)
## 
## Residuals:
##    Min     1Q Median     3Q    Max 
## -67229 -12342  -1333   9627  95509 
## 
## Coefficients:
##           Estimate Std. Error t value Pr(&gt;|t|)    
## lotsize      6.283      0.390   16.11   &lt;2e-16 ***
## bedrooms 11968.362    713.194   16.78   &lt;2e-16 ***
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## Residual standard error: 21250 on 544 degrees of freedom
## Multiple R-squared:  0.916,  Adjusted R-squared:  0.9157 
## F-statistic:  2965 on 2 and 544 DF,  p-value: &lt; 2.2e-16</code></pre>
<p>or if you want to use all the columns inside <code>Housing</code>:</p>
<div class="sourceCode" id="cb549"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb549-1" title="1">model3 &lt;-<span class="st"> </span><span class="kw">lm</span>(price <span class="op">~</span><span class="st"> </span>., <span class="dt">data =</span> Housing)</a>
<a class="sourceLine" id="cb549-2" title="2"></a>
<a class="sourceLine" id="cb549-3" title="3"><span class="kw">summary</span>(model3)</a></code></pre></div>
<pre><code>## 
## Call:
## lm(formula = price ~ ., data = Housing)
## 
## Residuals:
##    Min     1Q Median     3Q    Max 
## -41389  -9307   -591   7353  74875 
## 
## Coefficients:
##               Estimate Std. Error t value Pr(&gt;|t|)    
## (Intercept) -4038.3504  3409.4713  -1.184 0.236762    
## lotsize         3.5463     0.3503  10.124  &lt; 2e-16 ***
## bedrooms     1832.0035  1047.0002   1.750 0.080733 .  
## bathrms     14335.5585  1489.9209   9.622  &lt; 2e-16 ***
## stories      6556.9457   925.2899   7.086 4.37e-12 ***
## drivewayyes  6687.7789  2045.2458   3.270 0.001145 ** 
## recroomyes   4511.2838  1899.9577   2.374 0.017929 *  
## fullbaseyes  5452.3855  1588.0239   3.433 0.000642 ***
## gashwyes    12831.4063  3217.5971   3.988 7.60e-05 ***
## aircoyes    12632.8904  1555.0211   8.124 3.15e-15 ***
## garagepl     4244.8290   840.5442   5.050 6.07e-07 ***
## prefareayes  9369.5132  1669.0907   5.614 3.19e-08 ***
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## Residual standard error: 15420 on 534 degrees of freedom
## Multiple R-squared:  0.6731, Adjusted R-squared:  0.6664 
## F-statistic: 99.97 on 11 and 534 DF,  p-value: &lt; 2.2e-16</code></pre>
<p>You can access different elements of <code>model3</code> (for example) with <code>$</code>, because the result of <code>lm()</code>
is a list:</p>
<div class="sourceCode" id="cb551"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb551-1" title="1"><span class="kw">print</span>(model3<span class="op">$</span>coefficients)</a></code></pre></div>
<pre><code>##  (Intercept)      lotsize     bedrooms      bathrms      stories 
## -4038.350425     3.546303  1832.003466 14335.558468  6556.945711 
##  drivewayyes   recroomyes  fullbaseyes     gashwyes     aircoyes 
##  6687.778890  4511.283826  5452.385539 12831.406266 12632.890405 
##     garagepl  prefareayes 
##  4244.829004  9369.513239</code></pre>
<p>but I prefer to use the <code>{broom}</code> package, and more specifically the <code>tidy()</code> function, which
converts <code>model3</code> into a neat <code>data.frame</code>:</p>
<div class="sourceCode" id="cb553"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb553-1" title="1">results3 &lt;-<span class="st"> </span>broom<span class="op">::</span><span class="kw">tidy</span>(model3)</a>
<a class="sourceLine" id="cb553-2" title="2"></a>
<a class="sourceLine" id="cb553-3" title="3"><span class="kw">glimpse</span>(results3)</a></code></pre></div>
<pre><code>## Observations: 12
## Variables: 5
## $ term      &lt;chr&gt; &quot;(Intercept)&quot;, &quot;lotsize&quot;, &quot;bedrooms&quot;, &quot;bathrms&quot;, &quot;st...
## $ estimate  &lt;dbl&gt; -4038.350425, 3.546303, 1832.003466, 14335.558468, 6...
## $ std.error &lt;dbl&gt; 3409.4713, 0.3503, 1047.0002, 1489.9209, 925.2899, 2...
## $ statistic &lt;dbl&gt; -1.184451, 10.123618, 1.749764, 9.621691, 7.086369, ...
## $ p.value   &lt;dbl&gt; 2.367616e-01, 3.732442e-22, 8.073341e-02, 2.570369e-...</code></pre>
<p>I explicitely write <code>broom::tidy()</code> because <code>tidy()</code> is a popular function name. For instance,
it is also a function from the <code>{yardstick}</code> package, which does not do the same thing at all. Since
I will also be using <code>{yardstick}</code> I prefer explicitely writing <code>broom::tidy()</code> to avoid conflicts.</p>
<p>Using <code>broom::tidy()</code> is useful, because you can then work on the results easily, for example if
you wish to only keep results that are significant at the 5% level:</p>
<div class="sourceCode" id="cb555"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb555-1" title="1">results3 <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb555-2" title="2"><span class="st">  </span><span class="kw">filter</span>(p.value <span class="op">&lt;</span><span class="st"> </span><span class="fl">0.05</span>)</a></code></pre></div>
<pre><code>## # A tibble: 10 x 5
##    term        estimate std.error statistic  p.value
##    &lt;chr&gt;          &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;
##  1 lotsize         3.55     0.350     10.1  3.73e-22
##  2 bathrms     14336.    1490.         9.62 2.57e-20
##  3 stories      6557.     925.         7.09 4.37e-12
##  4 drivewayyes  6688.    2045.         3.27 1.15e- 3
##  5 recroomyes   4511.    1900.         2.37 1.79e- 2
##  6 fullbaseyes  5452.    1588.         3.43 6.42e- 4
##  7 gashwyes    12831.    3218.         3.99 7.60e- 5
##  8 aircoyes    12633.    1555.         8.12 3.15e-15
##  9 garagepl     4245.     841.         5.05 6.07e- 7
## 10 prefareayes  9370.    1669.         5.61 3.19e- 8</code></pre>
<p>You can even add new columns, such as the confidence intervals:</p>
<div class="sourceCode" id="cb557"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb557-1" title="1">results3 &lt;-<span class="st"> </span>broom<span class="op">::</span><span class="kw">tidy</span>(model3, <span class="dt">conf.int =</span> <span class="ot">TRUE</span>, <span class="dt">conf.level =</span> <span class="fl">0.95</span>)</a>
<a class="sourceLine" id="cb557-2" title="2"></a>
<a class="sourceLine" id="cb557-3" title="3"><span class="kw">print</span>(results3)</a></code></pre></div>
<pre><code>## # A tibble: 12 x 7
##    term         estimate std.error statistic  p.value  conf.low conf.high
##    &lt;chr&gt;           &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;
##  1 (Intercept)  -4038.    3409.        -1.18 2.37e- 1 -10736.     2659.  
##  2 lotsize          3.55     0.350     10.1  3.73e-22      2.86      4.23
##  3 bedrooms      1832.    1047.         1.75 8.07e- 2   -225.     3889.  
##  4 bathrms      14336.    1490.         9.62 2.57e-20  11409.    17262.  
##  5 stories       6557.     925.         7.09 4.37e-12   4739.     8375.  
##  6 drivewayyes   6688.    2045.         3.27 1.15e- 3   2670.    10705.  
##  7 recroomyes    4511.    1900.         2.37 1.79e- 2    779.     8244.  
##  8 fullbaseyes   5452.    1588.         3.43 6.42e- 4   2333.     8572.  
##  9 gashwyes     12831.    3218.         3.99 7.60e- 5   6511.    19152.  
## 10 aircoyes     12633.    1555.         8.12 3.15e-15   9578.    15688.  
## 11 garagepl      4245.     841.         5.05 6.07e- 7   2594.     5896.  
## 12 prefareayes   9370.    1669.         5.61 3.19e- 8   6091.    12648.</code></pre>
<p>Going back to model estimation, you can of course use <code>lm()</code> in a pipe workflow:</p>
<div class="sourceCode" id="cb559"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb559-1" title="1">Housing <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb559-2" title="2"><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>driveway, <span class="op">-</span>stories) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb559-3" title="3"><span class="st">  </span><span class="kw">lm</span>(price <span class="op">~</span><span class="st"> </span>., <span class="dt">data =</span> .) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb559-4" title="4"><span class="st">  </span>broom<span class="op">::</span><span class="kw">tidy</span>()</a></code></pre></div>
<pre><code>## # A tibble: 10 x 5
##    term        estimate std.error statistic  p.value
##    &lt;chr&gt;          &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;
##  1 (Intercept)  3025.    3263.        0.927 3.54e- 1
##  2 lotsize         3.67     0.363    10.1   4.52e-22
##  3 bedrooms     4140.    1036.        3.99  7.38e- 5
##  4 bathrms     16443.    1546.       10.6   4.29e-24
##  5 recroomyes   5660.    2010.        2.82  5.05e- 3
##  6 fullbaseyes  2241.    1618.        1.38  1.67e- 1
##  7 gashwyes    13568.    3411.        3.98  7.93e- 5
##  8 aircoyes    15578.    1597.        9.75  8.53e-21
##  9 garagepl     4232.     883.        4.79  2.12e- 6
## 10 prefareayes 10729.    1753.        6.12  1.81e- 9</code></pre>
<p>The first <code>.</code> in the <code>lm()</code> function is used to indicate that we wish to use all the data from <code>Housing</code>
(minus <code>driveway</code> and <code>stories</code> which I removed using <code>select()</code> and the <code>-</code> sign), and the second <code>.</code> is
used to <em>place</em> the result from the two <code>dplyr</code> instructions that preceded is to be placed there.
The picture below should help you understand:</p>
<div class="sourceCode" id="cb561"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb561-1" title="1">knitr<span class="op">::</span><span class="kw">include_graphics</span>(<span class="st">&quot;pics/pipe_to_second_position.png&quot;</span>)</a></code></pre></div>
<p><img src="pics/pipe_to_second_position.png" width="288" /></p>
<p>You have to specify this, because by default, when using <code>%&gt;%</code> the left hand side argument gets
passed as the first argument of the function on the right hand side.</p>
</div>
<div id="diagnostics" class="section level2">
<h2><span class="header-section-number">7.3</span> Diagnostics</h2>
<p>Diagnostics are useful metrics to assess model fit. You can read some of these diagnostics, such as
the <span class="math inline">\(R^2\)</span> at the bottom of the summary (when running <code>summary(my_model)</code>), but if you want to do
more than simply reading these diagnostics from RStudio, you can put those in a <code>data.frame</code> too,
using <code>broom::glance()</code>:</p>
<div class="sourceCode" id="cb562"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb562-1" title="1"><span class="kw">glance</span>(model3)</a></code></pre></div>
<pre><code>## # A tibble: 1 x 11
##   r.squared adj.r.squared  sigma statistic   p.value    df logLik    AIC
## *     &lt;dbl&gt;         &lt;dbl&gt;  &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt; &lt;int&gt;  &lt;dbl&gt;  &lt;dbl&gt;
## 1     0.673         0.666 15423.     100.0 6.18e-122    12 -6034. 12094.
## # ... with 3 more variables: BIC &lt;dbl&gt;, deviance &lt;dbl&gt;, df.residual &lt;int&gt;</code></pre>
<p>You can also plot the usual diagnostics plots using <code>ggfortify::autoplot()</code> which uses the
<code>ggplot2</code> package under the hood:</p>
<div class="sourceCode" id="cb564"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb564-1" title="1"><span class="kw">library</span>(ggfortify)</a>
<a class="sourceLine" id="cb564-2" title="2"></a>
<a class="sourceLine" id="cb564-3" title="3"><span class="kw">autoplot</span>(model3, <span class="dt">which =</span> <span class="dv">1</span><span class="op">:</span><span class="dv">6</span>) <span class="op">+</span><span class="st"> </span><span class="kw">theme_minimal</span>()</a></code></pre></div>
<p><img src="modern_R_files/figure-html/unnamed-chunk-365-1.png" width="672" /></p>
<p><code>which=1:6</code> is an additional option that shows you all the diagnostics plot. If you omit this
option, you will only get 4 of them.</p>
<p>You can also get the residuals of the regression in two ways; either you grab them directly from
the model fit:</p>
<div class="sourceCode" id="cb565"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb565-1" title="1">resi3 &lt;-<span class="st"> </span><span class="kw">residuals</span>(model3)</a></code></pre></div>
<p>or you can augment the original data with a residuals column, using <code>broom::augment()</code>:</p>
<div class="sourceCode" id="cb566"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb566-1" title="1">housing_aug &lt;-<span class="st"> </span><span class="kw">augment</span>(model3)</a></code></pre></div>
<p>Let‚Äôs take a look at <code>housing_aug</code>:</p>
<div class="sourceCode" id="cb567"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb567-1" title="1"><span class="kw">glimpse</span>(housing_aug)</a></code></pre></div>
<pre><code>## Observations: 546
## Variables: 19
## $ price      &lt;dbl&gt; 42000, 38500, 49500, 60500, 61000, 66000, 66000, 69...
## $ lotsize    &lt;dbl&gt; 5850, 4000, 3060, 6650, 6360, 4160, 3880, 4160, 480...
## $ bedrooms   &lt;dbl&gt; 3, 2, 3, 3, 2, 3, 3, 3, 3, 3, 3, 2, 3, 3, 2, 2, 3, ...
## $ bathrms    &lt;dbl&gt; 1, 1, 1, 1, 1, 1, 2, 1, 1, 2, 2, 1, 1, 1, 1, 1, 1, ...
## $ stories    &lt;dbl&gt; 2, 1, 1, 2, 1, 1, 2, 3, 1, 4, 1, 1, 2, 1, 1, 1, 2, ...
## $ driveway   &lt;fct&gt; yes, yes, yes, yes, yes, yes, yes, yes, yes, yes, y...
## $ recroom    &lt;fct&gt; no, no, no, yes, no, yes, no, no, yes, yes, no, no,...
## $ fullbase   &lt;fct&gt; yes, no, no, no, no, yes, yes, no, yes, no, yes, no...
## $ gashw      &lt;fct&gt; no, no, no, no, no, no, no, no, no, no, no, no, no,...
## $ airco      &lt;fct&gt; no, no, no, no, no, yes, no, no, no, yes, yes, no, ...
## $ garagepl   &lt;dbl&gt; 1, 0, 0, 0, 0, 0, 2, 0, 0, 1, 3, 0, 0, 0, 0, 0, 1, ...
## $ prefarea   &lt;fct&gt; no, no, no, no, no, no, no, no, no, no, no, no, no,...
## $ .fitted    &lt;dbl&gt; 66037.98, 41391.15, 39889.63, 63689.09, 49760.43, 6...
## $ .se.fit    &lt;dbl&gt; 1790.507, 1406.500, 1534.102, 2262.056, 1567.689, 2...
## $ .resid     &lt;dbl&gt; -24037.9757, -2891.1515, 9610.3699, -3189.0873, 112...
## $ .hat       &lt;dbl&gt; 0.013477335, 0.008316321, 0.009893730, 0.021510891,...
## $ .sigma     &lt;dbl&gt; 15402.01, 15437.14, 15431.98, 15437.02, 15429.89, 1...
## $ .cooksd    &lt;dbl&gt; 2.803214e-03, 2.476265e-05, 3.265481e-04, 8.004787e...
## $ .std.resid &lt;dbl&gt; -1.56917096, -0.18823924, 0.62621736, -0.20903274, ...</code></pre>
<p>A few columns have been added to the original data, among them <code>.resid</code> which contains the
residuals. Let‚Äôs plot them:</p>
<div class="sourceCode" id="cb569"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb569-1" title="1"><span class="kw">ggplot</span>(housing_aug) <span class="op">+</span></a>
<a class="sourceLine" id="cb569-2" title="2"><span class="st">  </span><span class="kw">geom_density</span>(<span class="kw">aes</span>(.resid))</a></code></pre></div>
<p><img src="modern_R_files/figure-html/unnamed-chunk-370-1.png" width="672" /></p>
<p>Fitted values are also added to the original data, under the variable <code>.fitted</code>. It would also have
been possible to get the fitted values with:</p>
<div class="sourceCode" id="cb570"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb570-1" title="1">fit3 &lt;-<span class="st"> </span><span class="kw">fitted</span>(model3)</a></code></pre></div>
<p>but I prefer using <code>augment()</code>, because the columns get merged to the original data, which then
makes it easier to find specific individuals, for example, you might want to know for which housing
units the model underestimates the price:</p>
<div class="sourceCode" id="cb571"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb571-1" title="1">total_pos &lt;-<span class="st"> </span>housing_aug <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb571-2" title="2"><span class="st">  </span><span class="kw">filter</span>(.resid <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb571-3" title="3"><span class="st">  </span><span class="kw">summarise</span>(<span class="dt">total =</span> <span class="kw">n</span>()) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb571-4" title="4"><span class="st">  </span><span class="kw">pull</span>(total)</a></code></pre></div>
<p>we find 261 individuals where the residuals are positive. It is also easier to
extract outliers:</p>
<div class="sourceCode" id="cb572"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb572-1" title="1">housing_aug <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb572-2" title="2"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">prank =</span> <span class="kw">cume_dist</span>(.cooksd)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb572-3" title="3"><span class="st">  </span><span class="kw">filter</span>(prank <span class="op">&gt;</span><span class="st"> </span><span class="fl">0.99</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb572-4" title="4"><span class="st">  </span><span class="kw">glimpse</span>()</a></code></pre></div>
<pre><code>## Observations: 6
## Variables: 20
## $ price      &lt;dbl&gt; 163000, 125000, 132000, 175000, 190000, 174500
## $ lotsize    &lt;dbl&gt; 7420, 4320, 3500, 9960, 7420, 7500
## $ bedrooms   &lt;dbl&gt; 4, 3, 4, 3, 4, 4
## $ bathrms    &lt;dbl&gt; 1, 1, 2, 2, 2, 2
## $ stories    &lt;dbl&gt; 2, 2, 2, 2, 3, 2
## $ driveway   &lt;fct&gt; yes, yes, yes, yes, yes, yes
## $ recroom    &lt;fct&gt; yes, no, no, no, no, no
## $ fullbase   &lt;fct&gt; yes, yes, no, yes, no, yes
## $ gashw      &lt;fct&gt; no, yes, yes, no, no, no
## $ airco      &lt;fct&gt; yes, no, no, no, yes, yes
## $ garagepl   &lt;dbl&gt; 2, 2, 2, 2, 2, 3
## $ prefarea   &lt;fct&gt; no, no, no, yes, yes, yes
## $ .fitted    &lt;dbl&gt; 94826.68, 77688.37, 85495.58, 108563.18, 115125.03,...
## $ .se.fit    &lt;dbl&gt; 2520.691, 3551.954, 3544.961, 2589.680, 2185.603, 2...
## $ .resid     &lt;dbl&gt; 68173.32, 47311.63, 46504.42, 66436.82, 74874.97, 5...
## $ .hat       &lt;dbl&gt; 0.02671105, 0.05303793, 0.05282929, 0.02819317, 0.0...
## $ .sigma     &lt;dbl&gt; 15144.70, 15293.34, 15298.27, 15159.14, 15085.99, 1...
## $ .cooksd    &lt;dbl&gt; 0.04590995, 0.04637969, 0.04461464, 0.04616068, 0.0...
## $ .std.resid &lt;dbl&gt; 4.480428, 3.152300, 3.098176, 4.369631, 4.904193, 3...
## $ prank      &lt;dbl&gt; 0.9963370, 1.0000000, 0.9945055, 0.9981685, 0.99267...</code></pre>
<p><code>prank</code> is a variable I created with <code>cume_dist()</code> which is a <code>dplyr</code> function that returns the
proportion of all values less than or equal to the current rank. For example:</p>
<div class="sourceCode" id="cb574"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb574-1" title="1">example &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dv">5</span>, <span class="fl">4.6</span>, <span class="dv">2</span>, <span class="dv">1</span>, <span class="fl">0.8</span>, <span class="dv">0</span>, <span class="dv">-1</span>)</a>
<a class="sourceLine" id="cb574-2" title="2"><span class="kw">cume_dist</span>(example)</a></code></pre></div>
<pre><code>## [1] 1.0000000 0.8571429 0.7142857 0.5714286 0.4285714 0.2857143 0.1428571</code></pre>
<p>by filtering <code>prank &gt; 0.99</code> we get the top 1% of outliers according to Cook‚Äôs distance.</p>
</div>
<div id="interpreting-models" class="section level2">
<h2><span class="header-section-number">7.4</span> Interpreting models</h2>
<p>Model interpretation is essential in the social sciences. If one wants to know the effect of
variable <code>x</code> on the dependent variable <code>y</code>, marginal effects have to be computed. This is easily
done in R with the <code>{margins}</code> package, which aims to provide the same functionality as the
<code>margins</code> command in STATA:</p>
<div class="sourceCode" id="cb576"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb576-1" title="1"><span class="kw">library</span>(margins)</a>
<a class="sourceLine" id="cb576-2" title="2"></a>
<a class="sourceLine" id="cb576-3" title="3">effects_model3 &lt;-<span class="st"> </span><span class="kw">margins</span>(model3)</a>
<a class="sourceLine" id="cb576-4" title="4"></a>
<a class="sourceLine" id="cb576-5" title="5"><span class="kw">summary</span>(effects_model3)</a></code></pre></div>
<pre><code>##       factor        AME        SE       z      p      lower      upper
##     aircoyes 12632.8904 1555.0329  8.1239 0.0000  9585.0819 15680.6989
##      bathrms 14335.5585 1482.9885  9.6667 0.0000 11428.9545 17242.1624
##     bedrooms  1832.0035 1045.6558  1.7520 0.0798  -217.4442  3881.4512
##  drivewayyes  6687.7789 2045.2636  3.2699 0.0011  2679.1359 10696.4219
##  fullbaseyes  5452.3855 1587.9782  3.4335 0.0006  2340.0054  8564.7657
##     garagepl  4244.8290  847.2173  5.0103 0.0000  2584.3136  5905.3444
##     gashwyes 12831.4063 3217.6211  3.9879 0.0001  6524.9848 19137.8277
##      lotsize     3.5463    0.3503 10.1250 0.0000     2.8598     4.2328
##  prefareayes  9369.5132 1669.1034  5.6135 0.0000  6098.1307 12640.8957
##   recroomyes  4511.2838 1899.9255  2.3745 0.0176   787.4982  8235.0694
##      stories  6556.9457  924.4211  7.0930 0.0000  4745.1137  8368.7777</code></pre>
<p>It is also possible to plot the results:</p>
<div class="sourceCode" id="cb578"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb578-1" title="1"><span class="kw">plot</span>(effects_model3)</a></code></pre></div>
<p><img src="modern_R_files/figure-html/unnamed-chunk-376-1.png" width="672" /></p>
<p>This uses the basic R plotting capabilities, which is useful because it is a simple call to the
function <code>plot()</code> but if you‚Äôve been using <code>ggplot2</code> and want this graph to have the same feel as
the others made with <code>ggplot2</code> you first need to save the summary in a variable.
<code>summary(effects_model3)</code> is a <code>data.frame</code> with many more details. Let‚Äôs overwrite this
<code>effects_model3</code> with its summary:</p>
<div class="sourceCode" id="cb579"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb579-1" title="1">effects_model3 &lt;-<span class="st"> </span><span class="kw">summary</span>(effects_model3)</a></code></pre></div>
<p>And now it is possible to use <code>ggplot2</code> to have the same plot:</p>
<div class="sourceCode" id="cb580"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb580-1" title="1"><span class="kw">ggplot</span>(<span class="dt">data =</span> effects_model3) <span class="op">+</span></a>
<a class="sourceLine" id="cb580-2" title="2"><span class="st">  </span><span class="kw">geom_point</span>(<span class="kw">aes</span>(factor, AME)) <span class="op">+</span></a>
<a class="sourceLine" id="cb580-3" title="3"><span class="st">  </span><span class="kw">geom_errorbar</span>(<span class="kw">aes</span>(<span class="dt">x =</span> factor, <span class="dt">ymin =</span> lower, <span class="dt">ymax =</span> upper)) <span class="op">+</span></a>
<a class="sourceLine" id="cb580-4" title="4"><span class="st">  </span><span class="kw">geom_hline</span>(<span class="dt">yintercept =</span> <span class="dv">0</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb580-5" title="5"><span class="st">  </span><span class="kw">theme_minimal</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb580-6" title="6"><span class="st">  </span><span class="kw">theme</span>(<span class="dt">axis.text.x =</span> <span class="kw">element_text</span>(<span class="dt">angle =</span> <span class="dv">45</span>))</a></code></pre></div>
<p><img src="modern_R_files/figure-html/unnamed-chunk-378-1.png" width="672" /></p>
<p>Of course for <code>model3</code>, the marginal effects are the same as the coefficients, so let‚Äôs estimate a
logit model and compute the marginal effects. Logit models can be estimated using the <code>glm()</code> function.
As an example, we are going to use the <code>Participation</code> data, also from the <code>Ecdat</code> package:</p>
<div class="sourceCode" id="cb581"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb581-1" title="1"><span class="kw">data</span>(Participation)</a></code></pre></div>
<div class="sourceCode" id="cb582"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb582-1" title="1">?Particpation</a></code></pre></div>
<pre><code>Participation              package:Ecdat               R Documentation

Labor Force Participation

Description:

     a cross-section

     _number of observations_ : 872

     _observation_ : individuals

     _country_ : Switzerland

Usage:

     data(Participation)

Format:

     A dataframe containing :

     lfp labour force participation ?

     lnnlinc the log of nonlabour income

     age age in years divided by 10

     educ years of formal education

     nyc the number of young children (younger than 7)

     noc number of older children

     foreign foreigner ?

Source:

     Gerfin, Michael (1996) ‚ÄúParametric and semiparametric estimation
     of the binary response‚Äù, _Journal of Applied Econometrics_,
     *11(3)*, 321-340.

References:

     Davidson, R.  and James G.  MacKinnon (2004) _Econometric Theory
     and Methods_, New York, Oxford University Press, &lt;URL:
     http://www.econ.queensu.ca/ETM/&gt;, chapter 11.

     Journal of Applied Econometrics data archive : &lt;URL:
     http://qed.econ.queensu.ca/jae/&gt;.

See Also:

     ‚ÄòIndex.Source‚Äô, ‚ÄòIndex.Economics‚Äô, ‚ÄòIndex.Econometrics‚Äô,
     ‚ÄòIndex.Observations‚Äô</code></pre>
<p>The variable of interest is lfp: whether the individual participates in the labour force. To know
which variables are relevant in the decision to participate in the labour force, one could estimate
a logit model, using glm().</p>
<div class="sourceCode" id="cb584"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb584-1" title="1">logit_participation &lt;-<span class="st"> </span><span class="kw">glm</span>(lfp <span class="op">~</span><span class="st"> </span>., <span class="dt">data =</span> Participation, <span class="dt">family =</span> <span class="st">&quot;binomial&quot;</span>)</a>
<a class="sourceLine" id="cb584-2" title="2"></a>
<a class="sourceLine" id="cb584-3" title="3">broom<span class="op">::</span><span class="kw">tidy</span>(logit_participation)</a></code></pre></div>
<pre><code>## # A tibble: 7 x 5
##   term        estimate std.error statistic  p.value
##   &lt;chr&gt;          &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;
## 1 (Intercept)  10.4       2.17       4.79  1.69e- 6
## 2 lnnlinc      -0.815     0.206     -3.97  7.31e- 5
## 3 age          -0.510     0.0905    -5.64  1.72e- 8
## 4 educ          0.0317    0.0290     1.09  2.75e- 1
## 5 nyc          -1.33      0.180     -7.39  1.51e-13
## 6 noc          -0.0220    0.0738    -0.298 7.66e- 1
## 7 foreignyes    1.31      0.200      6.56  5.38e-11</code></pre>
<p>From the results above, one can only interpret the sign of the coefficients. To know how much a
variable influences the labour force participation, one has to use <code>margins()</code>:</p>
<div class="sourceCode" id="cb586"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb586-1" title="1">effects_logit_participation &lt;-<span class="st"> </span><span class="kw">margins</span>(logit_participation) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb586-2" title="2"><span class="st">  </span><span class="kw">summary</span>()</a>
<a class="sourceLine" id="cb586-3" title="3"></a>
<a class="sourceLine" id="cb586-4" title="4"><span class="kw">print</span>(effects_logit_participation)</a></code></pre></div>
<pre><code>##      factor     AME     SE       z      p   lower   upper
##         age -0.1064 0.0176 -6.0494 0.0000 -0.1409 -0.0719
##        educ  0.0066 0.0060  1.0955 0.2733 -0.0052  0.0185
##  foreignyes  0.2834 0.0399  7.1102 0.0000  0.2053  0.3615
##     lnnlinc -0.1699 0.0415 -4.0994 0.0000 -0.2512 -0.0887
##         noc -0.0046 0.0154 -0.2981 0.7656 -0.0347  0.0256
##         nyc -0.2775 0.0333 -8.3433 0.0000 -0.3426 -0.2123</code></pre>
<p>We can use the previous code to plot the marginal effects:</p>
<div class="sourceCode" id="cb588"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb588-1" title="1"><span class="kw">ggplot</span>(<span class="dt">data =</span> effects_logit_participation) <span class="op">+</span></a>
<a class="sourceLine" id="cb588-2" title="2"><span class="st">  </span><span class="kw">geom_point</span>(<span class="kw">aes</span>(factor, AME)) <span class="op">+</span></a>
<a class="sourceLine" id="cb588-3" title="3"><span class="st">  </span><span class="kw">geom_errorbar</span>(<span class="kw">aes</span>(<span class="dt">x =</span> factor, <span class="dt">ymin =</span> lower, <span class="dt">ymax =</span> upper)) <span class="op">+</span></a>
<a class="sourceLine" id="cb588-4" title="4"><span class="st">  </span><span class="kw">geom_hline</span>(<span class="dt">yintercept =</span> <span class="dv">0</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb588-5" title="5"><span class="st">  </span><span class="kw">theme_minimal</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb588-6" title="6"><span class="st">  </span><span class="kw">theme</span>(<span class="dt">axis.text.x =</span> <span class="kw">element_text</span>(<span class="dt">angle =</span> <span class="dv">45</span>))</a></code></pre></div>
<p><img src="modern_R_files/figure-html/unnamed-chunk-383-1.png" width="672" /></p>
<p>So an infinitesimal increase, in say, non-labour income (lnnlinc) of 0.001 is associated with a
decrease of the probability of labour force participation by 0.001*17 percentage points.</p>
<p>You can also extract the marginal effects of a single variable:</p>
<div class="sourceCode" id="cb589"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb589-1" title="1"><span class="kw">head</span>(<span class="kw">dydx</span>(Participation, logit_participation, <span class="st">&quot;lnnlinc&quot;</span>))</a></code></pre></div>
<pre><code>##   dydx_lnnlinc
## 1  -0.15667764
## 2  -0.20014487
## 3  -0.18495109
## 4  -0.05377262
## 5  -0.18710476
## 6  -0.19586986</code></pre>
<p>Which makes it possible to extract the effect for a list of individuals that you can create yourself:</p>
<div class="sourceCode" id="cb591"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb591-1" title="1">my_subjects =<span class="st"> </span><span class="kw">tribble</span>(</a>
<a class="sourceLine" id="cb591-2" title="2">    <span class="op">~</span>lfp,  <span class="op">~</span>lnnlinc, <span class="op">~</span>age, <span class="op">~</span>educ, <span class="op">~</span>nyc, <span class="op">~</span>noc, <span class="op">~</span>foreign,</a>
<a class="sourceLine" id="cb591-3" title="3">    <span class="st">&quot;yes&quot;</span>,   <span class="fl">10.780</span>,  <span class="fl">7.0</span>,     <span class="dv">4</span>,    <span class="dv">1</span>,   <span class="dv">1</span>,     <span class="st">&quot;yes&quot;</span>,</a>
<a class="sourceLine" id="cb591-4" title="4">     <span class="st">&quot;no&quot;</span>,     <span class="fl">1.30</span>,  <span class="fl">9.0</span>,     <span class="dv">1</span>,    <span class="dv">4</span>,   <span class="dv">1</span>,     <span class="st">&quot;yes&quot;</span></a>
<a class="sourceLine" id="cb591-5" title="5">)</a>
<a class="sourceLine" id="cb591-6" title="6"></a>
<a class="sourceLine" id="cb591-7" title="7"><span class="kw">dydx</span>(my_subjects, logit_participation, <span class="st">&quot;lnnlinc&quot;</span>)</a></code></pre></div>
<pre><code>##   dydx_lnnlinc
## 1  -0.09228119
## 2  -0.17953451</code></pre>
<p>I used the <code>tribble()</code> function from the tibble package to create this test data set, row by row.
Then, using <code>dydx()</code>, I get the marginal effect of variable <code>lnnlinc</code> for these two individuals.</p>
</div>
<div id="comparing-models" class="section level2">
<h2><span class="header-section-number">7.5</span> Comparing models</h2>
<p>Let‚Äôs estimate another model on the same data; prices are only positive, so a linear regression
might not be the best model, because the model could predict negative prices. Let‚Äôs look at the
distribution of prices:</p>
<div class="sourceCode" id="cb593"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb593-1" title="1"><span class="kw">ggplot</span>(Housing) <span class="op">+</span></a>
<a class="sourceLine" id="cb593-2" title="2"><span class="st">  </span><span class="kw">geom_density</span>(<span class="kw">aes</span>(price))</a></code></pre></div>
<p><img src="modern_R_files/figure-html/unnamed-chunk-386-1.png" width="672" /></p>
<p>it looks like modeling the log of <code>price</code> might provide a better fit:</p>
<div class="sourceCode" id="cb594"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb594-1" title="1">model_log &lt;-<span class="st"> </span><span class="kw">lm</span>(<span class="kw">log</span>(price) <span class="op">~</span><span class="st"> </span>., <span class="dt">data =</span> Housing)</a>
<a class="sourceLine" id="cb594-2" title="2"></a>
<a class="sourceLine" id="cb594-3" title="3">result_log &lt;-<span class="st"> </span>broom<span class="op">::</span><span class="kw">tidy</span>(model_log)</a>
<a class="sourceLine" id="cb594-4" title="4"></a>
<a class="sourceLine" id="cb594-5" title="5"><span class="kw">print</span>(result_log)</a></code></pre></div>
<pre><code>## # A tibble: 12 x 5
##    term          estimate  std.error statistic  p.value
##    &lt;chr&gt;            &lt;dbl&gt;      &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;
##  1 (Intercept) 10.0       0.0472        212.   0.      
##  2 lotsize      0.0000506 0.00000485     10.4  2.91e-23
##  3 bedrooms     0.0340    0.0145          2.34 1.94e- 2
##  4 bathrms      0.168     0.0206          8.13 3.10e-15
##  5 stories      0.0923    0.0128          7.20 2.10e-12
##  6 drivewayyes  0.131     0.0283          4.61 5.04e- 6
##  7 recroomyes   0.0735    0.0263          2.79 5.42e- 3
##  8 fullbaseyes  0.0994    0.0220          4.52 7.72e- 6
##  9 gashwyes     0.178     0.0446          4.00 7.22e- 5
## 10 aircoyes     0.178     0.0215          8.26 1.14e-15
## 11 garagepl     0.0508    0.0116          4.36 1.58e- 5
## 12 prefareayes  0.127     0.0231          5.50 6.02e- 8</code></pre>
<p>Let‚Äôs take a look at the diagnostics:</p>
<div class="sourceCode" id="cb596"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb596-1" title="1"><span class="kw">glance</span>(model_log)</a></code></pre></div>
<pre><code>## # A tibble: 1 x 11
##   r.squared adj.r.squared sigma statistic   p.value    df logLik   AIC
## *     &lt;dbl&gt;         &lt;dbl&gt; &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt; &lt;int&gt;  &lt;dbl&gt; &lt;dbl&gt;
## 1     0.677         0.670 0.214      102. 3.67e-123    12   73.9 -122.
## # ... with 3 more variables: BIC &lt;dbl&gt;, deviance &lt;dbl&gt;, df.residual &lt;int&gt;</code></pre>
<p>Let‚Äôs compare these to the ones from the previous model:</p>
<div class="sourceCode" id="cb598"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb598-1" title="1">diag_lm &lt;-<span class="st"> </span><span class="kw">glance</span>(model3)</a>
<a class="sourceLine" id="cb598-2" title="2"></a>
<a class="sourceLine" id="cb598-3" title="3">diag_lm &lt;-<span class="st"> </span>diag_lm <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb598-4" title="4"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">model =</span> <span class="st">&quot;lin-lin model&quot;</span>)</a>
<a class="sourceLine" id="cb598-5" title="5"></a>
<a class="sourceLine" id="cb598-6" title="6">diag_log &lt;-<span class="st"> </span><span class="kw">glance</span>(model_log)</a>
<a class="sourceLine" id="cb598-7" title="7"></a>
<a class="sourceLine" id="cb598-8" title="8">diag_log  &lt;-<span class="st"> </span>diag_log <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb598-9" title="9"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">model =</span> <span class="st">&quot;log-lin model&quot;</span>)</a>
<a class="sourceLine" id="cb598-10" title="10"></a>
<a class="sourceLine" id="cb598-11" title="11">diagnostics_models &lt;-<span class="st"> </span><span class="kw">full_join</span>(diag_lm, diag_log)</a></code></pre></div>
<pre><code>## Joining, by = c(&quot;r.squared&quot;, &quot;adj.r.squared&quot;, &quot;sigma&quot;, &quot;statistic&quot;, &quot;p.value&quot;, &quot;df&quot;, &quot;logLik&quot;, &quot;AIC&quot;, &quot;BIC&quot;, &quot;deviance&quot;, &quot;df.residual&quot;, &quot;model&quot;)</code></pre>
<div class="sourceCode" id="cb600"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb600-1" title="1"><span class="kw">print</span>(diagnostics_models)</a></code></pre></div>
<pre><code>## # A tibble: 2 x 12
##   r.squared adj.r.squared   sigma statistic   p.value    df  logLik     AIC
##       &lt;dbl&gt;         &lt;dbl&gt;   &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt; &lt;int&gt;   &lt;dbl&gt;   &lt;dbl&gt;
## 1     0.673         0.666 1.54e+4     100.0 6.18e-122    12 -6034.   12094.
## 2     0.677         0.670 2.14e-1     102.  3.67e-123    12    73.9   -122.
## # ... with 4 more variables: BIC &lt;dbl&gt;, deviance &lt;dbl&gt;, df.residual &lt;int&gt;,
## #   model &lt;chr&gt;</code></pre>
<p>I saved the diagnostics in two different <code>data.frame</code> objects using the <code>glance()</code> function and added a
<code>model</code> column to indicate which model the diagnostics come from. Then I merged both datasets using
<code>full_join()</code>, a <code>{dplyr}</code> function.</p>
<p>As you can see, the model with the logarithm of the prices as the dependent variable has a higher
likelihood (and thus lower AIC and BIC) than the simple linear model. Let‚Äôs take a look at the
diagnostics plots:</p>
<div class="sourceCode" id="cb602"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb602-1" title="1"><span class="kw">autoplot</span>(model_log, <span class="dt">which =</span> <span class="dv">1</span><span class="op">:</span><span class="dv">6</span>) <span class="op">+</span><span class="st"> </span><span class="kw">theme_minimal</span>()</a></code></pre></div>
<p><img src="modern_R_files/figure-html/unnamed-chunk-391-1.png" width="672" /></p>
</div>
<div id="using-a-model-for-prediction" class="section level2">
<h2><span class="header-section-number">7.6</span> Using a model for prediction</h2>
<p>Once you estimated a model, you might want to use it for prediction. This is easily done using the
<code>predict()</code> function that works with most models. Prediction is also useful as a way to test the
accuracy of your model: split your data into a training set (used for estimation) and a testing
set (used for the pseudo-prediction) and see if your model overfits the data. We are going to see
how to do that in a later section; for now, let‚Äôs just get acquainted with <code>predict()</code> and other
functions. I insist, keep in mind that this section is only to get acquainted with these functions.
We are going to explore prediction, overfitting and tuning of models in a later section.</p>
<p>Let‚Äôs go back to the models we estimated in the previous section, <code>model3</code> and <code>model_log</code>. Let‚Äôs also
take a subsample of data, which we will be using for prediction:</p>
<div class="sourceCode" id="cb603"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb603-1" title="1"><span class="kw">set.seed</span>(<span class="dv">1234</span>)</a>
<a class="sourceLine" id="cb603-2" title="2"></a>
<a class="sourceLine" id="cb603-3" title="3">pred_set &lt;-<span class="st"> </span>Housing <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb603-4" title="4"><span class="st">  </span><span class="kw">sample_n</span>(<span class="dv">20</span>)</a></code></pre></div>
<p>so that we get always the same <code>pred_set</code> I set the random seed first. Let‚Äôs take a look at the
data:</p>
<div class="sourceCode" id="cb604"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb604-1" title="1"><span class="kw">print</span>(pred_set)</a></code></pre></div>
<pre><code>##      price lotsize bedrooms bathrms stories driveway recroom fullbase
## 63   52000    4280        2       1       1      yes      no       no
## 340  62500    3900        3       1       2      yes      no       no
## 332 175000    8960        4       4       4      yes      no       no
## 339 141000    8100        4       1       2      yes     yes      yes
## 467  54000    2856        3       1       3      yes      no       no
## 347  52000    4130        3       2       2      yes      no       no
## 6    66000    4160        3       1       1      yes     yes      yes
## 126  95000    4260        4       2       2      yes      no       no
## 359  97000   12090        4       2       2      yes      no       no
## 277  70000    6300        3       1       1      yes      no       no
## 372  85000    6420        3       1       1      yes      no      yes
## 292  39000    4000        3       1       2      yes      no       no
## 151  59900    3450        3       1       2      yes      no       no
## 493  53000    4050        2       1       1      yes      no       no
## 156  60000    2610        4       3       2       no      no       no
## 445  72500    5720        2       1       2      yes      no       no
## 152  35500    3000        3       1       2       no      no       no
## 142  40000    2650        3       1       2      yes      no      yes
## 99   35000    3500        2       1       1      yes     yes       no
## 123  37000    4400        2       1       1      yes      no       no
##     gashw airco garagepl prefarea
## 63     no   yes        2       no
## 340    no    no        0       no
## 332    no   yes        3       no
## 339    no   yes        2      yes
## 467    no    no        0      yes
## 347    no    no        2       no
## 6      no   yes        0       no
## 126   yes    no        0       no
## 359    no    no        2      yes
## 277    no   yes        2       no
## 372    no   yes        0      yes
## 292    no    no        1       no
## 151    no    no        1       no
## 493    no    no        0       no
## 156    no    no        0       no
## 445    no   yes        0      yes
## 152    no    no        0       no
## 142    no    no        1       no
## 99     no    no        0       no
## 123    no    no        0       no</code></pre>
<p>If we wish to use it for prediction, this is easily done with <code>predict()</code>:</p>
<div class="sourceCode" id="cb606"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb606-1" title="1"><span class="kw">predict</span>(model3, pred_set)</a></code></pre></div>
<pre><code>##        63       340       332       339       467       347         6 
##  63506.66  49425.47 150689.71 106607.68  61649.59  73066.34  66387.12 
##       126       359       277       372       292       151       493 
##  79701.11 112496.42  72502.20  79260.00  54024.93  52074.46  41568.47 
##       156       445       152       142        99       123 
##  68666.08  76050.14  39546.02  54689.81  44129.28  42809.67</code></pre>
<p>This returns a vector of predicted prices. This can then be used to compute the Root Mean Squared Error
for instance. Let‚Äôs do it within a <code>tidyverse</code> pipeline:</p>
<div class="sourceCode" id="cb608"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb608-1" title="1">rmse &lt;-<span class="st"> </span>pred_set <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb608-2" title="2"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">predictions =</span> <span class="kw">predict</span>(model3, .)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb608-3" title="3"><span class="st">  </span><span class="kw">summarise</span>(<span class="kw">sqrt</span>(<span class="kw">sum</span>(predictions <span class="op">-</span><span class="st"> </span>price)<span class="op">**</span><span class="dv">2</span><span class="op">/</span><span class="kw">n</span>()))</a></code></pre></div>
<p>The root mean square error of <code>model3</code> is 1666.1312666.</p>
<p>I also used the <code>n()</code> function which returns the number of observations in a group (or all the
observations, if the data is not grouped). Let‚Äôs compare <code>model3</code> ‚Äôs RMSE with the one from
<code>model_log</code>:</p>
<div class="sourceCode" id="cb609"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb609-1" title="1">rmse2 &lt;-<span class="st"> </span>pred_set <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb609-2" title="2"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">predictions =</span> <span class="kw">exp</span>(<span class="kw">predict</span>(model_log, .))) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb609-3" title="3"><span class="st">  </span><span class="kw">summarise</span>(<span class="kw">sqrt</span>(<span class="kw">sum</span>(predictions <span class="op">-</span><span class="st"> </span>price)<span class="op">**</span><span class="dv">2</span><span class="op">/</span><span class="kw">n</span>()))</a></code></pre></div>
<p>Don‚Äôt forget to exponentiate the predictions, remember you‚Äôre dealing with a log-linear model! <code>model_log</code>‚Äôs
RMSE is 1359.0392252 which is lower than <code>model3</code>‚Äôs. However, keep in mind that the model was estimated
on the whole data, and then the prediction quality was assessed using a subsample of the data the
model was estimated on‚Ä¶ so actually we can‚Äôt really say if <code>model_log</code>‚Äôs predictions are very useful.
Of course, this is the same for <code>model3</code>.
In a later section we are going to learn how to do cross validation to avoid this issue.</p>
<p>Also another problem of what I did before, unrelated to statistics per se, is that I wanted to compute
the same quantity for two different models, and did so by copy and pasting 3 lines of code. That‚Äôs not
much, but if I wanted to compare 10 models, copy and paste mistakes could have sneaked in. Instead,
it would have been nice to have a function that computes the RMSE and then use it on my models. We
are going to learn how to write our own function and use it just like if it was another built-in
R function.</p>
</div>
<div id="beyond-linear-regression" class="section level2">
<h2><span class="header-section-number">7.7</span> Beyond linear regression</h2>
<p>R has a lot of other built-in functions for regression, such as <code>glm()</code> (for Generalized Linear
Models) and <code>nls()</code> for (for Nonlinear Least Squares). There are also functions and additional
packages for time series, panel data, machine learning, bayesian and nonparametric methods.
Presenting everything here would take too much space, and would be pretty useless as you can find
whatever you need using an internet search engine. What you have learned until now is quite general
and should work on many type of models. To help you out, here is a list of methods and the
recommended packages that you can use:</p>
<table>
<thead>
<tr class="header">
<th>Model</th>
<th>Package</th>
<th>Quick example</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Robust Linear Regression</td>
<td><code>MASS</code></td>
<td><code>rlm(y ~ x, data = mydata)</code></td>
</tr>
<tr class="even">
<td>Nonlinear Least Squares</td>
<td><code>stats</code><a href="#fn2" class="footnote-ref" id="fnref2"><sup>2</sup></a></td>
<td><code>nls(y ~ x1 / (1 + x2), data = mydata)</code><a href="#fn3" class="footnote-ref" id="fnref3"><sup>3</sup></a></td>
</tr>
<tr class="odd">
<td>Logit</td>
<td><code>stats</code></td>
<td><code>glm(y ~ x, data = mydata, family = "binomial")</code></td>
</tr>
<tr class="even">
<td>Probit</td>
<td><code>stats</code></td>
<td><code>glm(y ~ x, data = mydata, family = binomial(link = "probit"))</code></td>
</tr>
<tr class="odd">
<td>K-Means</td>
<td><code>stats</code></td>
<td><code>kmeans(data, n)</code><a href="#fn4" class="footnote-ref" id="fnref4"><sup>4</sup></a></td>
</tr>
<tr class="even">
<td>PCA</td>
<td><code>stats</code></td>
<td><code>prcomp(data, scale = TRUE, center = TRUE)</code><a href="#fn5" class="footnote-ref" id="fnref5"><sup>5</sup></a></td>
</tr>
<tr class="odd">
<td>Multinomial Logit</td>
<td><code>mlogit</code></td>
<td>Requires several steps of data pre-processing and formula definition, refer to the <a href="https://cran.r-project.org/web/packages/mlogit/vignettes/mlogit.pdf">Vignette</a> for more details.</td>
</tr>
<tr class="even">
<td>Cox PH</td>
<td><code>survival</code></td>
<td><code>coxph(Surv(y_time, y_status) ~ x, data = mydata)</code><a href="#fn6" class="footnote-ref" id="fnref6"><sup>6</sup></a></td>
</tr>
<tr class="odd">
<td>Time series</td>
<td>Several, depending on your needs.</td>
<td>Time series in R is a vast subject that would require a very thick book to cover. You can get started with the following series of blog articles, <a href="http://www.business-science.io/timeseries-analysis/2017/07/02/tidy-timeseries-analysis.html">Tidy time-series, part 1</a>, <a href="http://www.business-science.io/timeseries-analysis/2017/07/23/tidy-timeseries-analysis-pt-2.html">Tidy time-series, part 2</a>, <a href="http://www.business-science.io/timeseries-analysis/2017/07/30/tidy-timeseries-analysis-pt-3.html">Tidy time-series, part 3</a> and <a href="http://www.business-science.io/timeseries-analysis/2017/08/30/tidy-timeseries-analysis-pt-4.html">Tidy time-series, part 3</a></td>
</tr>
<tr class="even">
<td>Panel data</td>
<td><code>plm</code></td>
<td><code>plm(y ~ x, data = mydata, model = "within|random")</code></td>
</tr>
<tr class="odd">
<td>Neural Networks</td>
<td>Several, depending on your needs.</td>
<td>R is a very popular programming language for machine learning. <a href="http://ww.rblog.uni-freiburg.de/2017/02/07/deep-learning-in-r">This blog post</a> lists and compares some of the most useful packages for Neural nets and deep learning.</td>
</tr>
<tr class="even">
<td>Nonparametric regression</td>
<td><code>np</code></td>
<td>Several functions and options available, refer to the <a href="https://cran.r-project.org/web/packages/np/vignettes/np.pdf">Vignette</a> for more details.</td>
</tr>
</tbody>
</table>
<p>I put neural networks in the table, but you can also find packages for regression trees, naive
bayes, and pretty much any machine learning method out there! The same goes for Bayesian methods.
Popular packages include <code>rstan</code>, <code>rjags</code> which link R to STAN and JAGS (two other pieces of software
that do the Gibbs sampling for you) which are tools that allow you to fit very general models. It
is also possible to estimate models using Bayesian inference without the need of external tools,
with the <code>bayesm</code> package which estimates the usual micro-econometric models.
There really are a lot of packages available for Bayesian inference, and you can find them all in the
<a href="https://cran.r-project.org/web/views/Bayesian.html">related CRAN Task View</a>.</p>
</div>
<div id="hyper-parameters" class="section level2">
<h2><span class="header-section-number">7.8</span> Hyper-parameters</h2>
<p>Hyper-parameters are parameters of the model that cannot be directly learned from the data.
A linear regression does not have any hyper-parameters, but a random forest for instance has several.
You might have heard of ridge regression, lasso and elasticnet. These are
extensions to linear models that avoid over-fitting by penalizing <em>large</em> models. These
extensions of the linear regression have hyper-parameters that the practitioner has to tune. There
are several ways one can tune these parameters, for example, by doing a grid-search, or a random
search over the grid or using more elaborate methods. To introduce hyper-parameters, let‚Äôs get
to know ridge regression, also called Tikhonov regularization.</p>
<div id="ridge-regression" class="section level3">
<h3><span class="header-section-number">7.8.1</span> Ridge regression</h3>
<p>Ridge regression is used when the data you are working with has a lot of explanatory variables,
or when there is a risk that a simple linear regression might overfit to the training data, because,
for example, your explanatory variables are collinear.
If you are training a linear model and then you notice that it generalizes very badly to new,
unseen data, it is very likely that the linear model you trained overfit the data.
In this case, ridge regression might prove useful. The way ridge regression works might seem
counter-intuititive; it boils down to fitting a <em>worse</em> model to the training data, but in return,
this worse model will generalize better to new data.</p>
<p>The closed form solution of the ordinary least squares estimator is defined as:</p>
<p><span class="math display">\[
\widehat{\beta} = (X&#39;X)^{-1}X&#39;Y
\]</span></p>
<p>where <span class="math inline">\(X\)</span> is the design matrix (the matrix made up of the explanatory variables) and <span class="math inline">\(Y\)</span> is the
dependent variable. For ridge regression, this closed form solution changes a little bit:</p>
<p><span class="math display">\[
\widehat{\beta} = (X&#39;X + \lambda I_p)^{-1}X&#39;Y
\]</span></p>
<p>where <span class="math inline">\(\lambda \in \mathbb{R}\)</span> is an hyper-parameter and <span class="math inline">\(I_p\)</span> is the identity matrix of dimension <span class="math inline">\(p\)</span>
(<span class="math inline">\(p\)</span> is the number of explanatory variables).
This formula above is the closed form solution to the following optimisation program:</p>
<p><span class="math display">\[
\sum_{i=1}^n \left(y_i - \sum_{j=1}^px_{ij}\beta_j\right)^2 
\]</span></p>
<p>such that:</p>
<p><span class="math display">\[
\sum_{j=1}^p(\beta_j)^2 &lt; c
\]</span></p>
<p>for any strictly positive <span class="math inline">\(c\)</span>.</p>
<p>The <code>glmnet()</code> function from the <code>{glmnet}</code> package can be used for ridge regression, by setting
the <code>alpha</code> argument to 0 (setting it to 1 would do LASSO, and setting it to a number between
0 and 1 would do elasticnet). But in order to compare linear regression and ridge regression,
let me first divide the data into a training set and a testing set:</p>
<div class="sourceCode" id="cb610"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb610-1" title="1">index &lt;-<span class="st"> </span><span class="dv">1</span><span class="op">:</span><span class="kw">nrow</span>(Housing)</a>
<a class="sourceLine" id="cb610-2" title="2"></a>
<a class="sourceLine" id="cb610-3" title="3"><span class="kw">set.seed</span>(<span class="dv">12345</span>)</a>
<a class="sourceLine" id="cb610-4" title="4">train_index &lt;-<span class="st"> </span><span class="kw">sample</span>(index, <span class="kw">round</span>(<span class="fl">0.90</span><span class="op">*</span><span class="kw">nrow</span>(Housing)), <span class="dt">replace =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb610-5" title="5"></a>
<a class="sourceLine" id="cb610-6" title="6">test_index &lt;-<span class="st"> </span><span class="kw">setdiff</span>(index, train_index)</a>
<a class="sourceLine" id="cb610-7" title="7"></a>
<a class="sourceLine" id="cb610-8" title="8">train_x &lt;-<span class="st"> </span>Housing[train_index, ] <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb610-9" title="9"><span class="st">    </span><span class="kw">select</span>(<span class="op">-</span>price)</a>
<a class="sourceLine" id="cb610-10" title="10"></a>
<a class="sourceLine" id="cb610-11" title="11">train_y &lt;-<span class="st"> </span>Housing[train_index, ] <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb610-12" title="12"><span class="st">    </span><span class="kw">pull</span>(price)</a>
<a class="sourceLine" id="cb610-13" title="13"></a>
<a class="sourceLine" id="cb610-14" title="14">test_x &lt;-<span class="st"> </span>Housing[test_index, ] <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb610-15" title="15"><span class="st">    </span><span class="kw">select</span>(<span class="op">-</span>price)</a>
<a class="sourceLine" id="cb610-16" title="16"></a>
<a class="sourceLine" id="cb610-17" title="17">test_y &lt;-<span class="st"> </span>Housing[test_index, ] <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb610-18" title="18"><span class="st">    </span><span class="kw">pull</span>(price)</a></code></pre></div>
<p>I do the train/test split this way, because <code>glmnet()</code> requires a design matrix as input, and not
a formula. Design matrices can be created using the <code>model.matrix()</code> function:</p>
<div class="sourceCode" id="cb611"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb611-1" title="1"><span class="kw">library</span>(<span class="st">&quot;glmnet&quot;</span>)</a>
<a class="sourceLine" id="cb611-2" title="2"></a>
<a class="sourceLine" id="cb611-3" title="3">train_matrix &lt;-<span class="st"> </span><span class="kw">model.matrix</span>(train_y <span class="op">~</span><span class="st"> </span>., <span class="dt">data =</span> train_x)</a>
<a class="sourceLine" id="cb611-4" title="4"></a>
<a class="sourceLine" id="cb611-5" title="5">test_matrix &lt;-<span class="st"> </span><span class="kw">model.matrix</span>(test_y <span class="op">~</span><span class="st"> </span>., <span class="dt">data =</span> test_x)</a></code></pre></div>
<p>Let‚Äôs now run a linear regression, by setting the penalty to 0:</p>
<div class="sourceCode" id="cb612"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb612-1" title="1">model_lm_ridge &lt;-<span class="st"> </span><span class="kw">glmnet</span>(<span class="dt">y =</span> train_y, <span class="dt">x =</span> train_matrix, <span class="dt">alpha =</span> <span class="dv">0</span>, <span class="dt">lambda =</span> <span class="dv">0</span>)</a></code></pre></div>
<p>The model above provides the same result as a linear regression, because I set <code>lambda</code> to 0. Let‚Äôs
compare the coefficients between the two:</p>
<div class="sourceCode" id="cb613"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb613-1" title="1"><span class="kw">coef</span>(model_lm_ridge)</a></code></pre></div>
<pre><code>## 13 x 1 sparse Matrix of class &quot;dgCMatrix&quot;
##                       s0
## (Intercept) -3247.030393
## (Intercept)     .       
## lotsize         3.520283
## bedrooms     1745.211187
## bathrms     14337.551325
## stories      6736.679470
## drivewayyes  5687.132236
## recroomyes   5701.831289
## fullbaseyes  5708.978557
## gashwyes    12508.524241
## aircoyes    12592.435621
## garagepl     4438.918373
## prefareayes  9085.172469</code></pre>
<p>and now the coefficients of the linear regression (because I provide a design matrix, I have to use
<code>lm.fit()</code> instead of <code>lm()</code> which requires a formula, not a matrix.)</p>
<div class="sourceCode" id="cb615"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb615-1" title="1"><span class="kw">coef</span>(<span class="kw">lm.fit</span>(<span class="dt">x =</span> train_matrix, <span class="dt">y =</span> train_y))</a></code></pre></div>
<pre><code>##  (Intercept)      lotsize     bedrooms      bathrms      stories 
## -3245.146665     3.520357  1744.983863 14336.336858  6737.000410 
##  drivewayyes   recroomyes  fullbaseyes     gashwyes     aircoyes 
##  5686.394123  5700.210775  5709.493884 12509.005265 12592.367268 
##     garagepl  prefareayes 
##  4439.029607  9085.409155</code></pre>
<p>as you can see, the coefficients are the same. Let‚Äôs compute the RMSE for the unpenalized linear
regression:</p>
<div class="sourceCode" id="cb617"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb617-1" title="1">preds_lm &lt;-<span class="st"> </span><span class="kw">predict</span>(model_lm_ridge, test_matrix)</a>
<a class="sourceLine" id="cb617-2" title="2"></a>
<a class="sourceLine" id="cb617-3" title="3">rmse_lm &lt;-<span class="st"> </span><span class="kw">sqrt</span>(<span class="kw">mean</span>(preds_lm <span class="op">-</span><span class="st"> </span>test_y)<span class="op">^</span><span class="dv">2</span>)</a></code></pre></div>
<p>The RMSE for the linear unpenalized regression is equal to 2077.4197343.</p>
<p>Let‚Äôs now run a ridge regression, with <code>lambda</code> equal to 100, and see if the RMSE is smaller:</p>
<div class="sourceCode" id="cb618"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb618-1" title="1">model_ridge &lt;-<span class="st"> </span><span class="kw">glmnet</span>(<span class="dt">y =</span> train_y, <span class="dt">x =</span> train_matrix, <span class="dt">alpha =</span> <span class="dv">0</span>, <span class="dt">lambda =</span> <span class="dv">100</span>)</a></code></pre></div>
<p>and let‚Äôs compute the RMSE again:</p>
<div class="sourceCode" id="cb619"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb619-1" title="1">preds &lt;-<span class="st"> </span><span class="kw">predict</span>(model_ridge, test_matrix)</a>
<a class="sourceLine" id="cb619-2" title="2"></a>
<a class="sourceLine" id="cb619-3" title="3">rmse &lt;-<span class="st"> </span><span class="kw">sqrt</span>(<span class="kw">mean</span>(preds <span class="op">-</span><span class="st"> </span>test_y)<span class="op">^</span><span class="dv">2</span>)</a></code></pre></div>
<p>The RMSE for the linear penalized regression is equal to 2072.6117757, which is smaller than before.
But which value of <code>lambda</code> gives smallest RMSE? To find out, one must run model over a grid of
<code>lambda</code> values and pick the model with lowest RMSE. This procedure is available in the <code>cv.glmnet()</code>
function, which picks the best value for <code>lambda</code>:</p>
<div class="sourceCode" id="cb620"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb620-1" title="1">best_model &lt;-<span class="st"> </span><span class="kw">cv.glmnet</span>(train_matrix, train_y)</a>
<a class="sourceLine" id="cb620-2" title="2"><span class="co"># lambda that minimises the MSE</span></a>
<a class="sourceLine" id="cb620-3" title="3">best_model<span class="op">$</span>lambda.min</a></code></pre></div>
<pre><code>## [1] 66.07936</code></pre>
<p>According to <code>cv.glmnet()</code> the best value for <code>lambda</code> is 66.0793576. In the
next section, we will implement cross validation ourselves, in order to find the hyper-parameters
of a random forest.</p>
</div>
</div>
<div id="training-validating-and-testing-models" class="section level2">
<h2><span class="header-section-number">7.9</span> Training, validating, and testing models</h2>
<p>Cross-validation is an important procedure which is used to compare models but also to tune the
hyper-parameters of a model.</p>
<p>In this section, we are going to use several packages from the
<a href="https://github.com/tidymodels"><code>{tidymodels}</code></a> collection of packages, namely
<a href="https://tidymodels.github.io/recipes/"><code>{recipes}</code></a>,
<a href="https://tidymodels.github.io/rsample/"><code>{rsample}</code></a> and
<a href="https://tidymodels.github.io/parsnip/"><code>{parsnip}</code></a> to train a random forest the tidy way. I will
also use <a href="http://mlrmbo.mlr-org.com/"><code>{mlrMBO}</code></a> to tune the hyper-parameters of the random forest.</p>
<div id="set-up" class="section level3">
<h3><span class="header-section-number">7.9.1</span> Set up</h3>
<p>Let‚Äôs load the needed packages:</p>
<div class="sourceCode" id="cb622"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb622-1" title="1"><span class="kw">library</span>(<span class="st">&quot;tidyverse&quot;</span>)</a>
<a class="sourceLine" id="cb622-2" title="2"><span class="kw">library</span>(<span class="st">&quot;tidymodels&quot;</span>)</a>
<a class="sourceLine" id="cb622-3" title="3"><span class="kw">library</span>(<span class="st">&quot;parsnip&quot;</span>)</a>
<a class="sourceLine" id="cb622-4" title="4"><span class="kw">library</span>(<span class="st">&quot;brotools&quot;</span>)</a>
<a class="sourceLine" id="cb622-5" title="5"><span class="kw">library</span>(<span class="st">&quot;mlbench&quot;</span>)</a></code></pre></div>
<p>Load the data, included in the <code>{mlrbench}</code> package:</p>
<div class="sourceCode" id="cb623"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb623-1" title="1"><span class="kw">data</span>(<span class="st">&quot;BostonHousing2&quot;</span>)</a></code></pre></div>
<p>I will train a random forest to predict the housing price, which is the <code>cmedv</code> column:</p>
<div class="sourceCode" id="cb624"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb624-1" title="1"><span class="kw">head</span>(BostonHousing2)</a></code></pre></div>
<pre><code>##         town tract      lon     lat medv cmedv    crim zn indus chas   nox
## 1     Nahant  2011 -70.9550 42.2550 24.0  24.0 0.00632 18  2.31    0 0.538
## 2 Swampscott  2021 -70.9500 42.2875 21.6  21.6 0.02731  0  7.07    0 0.469
## 3 Swampscott  2022 -70.9360 42.2830 34.7  34.7 0.02729  0  7.07    0 0.469
## 4 Marblehead  2031 -70.9280 42.2930 33.4  33.4 0.03237  0  2.18    0 0.458
## 5 Marblehead  2032 -70.9220 42.2980 36.2  36.2 0.06905  0  2.18    0 0.458
## 6 Marblehead  2033 -70.9165 42.3040 28.7  28.7 0.02985  0  2.18    0 0.458
##      rm  age    dis rad tax ptratio      b lstat
## 1 6.575 65.2 4.0900   1 296    15.3 396.90  4.98
## 2 6.421 78.9 4.9671   2 242    17.8 396.90  9.14
## 3 7.185 61.1 4.9671   2 242    17.8 392.83  4.03
## 4 6.998 45.8 6.0622   3 222    18.7 394.63  2.94
## 5 7.147 54.2 6.0622   3 222    18.7 396.90  5.33
## 6 6.430 58.7 6.0622   3 222    18.7 394.12  5.21</code></pre>
<p>Only keep relevant columns:</p>
<div class="sourceCode" id="cb626"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb626-1" title="1">boston &lt;-<span class="st"> </span>BostonHousing2 <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb626-2" title="2"><span class="st">    </span><span class="kw">select</span>(<span class="op">-</span>medv, <span class="op">-</span>tract, <span class="op">-</span>lon, <span class="op">-</span>lat) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb626-3" title="3"><span class="st">    </span><span class="kw">rename</span>(<span class="dt">price =</span> cmedv)</a></code></pre></div>
<p>I remove <code>tract</code>, <code>lat</code> and <code>lon</code> because the information contained in the column <code>town</code> is enough.</p>
<p>To train and evaluate the model‚Äôs performance, I split the data in two.
One data set, called the training set, will be further split into two down below. I won‚Äôt
touch the second data set, the test set, until the very end, to finally assess the model‚Äôs
performance.</p>
<div class="sourceCode" id="cb627"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb627-1" title="1">train_test_split &lt;-<span class="st"> </span><span class="kw">initial_split</span>(boston, <span class="dt">prop =</span> <span class="fl">0.9</span>)</a>
<a class="sourceLine" id="cb627-2" title="2"></a>
<a class="sourceLine" id="cb627-3" title="3">housing_train &lt;-<span class="st"> </span><span class="kw">training</span>(train_test_split)</a>
<a class="sourceLine" id="cb627-4" title="4"></a>
<a class="sourceLine" id="cb627-5" title="5">housing_test &lt;-<span class="st"> </span><span class="kw">testing</span>(train_test_split)</a></code></pre></div>
<p><code>initial_split()</code>, <code>training()</code> and <code>testing()</code> are functions from the <code>{rsample}</code> package.</p>
<p>I will train a random forest on the training data, but the question, is <em>which</em> random forest?
Because random forests have several hyper-parameters, and as explained in the intro these
hyper-parameters cannot be directly learned from the data, which one should we choose? We could
train 6 random forests for instance and compare their performance, but why only 6? Why not 16?</p>
<p>In order to find the right hyper-parameters, the practitioner can
use values from the literature that seemed to have worked well (like is done in Macro-econometrics)
or you can further split the train set into two, create a grid of hyperparameter, train the model
on one part of the data for all values of the grid, and compare the predictions of the models on the
second part of the data. You then stick with the model that performed the best, for example, the
model with lowest RMSE. The thing is, you can‚Äôt estimate the true value of the RMSE with only
one value. It‚Äôs like if you wanted to estimate the height of the population by drawing one single
observation from the population. You need a bit more observations. To approach the true value of the
RMSE for a give set of hyperparameters, instead of doing one split, let‚Äôs do 30. Then we
compute the average RMSE, which implies training 30 models for each combination of the values of the
hyperparameters.</p>
<p>First, let‚Äôs split the training data again, using the <code>mc_cv()</code> function from <code>{rsample}</code> package.
This function implements Monte Carlo cross-validation:</p>
<div class="sourceCode" id="cb628"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb628-1" title="1">validation_data &lt;-<span class="st"> </span><span class="kw">mc_cv</span>(housing_train, <span class="dt">prop =</span> <span class="fl">0.9</span>, <span class="dt">times =</span> <span class="dv">30</span>)</a></code></pre></div>
<p>What does <code>validation_data</code> look like?</p>
<div class="sourceCode" id="cb629"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb629-1" title="1">validation_data</a></code></pre></div>
<pre><code>## # # Monte Carlo cross-validation (0.9/0.1) with 30 resamples  
## # A tibble: 30 x 2
##    splits           id        
##    &lt;list&gt;           &lt;chr&gt;     
##  1 &lt;split [411/45]&gt; Resample01
##  2 &lt;split [411/45]&gt; Resample02
##  3 &lt;split [411/45]&gt; Resample03
##  4 &lt;split [411/45]&gt; Resample04
##  5 &lt;split [411/45]&gt; Resample05
##  6 &lt;split [411/45]&gt; Resample06
##  7 &lt;split [411/45]&gt; Resample07
##  8 &lt;split [411/45]&gt; Resample08
##  9 &lt;split [411/45]&gt; Resample09
## 10 &lt;split [411/45]&gt; Resample10
## # ... with 20 more rows</code></pre>
<p>Let‚Äôs look further down:</p>
<div class="sourceCode" id="cb631"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb631-1" title="1">validation_data<span class="op">$</span>splits[[<span class="dv">1</span>]]</a></code></pre></div>
<pre><code>## &lt;411/45/456&gt;</code></pre>
<p>The first value is the number of rows of the first set, the second value of the second, and the third
was the original amount of values in the training data, before splitting again.</p>
<p>How should we call these two new data sets? The author of <code>{rsample}</code>, Max Kuhn, talks about
the <em>analysis</em> and the <em>assessment</em> sets:</p>
{{% tweet "1066131042615140353" %}}
<p>Now, in order to continue I need pre-process the data. I will do this in three steps.
The first and the second step are used to center and scale the numeric variables and the third step
converts character and factor variables to dummy variables. This is needed because I will train a
random forest, which cannot handle factor variables directly. Let‚Äôs define a recipe to do that,
and start by pre-processing the testing set. I write a wrapper function around the recipe,
because I will need to apply this recipe to various data sets:</p>
<div class="sourceCode" id="cb633"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb633-1" title="1">simple_recipe &lt;-<span class="st"> </span><span class="cf">function</span>(dataset){</a>
<a class="sourceLine" id="cb633-2" title="2">    <span class="kw">recipe</span>(price <span class="op">~</span><span class="st"> </span>., <span class="dt">data =</span> dataset) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb633-3" title="3"><span class="st">        </span><span class="kw">step_center</span>(<span class="kw">all_numeric</span>()) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb633-4" title="4"><span class="st">        </span><span class="kw">step_scale</span>(<span class="kw">all_numeric</span>()) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb633-5" title="5"><span class="st">        </span><span class="kw">step_dummy</span>(<span class="kw">all_nominal</span>())</a>
<a class="sourceLine" id="cb633-6" title="6">}</a></code></pre></div>
<p>Once the recipe is defined, I can use the <code>prep()</code> function, which estimates the parameters from
the data which are needed to process the data. For example, for centering, <code>prep()</code> estimates
the mean which will then be subtracted from the variables. With <code>bake()</code> the estimates are then
applied on the data:</p>
<div class="sourceCode" id="cb634"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb634-1" title="1">testing_rec &lt;-<span class="st"> </span><span class="kw">prep</span>(<span class="kw">simple_recipe</span>(housing_test), <span class="dt">testing =</span> housing_test)</a>
<a class="sourceLine" id="cb634-2" title="2"></a>
<a class="sourceLine" id="cb634-3" title="3">test_data &lt;-<span class="st"> </span><span class="kw">bake</span>(testing_rec, <span class="dt">new_data =</span> housing_test)</a></code></pre></div>
<p>It is important to split the data before using <code>prep()</code> and <code>bake()</code>, because if not, you will
use observations from the test set in the <code>prep()</code> step, and thus introduce knowledge from the test
set into the training data. This is called data leakage, and must be avoided. This is why it is
necessary to first split the training data into an analysis and an assessment set, and then also
pre-process these sets separately. However, the <code>validation_data</code> object cannot now be used with
<code>recipe()</code>, because it is not a dataframe. No worries, I simply need to write a function that extracts
the analysis and assessment sets from the <code>validation_data</code> object, applies the pre-processing, trains
the model, and returns the RMSE. This will be a big function, at the center of the analysis.</p>
<p>But before that, let‚Äôs run a simple linear regression, as a benchmark. For the linear regression, I will
not use any CV, so let‚Äôs pre-process the training set:</p>
<div class="sourceCode" id="cb635"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb635-1" title="1">trainlm_rec &lt;-<span class="st"> </span><span class="kw">prep</span>(<span class="kw">simple_recipe</span>(housing_train), <span class="dt">testing =</span> housing_train)</a>
<a class="sourceLine" id="cb635-2" title="2"></a>
<a class="sourceLine" id="cb635-3" title="3">trainlm_data &lt;-<span class="st"> </span><span class="kw">bake</span>(trainlm_rec, <span class="dt">new_data =</span> housing_train)</a>
<a class="sourceLine" id="cb635-4" title="4"></a>
<a class="sourceLine" id="cb635-5" title="5">linreg_model &lt;-<span class="st"> </span><span class="kw">lm</span>(price <span class="op">~</span><span class="st"> </span>., <span class="dt">data =</span> trainlm_data)</a>
<a class="sourceLine" id="cb635-6" title="6"></a>
<a class="sourceLine" id="cb635-7" title="7">broom<span class="op">::</span><span class="kw">augment</span>(linreg_model, <span class="dt">newdata =</span> test_data) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb635-8" title="8"><span class="st">    </span><span class="kw">rmse</span>(price, .fitted)</a></code></pre></div>
<pre><code>## # A tibble: 1 x 3
##   .metric .estimator .estimate
##   &lt;chr&gt;   &lt;chr&gt;          &lt;dbl&gt;
## 1 rmse    standard       0.345</code></pre>
<p><code>broom::augment()</code> adds the predictions to the <code>test_data</code> in a new column, <code>.fitted</code>. I won‚Äôt
use this trick with the random forest, because there is no <code>augment()</code> method for random forests
from the <code>{ranger}</code> which I‚Äôll use. I‚Äôll add the predictions to the data myself.</p>
<p>Ok, now let‚Äôs go back to the random forest and write the big function:</p>
<div class="sourceCode" id="cb637"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb637-1" title="1">my_rf &lt;-<span class="st"> </span><span class="cf">function</span>(mtry, trees, split, id){</a>
<a class="sourceLine" id="cb637-2" title="2">    </a>
<a class="sourceLine" id="cb637-3" title="3">    analysis_set &lt;-<span class="st"> </span><span class="kw">analysis</span>(split)</a>
<a class="sourceLine" id="cb637-4" title="4">    </a>
<a class="sourceLine" id="cb637-5" title="5">    analysis_prep &lt;-<span class="st"> </span><span class="kw">prep</span>(<span class="kw">simple_recipe</span>(analysis_set), <span class="dt">training =</span> analysis_set)</a>
<a class="sourceLine" id="cb637-6" title="6">    </a>
<a class="sourceLine" id="cb637-7" title="7">    analysis_processed &lt;-<span class="st"> </span><span class="kw">bake</span>(analysis_prep, <span class="dt">new_data =</span> analysis_set)</a>
<a class="sourceLine" id="cb637-8" title="8">    </a>
<a class="sourceLine" id="cb637-9" title="9">    model &lt;-<span class="st"> </span><span class="kw">rand_forest</span>(<span class="dt">mtry =</span> mtry, <span class="dt">trees =</span> trees) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb637-10" title="10"><span class="st">        </span><span class="kw">set_engine</span>(<span class="st">&quot;ranger&quot;</span>, <span class="dt">importance =</span> <span class="st">&#39;impurity&#39;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb637-11" title="11"><span class="st">        </span><span class="kw">fit</span>(price <span class="op">~</span><span class="st"> </span>., <span class="dt">data =</span> analysis_processed)</a>
<a class="sourceLine" id="cb637-12" title="12"></a>
<a class="sourceLine" id="cb637-13" title="13">    assessment_set &lt;-<span class="st"> </span><span class="kw">assessment</span>(split)</a>
<a class="sourceLine" id="cb637-14" title="14">    </a>
<a class="sourceLine" id="cb637-15" title="15">    assessment_prep &lt;-<span class="st"> </span><span class="kw">prep</span>(<span class="kw">simple_recipe</span>(assessment_set), <span class="dt">testing =</span> assessment_set)</a>
<a class="sourceLine" id="cb637-16" title="16">    </a>
<a class="sourceLine" id="cb637-17" title="17">    assessment_processed &lt;-<span class="st"> </span><span class="kw">bake</span>(assessment_prep, <span class="dt">new_data =</span> assessment_set)</a>
<a class="sourceLine" id="cb637-18" title="18"></a>
<a class="sourceLine" id="cb637-19" title="19">    tibble<span class="op">::</span><span class="kw">tibble</span>(<span class="st">&quot;id&quot;</span> =<span class="st"> </span>id,</a>
<a class="sourceLine" id="cb637-20" title="20">        <span class="st">&quot;truth&quot;</span> =<span class="st"> </span>assessment_processed<span class="op">$</span>price,</a>
<a class="sourceLine" id="cb637-21" title="21">        <span class="st">&quot;prediction&quot;</span> =<span class="st"> </span><span class="kw">unlist</span>(<span class="kw">predict</span>(model, <span class="dt">new_data =</span> assessment_processed)))</a>
<a class="sourceLine" id="cb637-22" title="22">}</a></code></pre></div>
<p>The <code>rand_forest()</code> function is available from the <code>{parsnip}</code> package. This package provides an
unified interface to a lot of other machine learning packages. This means that instead of having to
learn the syntax of <code>range()</code> and <code>randomForest()</code> and, and‚Ä¶ you can simply use the <code>rand_forest()</code>
function and change the <code>engine</code> argument to the one you want (<code>ranger</code>, <code>randomForest</code>, etc).</p>
<p>Let‚Äôs try this function:</p>
<div class="sourceCode" id="cb638"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb638-1" title="1">results_example &lt;-<span class="st"> </span><span class="kw">map2_df</span>(<span class="dt">.x =</span> validation_data<span class="op">$</span>splits,</a>
<a class="sourceLine" id="cb638-2" title="2">                           <span class="dt">.y =</span> validation_data<span class="op">$</span>id,</a>
<a class="sourceLine" id="cb638-3" title="3">                           <span class="op">~</span><span class="kw">my_rf</span>(<span class="dt">mtry =</span> <span class="dv">3</span>, <span class="dt">trees =</span> <span class="dv">200</span>, <span class="dt">split =</span> .x, <span class="dt">id =</span> .y))</a></code></pre></div>
<div class="sourceCode" id="cb639"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb639-1" title="1"><span class="kw">head</span>(results_example)</a></code></pre></div>
<pre><code>## # A tibble: 6 x 3
##   id          truth prediction
##   &lt;chr&gt;       &lt;dbl&gt;      &lt;dbl&gt;
## 1 Resample01 -0.518     -0.259
## 2 Resample01 -1.03      -0.354
## 3 Resample01 -0.913     -0.345
## 4 Resample01 -0.874     -0.407
## 5 Resample01  0.430      0.241
## 6 Resample01  0.259      0.301</code></pre>
<p>I can now compute the RMSE when <code>mtry</code> = 3 and <code>trees</code> = 200:</p>
<div class="sourceCode" id="cb641"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb641-1" title="1">results_example <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb641-2" title="2"><span class="st">    </span><span class="kw">group_by</span>(id) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb641-3" title="3"><span class="st">    </span><span class="kw">rmse</span>(truth, prediction) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb641-4" title="4"><span class="st">    </span><span class="kw">summarise</span>(<span class="dt">mean_rmse =</span> <span class="kw">mean</span>(.estimate)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb641-5" title="5"><span class="st">    </span>pull</a></code></pre></div>
<pre><code>## [1] 0.6095162</code></pre>
<p>The random forest has already lower RMSE than the linear regression. The goal now is to lower this
RMSE by tuning the <code>mtry</code> and <code>trees</code> hyperparameters. For this, I will use Bayesian Optimization
methods implemented in the <code>{mlrMBO}</code> package.</p>
</div>
<div id="bayesian-hyperparameter-optimization" class="section level3">
<h3><span class="header-section-number">7.9.2</span> Bayesian hyperparameter optimization</h3>
<p>I will re-use the code from above, and define a function that does everything from pre-processing
to returning the metric I want to minimize by tuning the hyperparameters, the RMSE:</p>
<div class="sourceCode" id="cb643"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb643-1" title="1">tuning &lt;-<span class="st"> </span><span class="cf">function</span>(param, validation_data){</a>
<a class="sourceLine" id="cb643-2" title="2"></a>
<a class="sourceLine" id="cb643-3" title="3">    mtry &lt;-<span class="st"> </span>param[<span class="dv">1</span>]</a>
<a class="sourceLine" id="cb643-4" title="4">    trees &lt;-<span class="st"> </span>param[<span class="dv">2</span>]</a>
<a class="sourceLine" id="cb643-5" title="5"></a>
<a class="sourceLine" id="cb643-6" title="6">    results &lt;-<span class="st"> </span>purrr<span class="op">::</span><span class="kw">map2_df</span>(<span class="dt">.x =</span> validation_data<span class="op">$</span>splits,</a>
<a class="sourceLine" id="cb643-7" title="7">                       <span class="dt">.y =</span> validation_data<span class="op">$</span>id,</a>
<a class="sourceLine" id="cb643-8" title="8">                       <span class="op">~</span><span class="kw">my_rf</span>(<span class="dt">mtry =</span> mtry, <span class="dt">trees =</span> trees, <span class="dt">split =</span> .x, <span class="dt">id =</span> .y))</a>
<a class="sourceLine" id="cb643-9" title="9"></a>
<a class="sourceLine" id="cb643-10" title="10">    results <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb643-11" title="11"><span class="st">        </span><span class="kw">group_by</span>(id) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb643-12" title="12"><span class="st">        </span><span class="kw">rmse</span>(truth, prediction) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb643-13" title="13"><span class="st">        </span><span class="kw">summarise</span>(<span class="dt">mean_rmse =</span> <span class="kw">mean</span>(.estimate)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb643-14" title="14"><span class="st">        </span>pull</a>
<a class="sourceLine" id="cb643-15" title="15">}</a></code></pre></div>
<p>This is exactly the code from before, but it now returns the RMSE. Let‚Äôs try the function
with the values from before:</p>
<div class="sourceCode" id="cb644"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb644-1" title="1"><span class="kw">tuning</span>(<span class="kw">c</span>(<span class="dv">3</span>, <span class="dv">200</span>), validation_data)</a></code></pre></div>
<pre><code>## [1] 0.6084911</code></pre>
<p>I now follow the code that can be found in the <a href="https://arxiv.org/abs/1703.03373">arxiv</a> paper to
run the optimization. I think I got the gist of the paper, but I did not understand everything yet.
For now, I am still experimenting with the library at the moment, but from what I understand, a
simpler model, called the surrogate model, is used to look for promising points and to evaluate the
value of the function at these points. This seems somewhat similar (in spirit) to the
<em>Indirect Inference</em> method as described in <a href="https://www.jstor.org/stable/2285076">Gourieroux, Monfort, Renault</a>.</p>
<p>Let‚Äôs first load the package and create the function to optimize:</p>
<div class="sourceCode" id="cb646"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb646-1" title="1"><span class="kw">library</span>(<span class="st">&quot;mlrMBO&quot;</span>)</a></code></pre></div>
<div class="sourceCode" id="cb647"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb647-1" title="1">fn &lt;-<span class="st"> </span><span class="kw">makeSingleObjectiveFunction</span>(<span class="dt">name =</span> <span class="st">&quot;tuning&quot;</span>,</a>
<a class="sourceLine" id="cb647-2" title="2">                                 <span class="dt">fn =</span> tuning,</a>
<a class="sourceLine" id="cb647-3" title="3">                                 <span class="dt">par.set =</span> <span class="kw">makeParamSet</span>(<span class="kw">makeIntegerParam</span>(<span class="st">&quot;x1&quot;</span>, <span class="dt">lower =</span> <span class="dv">3</span>, <span class="dt">upper =</span> <span class="dv">8</span>),</a>
<a class="sourceLine" id="cb647-4" title="4">                                                        <span class="kw">makeIntegerParam</span>(<span class="st">&quot;x2&quot;</span>, <span class="dt">lower =</span> <span class="dv">100</span>, <span class="dt">upper =</span> <span class="dv">500</span>)))</a></code></pre></div>
<p>This function is based on the function I defined before. The parameters to optimize are also
defined as are their bounds. I will look for <code>mtry</code> between the values of 3 and 8, and <code>trees</code>
between 50 and 500.</p>
<p>Now comes the part I didn‚Äôt quite get.</p>
<div class="sourceCode" id="cb648"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb648-1" title="1"><span class="co"># Create initial random Latin Hypercube Design of 10 points</span></a>
<a class="sourceLine" id="cb648-2" title="2"><span class="kw">library</span>(lhs)<span class="co"># for randomLHS</span></a>
<a class="sourceLine" id="cb648-3" title="3">des &lt;-<span class="st"> </span><span class="kw">generateDesign</span>(<span class="dt">n =</span> 5L <span class="op">*</span><span class="st"> </span>2L, <span class="kw">getParamSet</span>(fn), <span class="dt">fun =</span> randomLHS)</a></code></pre></div>
<p>I think this means that these 10 points are the points used to start the whole process. I did not
understand why they have to be sampled from a hypercube, but ok. Then I choose the surrogate model,
a random forest too, and predict the standard error. Here also, I¬†did not quite get why the
standard error can be an option.</p>
<div class="sourceCode" id="cb649"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb649-1" title="1"><span class="co"># Specify kriging model with standard error estimation</span></a>
<a class="sourceLine" id="cb649-2" title="2">surrogate &lt;-<span class="st"> </span><span class="kw">makeLearner</span>(<span class="st">&quot;regr.ranger&quot;</span>, <span class="dt">predict.type =</span> <span class="st">&quot;se&quot;</span>, <span class="dt">keep.inbag =</span> <span class="ot">TRUE</span>)</a></code></pre></div>
<p>Here I define some options:</p>
<div class="sourceCode" id="cb650"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb650-1" title="1"><span class="co"># Set general controls</span></a>
<a class="sourceLine" id="cb650-2" title="2">ctrl &lt;-<span class="st"> </span><span class="kw">makeMBOControl</span>()</a>
<a class="sourceLine" id="cb650-3" title="3">ctrl &lt;-<span class="st"> </span><span class="kw">setMBOControlTermination</span>(ctrl, <span class="dt">iters =</span> 10L)</a>
<a class="sourceLine" id="cb650-4" title="4">ctrl &lt;-<span class="st"> </span><span class="kw">setMBOControlInfill</span>(ctrl, <span class="dt">crit =</span> <span class="kw">makeMBOInfillCritEI</span>())</a></code></pre></div>
<p>And this is the optimization part:</p>
<div class="sourceCode" id="cb651"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb651-1" title="1"><span class="co"># Start optimization</span></a>
<a class="sourceLine" id="cb651-2" title="2">result &lt;-<span class="st"> </span><span class="kw">mbo</span>(fn, des, surrogate, ctrl, <span class="dt">more.args =</span> <span class="kw">list</span>(<span class="st">&quot;validation_data&quot;</span> =<span class="st"> </span>validation_data))</a></code></pre></div>
<div class="sourceCode" id="cb652"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb652-1" title="1">result</a></code></pre></div>
<pre><code>## Recommended parameters:
## x1=8; x2=314
## Objective: y = 0.484
## 
## Optimization path
## 10 + 10 entries in total, displaying last 10 (or less):
##    x1  x2         y dob eol error.message exec.time            ei
## 11  8 283 0.4855415   1  NA          &lt;NA&gt;     7.353 -3.276847e-04
## 12  8 284 0.4852047   2  NA          &lt;NA&gt;     7.321 -3.283713e-04
## 13  8 314 0.4839817   3  NA          &lt;NA&gt;     7.703 -3.828517e-04
## 14  8 312 0.4841398   4  NA          &lt;NA&gt;     7.633 -2.829713e-04
## 15  8 318 0.4841066   5  NA          &lt;NA&gt;     7.692 -2.668354e-04
## 16  8 314 0.4845221   6  NA          &lt;NA&gt;     7.574 -1.382333e-04
## 17  8 321 0.4843018   7  NA          &lt;NA&gt;     7.693 -3.828924e-05
## 18  8 318 0.4868457   8  NA          &lt;NA&gt;     7.696 -8.692828e-07
## 19  8 310 0.4862687   9  NA          &lt;NA&gt;     7.594 -1.061185e-07
## 20  8 313 0.4878694  10  NA          &lt;NA&gt;     7.628 -5.153015e-07
##    error.model train.time prop.type propose.time           se      mean
## 11        &lt;NA&gt;      0.011 infill_ei        0.450 0.0143886864 0.5075765
## 12        &lt;NA&gt;      0.011 infill_ei        0.427 0.0090265872 0.4971003
## 13        &lt;NA&gt;      0.012 infill_ei        0.443 0.0062693960 0.4916927
## 14        &lt;NA&gt;      0.012 infill_ei        0.435 0.0037308971 0.4878950
## 15        &lt;NA&gt;      0.012 infill_ei        0.737 0.0024446891 0.4860699
## 16        &lt;NA&gt;      0.013 infill_ei        0.442 0.0012713838 0.4850705
## 17        &lt;NA&gt;      0.012 infill_ei        0.444 0.0006371109 0.4847248
## 18        &lt;NA&gt;      0.013 infill_ei        0.467 0.0002106381 0.4844576
## 19        &lt;NA&gt;      0.014 infill_ei        0.435 0.0002182254 0.4846214
## 20        &lt;NA&gt;      0.013 infill_ei        0.748 0.0002971160 0.4847383</code></pre>
<p>So the recommended parameters are 8 for <code>mtry</code> and 314 for <code>trees</code>. The
user can access these recommended parameters with <code>result$x$x1</code> and <code>result$x$x2</code>.
The value of the RMSE is lower than before, and equals 0.4839817. It can be accessed with
<code>result$y</code>.
Let‚Äôs now train the random forest on the training data with this values. First, I pre-process the
training data</p>
<div class="sourceCode" id="cb654"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb654-1" title="1">training_rec &lt;-<span class="st"> </span><span class="kw">prep</span>(<span class="kw">simple_recipe</span>(housing_train), <span class="dt">testing =</span> housing_train)</a>
<a class="sourceLine" id="cb654-2" title="2"></a>
<a class="sourceLine" id="cb654-3" title="3">train_data &lt;-<span class="st"> </span><span class="kw">bake</span>(training_rec, <span class="dt">new_data =</span> housing_train)</a></code></pre></div>
<p>Let‚Äôs now train our final model and predict the prices:</p>
<div class="sourceCode" id="cb655"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb655-1" title="1">final_model &lt;-<span class="st"> </span><span class="kw">rand_forest</span>(<span class="dt">mtry =</span> result<span class="op">$</span>x<span class="op">$</span>x1, <span class="dt">trees =</span> result<span class="op">$</span>x<span class="op">$</span>x2) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb655-2" title="2"><span class="st">        </span><span class="kw">set_engine</span>(<span class="st">&quot;ranger&quot;</span>, <span class="dt">importance =</span> <span class="st">&#39;impurity&#39;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb655-3" title="3"><span class="st">        </span><span class="kw">fit</span>(price <span class="op">~</span><span class="st"> </span>., <span class="dt">data =</span> train_data)</a>
<a class="sourceLine" id="cb655-4" title="4"></a>
<a class="sourceLine" id="cb655-5" title="5">price_predict &lt;-<span class="st"> </span><span class="kw">predict</span>(final_model, <span class="dt">new_data =</span> <span class="kw">select</span>(test_data, <span class="op">-</span>price))</a></code></pre></div>
<p>Let‚Äôs transform the data back and compare the predicted prices to the true ones visually:</p>
<div class="sourceCode" id="cb656"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb656-1" title="1"><span class="kw">cbind</span>(price_predict <span class="op">*</span><span class="st"> </span><span class="kw">sd</span>(housing_train<span class="op">$</span>price) <span class="op">+</span><span class="st"> </span><span class="kw">mean</span>(housing_train<span class="op">$</span>price), </a>
<a class="sourceLine" id="cb656-2" title="2">      housing_test<span class="op">$</span>price)</a></code></pre></div>
<pre><code>##       .pred housing_test$price
## 1  30.59821               33.4
## 2  20.51527               22.1
## 3  20.70910               15.0
## 4  21.05006               18.9
## 5  21.83339               21.0
## 6  22.21497               19.7
## 7  25.46633               23.5
## 8  23.33025               22.8
## 9  23.10575               22.9
## 10 35.21667               43.8
## 11 19.74732               19.4
## 12 20.64019               18.5
## 13 19.33295               20.5
## 14 17.45800               19.2
## 15 17.84190               23.0
## 16 37.03059               50.0
## 17 19.93137               17.4
## 18 25.12708               29.9
## 19 28.48672               29.6
## 20 27.60802               30.5
## 21 36.22326               48.5
## 22 37.12297               50.0
## 23 22.24472               24.4
## 24 25.26734               27.5
## 25 36.77645               44.8
## 26 31.38922               31.5
## 27 32.41102               44.0
## 28 29.69693               36.5
## 29 29.55211               35.1
## 30 23.21213               23.9
## 31 23.85407               26.4
## 32 19.85476               17.8
## 33 22.49282               19.4
## 34 20.94734               18.7
## 35 24.34244               23.1
## 36 22.48134               20.6
## 37 16.06177               17.8
## 38 21.52339               50.0
## 39 13.02448               12.3
## 40 12.45328               12.7
## 41 15.59053               11.9
## 42 19.65195               15.0
## 43 14.32340               11.7
## 44 12.10552                8.3
## 45 13.72787               14.4
## 46 17.12866               19.1
## 47 15.80288               13.3
## 48 16.89238               21.4
## 49 20.52074               16.8
## 50 21.40366               22.4</code></pre>
<p>Let‚Äôs now compute the RMSE:</p>
<div class="sourceCode" id="cb658"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb658-1" title="1">tibble<span class="op">::</span><span class="kw">tibble</span>(<span class="st">&quot;truth&quot;</span> =<span class="st"> </span>test_data<span class="op">$</span>price,</a>
<a class="sourceLine" id="cb658-2" title="2">        <span class="st">&quot;prediction&quot;</span> =<span class="st"> </span><span class="kw">unlist</span>(price_predict)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb658-3" title="3"><span class="st">    </span><span class="kw">rmse</span>(truth, prediction)</a></code></pre></div>
<pre><code>## # A tibble: 1 x 3
##   .metric .estimator .estimate
##   &lt;chr&gt;   &lt;chr&gt;          &lt;dbl&gt;
## 1 rmse    standard       0.481</code></pre>

</div>
</div>
</div>
<div class="footnotes">
<hr />
<ol start="2">
<li id="fn2"><p>This package gets installed with R, no need to add it<a href="statistical-models.html#fnref2" class="footnote-back">‚Ü©</a></p></li>
<li id="fn3"><p>The formula in the example is shown for illustration purposes.<a href="statistical-models.html#fnref3" class="footnote-back">‚Ü©</a></p></li>
<li id="fn4"><p><code>data</code> must only contain numeric values, and <code>n</code> is the number of clusters.<a href="statistical-models.html#fnref4" class="footnote-back">‚Ü©</a></p></li>
<li id="fn5"><p><code>data</code> must only contain numeric values, or a formula can be provided.<a href="statistical-models.html#fnref5" class="footnote-back">‚Ü©</a></p></li>
<li id="fn6"><p><code>Surv(y_time, y_status)</code> creates a <em>survival</em> object, where <code>y_time</code> is the time to event <code>y_status</code>. It is possible to create more complex survival objects depending on exactly which data you are dealing with.<a href="statistical-models.html#fnref6" class="footnote-back">‚Ü©</a></p></li>
</ol>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="graphs.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="defining-your-own-functions.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"google": false,
"linkedin": false,
"weibo": false,
"instapper": false,
"vk": false,
"all": ["facebook", "google", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"download": null,
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdn.bootcss.com/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:" && /^https?:/.test(src))
      src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
